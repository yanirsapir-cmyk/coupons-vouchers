<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>×©×•×‘×¨×™× ×•×§×•×¤×•× ×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#ef4444; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;

      --good:#5fbf73;      /* ×™×¨×•×§ ×¢×“×™×Ÿ */
      --warn:#f2c94c;      /* ×¦×”×•×‘ ×¢×“×™×Ÿ */
      --bad:#ef6b6b;       /* ××“×•× ×¢×“×™×Ÿ */
      --off:#b9c0cc;       /* ××¤×•×¨ ×¢×“×™×Ÿ */

      --sel:#e9f7ee;       /* ×™×¨×•×§ ×‘×—×™×¨×” ×¢×“×™×Ÿ */
      --selBorder:#bfe7cc;

      --softGreen:#e9f7ee;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:22px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:13px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:12px; margin-bottom:12px; overflow:hidden;
    }
    .tabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .view{display:none}
    .view.active{display:block}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}
    .danger{background:#fee2e2; color:#991b1b; border:1px solid #fecaca}
    .subtle{background:#f3f4f6; color:#111827; border:1px solid var(--border)}
    .successSoft{background:var(--softGreen); color:#1f6f3a; border:1px solid var(--selBorder)}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline > *{flex:0 0 auto}
    .grow{flex:1 1 auto; min-width:200px}

    label{font-weight:900; font-size:13px}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff; max-width:100%;
    }
    textarea{min-height:110px; resize:vertical}
    input[type="date"]{width:100%; display:block}

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    /* ×¨×©×™××•×ª */
    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    .btn-group{display:flex; gap:8px; align-items:center; flex:0 0 auto}

    /* ×›×¨×˜×™×¡ ×©×•×‘×¨ */
    .voucher{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 10px;
      background:#fff;
      margin-bottom:8px;
    }
    .voucher-left{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .voucher-main{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .voucher-title{
      font-weight:900;
      font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .voucher-sub{
      font-weight:900;
      font-size:12px;
      color:#4b5563;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .voucher-meta{
      font-weight:900;
      font-size:12px;
      color:#6b7280;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .openBtn{
      background:var(--primary); color:#fff;
      border:none; border-radius:12px;
      padding:8px 12px;
      font-weight:900;
      cursor:pointer;
      flex:0 0 auto;
    }

    /* ××™×™×§×•×Ÿ â€œ×©×•×‘×¨â€ â€“ ×¦×‘×¢ ×”××™×™×§×•×Ÿ ×¢×¦××• ×‘×œ×‘×“ (××™×Ÿ ×¨×§×¢) */
    .ticketIcon{ width:22px; height:22px; flex:0 0 auto; }
    .c-good{ color:var(--good); }
    .c-warn{ color:var(--warn); }
    .c-bad{  color:var(--bad);  }
    .c-off{  color:var(--off);  }

    /* ×¤×™×œ×˜×¨×™× */
    .filters{
      display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; margin:8px 0 10px;
    }
    .pillBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pillBtn.active{ background:#e8efff; border-color:#c7d2fe; color:#1e40af; }
    .pillBtn.dangerActive{ background:#ffe4e6; border-color:#fecdd3; color:#9f1239; }

    /* Multi-select chips */
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
    .chip{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chip.selected{
      background:var(--sel);
      border-color:var(--selBorder);
      color:#14532d;
    }
    .chip small{font-weight:900; color:#6b7280}

    /* × ×™×”×•×œ â€“ ×¦×¤×•×£ ×™×•×ª×¨ */
    .compactList li{
      padding:7px 10px;
      margin-bottom:6px;
      border-radius:12px;
    }
    .compactText{
      font-size:13px;
      font-weight:900;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:7px 9px; border-radius:10px; border:1px solid var(--border);
      font-weight:900; line-height:1; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      min-width:38px;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:760px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
      max-height:92vh;
      overflow:auto;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      position:sticky;
      top:0;
      background:#fff;
      padding:4px 0 10px;
      z-index:2;
    }
    .modal-title{font-weight:900;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tiny{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .tiny.primaryTiny{background:var(--primary); color:#fff; border-color:var(--primary);}
    .tiny.dangerTiny{background:#fee2e2; color:#991b1b; border-color:#fecaca;}

    .sectionSep{height:1px; background:#eef2f7; margin:12px 0;}

    @media(min-width:700px){ body{max-width:900px;margin:auto} }
  </style>
</head>

<body>
  <h1>ğŸŸï¸ ×©×•×‘×¨×™× ×•×§×•×¤×•× ×™×</h1>

  <div class="tabs">
    <button class="tabbtn active" type="button" onclick="showTab('active')">×¤×¢×™×œ×™×</button>
    <button class="tabbtn" type="button" onclick="showTab('archive')">××¨×›×™×•×Ÿ</button>
    <button class="tabbtn" type="button" onclick="showTab('manage')">× ×™×”×•×œ</button>
    <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
  </div>

  <!-- ×¤×¢×™×œ×™× -->
  <section id="view-active" class="view active">
    <section class="card" style="background:var(--softGreen); border-color:var(--selBorder);">
      <h2 style="margin:0 0 6px 0;">×™×¦×™×¨×ª ×©×•×‘×¨ ×—×“×©</h2>
      <div class="note" style="margin:0 0 10px 0;">×œ×—×¥ ×›××Ÿ ×œ×”×•×¡×¤×ª ×©×•×‘×¨ ×—×“×©</div>
      <button class="btn successSoft" type="button" onclick="openVoucherModal(null)">â• ×”×•×¡×£ ×©×•×‘×¨</button>
    </section>

    <section class="card">
      <div class="field">
        <label>×—×™×¤×•×©</label>
        <input id="searchActive" placeholder="×—×¤×© ×œ×¤×™ ××•×ª×’ / ×—× ×•×ª / ×§×˜×’×•×¨×™×”..." oninput="renderVouchers()">
        <div class="note">×”×—×™×¤×•×© ×¢×•×‘×“ ×¢×œ ×©× ××•×ª×’, ×—× ×•×™×•×ª, ×§×˜×’×•×¨×™×•×ª ×•×”×¢×¨×•×ª.</div>
      </div>

      <h3>×¡×™× ×•×Ÿ</h3>

      <div class="filters">
        <button class="pillBtn active" id="fltA_all" onclick="setTopFilter('active','all')">×”×›×œ</button>
        <button class="pillBtn" id="fltA_exp" onclick="setTopFilter('active','exp')">×§×¨×•×‘ ×œ×¤×§×™×¢×”</button>
      </div>

      <div class="field">
        <label>×§×˜×’×•×¨×™×•×ª</label>
        <div id="catChipsActive" class="chips"></div>
      </div>

      <div class="field">
        <label>××•×ª×’×™×</label>
        <div id="brandChipsActive" class="chips"></div>
      </div>

      <div class="field">
        <label>×—× ×•×™×•×ª</label>
        <div id="storeChipsActive" class="chips"></div>
      </div>

      <div class="inline" style="margin-top:10px;">
        <button class="btn subtle" type="button" onclick="clearFilters('active')">× ×§×” ×¡×™× ×•×Ÿ</button>
        <button class="btn subtle" type="button" onclick="setSort('active','exp')">××™×™×Ÿ ×œ×¤×™ ×ª×•×§×£</button>
        <button class="btn subtle" type="button" onclick="setSort('active','name')">××™×™×Ÿ ×œ×¤×™ ×©×</button>
        <button class="btn subtle" type="button" onclick="setSort('active','amount')">××™×™×Ÿ ×œ×¤×™ ×™×ª×¨×”</button>
      </div>
    </section>

    <section class="card">
      <h2>×©×•×‘×¨×™× ×¤×¢×™×œ×™×</h2>
      <div id="activeList"></div>
    </section>
  </section>

  <!-- ××¨×›×™×•×Ÿ -->
  <section id="view-archive" class="view">
    <section class="card">
      <div class="field">
        <label>×—×™×¤×•×©</label>
        <input id="searchArchive" placeholder="×—×¤×© ×‘××¨×›×™×•×Ÿ..." oninput="renderVouchers()">
      </div>

      <h3>×¡×™× ×•×Ÿ</h3>

      <div class="filters">
        <button class="pillBtn active" id="fltR_all" onclick="setTopFilter('archive','all')">×”×›×œ</button>
        <button class="pillBtn" id="fltR_exp" onclick="setTopFilter('archive','exp')">×§×¨×•×‘ ×œ×¤×§×™×¢×”</button>
      </div>

      <div class="field">
        <label>×§×˜×’×•×¨×™×•×ª</label>
        <div id="catChipsArchive" class="chips"></div>
      </div>

      <div class="field">
        <label>××•×ª×’×™×</label>
        <div id="brandChipsArchive" class="chips"></div>
      </div>

      <div class="field">
        <label>×—× ×•×™×•×ª</label>
        <div id="storeChipsArchive" class="chips"></div>
      </div>

      <div class="inline" style="margin-top:10px;">
        <button class="btn subtle" type="button" onclick="clearFilters('archive')">× ×§×” ×¡×™× ×•×Ÿ</button>
        <button class="btn subtle" type="button" onclick="setSort('archive','exp')">××™×™×Ÿ ×œ×¤×™ ×ª×•×§×£</button>
        <button class="btn subtle" type="button" onclick="setSort('archive','name')">××™×™×Ÿ ×œ×¤×™ ×©×</button>
        <button class="btn subtle" type="button" onclick="setSort('archive','amount')">××™×™×Ÿ ×œ×¤×™ ×™×ª×¨×”</button>
      </div>
    </section>

    <section class="card">
      <h2>××¨×›×™×•×Ÿ</h2>
      <div id="archiveList"></div>
    </section>
  </section>

  <!-- × ×™×”×•×œ -->
  <section id="view-manage" class="view">
    <section class="card">
      <div class="filters">
        <button class="pillBtn active" id="mTabBrands" onclick="setManageTab('brands')">××•×ª×’×™×</button>
        <button class="pillBtn" id="mTabStores" onclick="setManageTab('stores')">×—× ×•×™×•×ª</button>
        <button class="pillBtn" id="mTabCats" onclick="setManageTab('cats')">×§×˜×’×•×¨×™×•×ª</button>
      </div>

      <!-- ××•×ª×’×™× -->
      <div id="manageBrands">
        <div class="inline">
          <input id="newBrandName" class="grow" placeholder="×©× ××•×ª×’ ×—×“×©">
          <button class="btn primary" type="button" onclick="addBrand()">×”×•×¡×£</button>
        </div>
        <ul id="brandsList" class="compactList"></ul>
      </div>

      <!-- ×—× ×•×™×•×ª -->
      <div id="manageStores" style="display:none;">
        <div class="inline">
          <input id="newStoreName" class="grow" placeholder="×©× ×—× ×•×ª ×—×“×©×”">
          <button class="btn primary" type="button" onclick="addStore()">×”×•×¡×£</button>
        </div>
        <ul id="storesList" class="compactList"></ul>
      </div>

      <!-- ×§×˜×’×•×¨×™×•×ª -->
      <div id="manageCats" style="display:none;">
        <div class="inline">
          <input id="newCatName" class="grow" placeholder="×©× ×§×˜×’×•×¨×™×” ×—×“×©×”">
          <button class="btn primary" type="button" onclick="addCategory()">×”×•×¡×£</button>
        </div>
        <ul id="catsList" class="compactList"></ul>
      </div>
    </section>
  </section>

  <!-- × ×ª×•× ×™× -->
  <section id="view-data" class="view">
    <section class="card">
      <h2>ğŸ”„ ×¡× ×›×¨×•×Ÿ</h2>
      <div class="note" id="syncStatusLine"></div>
      <div class="note" id="syncLastLine"></div>

      <div class="inline" style="margin-top:10px;">
        <button class="btn primary" type="button" onclick="syncPullNow()">××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ</button>
        <button class="btn primary" type="button" onclick="syncPushNow()">×©×œ×— × ×ª×•× ×™× ×œ×¢× ×Ÿ</button>
        <button class="btn ghost" type="button" onclick="backupNow()">×’×™×‘×•×™ ×œ×§×•×‘×¥</button>
        <button class="btn ghost" type="button" onclick="triggerRestore()">×˜×¢×™× ×ª ×’×™×‘×•×™</button>
      </div>

      <input id="restoreFile" type="file" accept=".json,application/json" style="display:none" onchange="restoreFromFile(event)">

      <div class="note" id="syncLocalNote" style="display:none; margin-top:10px;"></div>
    </section>

    <section class="card" id="deviceCard" style="display:none;">
      <h2>×”×’×“×¨×•×ª ××›×©×™×¨ (×¨×§ Yanir)</h2>
      <div class="note">×œ××©×ª×™ ×–×” ××•×¡×ª×¨ ×›×“×™ ×œ× ×œ×”×¢××™×¡.</div>
      <div class="inline">
        <label style="min-width:90px;">×©× ××›×©×™×¨</label>
        <select id="deviceNameSelect" onchange="onDeviceChange()">
          <option value="Yanir">Yanir</option>
          <option value="Shirly">Shirly</option>
        </select>
      </div>
    </section>
  </section>

  <!-- Modal: Voucher -->
  <div id="voucherBackdrop" class="modal-backdrop" onclick="closeVoucherModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="voucherModalTitle">â• ×©×•×‘×¨ ×—×“×©</div>
        <div class="modal-actions">
          <button class="tiny primaryTiny" type="button" onclick="saveVoucherFromModal()">×©××™×¨×”</button>
          <button class="tiny" type="button" onclick="hideVoucherModal()">×¡×’×•×¨</button>
        </div>
      </div>

      <div class="field">
        <label>×¡×•×’ ×©×•×‘×¨</label>
        <select id="vType">
          <option value="money" selected>×›×¡×¤×™</option>
          <option value="percent">××—×•×– ×”× ×—×”</option>
          <option value="bogo">1+1 / 2 ×‘××—×™×¨ 1</option>
          <option value="general">×›×œ×œ×™</option>
        </select>
      </div>

      <div class="field">
        <label>×›×¨×˜×™×¡ ×¤×™×–×™?</label>
        <select id="vPhysical">
          <option value="0" selected>×œ×</option>
          <option value="1">×›×Ÿ</option>
        </select>
      </div>

      <div class="sectionSep"></div>

      <!-- ××•×ª×’/×—× ×•×ª: ×‘×œ×™ "×©× ×©×•×‘×¨" -->
      <div class="field">
        <label>××•×ª×’ (××•×¤×¦×™×•× ×œ×™)</label>
        <select id="vBrand" onchange="onVoucherBrandChanged()"></select>
        <div class="note">××¤×©×¨ ×œ×”×©××™×¨ â€œ×œ×œ× ××•×ª×’â€ ×•×œ×‘×—×•×¨ ×—× ×•×ª ×‘×œ×‘×“.</div>
      </div>

      <div class="field">
        <label>×”×× ×”×©×•×‘×¨ ×ª×§×£ ×œ×›×œ ×”×¨×©×ª?</label>
        <select id="vAllNetwork" onchange="onAllNetworkChanged()">
          <option value="1" selected>×›×Ÿ (×›×œ ×”×¨×©×ª)</option>
          <option value="0">×œ×, ×¨×§ ×—× ×•×™×•×ª ××¡×•×™××•×ª</option>
        </select>
      </div>

      <div class="field">
        <label>×—× ×•×™×•×ª ×ª×§×¤×•×ª</label>
        <div class="note" id="storesHintLine"></div>

        <div class="inline" style="margin-top:8px;">
          <button class="btn subtle" type="button" onclick="pickBrandStores()">×‘×—×¨ ×—× ×•×™×•×ª ×©×œ ×”××•×ª×’</button>
          <button class="btn subtle" type="button" onclick="clearStoreSelection()">× ×§×” ×‘×—×™×¨×”</button>
          <button class="btn subtle" type="button" onclick="quickAddStore()">×”×•×¡×£ ×—× ×•×ª ×—×“×©×”</button>
        </div>

        <div id="vStoresChips" class="chips"></div>

        <div class="note">×× ×‘×—×¨×ª â€œ×›×œ ×”×¨×©×ªâ€, ×‘×—×™×¨×ª ×—× ×•×™×•×ª ×”×™× ×¨×§ ×œ×¦×•×¨×š ×ª×¦×•×’×”/×—×™×¤×•×© (×œ× ×—×•×‘×”).</div>
      </div>

      <div class="field">
        <label>×§×˜×’×•×¨×™×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
        <div id="vCatsChips" class="chips"></div>
      </div>

      <div class="sectionSep"></div>

      <div id="moneyFields">
        <h3>×¡×›×•××™×</h3>
        <div class="inline">
          <div class="grow">
            <label>×¡×›×•× ×©×•×‘×¨</label>
            <input id="vFace" type="number" inputmode="decimal" placeholder="×œ××©×œ 500" oninput="recalcRemaining()">
          </div>
          <div class="grow">
            <label>× ×•×¦×œ</label>
            <input id="vUsed" type="number" inputmode="decimal" placeholder="×œ××©×œ 200" oninput="recalcRemaining()">
          </div>
          <div class="grow">
            <label>×™×ª×¨×” (××—×•×©×‘)</label>
            <input id="vRemain" type="text" disabled>
          </div>
        </div>
      </div>

      <div class="field">
        <label>×§×•×“ / ××¡×¤×¨ ×©×•×‘×¨ (××•×¤×¦×™×•× ×œ×™)</label>
        <div class="inline">
          <input id="vCode" class="grow" placeholder="×”×“×‘×§ ×§×•×“ ×›××Ÿ...">
          <button class="btn ghost" type="button" onclick="copyField('vCode')">×”×¢×ª×§</button>
        </div>
        <div class="note">×× ×›×¨×˜×™×¡ ×¤×™×–×™ â€“ ××¤×©×¨ ×œ×”×©××™×¨ ×¨×™×§.</div>
      </div>

      <div class="field">
        <label>×ª×•×§×£ (××•×¤×¦×™×•× ×œ×™)</label>
        <input id="vExpiry" type="date">
        <div class="note">×ª×¦×•×’×” ×‘×›×¨×˜×™×¡ ×ª×”×™×” ×‘×¤×•×¨××˜ ×™×©×¨××œ×™ (dd/mm/yyyy).</div>
      </div>

      <div class="field">
        <label>×”×¢×¨×•×ª / ×¤×™×¨×•×˜</label>
        <textarea id="vNotes" placeholder="×”×“×‘×§ ×˜×§×¡×˜, ×ª× ××™×, ×¤×™×¨×•×˜ ×”× ×—×”, ×›×œ ××” ×©×—×©×•×‘..."></textarea>
      </div>

      <div class="sectionSep"></div>

      <div class="inline" style="justify-content:space-between;">
        <button class="btn danger" type="button" onclick="deleteVoucherFromModal()">ğŸ—‘ï¸ ××—×™×§×ª ×©×•×‘×¨</button>
        <button class="btn ghost" type="button" onclick="toggleArchiveFromModal()" id="archiveToggleBtn">×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ</button>
      </div>

      <div style="height:10px"></div>

      <!-- ×›×¤×ª×•×¨ ×©××™×¨×” ×’× ×‘×ª×—×ª×™×ª -->
      <button class="btn primary" type="button" style="width:100%;" onclick="saveVoucherFromModal()">×©××™×¨×”</button>
    </div>
  </div>

<script>
/* ========= PWA Service Worker ========= */
(function(){
  if (!("serviceWorker" in navigator)) return;
  navigator.serviceWorker.register("./sw.js").catch(function(){});
})();

/* ========= Sync Config ========= */
var __isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
var SYNC_URL = "https://script.google.com/macros/s/AKfycbzq9M_mKke4GTDeVPIHHfF-NFu5Yb7MADNVdeaYiuIn_S4LmkqhYejJw7DT9vR7HZG6/exec";
var SYNC_TOKEN = "tok_coupons_9f3a6b2d_20260113";  // <-- ××•×ª×• ×˜×•×§×Ÿ ×’× ×‘-Apps Script

var DEVICE_NAME = (function(){
  var saved = localStorage.getItem("deviceName");
  if(saved) return saved;
  var guess = __isIOS ? "Shirly" : "Yanir";
  localStorage.setItem("deviceName", guess);
  return guess;
})();

var META_KEY = "cloudMeta";
var LAST_SYNC_AT_KEY = "lastSyncAt";
var __userTyping = false;

document.addEventListener("focusin", function(e){
  var t = e && e.target;
  if(!t) return;
  var tag = (t.tagName||"").toLowerCase();
  if(tag === "input" || tag === "select" || tag === "textarea") __userTyping = true;
});
document.addEventListener("focusout", function(e){
  var t = e && e.target;
  if(!t) return;
  var tag = (t.tagName||"").toLowerCase();
  if(tag === "input" || tag === "select" || tag === "textarea") __userTyping = false;
});

function pad2(n){ return String(n).padStart(2,"0"); }
function fmtDateTime(ms){
  if(!ms) return "";
  var d = new Date(ms);
  return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate()) + " " + pad2(d.getHours()) + ":" + pad2(d.getMinutes());
}
function fmtILDate(iso){
  if(!iso) return "â€”";
  // iso YYYY-MM-DD
  var p = String(iso).split("-");
  if(p.length !== 3) return iso;
  return p[2] + "/" + p[1] + "/" + p[0];
}
function safeJSONParse(s, fallback){
  try { return JSON.parse(s); } catch(e){ return fallback; }
}
function uid(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
function now(){ return Date.now(); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function addMonths(date, m){
  var d = new Date(date);
  d.setMonth(d.getMonth()+m);
  return d;
}
function diffDays(a,b){
  // a,b: Date
  var ms = (a.getTime()-b.getTime());
  return Math.floor(ms/(24*60*60*1000));
}
function setSyncMsg(msg){
  var el = document.getElementById("syncStatusLine");
  if(el) el.textContent = msg || "";
}
function setLastSyncNow(){
  localStorage.setItem(LAST_SYNC_AT_KEY, String(Date.now()));
  renderSyncLastLine();
}
function renderSyncLastLine(){
  var el = document.getElementById("syncLastLine");
  if(!el) return;
  var v = Number(localStorage.getItem(LAST_SYNC_AT_KEY) || "0");
  el.textContent = v ? ("×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: " + fmtDateTime(v)) : "×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: â€”";
}
function getLocalMeta(){
  return safeJSONParse(localStorage.getItem(META_KEY) || "null", { updatedAt:0, updatedBy:"" });
}
function setLocalMeta(meta){
  localStorage.setItem(META_KEY, JSON.stringify(meta || { updatedAt:0, updatedBy:"" }));
}
function doFetchJSON(url){
  return fetch(url, { cache:"no-store" }).then(function(r){ return r.json(); });
}
function payload(){
  return {
    v: 1,
    brands: brands,
    stores: stores,
    categories: categories,
    vouchers: vouchers
  };
}
function applyPayload(p, meta){
  p = p || {};
  brands = Array.isArray(p.brands) ? p.brands : [];
  stores = Array.isArray(p.stores) ? p.stores : [];
  categories = Array.isArray(p.categories) ? p.categories : [];
  vouchers = Array.isArray(p.vouchers) ? p.vouchers : [];
  setLocalMeta(meta || {updatedAt:0, updatedBy:""});
  saveLocal(false);
  renderAll();
}
function hasLocalAnyData(){
  return (brands.length || stores.length || categories.length || vouchers.length);
}

function showLocalNoteIfYanir(){
  var el = document.getElementById("syncLocalNote");
  if(!el) return;
  if(DEVICE_NAME === "Yanir"){
    el.style.display = "block";
    el.textContent = "×”×¢×¨×” (×¨×§ ××¦×œ×š): ×× ×œ× ×¨×•××™× ×¢×“×›×•× ×™× â€“ ×œ×—×¥ ××©×™×›×” ××”×¢× ×Ÿ, ×•×× ×¢×“×™×™×Ÿ ×œ×, ×¨×¢× ×•×Ÿ ×¤×¢× ××—×ª.";
  } else {
    el.style.display = "none";
  }
}

function syncPullNow(){
  if(__userTyping) return;
  setSyncMsg("×˜×•×¢×Ÿ ××”×¢× ×Ÿ...");
  doFetchJSON(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN))
    .then(function(j){
      if(!j || !j.ok) throw new Error(j && j.error ? j.error : "bad");
      if(!j.data){
        setSyncMsg("××™×Ÿ × ×ª×•× ×™× ×‘×¢× ×Ÿ");
        setLastSyncNow();
        return;
      }
      var remote = safeJSONParse(j.data, null);
      if(!remote) throw new Error("bad_json");
      applyPayload(remote, j.meta);
      setSyncMsg("× ×˜×¢×Ÿ ××”×¢× ×Ÿ âœ…");
      setLastSyncNow();
    })
    .catch(function(e){
      setSyncMsg("××©×™×›×” ××”×¢× ×Ÿ × ×›×©×œ×” âŒ");
      renderSyncLastLine();
    });
}
window.syncPullNow = syncPullNow;

function syncPushNow(){
  if(__userTyping) return;
  setSyncMsg("×©×•×œ×— ×œ×¢× ×Ÿ...");
  // Yanir wins: Shirly ×§×•×“× ×‘×•×“×§×ª meta
  doFetchJSON(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN) + "&meta=1")
    .then(function(metaResp){
      var remoteMeta = (metaResp && metaResp.meta) ? metaResp.meta : { updatedAt:0, updatedBy:"" };
      var localMeta = getLocalMeta();

      if(DEVICE_NAME !== "Yanir" &&
         (remoteMeta.updatedAt||0) > (localMeta.updatedAt||0) &&
         String(remoteMeta.updatedBy||"") === "Yanir"){
        setSyncMsg("×™×© ×¢×“×›×•×Ÿ ×—×“×© ×©×œ Yanir â€” ××•×©×š ×‘××§×•× ×œ×©×œ×•×—...");
        return syncPullNow();
      }

      var dataStr = JSON.stringify(payload());
      var url = SYNC_URL
        + "?token=" + encodeURIComponent(SYNC_TOKEN)
        + "&write=1"
        + "&by=" + encodeURIComponent(DEVICE_NAME)
        + "&data=" + encodeURIComponent(dataStr);

      return doFetchJSON(url).then(function(w){
        if(w && w.ok){
          setLocalMeta(w.meta || remoteMeta);
          setSyncMsg("× ×©×œ×— ×œ×¢× ×Ÿ âœ…");
          setLastSyncNow();
        } else {
          setSyncMsg("×©×œ×™×—×” ×œ×¢× ×Ÿ × ×›×©×œ×” âŒ");
        }
      });
    })
    .catch(function(){
      setSyncMsg("×©×œ×™×—×” ×œ×¢× ×Ÿ × ×›×©×œ×” âŒ");
    });
}
window.syncPushNow = syncPushNow;

/* ========= Local Storage ========= */
var KEY = "couponsAppData_v1";

var brands = safeJSONParse(localStorage.getItem(KEY), null)?.brands || [];
var stores = safeJSONParse(localStorage.getItem(KEY), null)?.stores || [];
var categories = safeJSONParse(localStorage.getItem(KEY), null)?.categories || [];
var vouchers = safeJSONParse(localStorage.getItem(KEY), null)?.vouchers || [];

function saveLocal(triggerRender){
  localStorage.setItem(KEY, JSON.stringify(payload()));
  if(triggerRender !== false) renderAll();
}

/* ========= Tabs ========= */
function showTab(key){
  var btns = document.querySelectorAll(".tabbtn");
  for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
  var views = document.querySelectorAll(".view");
  for(var j=0;j<views.length;j++) views[j].classList.remove("active");

  var idx=0, viewId="view-active";
  if(key==="archive"){ idx=1; viewId="view-archive"; }
  else if(key==="manage"){ idx=2; viewId="view-manage"; }
  else if(key==="data"){ idx=3; viewId="view-data"; }

  btns[idx].classList.add("active");
  document.getElementById(viewId).classList.add("active");

  renderAll();
}
window.showTab = showTab;

/* ========= Manage tab internal ========= */
var manageTab = "brands";
function setManageTab(k){
  manageTab = k;
  document.getElementById("mTabBrands").classList.toggle("active", k==="brands");
  document.getElementById("mTabStores").classList.toggle("active", k==="stores");
  document.getElementById("mTabCats").classList.toggle("active", k==="cats");

  document.getElementById("manageBrands").style.display = (k==="brands") ? "block" : "none";
  document.getElementById("manageStores").style.display = (k==="stores") ? "block" : "none";
  document.getElementById("manageCats").style.display = (k==="cats") ? "block" : "none";
}
window.setManageTab = setManageTab;

/* ========= CRUD: Categories ========= */
function addCategory(){
  var name = (document.getElementById("newCatName").value || "").trim();
  if(!name) return;
  categories.push({ id:uid(), name:name });
  document.getElementById("newCatName").value = "";
  saveLocal(true);
}
window.addCategory = addCategory;

function deleteCategory(catId){
  if(!confirm("×œ××—×•×§ ×§×˜×’×•×¨×™×”?")) return;
  categories = categories.filter(function(c){ return c.id !== catId; });
  // ×œ× ×©×•×‘×¨×™× ×”×™×¡×˜×•×¨×™×” â€“ ×”×©×•×‘×¨×™× ×©×•××¨×™× snapshot ×˜×§×¡×˜
  saveLocal(true);
}
function editCategory(catId){
  var c = categories.find(function(x){ return x.id===catId; });
  if(!c) return;
  var next = (prompt("×©× ×§×˜×’×•×¨×™×” ×—×“×©:", c.name) || "").trim();
  if(!next) return;
  c.name = next;
  saveLocal(true);
}

/* ========= CRUD: Stores ========= */
function addStore(){
  var name = (document.getElementById("newStoreName").value || "").trim();
  if(!name) return;
  stores.push({ id:uid(), name:name, brandIds:[], categoryIds:[] });
  document.getElementById("newStoreName").value = "";
  saveLocal(true);
}
window.addStore = addStore;

function deleteStore(storeId){
  if(!confirm("×œ××—×•×§ ×—× ×•×ª?")) return;
  stores = stores.filter(function(s){ return s.id !== storeId; });
  // ×”×¡×¨×ª ×§×©×¨×™× ×××•×ª×’×™×
  brands.forEach(function(b){
    b.storeIds = (b.storeIds||[]).filter(function(id){ return id !== storeId; });
  });
  saveLocal(true);
}
function editStore(storeId){
  var s = stores.find(function(x){ return x.id===storeId; });
  if(!s) return;
  var next = (prompt("×©× ×—× ×•×ª ×—×“×©:", s.name) || "").trim();
  if(!next) return;
  s.name = next;
  saveLocal(true);
}
function openStore(storeId){
  // ××¡×š â€œ×¤×ª×—â€ ×¢× × ×™×”×•×œ ×§×©×¨×™×: ××©×ª××©×™× ×‘××•×ª×• modal ×©×œ ×©×•×‘×¨? ×œ× â€“ × ×¤×ª×— prompt+chip modal ×¤×©×•×˜
  openEntityModal("store", storeId);
}

/* ========= CRUD: Brands ========= */
function addBrand(){
  var name = (document.getElementById("newBrandName").value || "").trim();
  if(!name) return;
  brands.push({ id:uid(), name:name, storeIds:[], categoryIds:[] });
  document.getElementById("newBrandName").value = "";
  saveLocal(true);
}
window.addBrand = addBrand;

function deleteBrand(brandId){
  if(!confirm("×œ××—×•×§ ××•×ª×’?")) return;
  brands = brands.filter(function(b){ return b.id !== brandId; });
  // ×”×¡×¨×ª ×§×©×¨×™× ××—× ×•×™×•×ª
  stores.forEach(function(s){
    s.brandIds = (s.brandIds||[]).filter(function(id){ return id !== brandId; });
  });
  saveLocal(true);
}
function editBrand(brandId){
  var b = brands.find(function(x){ return x.id===brandId; });
  if(!b) return;
  var next = (prompt("×©× ××•×ª×’ ×—×“×©:", b.name) || "").trim();
  if(!next) return;
  b.name = next;
  saveLocal(true);
}
function openBrand(brandId){
  openEntityModal("brand", brandId);
}

/* ========= Entity Modal (Brands/Stores relationships) ========= */
var entityModal = null;
var entityType = null;
var entityId = null;

function openEntityModal(type, id){
  entityType = type; entityId = id;

  var title = type==="brand" ? "××•×ª×’" : "×—× ×•×ª";
  var name = "";
  if(type==="brand"){
    var b = brands.find(function(x){ return x.id===id; });
    if(!b) return;
    name = b.name;
  } else {
    var s = stores.find(function(x){ return x.id===id; });
    if(!s) return;
    name = s.name;
  }

  var backdrop = document.createElement("div");
  backdrop.className = "modal-backdrop";
  backdrop.style.display = "flex";
  backdrop.onclick = function(e){ if(e.target===backdrop) document.body.removeChild(backdrop); };

  var modal = document.createElement("div");
  modal.className = "modal";
  modal.onclick = function(e){ e.stopPropagation(); };

  modal.innerHTML =
    '<div class="modal-header">'+
      '<div class="modal-title">ğŸ“Œ '+title+': '+escapeHtml(name)+'</div>'+
      '<div class="modal-actions">'+
        '<button class="tiny primaryTiny" type="button" id="entSaveBtn">×©××™×¨×”</button>'+
        '<button class="tiny" type="button" id="entCloseBtn">×¡×’×•×¨</button>'+
      '</div>'+
    '</div>'+
    '<div class="note">×¢×¨×™×›×ª ×§×©×¨×™×. ××—×™×§×” ×‘× ×™×”×•×œ ×œ× ×©×•×‘×¨×ª ×”×™×¡×˜×•×¨×™×”. ××¤×©×¨ ×œ×™×¦×•×¨ ××—×“×© ×©××•×ª ×’× ×× ×”×•×¤×™×¢×• ×‘×¢×‘×¨.</div>'+
    '<div class="sectionSep"></div>'+
    '<div class="field"><label>×§×˜×’×•×¨×™×•×ª</label><div id="entCats" class="chips"></div></div>'+
    '<div class="field" style="'+(type==="brand" ? "" : "")+'"><label>'+(type==="brand" ? '×—× ×•×™×•×ª ×©×©×™×™×›×•×ª ×œ××•×ª×’' : '××•×ª×’×™× ×©×©×™×™×›×™× ×œ×—× ×•×ª')+'</label><div id="entLinks" class="chips"></div></div>';

  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);
  entityModal = backdrop;

  document.getElementById("entCloseBtn").onclick = function(){ document.body.removeChild(backdrop); };

  // render chips
  renderEntityCats();
  renderEntityLinks();

  document.getElementById("entSaveBtn").onclick = function(){
    // nothing extra (chips already update live)
    saveLocal(true);
    document.body.removeChild(backdrop);
  };
}

function renderEntityCats(){
  var host = document.getElementById("entCats");
  if(!host) return;
  host.innerHTML = "";

  var selected = [];
  if(entityType==="brand"){
    var b = brands.find(function(x){ return x.id===entityId; });
    selected = (b && b.categoryIds) ? b.categoryIds.slice() : [];
  } else {
    var s = stores.find(function(x){ return x.id===entityId; });
    selected = (s && s.categoryIds) ? s.categoryIds.slice() : [];
  }

  categories.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(c){
    var chip = document.createElement("div");
    chip.className = "chip" + (selected.indexOf(c.id)>=0 ? " selected" : "");
    chip.textContent = c.name;
    chip.onclick = function(){
      var on = chip.classList.contains("selected");
      chip.classList.toggle("selected", !on);
      if(entityType==="brand"){
        var b = brands.find(function(x){ return x.id===entityId; }); if(!b) return;
        b.categoryIds = toggleIdList(b.categoryIds||[], c.id, !on);
      } else {
        var s = stores.find(function(x){ return x.id===entityId; }); if(!s) return;
        s.categoryIds = toggleIdList(s.categoryIds||[], c.id, !on);
      }
    };
    host.appendChild(chip);
  });
}

function renderEntityLinks(){
  var host = document.getElementById("entLinks");
  if(!host) return;
  host.innerHTML = "";

  if(entityType==="brand"){
    var b = brands.find(function(x){ return x.id===entityId; });
    if(!b) return;
    var selected = (b.storeIds||[]).slice();

    stores.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(s){
      var chip = document.createElement("div");
      chip.className = "chip" + (selected.indexOf(s.id)>=0 ? " selected" : "");
      chip.textContent = s.name;
      chip.onclick = function(){
        var on = chip.classList.contains("selected");
        chip.classList.toggle("selected", !on);
        b.storeIds = toggleIdList(b.storeIds||[], s.id, !on);
        // ×¢×“×›×•×Ÿ ×“×•-×›×™×•×•× ×™
        s.brandIds = toggleIdList(s.brandIds||[], b.id, !on);
      };
      host.appendChild(chip);
    });

  } else {
    var s2 = stores.find(function(x){ return x.id===entityId; });
    if(!s2) return;
    var selected2 = (s2.brandIds||[]).slice();

    brands.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(b2){
      var chip2 = document.createElement("div");
      chip2.className = "chip" + (selected2.indexOf(b2.id)>=0 ? " selected" : "");
      chip2.textContent = b2.name;
      chip2.onclick = function(){
        var on2 = chip2.classList.contains("selected");
        chip2.classList.toggle("selected", !on2);
        s2.brandIds = toggleIdList(s2.brandIds||[], b2.id, !on2);
        // ×¢×“×›×•×Ÿ ×“×•-×›×™×•×•× ×™
        b2.storeIds = toggleIdList(b2.storeIds||[], s2.id, !on2);
      };
      host.appendChild(chip2);
    });
  }
}

function toggleIdList(arr, id, shouldHave){
  arr = Array.isArray(arr) ? arr.slice() : [];
  var idx = arr.indexOf(id);
  if(shouldHave && idx<0) arr.push(id);
  if(!shouldHave && idx>=0) arr.splice(idx,1);
  return arr;
}

/* ========= Filters state ========= */
var filters = {
  active: { top:"all", cats:[], brands:[], stores:[], sort:"default" },
  archive:{ top:"all", cats:[], brands:[], stores:[], sort:"default" }
};

function setTopFilter(where, val){
  filters[where].top = val;
  document.getElementById(where==="active" ? "fltA_all" : "fltR_all").classList.toggle("active", val==="all");
  document.getElementById(where==="active" ? "fltA_exp" : "fltR_exp").classList.toggle(where==="active" ? "dangerActive" : "dangerActive", val==="exp");
  document.getElementById(where==="active" ? "fltA_exp" : "fltR_exp").classList.toggle("active", val==="exp");
  renderVouchers();
}
window.setTopFilter = setTopFilter;

function clearFilters(where){
  filters[where] = { top:"all", cats:[], brands:[], stores:[], sort:"default" };
  if(where==="active"){
    document.getElementById("searchActive").value = "";
    setTopFilter("active","all");
  } else {
    document.getElementById("searchArchive").value = "";
    setTopFilter("archive","all");
  }
  renderAll();
}
window.clearFilters = clearFilters;

function setSort(where, sortKey){
  filters[where].sort = sortKey;
  renderVouchers();
}
window.setSort = setSort;

/* ========= Voucher modal state ========= */
var editingVoucherId = null;

function openVoucherModal(vId){
  editingVoucherId = vId;
  document.getElementById("voucherBackdrop").style.display = "flex";

  // populate brand select
  var brandSel = document.getElementById("vBrand");
  brandSel.innerHTML = "";
  var opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "×œ×œ× ××•×ª×’";
  brandSel.appendChild(opt0);
  brands.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(b){
    var o = document.createElement("option");
    o.value = b.id;
    o.textContent = b.name;
    brandSel.appendChild(o);
  });

  // default fields
  document.getElementById("vType").value = "money";
  document.getElementById("vPhysical").value = "0";
  document.getElementById("vAllNetwork").value = "1";
  document.getElementById("vFace").value = "";
  document.getElementById("vUsed").value = "";
  document.getElementById("vRemain").value = "";
  document.getElementById("vCode").value = "";
  document.getElementById("vExpiry").value = "";
  document.getElementById("vNotes").value = "";

  // clear chips
  __modalSelectedStores = [];
  __modalSelectedCats = [];

  // title/buttons
  var isEdit = !!vId;
  document.getElementById("voucherModalTitle").textContent = isEdit ? "âœï¸ ×¢×¨×™×›×ª ×©×•×‘×¨" : "â• ×©×•×‘×¨ ×—×“×©";
  document.getElementById("archiveToggleBtn").textContent = "×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ";
  document.getElementById("archiveToggleBtn").dataset.mode = "toArchive";
  document.getElementById("archiveToggleBtn").style.display = isEdit ? "inline-block" : "none";
  document.querySelector("#voucherBackdrop .btn.danger").style.display = isEdit ? "inline-block" : "none";

  // load existing if edit
  if(isEdit){
    var v = vouchers.find(function(x){ return x.id===vId; });
    if(v){
      document.getElementById("vType").value = v.type || "money";
      document.getElementById("vPhysical").value = v.physical ? "1" : "0";
      document.getElementById("vBrand").value = v.brandId || "";
      document.getElementById("vAllNetwork").value = v.allNetwork ? "1" : "0";
      __modalSelectedStores = Array.isArray(v.storeIds) ? v.storeIds.slice() : [];
      __modalSelectedCats = Array.isArray(v.categoryIds) ? v.categoryIds.slice() : [];
      document.getElementById("vFace").value = (v.faceValue!=null) ? String(v.faceValue) : "";
      document.getElementById("vUsed").value = (v.usedValue!=null) ? String(v.usedValue) : "";
      document.getElementById("vCode").value = v.code || "";
      document.getElementById("vExpiry").value = v.expiry || "";
      document.getElementById("vNotes").value = v.notes || "";

      if(v.archived){
        document.getElementById("archiveToggleBtn").textContent = "×”×—×–×¨ ×œ×¤×¢×™×œ";
        document.getElementById("archiveToggleBtn").dataset.mode = "toActive";
      } else {
        document.getElementById("archiveToggleBtn").textContent = "×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ";
        document.getElementById("archiveToggleBtn").dataset.mode = "toArchive";
      }
    }
  }

  renderModalChips();
  onVoucherBrandChanged();
  onAllNetworkChanged();
  recalcRemaining();
}
window.openVoucherModal = openVoucherModal;

function hideVoucherModal(){
  document.getElementById("voucherBackdrop").style.display = "none";
  editingVoucherId = null;
}
window.hideVoucherModal = hideVoucherModal;

function closeVoucherModal(e){
  if(e.target === document.getElementById("voucherBackdrop")) hideVoucherModal();
}
window.closeVoucherModal = closeVoucherModal;

function escapeHtml(s){
  s = String(s==null?"":s);
  return s.replace(/[&<>"']/g, function(m){
    return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[m];
  });
}

function copyField(id){
  var el = document.getElementById(id);
  if(!el) return;
  var val = el.value || "";
  if(!val) return;
  try{
    navigator.clipboard.writeText(val);
    alert("×”×•×¢×ª×§ âœ…");
  }catch(e){
    // fallback
    try{
      el.select();
      document.execCommand("copy");
      alert("×”×•×¢×ª×§ âœ…");
    }catch(e2){
      alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§. × ×¡×” ×™×“× ×™×ª.");
    }
  }
}
window.copyField = copyField;

var __modalSelectedStores = [];
var __modalSelectedCats = [];

function onVoucherBrandChanged(){
  // ×× ×–×” ×©×•×‘×¨ ×—×“×© (×œ× ×¢×¨×™×›×”) â€“ ×‘×•×—×¨×™× ×›×‘×¨×™×¨×ª ××—×“×œ ×—× ×•×™×•×ª ×©×œ ×”××•×ª×’
  var brandId = document.getElementById("vBrand").value || "";
  var hint = document.getElementById("storesHintLine");
  var b = brandId ? brands.find(function(x){ return x.id===brandId; }) : null;

  if(b && Array.isArray(b.storeIds) && b.storeIds.length){
    hint.textContent = "×‘×¨×™×¨×ª ××—×“×œ: ×—× ×•×™×•×ª ××©×•×™×›×•×ª ×œ××•×ª×’ × ×˜×¢× ×• ××•×˜×•××˜×™×ª. ××¤×©×¨ ×œ×©× ×•×ª.";
    if(!editingVoucherId){
      __modalSelectedStores = b.storeIds.slice();
    }
  } else if(b){
    hint.textContent = "×œ××•×ª×’ ×”×–×” ××™×Ÿ ×—× ×•×™×•×ª ××©×•×™×›×•×ª ×‘× ×™×”×•×œ. ××¤×©×¨ ×œ×‘×—×•×¨ ×™×“× ×™×ª.";
    if(!editingVoucherId){
      __modalSelectedStores = [];
    }
  } else {
    hint.textContent = "×œ×œ× ××•×ª×’: ×‘×—×¨ ×—× ×•×ª/×—× ×•×™×•×ª ×œ×¤×™ ×”×¦×•×¨×š.";
    if(!editingVoucherId){
      __modalSelectedStores = [];
    }
  }

  renderModalChips();
  onAllNetworkChanged();
}
window.onVoucherBrandChanged = onVoucherBrandChanged;

function onAllNetworkChanged(){
  var allNet = document.getElementById("vAllNetwork").value === "1";
  // ×œ× ××¡×ª×™×¨×™× ××ª ×”×—× ×•×™×•×ª â€” ×××¤×©×¨×™× ×œ×¡××Ÿ ×œ×¦×•×¨×š ×ª×¦×•×’×”/×—×™×¤×•×©, ××‘×œ ×œ× ×—×•×‘×”
  // ×× allNetwork=1 ×•×œ× × ×‘×—×¨×• ×—× ×•×™×•×ª â€“ ×¢×“×™×™×Ÿ ×‘×¡×“×¨
}
window.onAllNetworkChanged = onAllNetworkChanged;

function pickBrandStores(){
  var brandId = document.getElementById("vBrand").value || "";
  if(!brandId) return alert("×‘×—×¨ ××•×ª×’ ×§×•×“×");
  var b = brands.find(function(x){ return x.id===brandId; });
  if(!b) return;
  __modalSelectedStores = (b.storeIds||[]).slice();
  renderModalChips();
}
window.pickBrandStores = pickBrandStores;

function clearStoreSelection(){
  __modalSelectedStores = [];
  renderModalChips();
}
window.clearStoreSelection = clearStoreSelection;

function quickAddStore(){
  var name = (prompt("×©× ×—× ×•×ª ×—×“×©×”:") || "").trim();
  if(!name) return;
  var s = { id:uid(), name:name, brandIds:[], categoryIds:[] };
  stores.push(s);

  // ×× ×™×© ××•×ª×’ × ×‘×—×¨ â€“ ××¤×©×¨ ×œ×©×™×™×š ××™×“?
  var brandId = document.getElementById("vBrand").value || "";
  if(brandId){
    var b = brands.find(function(x){ return x.id===brandId; });
    if(b){
      b.storeIds = toggleIdList(b.storeIds||[], s.id, true);
      s.brandIds = toggleIdList(s.brandIds||[], b.id, true);
    }
  }

  __modalSelectedStores = toggleIdList(__modalSelectedStores, s.id, true);
  saveLocal(false);
  renderModalChips();
  renderManageLists();
  renderFilterChips();
}
window.quickAddStore = quickAddStore;

function renderModalChips(){
  // stores chips - show all stores (sorted), allow pick any.
  var storesHost = document.getElementById("vStoresChips");
  storesHost.innerHTML = "";
  stores.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(s){
    var chip = document.createElement("div");
    chip.className = "chip" + (__modalSelectedStores.indexOf(s.id)>=0 ? " selected" : "");
    chip.textContent = s.name;
    chip.onclick = function(){
      var on = chip.classList.contains("selected");
      chip.classList.toggle("selected", !on);
      __modalSelectedStores = toggleIdList(__modalSelectedStores, s.id, !on);
    };
    storesHost.appendChild(chip);
  });

  // cats chips
  var catsHost = document.getElementById("vCatsChips");
  catsHost.innerHTML = "";
  categories.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(c){
    var chip2 = document.createElement("div");
    chip2.className = "chip" + (__modalSelectedCats.indexOf(c.id)>=0 ? " selected" : "");
    chip2.textContent = c.name;
    chip2.onclick = function(){
      var on2 = chip2.classList.contains("selected");
      chip2.classList.toggle("selected", !on2);
      __modalSelectedCats = toggleIdList(__modalSelectedCats, c.id, !on2);
    };
    catsHost.appendChild(chip2);
  });

  recalcRemaining();
}

function recalcRemaining(){
  var face = parseFloat(document.getElementById("vFace").value || "0");
  var used = parseFloat(document.getElementById("vUsed").value || "0");
  if(isNaN(face)) face = 0;
  if(isNaN(used)) used = 0;
  var rem = (face - used);
  document.getElementById("vRemain").value = (isFinite(rem) ? rem.toFixed(2).replace(/\.00$/,"") : "");
}
window.recalcRemaining = recalcRemaining;

function validateVoucherForm(){
  var brandId = document.getElementById("vBrand").value || "";
  var allNet = document.getElementById("vAllNetwork").value === "1";
  var hasBrand = !!brandId;
  var hasStores = (__modalSelectedStores && __modalSelectedStores.length>0);
  if(!hasBrand && !hasStores){
    return "×—×•×‘×” ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××•×ª×’ ××• ×—× ×•×ª ××—×ª.";
  }
  // ×× ×œ× ×›×œ ×”×¨×©×ª ×•×¢×“×™×™×Ÿ ××™×Ÿ ×—× ×•×™×•×ª â€“ ×–×” ×‘×¢×™×™×ª×™ (×‘×—×¨×ª ×¨×§ ××•×ª×’ ××‘×œ ×××¨×ª ×œ× ×›×œ ×”×¨×©×ª)
  if(!allNet && !hasStores){
    return "×‘×—×¨×ª â€œ×¨×§ ×—× ×•×™×•×ª ××¡×•×™××•×ªâ€ ××‘×œ ×œ× ×‘×—×¨×ª ×—× ×•×™×•×ª. ×‘×—×¨ ×—× ×•×ª ××—×ª ×œ×¤×—×•×ª ××• ×©× ×” ×œâ€œ×›×œ ×”×¨×©×ªâ€.";
  }
  return "";
}

function snapshotNames(brandId, storeIds, catIds){
  var bName = brandId ? (brands.find(function(b){return b.id===brandId;})?.name || "") : "";
  var sNames = (storeIds||[]).map(function(id){
    return stores.find(function(s){return s.id===id;})?.name || "";
  }).filter(Boolean);

  var cNames = (catIds||[]).map(function(id){
    return categories.find(function(c){return c.id===id;})?.name || "";
  }).filter(Boolean);

  return { brandNameSnap:bName, storeNamesSnap:sNames, catNamesSnap:cNames };
}

function saveVoucherFromModal(){
  var err = validateVoucherForm();
  if(err){ alert(err); return; }

  var type = document.getElementById("vType").value;
  var physical = document.getElementById("vPhysical").value === "1";
  var brandId = document.getElementById("vBrand").value || "";
  var allNet = document.getElementById("vAllNetwork").value === "1";
  var face = document.getElementById("vFace").value.trim();
  var used = document.getElementById("vUsed").value.trim();
  var faceValue = (face==="" ? null : Number(face));
  var usedValue = (used==="" ? 0 : Number(used));
  if(!isFinite(usedValue)) usedValue = 0;

  var code = (document.getElementById("vCode").value || "").trim();
  var expiry = document.getElementById("vExpiry").value || "";
  var notes = document.getElementById("vNotes").value || "";

  var cats = __modalSelectedCats.slice();
  var storesSel = __modalSelectedStores.slice();

  var snap = snapshotNames(brandId, storesSel, cats);

  if(editingVoucherId){
    var v = vouchers.find(function(x){ return x.id===editingVoucherId; });
    if(!v) return;

    v.type = type;
    v.physical = physical;
    v.brandId = brandId || "";
    v.allNetwork = allNet;
    v.storeIds = storesSel;
    v.categoryIds = cats;
    v.faceValue = faceValue;
    v.usedValue = usedValue;
    v.code = code;
    v.expiry = expiry;
    v.notes = notes;
    // snapshot × ×©××¨ ×›××¦×‘ × ×•×›×—×™ ×©×œ ×”×¢×¨×™×›×” (×›××• ×©×¡×™×›×× ×• â€“ ××” ×©×”×™×” ×‘×–××Ÿ ×”×©×•×‘×¨/×¢×¨×™×›×”)
    v.brandNameSnap = snap.brandNameSnap;
    v.storeNamesSnap = snap.storeNamesSnap;
    v.catNamesSnap = snap.catNamesSnap;

    v.updatedAt = now();

  } else {
    var v2 = {
      id: uid(),
      createdAt: now(),
      updatedAt: now(),
      archived: false,
      archivedAt: 0,
      archivedReason: "",
      type: type,
      physical: physical,
      brandId: brandId || "",
      allNetwork: allNet,
      storeIds: storesSel,
      categoryIds: cats,
      faceValue: faceValue,
      usedValue: usedValue,
      code: code,
      expiry: expiry,
      notes: notes,
      // snapshot
      brandNameSnap: snap.brandNameSnap,
      storeNamesSnap: snap.storeNamesSnap,
      catNamesSnap: snap.catNamesSnap
    };
    vouchers.push(v2);
  }

  autoArchiveRules();
  saveLocal(true);
  hideVoucherModal();
}
window.saveVoucherFromModal = saveVoucherFromModal;

function deleteVoucherFromModal(){
  if(!editingVoucherId) return;
  if(!confirm("×œ××—×•×§ ×©×•×‘×¨?")) return;
  vouchers = vouchers.filter(function(v){ return v.id !== editingVoucherId; });
  saveLocal(true);
  hideVoucherModal();
}
window.deleteVoucherFromModal = deleteVoucherFromModal;

function toggleArchiveFromModal(){
  if(!editingVoucherId) return;
  var v = vouchers.find(function(x){ return x.id===editingVoucherId; });
  if(!v) return;

  var mode = document.getElementById("archiveToggleBtn").dataset.mode;
  if(mode==="toArchive"){
    v.archived = true;
    v.archivedAt = now();
    v.archivedReason = "manual";
  } else {
    v.archived = false;
    v.archivedAt = 0;
    v.archivedReason = "";
  }
  v.updatedAt = now();
  autoArchiveRules();
  saveLocal(true);

  // keep modal open but update button label
  if(v.archived){
    document.getElementById("archiveToggleBtn").textContent = "×”×—×–×¨ ×œ×¤×¢×™×œ";
    document.getElementById("archiveToggleBtn").dataset.mode = "toActive";
  } else {
    document.getElementById("archiveToggleBtn").textContent = "×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ";
    document.getElementById("archiveToggleBtn").dataset.mode = "toArchive";
  }
}
window.toggleArchiveFromModal = toggleArchiveFromModal;

/* ========= Auto-archive rules ========= */
function voucherRemaining(v){
  if(v.faceValue==null) return null;
  var rem = Number(v.faceValue||0) - Number(v.usedValue||0);
  if(!isFinite(rem)) return null;
  return rem;
}
function isExpired(v){
  if(!v.expiry) return false;
  // compare by date
  var end = new Date(v.expiry + "T00:00:00");
  var today = new Date(todayISO() + "T00:00:00");
  return end.getTime() < today.getTime();
}
function isExpiringSoon(v){
  if(!v.expiry) return false;
  var end = new Date(v.expiry + "T00:00:00");
  var today = new Date(todayISO() + "T00:00:00");
  // ×¤×—×•×ª ×-3 ×—×•×“×©×™× = 92 ×™××™× ×‘×¢×¨×š
  var days = Math.ceil((end.getTime()-today.getTime())/(24*60*60*1000));
  return days >= 0 && days <= 92;
}
function autoArchiveRules(){
  vouchers.forEach(function(v){
    // ×× ×›×‘×¨ ×‘××¨×›×™×•×Ÿ â€“ ×œ× ××—×–×™×¨×™× ××•×˜×•××˜×™×ª
    if(v.archived) return;

    // ×™×ª×¨×” 0 (×¨×§ ×× ×™×© faceValue)
    var rem = voucherRemaining(v);
    if(rem != null && rem <= 0){
      v.archived = true;
      v.archivedAt = now();
      v.archivedReason = "zero";
      return;
    }

    // ×¤×’ ×ª×•×§×£
    if(isExpired(v)){
      v.archived = true;
      v.archivedAt = now();
      v.archivedReason = "expired";
      return;
    }
  });
}

/* ========= Rendering ========= */
function getBrandName(brandId){
  var b = brands.find(function(x){ return x.id===brandId; });
  return b ? b.name : "";
}
function getStoreName(storeId){
  var s = stores.find(function(x){ return x.id===storeId; });
  return s ? s.name : "";
}
function getCatName(catId){
  var c = categories.find(function(x){ return x.id===catId; });
  return c ? c.name : "";
}

function ticketSVG(colorClass){
  // currentColor is driven by .c-good etc
  return '<svg class="ticketIcon '+colorClass+'" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">'+
    '<path d="M4 7.5A2.5 2.5 0 0 1 6.5 5h11A2.5 2.5 0 0 1 20 7.5v1.2a2 2 0 0 0 0 4.1v1.7A2.5 2.5 0 0 1 17.5 17h-11A2.5 2.5 0 0 1 4 14.5v-1.7a2 2 0 0 0 0-4.1V7.5Zm5.5-.5a.75.75 0 0 0 0 1.5h5a.75.75 0 0 0 0-1.5h-5Zm0 3a.75.75 0 0 0 0 1.5h5a.75.75 0 0 0 0-1.5h-5Zm0 3a.75.75 0 0 0 0 1.5h2.5a.75.75 0 0 0 0-1.5H9.5Z"/>'+
  '</svg>';
}

function getVoucherStatus(v){
  // ×§×“×™××•×ª: ××“×•× (×§×¨×•×‘ ×œ×¤×§×™×¢×”) ×¢×•×§×£ ×”×›×œ
  if(!v.archived && isExpiringSoon(v)) return "bad";

  // ×œ× ×–××™×Ÿ
  if(v.archived || isExpired(v)) return "off";

  // ×©×•×‘×¨ ×›×¡×¤×™: ××œ×/×—×œ×§×™
  if(v.type === "money" && v.faceValue != null){
    var rem = voucherRemaining(v);
    if(rem == null) return "good";
    if(rem <= 0) return "off";
    if(Number(v.usedValue||0) > 0) return "warn";
    return "good";
  }

  // ×©×•×‘×¨ ×¢× ×¢×¨×š ×›×¡×¤×™ ×’× ×× type ××—×¨ â€“ ×× ×”×•×’×“×¨
  if(v.faceValue != null){
    var rem2 = voucherRemaining(v);
    if(rem2 != null && rem2 <= 0) return "off";
    if(Number(v.usedValue||0) > 0) return "warn";
    return "good";
  }

  // ×›×œ×œ×™/××—×•×–/1+1/×¤×™×–×™ ×‘×œ×™ ×¡×›×•×: ××™×Ÿ â€œ×—×œ×§×™â€ -> ×˜×•×‘/×œ× ×–××™×Ÿ
  return "good";
}

function getDisplayTitle(v){
  // ×›×œ×œ: ××•×ª×’ ×‘×¨××©, ×•×× ××™×Ÿ ××•×ª×’ â€“ ×—× ×•×ª (×¨××©×•× ×”)
  var brand = v.brandNameSnap || getBrandName(v.brandId) || "";
  var storesSnap = Array.isArray(v.storeNamesSnap) ? v.storeNamesSnap : [];
  if(brand) return brand;
  if(storesSnap.length) return storesSnap[0];
  // fallback - ×—× ×•×ª ×œ×¤×™ ID
  if(Array.isArray(v.storeIds) && v.storeIds.length) return getStoreName(v.storeIds[0]);
  return "×©×•×‘×¨";
}

function getDisplayStoresLine(v){
  // ×× allNetwork ×•××™×Ÿ ×—× ×•×™×•×ª ×©×¡×•×× ×• -> ×œ×”×¦×™×’ â€œ×›×œ ×”×¨×©×ªâ€
  var allNet = !!v.allNetwork;
  var storesSnap = Array.isArray(v.storeNamesSnap) ? v.storeNamesSnap : [];
  var list = storesSnap.slice();

  if(allNet && list.length===0){
    return "×›×œ ×”×¨×©×ª";
  }

  // 2 ×—× ×•×™×•×ª + "+"
  if(list.length===0 && Array.isArray(v.storeIds) && v.storeIds.length){
    list = v.storeIds.map(getStoreName).filter(Boolean);
  }

  if(list.length<=2) return list.join(" Â· ") || (allNet ? "×›×œ ×”×¨×©×ª" : "â€”");
  return list.slice(0,2).join(" Â· ") + " +";
}

function getDisplayMeta(v){
  var parts = [];
  // ×ª×•×§×£
  if(v.expiry) parts.push("×ª×•×§×£: " + fmtILDate(v.expiry));
  // ×™×ª×¨×”
  var rem = voucherRemaining(v);
  if(rem != null){
    parts.push("×™×ª×¨×”: " + rem.toFixed(2).replace(/\.00$/,"") + "â‚ª");
  }
  // ×¤×™×–×™
  if(v.physical) parts.push("×›×¨×˜×™×¡ ×¤×™×–×™");
  return parts.join(" Â· ");
}

function matchesText(v, q){
  if(!q) return true;
  q = q.toLowerCase();

  var brand = (v.brandNameSnap || getBrandName(v.brandId) || "").toLowerCase();
  var storesLine = (Array.isArray(v.storeNamesSnap) ? v.storeNamesSnap.join(" ") : "").toLowerCase();
  var catsLine = (Array.isArray(v.catNamesSnap) ? v.catNamesSnap.join(" ") : "").toLowerCase();
  var notes = String(v.notes||"").toLowerCase();

  return brand.indexOf(q)>=0 || storesLine.indexOf(q)>=0 || catsLine.indexOf(q)>=0 || notes.indexOf(q)>=0;
}

function matchesFilters(v, where){
  var f = filters[where];

  if(f.top==="exp"){
    if(!(isExpiringSoon(v))) return false;
  }

  if(f.cats.length){
    // match by snapshot names OR ids
    var ids = Array.isArray(v.categoryIds) ? v.categoryIds : [];
    var ok = ids.some(function(id){ return f.cats.indexOf(id)>=0; });
    if(!ok) return false;
  }

  if(f.brands.length){
    var bid = v.brandId || "";
    if(f.brands.indexOf(bid) < 0) return false;
  }

  if(f.stores.length){
    var sids = Array.isArray(v.storeIds) ? v.storeIds : [];
    var ok2 = sids.some(function(id){ return f.stores.indexOf(id)>=0; });
    if(!ok2) return false;
  }

  return true;
}

function sortVouchers(list, where){
  var f = filters[where];

  // brand frequency for active sorting rule: more frequent brand first
  var brandCount = {};
  vouchers.forEach(function(v){
    if(v.archived) return;
    var key = v.brandId || (v.brandNameSnap||"") || "";
    if(!key) return;
    brandCount[key] = (brandCount[key]||0) + 1;
  });

  function primaryCompare(a,b){
    // ×›×œ×œ ×¢×•×§×£: ×§×¨×•×‘ ×œ×¤×§×™×¢×” ×œ××¢×œ×” (×× ×œ× ×‘××¨×›×™×•×Ÿ)
    var ae = (!a.archived && isExpiringSoon(a)) ? 1 : 0;
    var be = (!b.archived && isExpiringSoon(b)) ? 1 : 0;
    if(be!==ae) return be-ae;

    // ××—×¨ ×›×š ×œ×¤×™ ×©×›×™×—×•×ª ××•×ª×’ (×¨×§ ×¤×¢×™×œ×™×)
    var ak = a.brandId || (a.brandNameSnap||"") || "";
    var bk = b.brandId || (b.brandNameSnap||"") || "";
    var ac = brandCount[ak] || 0;
    var bc = brandCount[bk] || 0;
    if(bc!==ac) return bc-ac;

    // ××—×¨ ×›×š ×œ×¤×™ ×™×ª×¨×”
    var ar = voucherRemaining(a);
    var br = voucherRemaining(b);
    ar = (ar==null ? -1 : ar);
    br = (br==null ? -1 : br);
    if(br!==ar) return br-ar;

    // ×©×
    return getDisplayTitle(a).localeCompare(getDisplayTitle(b),"he");
  }

  function sortByExp(a,b){
    var ae = a.expiry ? a.expiry : "9999-12-31";
    var be = b.expiry ? b.expiry : "9999-12-31";
    if(ae!==be) return ae.localeCompare(be);
    return primaryCompare(a,b);
  }

  function sortByName(a,b){
    var an = getDisplayTitle(a);
    var bn = getDisplayTitle(b);
    var c = an.localeCompare(bn,"he");
    if(c!==0) return c;
    return primaryCompare(a,b);
  }

  function sortByAmount(a,b){
    var ar = voucherRemaining(a); ar = (ar==null ? -1 : ar);
    var br = voucherRemaining(b); br = (br==null ? -1 : br);
    if(br!==ar) return br-ar;
    return primaryCompare(a,b);
  }

  if(f.sort==="exp") return list.sort(sortByExp);
  if(f.sort==="name") return list.sort(sortByName);
  if(f.sort==="amount") return list.sort(sortByAmount);
  return list.sort(primaryCompare);
}

function renderVouchers(){
  autoArchiveRules();

  // active
  var qA = (document.getElementById("searchActive").value || "").trim();
  var act = vouchers.filter(function(v){ return !v.archived; })
    .filter(function(v){ return matchesText(v,qA); })
    .filter(function(v){ return matchesFilters(v,"active"); });

  act = sortVouchers(act, "active");

  var hostA = document.getElementById("activeList");
  hostA.innerHTML = "";
  if(!act.length){
    hostA.innerHTML = '<div class="note">××™×Ÿ ×©×•×‘×¨×™× ×œ×”×¦×’×”.</div>';
  } else {
    act.forEach(function(v){
      hostA.appendChild(renderVoucherCard(v));
    });
  }

  // archive
  var qR = (document.getElementById("searchArchive").value || "").trim();
  var arc = vouchers.filter(function(v){ return !!v.archived; })
    .filter(function(v){ return matchesText(v,qR); })
    .filter(function(v){ return matchesFilters(v,"archive"); });

  arc = sortVouchers(arc, "archive");

  var hostR = document.getElementById("archiveList");
  hostR.innerHTML = "";
  if(!arc.length){
    hostR.innerHTML = '<div class="note">××™×Ÿ ×©×•×‘×¨×™× ×‘××¨×›×™×•×Ÿ ×œ×”×¦×’×”.</div>';
  } else {
    arc.forEach(function(v){
      hostR.appendChild(renderVoucherCard(v));
    });
  }
}

function renderVoucherCard(v){
  var status = getVoucherStatus(v);
  var cls = (status==="bad") ? "c-bad" : (status==="warn") ? "c-warn" : (status==="off") ? "c-off" : "c-good";

  var card = document.createElement("div");
  card.className = "voucher";

  var left = document.createElement("div");
  left.className = "voucher-left";

  var iconWrap = document.createElement("div");
  iconWrap.innerHTML = ticketSVG(cls);

  var main = document.createElement("div");
  main.className = "voucher-main";

  var t = document.createElement("div");
  t.className = "voucher-title";
  t.textContent = getDisplayTitle(v);

  var sub = document.createElement("div");
  sub.className = "voucher-sub";
  sub.textContent = getDisplayStoresLine(v);

  var meta = document.createElement("div");
  meta.className = "voucher-meta";
  meta.textContent = getDisplayMeta(v);

  main.appendChild(t);
  main.appendChild(sub);
  main.appendChild(meta);

  left.appendChild(iconWrap);
  left.appendChild(main);

  var btn = document.createElement("button");
  btn.className = "openBtn";
  btn.textContent = "×¤×ª×—";
  btn.onclick = function(){ openVoucherModal(v.id); };

  // ×”××™×™×§×•×Ÿ ×‘×§×¦×” ×©×××œ, ×•×”×›×¤×ª×•×¨ â€œ×¤×ª×—â€ ××™××™×Ÿ ×œ×• (×‘-RTL ×–×” × ×¨××” ×›××• ×©×‘×™×§×©×ª)
  card.appendChild(left);
  card.appendChild(btn);
  return card;
}

/* ========= Render management lists (compact) ========= */
function renderManageLists(){
  // brands
  var bUl = document.getElementById("brandsList");
  bUl.innerHTML = "";
  brands.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(b){
    var li = document.createElement("li");
    li.innerHTML =
      '<span class="compactText">'+escapeHtml(b.name)+'</span>'+
      '<div class="btn-group">'+
        '<button class="iconbtn" type="button" title="×¤×ª×—">â¡ï¸</button>'+
        '<button class="iconbtn" type="button" title="×¢×¨×•×š">âœï¸</button>'+
        '<button class="iconbtn" type="button" title="××—×§">âŒ</button>'+
      '</div>';
    var btns = li.querySelectorAll("button");
    btns[0].onclick = function(){ openBrand(b.id); };
    btns[1].onclick = function(){ editBrand(b.id); };
    btns[2].onclick = function(){ deleteBrand(b.id); };
    bUl.appendChild(li);
  });

  // stores
  var sUl = document.getElementById("storesList");
  sUl.innerHTML = "";
  stores.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(s){
    var li2 = document.createElement("li");
    li2.innerHTML =
      '<span class="compactText">'+escapeHtml(s.name)+'</span>'+
      '<div class="btn-group">'+
        '<button class="iconbtn" type="button" title="×¤×ª×—">â¡ï¸</button>'+
        '<button class="iconbtn" type="button" title="×¢×¨×•×š">âœï¸</button>'+
        '<button class="iconbtn" type="button" title="××—×§">âŒ</button>'+
      '</div>';
    var btns2 = li2.querySelectorAll("button");
    btns2[0].onclick = function(){ openStore(s.id); };
    btns2[1].onclick = function(){ editStore(s.id); };
    btns2[2].onclick = function(){ deleteStore(s.id); };
    sUl.appendChild(li2);
  });

  // cats
  var cUl = document.getElementById("catsList");
  cUl.innerHTML = "";
  categories.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(c){
    var li3 = document.createElement("li");
    li3.innerHTML =
      '<span class="compactText">'+escapeHtml(c.name)+'</span>'+
      '<div class="btn-group">'+
        '<button class="iconbtn" type="button" title="×¢×¨×•×š">âœï¸</button>'+
        '<button class="iconbtn" type="button" title="××—×§">âŒ</button>'+
      '</div>';
    var btns3 = li3.querySelectorAll("button");
    btns3[0].onclick = function(){ editCategory(c.id); };
    btns3[1].onclick = function(){ deleteCategory(c.id); };
    cUl.appendChild(li3);
  });
}

/* ========= Filter chips rendering ========= */
function renderFilterChips(){
  function renderChipList(hostId, items, selectedArr, onToggle){
    var host = document.getElementById(hostId);
    host.innerHTML = "";
    items.forEach(function(it){
      var chip = document.createElement("div");
      chip.className = "chip" + (selectedArr.indexOf(it.id)>=0 ? " selected" : "");
      chip.textContent = it.name;
      chip.onclick = function(){
        var on = chip.classList.contains("selected");
        chip.classList.toggle("selected", !on);
        onToggle(it.id, !on);
      };
      host.appendChild(chip);
    });
  }

  var catItems = categories.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });
  var brandItems = brands.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });
  var storeItems = stores.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });

  // active
  renderChipList("catChipsActive", catItems, filters.active.cats, function(id, on){
    filters.active.cats = toggleIdList(filters.active.cats, id, on); renderVouchers();
  });
  renderChipList("brandChipsActive", brandItems, filters.active.brands, function(id, on){
    filters.active.brands = toggleIdList(filters.active.brands, id, on); renderVouchers();
  });
  renderChipList("storeChipsActive", storeItems, filters.active.stores, function(id, on){
    filters.active.stores = toggleIdList(filters.active.stores, id, on); renderVouchers();
  });

  // archive
  renderChipList("catChipsArchive", catItems, filters.archive.cats, function(id, on){
    filters.archive.cats = toggleIdList(filters.archive.cats, id, on); renderVouchers();
  });
  renderChipList("brandChipsArchive", brandItems, filters.archive.brands, function(id, on){
    filters.archive.brands = toggleIdList(filters.archive.brands, id, on); renderVouchers();
  });
  renderChipList("storeChipsArchive", storeItems, filters.archive.stores, function(id, on){
    filters.archive.stores = toggleIdList(filters.archive.stores, id, on); renderVouchers();
  });
}

/* ========= Backup / Restore ========= */
function backupNow(){
  try{
    var backup = {
      v: 1,
      exportedAt: Date.now(),
      deviceName: DEVICE_NAME,
      meta: getLocalMeta(),
      payload: payload()
    };
    var blob = new Blob([JSON.stringify(backup, null, 2)], { type:"application/json" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = "coupons-backup-" + (new Date().toISOString().slice(0,10)) + ".json";
    a.rel = "noopener";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} }, 1500);
    setSyncMsg("×’×™×‘×•×™ × ×•×¦×¨ âœ…");
  } catch(e){
    alert("×’×™×‘×•×™ × ×›×©×œ");
  }
}
window.backupNow = backupNow;

function triggerRestore(){
  if(!confirm("×˜×¢×™× ×ª ×’×™×‘×•×™ ×ª×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×‘××›×©×™×¨ ×”×–×”. ×œ×”××©×™×š?")) return;
  var inp = document.getElementById("restoreFile");
  inp.value = "";
  inp.click();
}
window.triggerRestore = triggerRestore;

function restoreFromFile(ev){
  try{
    var f = ev && ev.target && ev.target.files && ev.target.files[0];
    if(!f) return;
    var reader = new FileReader();
    reader.onload = function(){
      try{
        var obj = safeJSONParse(reader.result, null);
        if(!obj || !obj.payload) throw new Error("bad");
        applyPayload(obj.payload, obj.meta);
        setSyncMsg("×’×™×‘×•×™ × ×˜×¢×Ÿ âœ…");
      } catch(e){
        alert("×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ");
      }
    };
    reader.readAsText(f);
    ev.target.value = "";
  } catch(e){
    alert("×˜×¢×™× ×ª ×’×™×‘×•×™ × ×›×©×œ×”");
  }
}
window.restoreFromFile = restoreFromFile;

/* ========= Device select (Yanir only) ========= */
function onDeviceChange(){
  var sel = document.getElementById("deviceNameSelect");
  var v = sel.value;
  DEVICE_NAME = v;
  localStorage.setItem("deviceName", v);
  showLocalNoteIfYanir();
  setSyncMsg("××›×©×™×¨: " + DEVICE_NAME);
}
window.onDeviceChange = onDeviceChange;

/* ========= Render All ========= */
function renderAll(){
  // show device card only for Yanir
  var deviceCard = document.getElementById("deviceCard");
  if(DEVICE_NAME === "Yanir"){
    deviceCard.style.display = "block";
    document.getElementById("deviceNameSelect").value = DEVICE_NAME;
  } else {
    deviceCard.style.display = "none";
  }

  renderManageLists();
  renderFilterChips();
  renderVouchers();
  renderSyncLastLine();
  showLocalNoteIfYanir();
}

/* ========= First-run defaults ========= */
// ×× ××™×Ÿ × ×ª×•× ×™× â€“ × ×•×¡×™×£ ×“×•×’×××•×ª ××™× ×™××œ×™×•×ª? ×œ×. × ×©××¨ ×¨×™×§ ×›×“×™ ×œ× ×œ×”×¤×¨×™×¢.
document.getElementById("vExpiry").value = "";
setManageTab("brands");

// init sync status
setSyncMsg("××§×•××™ (" + DEVICE_NAME + ")");
renderAll();
</script>
</body>
</html>
