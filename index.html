<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×§×•×¤×•× ×™× ×•×©×•×‘×¨×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;
      --warn:#b45309;
      --ok:#16a34a;
      --near:#fee2e2;
      --nearText:#991b1b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
      overflow:hidden;
    }
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}

    .view{display:none}
    .view.active{display:block}

    .field{margin-top:10px; min-width:0; overflow:hidden;}
    label{font-weight:900}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff; max-width:100%;
    }
    textarea{min-height:120px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline input{flex:1; min-width:180px}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}
    .ok{background:var(--ok); color:#fff}
    .warnbtn{background:#fffbeb; color:var(--warn); border:1px solid #fed7aa}

    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      font-weight:900; line-height:1; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      min-width:40px;
    }

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    .filters{
      display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; margin:8px 0 10px;
    }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      padding:7px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      cursor:pointer;
      flex:0 0 auto;
    }
    .chip.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .chip.soft{background:#f8fafc}
    .chip.warn{background:#fffbeb;border-color:#fed7aa;color:#b45309}
    .chip.warn.active{background:#f59e0b; color:#111827; border-color:#f59e0b;}

    .searchrow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .searchrow input{flex:1; min-width:200px}
    .small{
      font-size:12px; color:var(--muted); font-weight:900;
    }

    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    li span{flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .btn-group{display:flex; gap:8px; align-items:center; flex:0 0 auto}

    /* Voucher cards list */
    .vcard{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:10px;
      margin-bottom:10px;
      overflow:hidden;
    }
    .vhead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:8px;
    }
    .vtitle{
      font-weight:900;
      font-size:16px;
      line-height:1.2;
    }
    .vsub{
      margin-top:4px;
      font-size:13px;
      color:#374151;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:100%;
    }
    .badges{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;}
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:5px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--border);
      background:var(--pill);
      white-space:nowrap;
    }
    .badge.near{background:var(--near); color:var(--nearText); border-color:#fecaca;}
    .badge.arch{background:#f1f5f9; color:#334155}
    .badge.phys{background:#ecfeff; color:#155e75; border-color:#a5f3fc;}
    .badge.type{background:#eef2ff; color:#1e40af; border-color:#c7d2fe;}
    .badge.cat{background:#f0fdf4; color:#166534; border-color:#bbf7d0;}

    .vrow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-top:1px dashed var(--border);
      align-items:center;
    }
    .vrow:first-child{border-top:none}
    .vrow b{white-space:nowrap}
    .vrow span{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; color:#374151; font-weight:900;}

    /* Modals */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:760px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
      max-height:86vh;
      overflow:auto;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      position:sticky;
      top:0;
      background:#fff;
      padding-bottom:8px;
      border-bottom:1px solid var(--border);
      z-index:2;
    }
    .modal-title{font-weight:900;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tiny{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .tiny.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    .tiny.danger{background:var(--danger); color:#fff; border-color:var(--danger)}
    .tiny.ok{background:var(--ok); color:#fff; border-color:var(--ok)}
    .tiny.ghost{background:#eef2ff; color:#1e40af; border-color:#c7d2fe}

    .pickerList{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .pickItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .pickItem small{color:var(--muted); font-weight:900}
    .pickItem.active{border-color:var(--primary); box-shadow:0 0 0 2px rgba(37,99,235,0.15)}
    .pickItem .right{display:flex; gap:8px; align-items:center}

    @media(min-width:700px){ body{max-width:900px;margin:auto} }
  </style>
</head>

<body>
<h1>ğŸŸï¸ ×§×•×¤×•× ×™× ×•×©×•×‘×¨×™×</h1>

<div class="tabs">
  <button class="tabbtn active" type="button" onclick="showTab('active')">×¤×¢×™×œ×™×</button>
  <button class="tabbtn" type="button" onclick="showTab('archive')">××¨×›×™×•×Ÿ</button>
  <button class="tabbtn" type="button" onclick="showTab('manage')">× ×™×”×•×œ</button>
  <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
</div>

<!-- ×¤×¢×™×œ×™× -->
<section id="view-active" class="view active">

  <!-- ×›×¤×ª×•×¨ ×”×•×¡×¤×” (×‘×•×¢×” × ×¤×¨×“×ª ××¢×œ ×”×—×™×¤×•×©) -->
  <section class="card">
    <div class="inline" style="justify-content:space-between;">
      <div style="font-weight:900;">××” ×¢×•×©×™×?</div>
      <button class="btn ok" type="button" onclick="openVoucherModal(null)">â• ×”×•×¡×£ ×©×•×‘×¨</button>
    </div>
    <div class="note">×˜×™×¤: ×× ×©×•×‘×¨ ×§×¨×•×‘ ×œ×¤×§×™×¢×” (â‰¤ 3 ×—×•×“×©×™×) ×”×•× ×™×§×¤×•×¥ ×œ×¨××© ×•×™×§×‘×œ ×¡×™××•×Ÿ.</div>
  </section>

  <section class="card">
    <h2>×—×™×¤×•×© ×•×¡×™× ×•×Ÿ</h2>

    <div class="searchrow">
      <input id="searchInputActive" placeholder="×—×™×¤×•×© ×œ×¤×™ ××•×ª×’ / ×—× ×•×ª / ×˜×§×¡×˜ ×—×•×¤×©×™..." oninput="renderActive()">
      <select id="sortActive" onchange="renderActive()">
        <option value="smart" selected>××™×•×Ÿ ×—×›× (×¤×§×™×¢×”/×ª×“×™×¨×•×ª/×™×ª×¨×”/×-×‘)</option>
        <option value="expiry">×ª×•×§×£ ×”×›×™ ×§×¨×•×‘</option>
        <option value="brand">××•×ª×’ ×-×‘</option>
        <option value="amount">×™×ª×¨×” ×”×›×™ ×’×‘×•×”×”</option>
      </select>
    </div>

    <!-- ×©×•×¨×” 1: ×”×›×œ / ×§×¨×•×‘ ×œ×¤×§×™×¢×” -->
    <div class="filters" id="rowTopActive"></div>

    <!-- ×©×•×¨×” 2: ×§×˜×’×•×¨×™×•×ª -->
    <div class="small">×§×˜×’×•×¨×™×•×ª</div>
    <div class="filters" id="rowCatsActive"></div>

    <!-- ×©×•×¨×” 3: ××•×ª×’×™× -->
    <div class="small">××•×ª×’×™×</div>
    <div class="filters" id="rowBrandsActive"></div>

    <!-- ×©×•×¨×” 4: ×—× ×•×™×•×ª -->
    <div class="small">×—× ×•×™×•×ª</div>
    <div class="filters" id="rowStoresActive"></div>

    <div id="activeList" style="margin-top:10px;"></div>
  </section>
</section>

<!-- ××¨×›×™×•×Ÿ -->
<section id="view-archive" class="view">
  <section class="card">
    <h2>××¨×›×™×•×Ÿ</h2>

    <div class="searchrow">
      <input id="searchInputArchive" placeholder="×—×™×¤×•×© ×‘××¨×›×™×•×Ÿ ×œ×¤×™ ××•×ª×’ / ×—× ×•×ª / ×˜×§×¡×˜..." oninput="renderArchive()">
      <select id="sortArchive" onchange="renderArchive()">
        <option value="smart" selected>××™×•×Ÿ ×—×›×</option>
        <option value="expiry">×ª×•×§×£ ×”×›×™ ×§×¨×•×‘</option>
        <option value="brand">××•×ª×’ ×-×‘</option>
        <option value="amount">×™×ª×¨×” ×”×›×™ ×’×‘×•×”×”</option>
      </select>
    </div>

    <div class="filters" id="rowTopArchive"></div>

    <div class="small">×§×˜×’×•×¨×™×•×ª</div>
    <div class="filters" id="rowCatsArchive"></div>

    <div class="small">××•×ª×’×™×</div>
    <div class="filters" id="rowBrandsArchive"></div>

    <div class="small">×—× ×•×™×•×ª</div>
    <div class="filters" id="rowStoresArchive"></div>

    <div id="archiveList" style="margin-top:10px;"></div>
  </section>
</section>

<!-- × ×™×”×•×œ -->
<section id="view-manage" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ</h2>

    <div class="filters" id="manageTabs"></div>

    <!-- ××•×ª×’×™× -->
    <div id="manageBrands" style="display:none;">
      <div class="inline">
        <input id="newBrandName" placeholder="×©× ××•×ª×’/×¨×©×ª">
        <button class="btn primary" type="button" onclick="addBrand()">×”×•×¡×£</button>
      </div>
      <div class="note">××—×™×§×” ×›××Ÿ ×œ× ××•×—×§×ª ×©×•×‘×¨×™× ×§×™×™××™× â€” ×¨×§ ××©×‘×™×ª×” ××ª ×”×©×.</div>
      <ul id="brandsList"></ul>
    </div>

    <!-- ×—× ×•×™×•×ª -->
    <div id="manageStores" style="display:none;">
      <div class="inline">
        <input id="newStoreName" placeholder="×©× ×—× ×•×ª">
        <button class="btn primary" type="button" onclick="addStore()">×”×•×¡×£</button>
      </div>
      <div class="note">××¤×©×¨ ×œ×©×™×™×š ×—× ×•×ª ×œ×›××” ××•×ª×’×™× + ×œ×§×˜×’×•×¨×™×•×ª.</div>
      <ul id="storesList"></ul>
    </div>

    <!-- ×§×˜×’×•×¨×™×•×ª -->
    <div id="manageCats" style="display:none;">
      <div class="inline">
        <input id="newCatName" placeholder="×©× ×§×˜×’×•×¨×™×” (×œ××©×œ: ××•×¤× ×”, ××¡×¢×“×•×ª...)">
        <button class="btn primary" type="button" onclick="addCategory()">×”×•×¡×£</button>
      </div>
      <div class="note">××—×™×§×” = ×”×©×‘×ª×” ×‘×œ×‘×“ (×œ× ××•×—×§ ×”×™×¡×˜×•×¨×™×”).</div>
      <ul id="catsList"></ul>
    </div>
  </section>
</section>

<!-- × ×ª×•× ×™× -->
<section id="view-data" class="view">
  <section class="card">
    <h2>ğŸ”„ ×¡× ×›×¨×•×Ÿ</h2>
    <div class="note" id="syncStatusLine"></div>
    <div class="note" id="syncLastLine"></div>

    <div class="inline" style="margin-top:10px;">
      <button class="btn ghost" type="button" onclick="syncPullNow()">××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ</button>
      <button class="btn ghost" type="button" onclick="syncPushNow()">×©×œ×— × ×ª×•× ×™× ×œ×¢× ×Ÿ</button>
      <button class="btn ghost" type="button" onclick="backupNow()">×’×™×‘×•×™ ×œ×§×•×‘×¥</button>
      <button class="btn ghost" type="button" onclick="triggerRestore()">×˜×¢×™× ×ª ×’×™×‘×•×™</button>
    </div>
    <input id="restoreFile" type="file" accept=".json,application/json" style="display:none" onchange="restoreFromFile(event)">
    <div class="note" id="syncLocalNote" style="display:none; margin-top:10px;"></div>
  </section>

  <!-- â€œ×”×’×“×¨×•×ª ××›×©×™×¨â€ ×¨×§ ××¦×œ Yanir -->
  <section class="card" id="deviceCard" style="display:none;">
    <h2>âš™ï¸ ×–×”×•×ª ××›×©×™×¨ (×¨×§ ×œ×¡× ×›×¨×•×Ÿ)</h2>
    <div class="note">××©××© ×¨×§ ×›×“×™ ×œ×–×”×•×ª ××™ ×¢×“×›×Ÿ ××—×¨×•×Ÿ ×•×œ×©××•×¨ â€œYanir ×× ×¦×—â€ ×›×‘×¨×™×¨×ª ××—×“×œ.</div>
    <div class="field">
      <label>×©× ××›×©×™×¨</label>
      <select id="deviceNameSelect" onchange="saveDeviceName()">
        <option value="Yanir">Yanir</option>
        <option value="×©×™×¨×œ×™">×©×™×¨×œ×™</option>
      </select>
    </div>
  </section>

  <section class="card">
    <h2>××™×¤×•×¡</h2>
    <div class="note">××•×—×§ ×”×›×œ ××”××›×©×™×¨ (××•××œ×¥ ×œ×‘×¦×¢ ×’×™×‘×•×™ ×œ×¤× ×™).</div>
    <button class="btn danger" type="button" onclick="resetAll()">××™×¤×•×¡ ××œ×</button>
  </section>
</section>

<!-- ===== Voucher modal (Add/Edit) ===== -->
<div id="voucherBackdrop" class="modal-backdrop" onclick="closeVoucherModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="voucherModalTitle">â• ×©×•×‘×¨ ×—×“×©</div>
      <div class="modal-actions">
        <button class="tiny primary" type="button" onclick="saveVoucher()">×©××™×¨×”</button>
        <button class="tiny" type="button" onclick="hideVoucherModal()">×¡×’×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>×¡×•×’ ×©×•×‘×¨</label>
      <select id="vType" onchange="renderVoucherTypeFields()">
        <option value="×›×¡×¤×™">×›×¡×¤×™</option>
        <option value="××—×•×–">××—×•×–</option>
        <option value="1+1">1+1</option>
        <option value="×›×œ×œ×™" selected>×›×œ×œ×™</option>
      </select>
      <div class="note">×× ×—×¡×¨ ×¡×•×’ â€œ×§×¨×™×˜×™â€ ×‘×¢×ª×™×“ â€” × ×•×¡×™×£ ××¡×š ×™×™×¢×•×“×™.</div>
    </div>

    <div class="field">
      <label>×ª×§×£ ×¢×‘×•×¨</label>
      <select id="vScope" onchange="renderVoucherScopeFields()">
        <option value="all" selected>×›×œ ×”×¨×©×ª</option>
        <option value="stores">×—× ×•×™×•×ª ××¡×•×™××•×ª</option>
      </select>
    </div>

    <!-- ×‘×—×™×¨×ª ××•×ª×’ (×›×¤×ª×•×¨ -> ××¡×š ×’×œ×™×œ×”) -->
    <div class="field">
      <label>××•×ª×’/×¨×©×ª</label>
      <div class="inline">
        <button class="btn ghost" type="button" onclick="openPicker('brand', false)">×‘×—×¨ ××•×ª×’</button>
        <button class="btn ghost" type="button" onclick="openQuickAdd('brand')">+ ××•×ª×’ ×—×“×©</button>
      </div>
      <div class="note" id="brandChosenNote">×œ× × ×‘×—×¨</div>
    </div>

    <!-- ×—× ×•×™×•×ª ×ª×§×¤×•×ª (multi, ×›×¤×ª×•×¨ -> ××¡×š ×’×œ×™×œ×”) -->
    <div class="field">
      <label>×—× ×•×™×•×ª ×ª×§×¤×•×ª</label>
      <div class="inline">
        <button class="btn ghost" type="button" onclick="openPicker('stores', true)">×‘×—×¨ ×—× ×•×™×•×ª</button>
        <button class="btn ghost" type="button" onclick="openQuickAdd('store')">+ ×—× ×•×ª ×—×“×©×”</button>
      </div>
      <div class="note" id="storesChosenNote">×œ× × ×‘×—×¨×•</div>
    </div>

    <!-- ×§×˜×’×•×¨×™×•×ª (multi) -->
    <div class="field">
      <label>×§×˜×’×•×¨×™×•×ª</label>
      <div class="inline">
        <button class="btn ghost" type="button" onclick="openPicker('cats', true)">×‘×—×¨ ×§×˜×’×•×¨×™×•×ª</button>
        <button class="btn ghost" type="button" onclick="openQuickAdd('cat')">+ ×§×˜×’×•×¨×™×” ×—×“×©×”</button>
      </div>
      <div class="note" id="catsChosenNote">×œ× × ×‘×—×¨×•</div>
    </div>

    <div class="field">
      <label>×›×¨×˜×™×¡ ×¤×™×–×™</label>
      <select id="vPhysical">
        <option value="0" selected>×œ×</option>
        <option value="1">×›×Ÿ</option>
      </select>
    </div>

    <div class="field">
      <label>×ª×•×§×£ (××•×¤×¦×™×•× ×œ×™)</label>
      <input type="date" id="vExpiry">
    </div>

    <div class="field" id="codeField">
      <label>×§×•×“ (××•×¤×¦×™×•× ×œ×™)</label>
      <input id="vCode" placeholder="×”×“×‘×§/×›×ª×•×‘ ×§×•×“ ×›××Ÿ...">
    </div>

    <!-- ×©×“×•×ª ××©×ª× ×™× ×œ×¤×™ ×¡×•×’ -->
    <div id="typeFields"></div>

    <div class="field">
      <label>×”×¢×¨×•×ª</label>
      <textarea id="vNotes" placeholder="×˜×§×¡×˜ ×—×•×¤×©×™..."></textarea>
    </div>

    <div class="field">
      <button class="btn danger" type="button" onclick="deleteVoucherFromModal()">ğŸ—‘ï¸ ××—×™×§×ª ×©×•×‘×¨</button>
      <div class="note">××—×™×§×” ××•×—×§×ª ××ª ×”×©×•×‘×¨ ×¢×¦××• (×œ× ×¨×§ ××¢×‘×™×¨×” ×œ××¨×›×™×•×Ÿ).</div>
    </div>
  </div>
</div>

<!-- ===== View voucher modal (Open) ===== -->
<div id="viewBackdrop" class="modal-backdrop" onclick="closeViewModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="viewTitle">×©×•×‘×¨</div>
      <div class="modal-actions">
        <button class="tiny ghost" type="button" onclick="copyCode()">×”×¢×ª×§ ×§×•×“</button>
        <button class="tiny" type="button" onclick="openEditFromView()">×¢×¨×™×›×”</button>
        <button class="tiny ok" type="button" onclick="toggleArchiveFromView()">×”×¢×‘×¨/×”×—×–×¨ ××¨×›×™×•×Ÿ</button>
        <button class="tiny danger" type="button" onclick="deleteVoucherFromView()">××—×™×§×”</button>
        <button class="tiny" type="button" onclick="hideViewModal()">×¡×’×•×¨</button>
      </div>
    </div>
    <div id="viewBody"></div>
  </div>
</div>

<!-- ===== Picker modal ===== -->
<div id="pickerBackdrop" class="modal-backdrop" onclick="closePickerModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="pickerTitle">×‘×—×™×¨×”</div>
      <div class="modal-actions">
        <button class="tiny primary" type="button" onclick="pickerApply()">××™×©×•×¨</button>
        <button class="tiny" type="button" onclick="hidePicker()">×¡×’×•×¨</button>
      </div>
    </div>
    <div class="field">
      <label>×—×™×¤×•×©</label>
      <input id="pickerSearch" placeholder="×—×¤×©..." oninput="renderPickerList()">
    </div>
    <div class="pickerList" id="pickerList"></div>
  </div>
</div>

<!-- ===== Brand detail modal (manage) ===== -->
<div id="brandDetailBackdrop" class="modal-backdrop" onclick="closeBrandDetail(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="brandDetailTitle">××•×ª×’</div>
      <div class="modal-actions">
        <button class="tiny" type="button" onclick="hideBrandDetail()">×¡×’×•×¨</button>
      </div>
    </div>
    <div id="brandDetailBody"></div>
  </div>
</div>

<!-- ===== Store detail modal (manage) ===== -->
<div id="storeDetailBackdrop" class="modal-backdrop" onclick="closeStoreDetail(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="storeDetailTitle">×—× ×•×ª</div>
      <div class="modal-actions">
        <button class="tiny" type="button" onclick="hideStoreDetail()">×¡×’×•×¨</button>
      </div>
    </div>
    <div id="storeDetailBody"></div>
  </div>
</div>

<script>
  // ===== Service Worker registration =====
  (function(){
    if (!("serviceWorker" in navigator)) return;
    navigator.serviceWorker.register("./sw.js").catch(function(){});
  })();

  // ===== Sync config =====
  var __isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

  // âš ï¸ ×©×™× ×›××Ÿ ××ª ×”-URL ×©×œ ×”-Apps Script ×©×œ×š
  var SYNC_URL = "PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE";
  // âš ï¸ ×˜×•×§×Ÿ â€” ×–×”×” ×’× ×‘-Apps Script
  var SYNC_TOKEN = "CUPN_7f3a9c2e_YANIR_MASTER_2026";

  var DEVICE_NAME = (function(){
    var saved = localStorage.getItem("deviceName");
    if(saved) return saved;
    var guess = __isIOS ? "×©×™×¨×œ×™" : "Yanir";
    localStorage.setItem("deviceName", guess);
    return guess;
  })();

  var META_KEY = "cloudMeta";
  var LAST_SYNC_AT_KEY = "lastSyncAt";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtDateTime(ms){
    if(!ms) return "";
    var d = new Date(ms);
    return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate()) + " " + pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  }
  function setLastSyncNow(){
    var now = Date.now();
    localStorage.setItem(LAST_SYNC_AT_KEY, String(now));
    renderSyncLastLine();
  }
  function renderSyncLastLine(){
    var el = document.getElementById("syncLastLine");
    if(!el) return;
    var v = Number(localStorage.getItem(LAST_SYNC_AT_KEY) || "0");
    el.textContent = v ? ("×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: " + fmtDateTime(v)) : "×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: â€”";
  }
  function setSyncMsg(msg){
    var el = document.getElementById("syncStatusLine");
    if(el) el.textContent = msg || "";
  }
  function safeJSONParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }
  function getLocalMeta(){
    return safeJSONParse(localStorage.getItem(META_KEY) || "null", { updatedAt:0, updatedBy:"" });
  }
  function setLocalMeta(meta){
    localStorage.setItem(META_KEY, JSON.stringify(meta || { updatedAt:0, updatedBy:"" }));
  }
  function doFetchJSON(url){
    return fetch(url, { cache:"no-store" }).then(function(r){ return r.json(); });
  }

  function localPayload(){
    return {
      brands: safeJSONParse(localStorage.getItem("brands") || "[]", []),
      stores: safeJSONParse(localStorage.getItem("stores") || "[]", []),
      categories: safeJSONParse(localStorage.getItem("categories") || "[]", []),
      vouchers: safeJSONParse(localStorage.getItem("vouchers") || "[]", []),
      linksBrandStores: safeJSONParse(localStorage.getItem("linksBrandStores") || "[]", []), // {brandId, storeId}
      storeCats: safeJSONParse(localStorage.getItem("storeCats") || "[]", []) // {storeId, catId}
    };
  }

  function applyRemote(remote, meta){
    localStorage.setItem("brands", JSON.stringify(remote.brands || []));
    localStorage.setItem("stores", JSON.stringify(remote.stores || []));
    localStorage.setItem("categories", JSON.stringify(remote.categories || []));
    localStorage.setItem("vouchers", JSON.stringify(remote.vouchers || []));
    localStorage.setItem("linksBrandStores", JSON.stringify(remote.linksBrandStores || []));
    localStorage.setItem("storeCats", JSON.stringify(remote.storeCats || []));
    setLocalMeta(meta || { updatedAt:0, updatedBy:"" });

    loadAll();
    renderAll();
  }

  function syncPullNow(){
    setSyncMsg("×˜×•×¢×Ÿ ××”×¢× ×Ÿ...");
    doFetchJSON(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN))
      .then(function(j){
        if(!j || !j.ok) throw new Error("bad");
        if(!j.data){
          setSyncMsg("××™×Ÿ × ×ª×•× ×™× ×‘×¢× ×Ÿ");
          renderSyncLastLine();
          return;
        }
        var remote = safeJSONParse(j.data, null);
        if(!remote) throw new Error("bad json");
        applyRemote(remote, j.meta);
        setSyncMsg("× ×˜×¢×Ÿ ××”×¢× ×Ÿ âœ…");
        setLastSyncNow();
      })
      .catch(function(){
        setSyncMsg("×˜×¢×™× ×” ××”×¢× ×Ÿ × ×›×©×œ×” âŒ");
        renderSyncLastLine();
      });
  }
  window.syncPullNow = syncPullNow;

  function syncPushNow(){
    try{
      setSyncMsg("×©×•×œ×— ×œ×¢× ×Ÿ...");
      var payloadStr = JSON.stringify(localPayload());
      var url = SYNC_URL
        + "?token=" + encodeURIComponent(SYNC_TOKEN)
        + "&write=1"
        + "&by=" + encodeURIComponent(DEVICE_NAME)
        + "&data=" + encodeURIComponent(payloadStr);
      doFetchJSON(url).then(function(w){
        if(w && w.ok){
          setLocalMeta(w.meta || getLocalMeta());
          setSyncMsg("× ×©×œ×— ×œ×¢× ×Ÿ âœ…");
          setLastSyncNow();
        } else {
          setSyncMsg("×©×œ×™×—×” × ×›×©×œ×” âŒ");
        }
      }).catch(function(){
        setSyncMsg("×©×œ×™×—×” × ×›×©×œ×” âŒ");
      });
    } catch(e){
      setSyncMsg("×©×œ×™×—×” × ×›×©×œ×” âŒ");
    }
  }
  window.syncPushNow = syncPushNow;

  function showLocalNoteIfYanir(){
    var el = document.getElementById("syncLocalNote");
    if(!el) return;
    if(DEVICE_NAME === "Yanir"){
      el.style.display = "block";
      el.textContent = "×”×¢×¨×” (×¨×§ ××¦×œ×š): ×× ××ª×” ×œ× ×¨×•××” ×¢×“×›×•× ×™× â€” ×œ×—×¥ '××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ'.";
    } else {
      el.style.display = "none";
    }
  }

  function maybeShowDeviceCard(){
    var card = document.getElementById("deviceCard");
    if(!card) return;
    if(DEVICE_NAME === "Yanir"){
      card.style.display = "block";
      var sel = document.getElementById("deviceNameSelect");
      if(sel) sel.value = DEVICE_NAME;
    } else {
      card.style.display = "none";
    }
  }

  function saveDeviceName(){
    var sel = document.getElementById("deviceNameSelect");
    if(!sel) return;
    DEVICE_NAME = sel.value;
    localStorage.setItem("deviceName", DEVICE_NAME);
    showLocalNoteIfYanir();
    maybeShowDeviceCard();
  }
  window.saveDeviceName = saveDeviceName;

  // ===== Backup/restore =====
  function backupNow(){
    try{
      var backup = {
        v: 1,
        exportedAt: Date.now(),
        deviceName: DEVICE_NAME,
        meta: getLocalMeta(),
        payload: localPayload()
      };
      var blob = new Blob([JSON.stringify(backup, null, 2)], { type:"application/json" });
      var url = URL.createObjectURL(blob);

      var a = document.createElement("a");
      a.href = url;
      a.download = "coupons-backup-" + (new Date().toISOString().slice(0,10)) + ".json";
      a.rel = "noopener";
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} }, 1500);
      setSyncMsg("×’×™×‘×•×™ × ×•×¦×¨ âœ…");
    } catch(e){
      alert("×’×™×‘×•×™ × ×›×©×œ");
    }
  }
  window.backupNow = backupNow;

  function triggerRestore(){
    if(!confirm("×˜×¢×™× ×ª ×’×™×‘×•×™ ×ª×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×‘××›×©×™×¨ ×”×–×”. ×œ×”××©×™×š?")) return;
    var inp = document.getElementById("restoreFile");
    if(!inp) return;
    inp.value = "";
    inp.click();
  }
  window.triggerRestore = triggerRestore;

  function restoreFromFile(ev){
    try{
      var f = ev && ev.target && ev.target.files && ev.target.files[0];
      if(!f) return;

      var reader = new FileReader();
      reader.onload = function(){
        try{
          var obj = safeJSONParse(reader.result, null);
          if(!obj || !obj.payload) throw new Error("bad");

          var p = obj.payload || {};
          localStorage.setItem("brands", JSON.stringify(p.brands || []));
          localStorage.setItem("stores", JSON.stringify(p.stores || []));
          localStorage.setItem("categories", JSON.stringify(p.categories || []));
          localStorage.setItem("vouchers", JSON.stringify(p.vouchers || []));
          localStorage.setItem("linksBrandStores", JSON.stringify(p.linksBrandStores || []));
          localStorage.setItem("storeCats", JSON.stringify(p.storeCats || []));
          if(obj.meta) setLocalMeta(obj.meta);

          loadAll();
          renderAll();
          setSyncMsg("×’×™×‘×•×™ × ×˜×¢×Ÿ âœ…");
        } catch(e){
          alert("×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ");
        }
      };
      reader.readAsText(f);
      ev.target.value = "";
    } catch(e){
      alert("×˜×¢×™× ×ª ×’×™×‘×•×™ × ×›×©×œ×”");
    }
  }
  window.restoreFromFile = restoreFromFile;

  // ===== Data model =====
  function uid(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function parseISO(iso){
    if(!iso) return 0;
    var t = Date.parse(iso + "T00:00:00");
    return isNaN(t) ? 0 : t;
  }
  function monthsFromNow(n){
    var d = new Date();
    d.setMonth(d.getMonth() + n);
    return d.getTime();
  }
  var NEAR_MS = (function(){
    // 3 ×—×•×“×©×™× ×‘×§×™×¨×•×‘ (×œ× ×¦×¨×™×š ×“×™×•×§ ×©×œ ×™××™×)
    var now = new Date();
    var d = new Date(now.getFullYear(), now.getMonth()+3, now.getDate());
    return d.getTime();
  })();

  // Soft delete: item {id,name,active:true/false,createdAt}
  var brands = [];
  var stores = [];
  var categories = [];
  var vouchers = [];
  var linksBrandStores = []; // {brandId, storeId}
  var storeCats = []; // {storeId, catId}

  function loadAll(){
    brands = safeJSONParse(localStorage.getItem("brands") || "[]", []);
    stores = safeJSONParse(localStorage.getItem("stores") || "[]", []);
    categories = safeJSONParse(localStorage.getItem("categories") || "[]", []);
    vouchers = safeJSONParse(localStorage.getItem("vouchers") || "[]", []);
    linksBrandStores = safeJSONParse(localStorage.getItem("linksBrandStores") || "[]", []);
    storeCats = safeJSONParse(localStorage.getItem("storeCats") || "[]", []);

    // defaults minimal
    if(!brands.length && !stores.length && !categories.length && !vouchers.length){
      // ××ª×—×™×œ×™× × ×§×™ â€” ×‘×œ×™ ×“×•×’×× "×§×¡×˜×¨×•" (×‘×™×§×©×ª ×œ××—×•×§)
      categories = [
        {id:uid(), name:"××•×¤× ×”", active:true, createdAt:Date.now()},
        {id:uid(), name:"××¡×¢×“×•×ª", active:true, createdAt:Date.now()}
      ];
      saveAll();
    }

    autoArchiveSweep();
  }

  function saveAll(){
    localStorage.setItem("brands", JSON.stringify(brands));
    localStorage.setItem("stores", JSON.stringify(stores));
    localStorage.setItem("categories", JSON.stringify(categories));
    localStorage.setItem("vouchers", JSON.stringify(vouchers));
    localStorage.setItem("linksBrandStores", JSON.stringify(linksBrandStores));
    localStorage.setItem("storeCats", JSON.stringify(storeCats));
  }

  function nameById(arr, id){
    for(var i=0;i<arr.length;i++) if(arr[i].id===id) return arr[i].name;
    return "";
  }

  function isActiveById(arr, id){
    for(var i=0;i<arr.length;i++) if(arr[i].id===id) return !!arr[i].active;
    return false;
  }

  function activeItems(arr){
    return arr.filter(function(x){ return x && x.active; });
  }

  function normalizeText(s){
    return String(s||"").trim().toLowerCase();
  }

  // Voucher schema:
  // {id, createdAt, updatedAt, updatedBy, type, scope("all"/"stores"), brandId|null, storeIds[], catIds[], physical(0/1), expiryISO, code, notes,
  //  moneyValue, moneyUsed, moneyRemain,
  //  percentText, dealText,
  //  archived(true/false), archivedReason("manual"/"zero"/"expired")}
  function emptyVoucher(){
    return {
      id: uid(),
      createdAt: Date.now(),
      updatedAt: Date.now(),
      updatedBy: DEVICE_NAME,
      type: "×›×œ×œ×™",
      scope: "all",
      brandId: "",
      storeIds: [],
      catIds: [],
      physical: 0,
      expiryISO: "",
      code: "",
      notes: "",
      moneyValue: "",
      moneyUsed: "",
      moneyRemain: "",
      percentText: "",
      dealText: "",
      archived: false,
      archivedReason: ""
    };
  }

  function voucherTitle(v){
    var b = v.brandId ? nameById(brands, v.brandId) : "";
    var ss = (v.storeIds||[]).map(function(id){ return nameById(stores, id); }).filter(Boolean);
    if(b){
      if(v.scope==="stores" && ss.length){
        // ××•×ª×’ ×§×•×“×, ×•××– "×¨×§: ..."
        var first2 = ss.slice(0,2);
        var plus = (ss.length>2) ? (" +" + (ss.length-2)) : "";
        return b + " Â· ×¨×§: " + first2.join(", ") + plus;
      } else {
        // ×›×œ ×”×¨×©×ª: ××•×ª×’ + ×¢×“ 2 ×—× ×•×™×•×ª ×›×ª×–×›×•×¨×ª
        if(ss.length){
          var f2 = ss.slice(0,2);
          var p = (ss.length>2) ? (" +" + (ss.length-2)) : "";
          return b + " Â· " + f2.join(", ") + p;
        }
        return b;
      }
    }
    // ××™×Ÿ ××•×ª×’ -> ×—× ×•×ª
    if(ss.length){
      var s2 = ss.slice(0,2);
      var pl = (ss.length>2) ? (" +" + (ss.length-2)) : "";
      return s2.join(", ") + pl;
    }
    return "×©×•×‘×¨";
  }

  function voucherSearchHaystack(v){
    var parts = [];
    parts.push(voucherTitle(v));
    if(v.brandId) parts.push(nameById(brands, v.brandId));
    (v.storeIds||[]).forEach(function(id){ parts.push(nameById(stores, id)); });
    (v.catIds||[]).forEach(function(id){ parts.push(nameById(categories, id)); });
    parts.push(v.notes||"");
    parts.push(v.code||"");
    parts.push(v.percentText||"");
    parts.push(v.dealText||"");
    return normalizeText(parts.join(" | "));
  }

  function voucherAmountRemain(v){
    var r = Number(v.moneyRemain);
    return isNaN(r) ? 0 : r;
  }

  function voucherExpiryMs(v){
    return parseISO(v.expiryISO);
  }

  function isNearExpiry(v){
    var em = voucherExpiryMs(v);
    if(!em) return false;
    return em <= NEAR_MS && em >= Date.now() - 24*60*60*1000; // ×œ× ××›×¤×ª ×× ×¢×‘×¨ ××ª××•×œ â€” ×›×‘×¨ ×‘××¨×›×™×•×Ÿ/expired
  }

  function isExpired(v){
    var em = voucherExpiryMs(v);
    if(!em) return false;
    // ×¢×‘×¨ ×ª×•×§×£ (×ª××¨×™×š ×œ×¤× ×™ ×”×™×•×)
    var today = parseISO(todayISO());
    return em && em < today;
  }

  function autoArchiveSweep(){
    // ××•×˜×•××˜×™: ×™×ª×¨×” 0 (×‘×©×•×‘×¨ ×›×¡×¤×™) ××• ×¤×’ ×ª×•×§×£
    var changed = false;
    vouchers.forEach(function(v){
      if(v.archived) return;

      if(isExpired(v)){
        v.archived = true;
        v.archivedReason = "expired";
        changed = true;
        return;
      }

      if(v.type==="×›×¡×¤×™"){
        var rem = voucherAmountRemain(v);
        if(rem <= 0 && (String(v.moneyRemain).trim() !== "")){
          v.archived = true;
          v.archivedReason = "zero";
          changed = true;
          return;
        }
      }
    });
    if(changed) saveAll();
  }

  // ===== Tabs =====
  function showTab(key){
    var btns = document.querySelectorAll(".tabbtn");
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
    var views = document.querySelectorAll(".view");
    for(var j=0;j<views.length;j++) views[j].classList.remove("active");

    var idx = 0, viewId = "view-active";
    if(key==="archive"){ idx=1; viewId="view-archive"; }
    else if(key==="manage"){ idx=2; viewId="view-manage"; }
    else if(key==="data"){ idx=3; viewId="view-data"; }

    btns[idx].classList.add("active");
    document.getElementById(viewId).classList.add("active");
  }
  window.showTab = showTab;

  // ===== Filters state =====
  var filterActive = {
    top: "all", // all / near
    catId: "",
    brandId: "",
    storeId: ""
  };
  var filterArchive = {
    top: "all",
    catId: "",
    brandId: "",
    storeId: ""
  };

  function buildTopRow(hostId, state, onChange){
    var host = document.getElementById(hostId);
    host.innerHTML = "";

    var all = document.createElement("div");
    all.className = "chip " + (state.top==="all" ? "active" : "");
    all.textContent = "×”×›×œ";
    all.onclick = function(){ state.top="all"; onChange(); };
    host.appendChild(all);

    var near = document.createElement("div");
    near.className = "chip warn " + (state.top==="near" ? "active" : "");
    near.textContent = "×§×¨×•×‘ ×œ×¤×§×™×¢×”";
    near.onclick = function(){ state.top="near"; onChange(); };
    host.appendChild(near);
  }

  function buildEntityRow(hostId, items, selectedId, placeholder, onPick){
    var host = document.getElementById(hostId);
    host.innerHTML = "";

    var first = document.createElement("div");
    first.className = "chip soft " + (!selectedId ? "active" : "");
    first.textContent = placeholder;
    first.onclick = function(){ onPick(""); };
    host.appendChild(first);

    items.forEach(function(it){
      var chip = document.createElement("div");
      chip.className = "chip " + (selectedId===it.id ? "active" : "");
      chip.textContent = it.name;
      chip.onclick = function(){ onPick(it.id); };
      host.appendChild(chip);
    });
  }

  // ===== Render lists =====
  function brandUsageCounts(vs){
    var map = {};
    vs.forEach(function(v){
      var bid = v.brandId || "";
      if(!bid) return;
      map[bid] = (map[bid]||0)+1;
    });
    return map;
  }

  function smartSort(vs, usageMap){
    return vs.slice().sort(function(a,b){
      // 1) ×§×¨×•×‘ ×œ×¤×§×™×¢×” ×ª××™×“ ×§×•×“× (×× <=3 ×—×•×“×©×™×) â€” ×›×œ×œ ×¢×•×§×£
      var an = isNearExpiry(a) ? 1 : 0;
      var bn = isNearExpiry(b) ? 1 : 0;
      if(bn !== an) return bn - an;

      // 2) ×ª×“×™×¨×•×ª ××•×ª×’ (×™×•×ª×¨ ×—×•×–×¨ ×§×•×“×)
      var au = a.brandId ? (usageMap[a.brandId]||0) : 0;
      var bu = b.brandId ? (usageMap[b.brandId]||0) : 0;
      if(bu !== au) return bu - au;

      // 3) ×™×ª×¨×” (×›×¡×¤×™) ×™×•×¨×“
      var ar = voucherAmountRemain(a);
      var br = voucherAmountRemain(b);
      if(br !== ar) return br - ar;

      // 4) ×-×‘ ×œ×¤×™ ×›×•×ª×¨×ª
      return voucherTitle(a).localeCompare(voucherTitle(b),"he");
    });
  }

  function sortByMode(vs, mode){
    if(mode==="expiry"){
      return vs.slice().sort(function(a,b){
        var ae=voucherExpiryMs(a)||9e18;
        var be=voucherExpiryMs(b)||9e18;
        if(ae!==be) return ae-be;
        return voucherTitle(a).localeCompare(voucherTitle(b),"he");
      });
    }
    if(mode==="brand"){
      return vs.slice().sort(function(a,b){
        var an = (a.brandId?nameById(brands,a.brandId):"");
        var bn = (b.brandId?nameById(brands,b.brandId):"");
        var c = an.localeCompare(bn,"he");
        if(c) return c;
        return voucherTitle(a).localeCompare(voucherTitle(b),"he");
      });
    }
    if(mode==="amount"){
      return vs.slice().sort(function(a,b){
        var ar=voucherAmountRemain(a), br=voucherAmountRemain(b);
        if(br!==ar) return br-ar;
        return voucherTitle(a).localeCompare(voucherTitle(b),"he");
      });
    }
    // smart handled elsewhere
    return vs;
  }

  function filterVouchers(vs, state, searchText){
    var q = normalizeText(searchText || "");
    return vs.filter(function(v){
      // top filter
      if(state.top==="near" && !isNearExpiry(v)) return false;

      // category
      if(state.catId){
        if(!(v.catIds||[]).includes(state.catId)) return false;
      }

      // brand
      if(state.brandId){
        if(v.brandId !== state.brandId) return false;
      }

      // store
      if(state.storeId){
        if(!(v.storeIds||[]).includes(state.storeId)) return false;
      }

      if(q){
        return voucherSearchHaystack(v).indexOf(q) >= 0;
      }
      return true;
    });
  }

  function renderVoucherCard(v){
    var div = document.createElement("div");
    div.className = "vcard";

    var head = document.createElement("div");
    head.className = "vhead";

    var left = document.createElement("div");
    left.style.minWidth = "0";

    var title = document.createElement("div");
    title.className = "vtitle";
    title.textContent = voucherTitle(v);

    var badges = document.createElement("div");
    badges.className = "badges";

    var bType = document.createElement("div");
    bType.className = "badge type";
    bType.textContent = "×¡×•×’: " + (v.type||"×›×œ×œ×™");
    badges.appendChild(bType);

    if(v.physical){
      var bp = document.createElement("div");
      bp.className = "badge phys";
      bp.textContent = "×›×¨×˜×™×¡ ×¤×™×–×™";
      badges.appendChild(bp);
    }

    var cats = (v.catIds||[]).map(function(id){ return nameById(categories, id); }).filter(Boolean);
    if(cats.length){
      var bc = document.createElement("div");
      bc.className = "badge cat";
      bc.textContent = "×§×˜×’×•×¨×™×•×ª: " + cats.slice(0,2).join(", ") + (cats.length>2 ? " +" + (cats.length-2) : "");
      badges.appendChild(bc);
    }

    if(isNearExpiry(v)){
      var be = document.createElement("div");
      be.className = "badge near";
      be.textContent = "×§×¨×•×‘ ×œ×¤×§×™×¢×”";
      badges.appendChild(be);
    }
    if(v.archived){
      var ba = document.createElement("div");
      ba.className = "badge arch";
      ba.textContent = "××¨×›×™×•×Ÿ";
      badges.appendChild(ba);
    }

    left.appendChild(title);
    left.appendChild(badges);

    var right = document.createElement("div");
    right.className = "btn-group";

    var openBtn = document.createElement("button");
    openBtn.className = "iconbtn";
    openBtn.type = "button";
    openBtn.textContent = "×¤×ª×—";
    openBtn.onclick = function(){ openViewModal(v.id); };

    right.appendChild(openBtn);

    head.appendChild(left);
    head.appendChild(right);

    div.appendChild(head);

    // rows
    var expiry = v.expiryISO ? v.expiryISO : "â€”";
    var row1 = document.createElement("div");
    row1.className = "vrow";
    row1.innerHTML = "<b>×ª×•×§×£</b><span>"+escapeHtml(expiry)+"</span>";
    div.appendChild(row1);

    var row2 = document.createElement("div");
    row2.className = "vrow";
    var brandName = v.brandId ? nameById(brands, v.brandId) : "â€”";
    row2.innerHTML = "<b>××•×ª×’</b><span>"+escapeHtml(brandName || "â€”")+"</span>";
    div.appendChild(row2);

    var storesNames = (v.storeIds||[]).map(function(id){ return nameById(stores,id); }).filter(Boolean);
    var row3 = document.createElement("div");
    row3.className = "vrow";
    row3.innerHTML = "<b>×—× ×•×™×•×ª</b><span>"+escapeHtml(storesNames.length ? storesNames.join(", ") : "â€”")+"</span>";
    div.appendChild(row3);

    if(v.type==="×›×¡×¤×™"){
      var r = document.createElement("div");
      r.className = "vrow";
      var val = (String(v.moneyValue||"").trim()!=="" ? v.moneyValue : "â€”");
      var used = (String(v.moneyUsed||"").trim()!=="" ? v.moneyUsed : "â€”");
      var rem = (String(v.moneyRemain||"").trim()!=="" ? v.moneyRemain : "â€”");
      r.innerHTML = "<b>×©×´×—</b><span>×¢×¨×š: "+escapeHtml(val)+" | × ×•×¦×œ: "+escapeHtml(used)+" | ×™×ª×¨×”: "+escapeHtml(rem)+"</span>";
      div.appendChild(r);
    } else if(v.type==="××—×•×–"){
      var r2 = document.createElement("div");
      r2.className = "vrow";
      r2.innerHTML = "<b>×¤×™×¨×•×˜</b><span>"+escapeHtml(v.percentText||"â€”")+"</span>";
      div.appendChild(r2);
    } else if(v.type==="1+1"){
      var r3 = document.createElement("div");
      r3.className = "vrow";
      r3.innerHTML = "<b>×¤×™×¨×•×˜</b><span>"+escapeHtml(v.dealText||"â€”")+"</span>";
      div.appendChild(r3);
    }

    return div;
  }

  function renderActive(){
    autoArchiveSweep();

    var listHost = document.getElementById("activeList");
    var sortMode = document.getElementById("sortActive").value;
    var q = document.getElementById("searchInputActive").value || "";

    // Build filter rows
    buildTopRow("rowTopActive", filterActive, renderActive);
    buildEntityRow("rowCatsActive", activeItems(categories), filterActive.catId, "×›×œ ×”×§×˜×’×•×¨×™×•×ª", function(id){ filterActive.catId=id; renderActive(); });
    buildEntityRow("rowBrandsActive", activeItems(brands), filterActive.brandId, "×›×œ ×”××•×ª×’×™×", function(id){ filterActive.brandId=id; renderActive(); });
    buildEntityRow("rowStoresActive", activeItems(stores), filterActive.storeId, "×›×œ ×”×—× ×•×™×•×ª", function(id){ filterActive.storeId=id; renderActive(); });

    var vs = vouchers.filter(function(v){ return !v.archived; });
    vs = filterVouchers(vs, filterActive, q);

    var usage = brandUsageCounts(vouchers.filter(function(v){ return !v.archived; }));
    if(sortMode==="smart"){
      vs = smartSort(vs, usage);
    } else {
      // ×¢×“×™×™×Ÿ â€” ×›×œ×œ â€œ×§×¨×•×‘ ×œ×¤×§×™×¢×” ×§×•×¤×¥ ×œ×¨××©â€ ×¢×•×§×£ ×’× ×›××Ÿ
      vs = sortByMode(vs, sortMode);
      vs = vs.slice().sort(function(a,b){
        var an = isNearExpiry(a) ? 1 : 0;
        var bn = isNearExpiry(b) ? 1 : 0;
        if(bn !== an) return bn - an;
        return 0;
      });
    }

    listHost.innerHTML = "";
    if(!vs.length){
      listHost.innerHTML = '<div class="note">××™×Ÿ ×©×•×‘×¨×™× ×œ×”×¦×’×” (× ×¡×” ×œ×”×•×¨×™×“ ×¡×™× ×•×Ÿ).</div>';
      return;
    }
    vs.forEach(function(v){ listHost.appendChild(renderVoucherCard(v)); });
  }
  window.renderActive = renderActive;

  function renderArchive(){
    var listHost = document.getElementById("archiveList");
    var sortMode = document.getElementById("sortArchive").value;
    var q = document.getElementById("searchInputArchive").value || "";

    buildTopRow("rowTopArchive", filterArchive, renderArchive);
    buildEntityRow("rowCatsArchive", activeItems(categories), filterArchive.catId, "×›×œ ×”×§×˜×’×•×¨×™×•×ª", function(id){ filterArchive.catId=id; renderArchive(); });
    buildEntityRow("rowBrandsArchive", activeItems(brands), filterArchive.brandId, "×›×œ ×”××•×ª×’×™×", function(id){ filterArchive.brandId=id; renderArchive(); });
    buildEntityRow("rowStoresArchive", activeItems(stores), filterArchive.storeId, "×›×œ ×”×—× ×•×™×•×ª", function(id){ filterArchive.storeId=id; renderArchive(); });

    var vs = vouchers.filter(function(v){ return !!v.archived; });
    vs = filterVouchers(vs, filterArchive, q);

    var usage = brandUsageCounts(vouchers.filter(function(v){ return !!v.archived; }));
    if(sortMode==="smart"){
      vs = smartSort(vs, usage);
    } else {
      vs = sortByMode(vs, sortMode);
      vs = vs.slice().sort(function(a,b){
        var an = isNearExpiry(a) ? 1 : 0;
        var bn = isNearExpiry(b) ? 1 : 0;
        if(bn !== an) return bn - an;
        return 0;
      });
    }

    listHost.innerHTML = "";
    if(!vs.length){
      listHost.innerHTML = '<div class="note">××™×Ÿ ×©×•×‘×¨×™× ×‘××¨×›×™×•×Ÿ ×œ×¤×™ ×”×¡×™× ×•×Ÿ.</div>';
      return;
    }
    vs.forEach(function(v){ listHost.appendChild(renderVoucherCard(v)); });
  }
  window.renderArchive = renderArchive;

  // ===== Manage tab =====
  var manageTab = "brands"; // brands/stores/cats

  function renderManageTabs(){
    var host = document.getElementById("manageTabs");
    host.innerHTML = "";

    function mk(key, label){
      var c = document.createElement("div");
      c.className = "chip " + (manageTab===key ? "active" : "");
      c.textContent = label;
      c.onclick = function(){
        manageTab = key;
        renderManage();
      };
      host.appendChild(c);
    }
    mk("brands","××•×ª×’×™×");
    mk("stores","×—× ×•×™×•×ª");
    mk("cats","×§×˜×’×•×¨×™×•×ª");
  }

  function renderManage(){
    renderManageTabs();

    document.getElementById("manageBrands").style.display = (manageTab==="brands" ? "block" : "none");
    document.getElementById("manageStores").style.display = (manageTab==="stores" ? "block" : "none");
    document.getElementById("manageCats").style.display = (manageTab==="cats" ? "block" : "none");

    if(manageTab==="brands") renderBrandsList();
    if(manageTab==="stores") renderStoresList();
    if(manageTab==="cats") renderCatsList();
  }

  function renderBrandsList(){
    var ul = document.getElementById("brandsList");
    ul.innerHTML = "";
    var sorted = brands.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });

    sorted.forEach(function(b){
      var row = document.createElement("li");
      row.innerHTML =
        '<span>'+escapeHtml(b.name)+(b.active? "": " (××•×©×‘×ª)")+'</span>'+
        '<div class="btn-group">'+
          '<button class="iconbtn" type="button" title="×¤×ª×—">×¤×ª×—</button>'+
          '<button class="iconbtn" type="button" title="×¢×¨×•×š">âœï¸</button>'+
          '<button class="iconbtn" type="button" title="×”×©×‘×ª/×”×—×–×¨">'+(b.active?"âŒ":"â†©ï¸")+'</button>'+
        '</div>';

      var btns = row.querySelectorAll("button");
      btns[0].onclick = function(){ openBrandDetail(b.id); };
      btns[1].onclick = function(){ editEntityName("brand", b.id); };
      btns[2].onclick = function(){ toggleEntityActive("brand", b.id); };

      ul.appendChild(row);
    });
  }

  function renderStoresList(){
    var ul = document.getElementById("storesList");
    ul.innerHTML = "";
    var sorted = stores.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });

    sorted.forEach(function(s){
      var row = document.createElement("li");
      row.innerHTML =
        '<span>'+escapeHtml(s.name)+(s.active? "": " (××•×©×‘×ª)")+'</span>'+
        '<div class="btn-group">'+
          '<button class="iconbtn" type="button" title="×¤×ª×—">×¤×ª×—</button>'+
          '<button class="iconbtn" type="button" title="×¢×¨×•×š">âœï¸</button>'+
          '<button class="iconbtn" type="button" title="×”×©×‘×ª/×”×—×–×¨">'+(s.active?"âŒ":"â†©ï¸")+'</button>'+
        '</div>';

      var btns = row.querySelectorAll("button");
      btns[0].onclick = function(){ openStoreDetail(s.id); };
      btns[1].onclick = function(){ editEntityName("store", s.id); };
      btns[2].onclick = function(){ toggleEntityActive("store", s.id); };

      ul.appendChild(row);
    });
  }

  function renderCatsList(){
    var ul = document.getElementById("catsList");
    ul.innerHTML = "";
    var sorted = categories.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });

    sorted.forEach(function(c){
      var row = document.createElement("li");
      row.innerHTML =
        '<span>'+escapeHtml(c.name)+(c.active? "": " (××•×©×‘×ª)")+'</span>'+
        '<div class="btn-group">'+
          '<button class="iconbtn" type="button" title="×¢×¨×•×š">âœï¸</button>'+
          '<button class="iconbtn" type="button" title="×”×©×‘×ª/×”×—×–×¨">'+(c.active?"âŒ":"â†©ï¸")+'</button>'+
        '</div>';

      var btns = row.querySelectorAll("button");
      btns[0].onclick = function(){ editEntityName("cat", c.id); };
      btns[1].onclick = function(){ toggleEntityActive("cat", c.id); };

      ul.appendChild(row);
    });
  }

  function addBrand(){
    var v = (document.getElementById("newBrandName").value || "").trim();
    if(!v) return;
    if(brands.some(function(x){ return normalizeText(x.name)===normalizeText(v); })) return alert("××•×ª×’ ×›×‘×¨ ×§×™×™×");
    brands.push({id:uid(), name:v, active:true, createdAt:Date.now()});
    document.getElementById("newBrandName").value = "";
    saveAll(); renderAll();
  }
  window.addBrand = addBrand;

  function addStore(){
    var v = (document.getElementById("newStoreName").value || "").trim();
    if(!v) return;
    if(stores.some(function(x){ return normalizeText(x.name)===normalizeText(v); })) return alert("×—× ×•×ª ×›×‘×¨ ×§×™×™××ª");
    stores.push({id:uid(), name:v, active:true, createdAt:Date.now()});
    document.getElementById("newStoreName").value = "";
    saveAll(); renderAll();
  }
  window.addStore = addStore;

  function addCategory(){
    var v = (document.getElementById("newCatName").value || "").trim();
    if(!v) return;
    if(categories.some(function(x){ return normalizeText(x.name)===normalizeText(v); })) return alert("×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª");
    categories.push({id:uid(), name:v, active:true, createdAt:Date.now()});
    document.getElementById("newCatName").value = "";
    saveAll(); renderAll();
  }
  window.addCategory = addCategory;

  function editEntityName(kind, id){
    var arr = (kind==="brand"?brands:(kind==="store"?stores:categories));
    var obj = arr.find(function(x){ return x.id===id; });
    if(!obj) return;
    var next = (prompt("×©× ×—×“×©:", obj.name) || "").trim();
    if(!next) return;
    if(arr.some(function(x){ return x.id!==id && normalizeText(x.name)===normalizeText(next); })) return alert("×›×‘×¨ ×§×™×™× ×‘×©× ×”×–×”");
    obj.name = next;
    saveAll(); renderAll();
  }

  function toggleEntityActive(kind, id){
    var arr = (kind==="brand"?brands:(kind==="store"?stores:categories));
    var obj = arr.find(function(x){ return x.id===id; });
    if(!obj) return;
    var msg = obj.active ? "×œ×”×©×‘×™×ª? (×œ× ××•×—×§ ×”×™×¡×˜×•×¨×™×”)" : "×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?";
    if(!confirm(msg)) return;
    obj.active = !obj.active;
    saveAll(); renderAll();
  }

  // ===== Brand detail (manage) =====
  var brandDetailId = "";

  function brandStores(brandId){
    var ids = linksBrandStores.filter(function(l){ return l.brandId===brandId; }).map(function(l){ return l.storeId; });
    return ids;
  }

  function openBrandDetail(brandId){
    brandDetailId = brandId;
    var b = brands.find(function(x){ return x.id===brandId; });
    if(!b) return;

    document.getElementById("brandDetailTitle").textContent = "××•×ª×’: " + b.name;

    var ids = brandStores(brandId);
    var names = ids.map(function(id){ return {id:id, name:nameById(stores,id)}; }).filter(function(x){ return x.name; })
      .sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });

    var body = document.getElementById("brandDetailBody");
    body.innerHTML = "";

    var note = document.createElement("div");
    note.className = "note";
    note.textContent = "×›××Ÿ ×× ×”×œ×™× ××ª ×”×—× ×•×™×•×ª ×©×©×™×™×›×•×ª ×œ××•×ª×’ ×”×–×”.";
    body.appendChild(note);

    var actions = document.createElement("div");
    actions.className = "inline";
    actions.style.marginTop = "10px";

    var addBtn = document.createElement("button");
    addBtn.className = "btn ghost";
    addBtn.type = "button";
    addBtn.textContent = "×”×•×¡×£/×”×¡×¨ ×—× ×•×™×•×ª";
    addBtn.onclick = function(){
      // × ×©×ª××© ×‘×¤×™×§×¨ ×¨×‘-×‘×—×™×¨×” ×¢×œ ×—× ×•×™×•×ª, ×•××– × ×™×™×©× ×§×©×¨×™×
      __pickerContext = { kind:"brandStores", multi:true, brandId:brandId };
      openPicker("stores", true, ids.slice());
    };

    actions.appendChild(addBtn);
    body.appendChild(actions);

    var ul = document.createElement("ul");
    if(!names.length){
      ul.innerHTML = '<li><span>××™×Ÿ ×—× ×•×™×•×ª ××©×•×™×›×•×ª</span></li>';
    } else {
      names.forEach(function(x){
        var li = document.createElement("li");
        li.innerHTML = '<span>'+escapeHtml(x.name)+'</span><div class="btn-group"><button class="iconbtn" type="button">× ×ª×§</button></div>';
        li.querySelector("button").onclick = function(){
          if(!confirm("×œ× ×ª×§ ××ª ×”×—× ×•×ª ××”××•×ª×’?")) return;
          linksBrandStores = linksBrandStores.filter(function(l){ return !(l.brandId===brandId && l.storeId===x.id); });
          saveAll(); openBrandDetail(brandId); renderAll();
        };
        ul.appendChild(li);
      });
    }
    body.appendChild(ul);

    document.getElementById("brandDetailBackdrop").style.display = "flex";
  }
  window.openBrandDetail = openBrandDetail;

  function hideBrandDetail(){
    document.getElementById("brandDetailBackdrop").style.display = "none";
    brandDetailId = "";
  }
  window.hideBrandDetail = hideBrandDetail;

  function closeBrandDetail(e){
    if(e.target === document.getElementById("brandDetailBackdrop")) hideBrandDetail();
  }
  window.closeBrandDetail = closeBrandDetail;

  // ===== Store detail (manage) =====
  var storeDetailId = "";

  function storeBrands(storeId){
    var ids = linksBrandStores.filter(function(l){ return l.storeId===storeId; }).map(function(l){ return l.brandId; });
    return ids;
  }
  function storeCategoriesIds(storeId){
    return storeCats.filter(function(x){ return x.storeId===storeId; }).map(function(x){ return x.catId; });
  }

  function openStoreDetail(storeId){
    storeDetailId = storeId;
    var s = stores.find(function(x){ return x.id===storeId; });
    if(!s) return;

    document.getElementById("storeDetailTitle").textContent = "×—× ×•×ª: " + s.name;

    var bIds = storeBrands(storeId);
    var cIds = storeCategoriesIds(storeId);

    var body = document.getElementById("storeDetailBody");
    body.innerHTML = "";

    var note = document.createElement("div");
    note.className = "note";
    note.textContent = "×›××Ÿ ×× ×”×œ×™× ××•×ª×’×™× ×•×§×˜×’×•×¨×™×•×ª ×©×œ ×”×—× ×•×ª.";
    body.appendChild(note);

    var actions = document.createElement("div");
    actions.className = "inline";
    actions.style.marginTop = "10px";

    var brandsBtn = document.createElement("button");
    brandsBtn.className = "btn ghost";
    brandsBtn.type = "button";
    brandsBtn.textContent = "× ×”×œ ××•×ª×’×™×";
    brandsBtn.onclick = function(){
      __pickerContext = { kind:"storeBrands", multi:true, storeId:storeId };
      openPicker("brand", true, bIds.slice());
    };

    var catsBtn = document.createElement("button");
    catsBtn.className = "btn ghost";
    catsBtn.type = "button";
    catsBtn.textContent = "× ×”×œ ×§×˜×’×•×¨×™×•×ª";
    catsBtn.onclick = function(){
      __pickerContext = { kind:"storeCats", multi:true, storeId:storeId };
      openPicker("cats", true, cIds.slice());
    };

    actions.appendChild(brandsBtn);
    actions.appendChild(catsBtn);
    body.appendChild(actions);

    // list brands
    var h1 = document.createElement("h3");
    h1.textContent = "××•×ª×’×™× ××©×•×™×›×™×";
    body.appendChild(h1);

    var ulB = document.createElement("ul");
    var bNames = bIds.map(function(id){ return {id:id, name:nameById(brands,id)}; }).filter(function(x){ return x.name; })
      .sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });
    if(!bNames.length){
      ulB.innerHTML = '<li><span>××™×Ÿ ××•×ª×’×™×</span></li>';
    } else {
      bNames.forEach(function(x){
        var li = document.createElement("li");
        li.innerHTML = '<span>'+escapeHtml(x.name)+'</span><div class="btn-group"><button class="iconbtn" type="button">× ×ª×§</button></div>';
        li.querySelector("button").onclick = function(){
          if(!confirm("×œ× ×ª×§ ××•×ª×’ ××”×—× ×•×ª?")) return;
          linksBrandStores = linksBrandStores.filter(function(l){ return !(l.brandId===x.id && l.storeId===storeId); });
          saveAll(); openStoreDetail(storeId); renderAll();
        };
        ulB.appendChild(li);
      });
    }
    body.appendChild(ulB);

    // list cats
    var h2 = document.createElement("h3");
    h2.textContent = "×§×˜×’×•×¨×™×•×ª";
    body.appendChild(h2);

    var ulC = document.createElement("ul");
    var cNames = cIds.map(function(id){ return {id:id, name:nameById(categories,id)}; }).filter(function(x){ return x.name; })
      .sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });
    if(!cNames.length){
      ulC.innerHTML = '<li><span>××™×Ÿ ×§×˜×’×•×¨×™×•×ª</span></li>';
    } else {
      cNames.forEach(function(x){
        var li2 = document.createElement("li");
        li2.innerHTML = '<span>'+escapeHtml(x.name)+'</span><div class="btn-group"><button class="iconbtn" type="button">×”×¡×¨</button></div>';
        li2.querySelector("button").onclick = function(){
          if(!confirm("×œ×”×¡×™×¨ ×§×˜×’×•×¨×™×” ××”×—× ×•×ª?")) return;
          storeCats = storeCats.filter(function(sc){ return !(sc.storeId===storeId && sc.catId===x.id); });
          saveAll(); openStoreDetail(storeId); renderAll();
        };
        ulC.appendChild(li2);
      });
    }
    body.appendChild(ulC);

    document.getElementById("storeDetailBackdrop").style.display = "flex";
  }
  window.openStoreDetail = openStoreDetail;

  function hideStoreDetail(){
    document.getElementById("storeDetailBackdrop").style.display = "none";
    storeDetailId = "";
  }
  window.hideStoreDetail = hideStoreDetail;

  function closeStoreDetail(e){
    if(e.target === document.getElementById("storeDetailBackdrop")) hideStoreDetail();
  }
  window.closeStoreDetail = closeStoreDetail;

  // ===== Voucher add/edit modal =====
  var editingVoucherId = "";

  function openVoucherModal(id){
    autoArchiveSweep();

    editingVoucherId = id || "";
    var v = id ? vouchers.find(function(x){ return x.id===id; }) : null;
    var cur = v ? JSON.parse(JSON.stringify(v)) : emptyVoucher(); // clone

    __voucherDraft = cur;

    document.getElementById("voucherModalTitle").textContent = id ? "âœï¸ ×¢×¨×™×›×ª ×©×•×‘×¨" : "â• ×©×•×‘×¨ ×—×“×©";

    document.getElementById("vType").value = cur.type || "×›×œ×œ×™";
    document.getElementById("vScope").value = cur.scope || "all";
    document.getElementById("vPhysical").value = String(cur.physical ? 1 : 0);
    document.getElementById("vExpiry").value = cur.expiryISO || "";
    document.getElementById("vCode").value = cur.code || "";
    document.getElementById("vNotes").value = cur.notes || "";

    // notes for chosen
    refreshChosenNotes();

    renderVoucherTypeFields();
    renderVoucherScopeFields();

    // hide delete button for brand-new? (×¢×“×™×™×Ÿ ××¤×©×¨, ××‘×œ ××™×Ÿ ××” ×œ××—×•×§)
    var delBtn = document.querySelector("#voucherBackdrop .btn.danger");
    if(delBtn) delBtn.style.display = id ? "block" : "none";

    document.getElementById("voucherBackdrop").style.display = "flex";
  }
  window.openVoucherModal = openVoucherModal;

  function hideVoucherModal(){
    document.getElementById("voucherBackdrop").style.display = "none";
    editingVoucherId = "";
    __voucherDraft = null;
  }
  window.hideVoucherModal = hideVoucherModal;

  function closeVoucherModal(e){
    if(e.target === document.getElementById("voucherBackdrop")) hideVoucherModal();
  }
  window.closeVoucherModal = closeVoucherModal;

  function renderVoucherScopeFields(){
    // ×× ×›×¨×˜×™×¡ ×¤×™×–×™ = ×§×•×“ ×¤×—×•×ª ×¨×œ×•×•× ×˜×™, ××‘×œ × ×©××™×¨ ××¤×©×¨×™; ×¨×§ ×œ× × ×¡×ª×™×¨.
    // ×”×¡×§×•×¤ ××©×¤×™×¢ ×¨×§ ×¢×œ ×”×ª×¦×•×’×” ×•×”×¡×›××”.
    // ××™×Ÿ ×¢×•×“ UI ×—×•×‘×” ×›××Ÿ ××¢×‘×¨ ×œ×”×¡×‘×¨ ×©×›×‘×¨ ×™×©.
  }

  function renderVoucherTypeFields(){
    var t = document.getElementById("vType").value;
    var host = document.getElementById("typeFields");
    host.innerHTML = "";

    if(t==="×›×¡×¤×™"){
      host.innerHTML =
        '<div class="field"><label>×¢×¨×š (×©×´×—)</label><input id="moneyValue" inputmode="decimal" placeholder="×œ××©×œ 500"></div>'+
        '<div class="field"><label>× ×•×¦×œ (×©×´×—)</label><input id="moneyUsed" inputmode="decimal" placeholder="×œ××©×œ 200"></div>'+
        '<div class="field"><label>×™×ª×¨×” (×©×´×—)</label><input id="moneyRemain" inputmode="decimal" placeholder="×œ××©×œ 300"></div>'+
        '<div class="note">×›××©×¨ ×™×ª×¨×” ××’×™×¢×” ×œ-0 â€” ×”×©×•×‘×¨ ×™×¢×‘×•×¨ ××•×˜×•××˜×™×ª ×œ××¨×›×™×•×Ÿ.</div>';
      document.getElementById("codeField").style.display = "block";
      // fill from draft
      document.getElementById("moneyValue").value = __voucherDraft.moneyValue || "";
      document.getElementById("moneyUsed").value = __voucherDraft.moneyUsed || "";
      document.getElementById("moneyRemain").value = __voucherDraft.moneyRemain || "";
    } else if(t==="××—×•×–"){
      host.innerHTML =
        '<div class="field"><label>×¤×™×¨×•×˜</label><input id="percentText" placeholder="×œ××©×œ 20% ×”× ×—×” ×¢×“ 200 ×©×´×—"></div>'+
        '<div class="note">×× ×™×© ×™×ª×¨×” ×—×œ×§×™×ª (×œ××©×œ × ×©××¨ 20 ×©×´×— ××ª×•×š 200) â€” ×¨×©×•× ×›××Ÿ/×‘×”×¢×¨×•×ª ××• ×”×©×ª××© ×‘×¡×•×’ ×›×¡×¤×™.</div>';
      document.getElementById("codeField").style.display = "block";
      document.getElementById("percentText").value = __voucherDraft.percentText || "";
    } else if(t==="1+1"){
      host.innerHTML =
        '<div class="field"><label>×¤×™×¨×•×˜</label><input id="dealText" placeholder="×œ××©×œ 1+1 ×¢×œ ×¤×¨×™×˜ ×©× ×™"></div>';
      document.getElementById("codeField").style.display = "block";
      document.getElementById("dealText").value = __voucherDraft.dealText || "";
    } else {
      host.innerHTML =
        '<div class="note">×¡×•×’ ×›×œ×œ×™ â€” ×¤×¨×˜×™× ×‘×”×¢×¨×•×ª.</div>';
      document.getElementById("codeField").style.display = "block";
    }
  }

  // ===== Picker =====
  var __picker = { mode:"", multi:false, selected:[], initial:[], kind:"" };
  var __pickerContext = null; // used for manage link modes
  var __voucherDraft = null;

  function openQuickAdd(kind){
    var label = (kind==="brand" ? "××•×ª×’" : (kind==="store" ? "×—× ×•×ª" : "×§×˜×’×•×¨×™×”"));
    var name = (prompt("×©× "+label+" ×—×“×©:") || "").trim();
    if(!name) return;

    if(kind==="brand"){
      if(brands.some(function(x){ return normalizeText(x.name)===normalizeText(name); })) return alert("××•×ª×’ ×›×‘×¨ ×§×™×™×");
      var id = uid();
      brands.push({id:id, name:name, active:true, createdAt:Date.now()});
      saveAll();
      if(__voucherDraft) __voucherDraft.brandId = id;
      refreshChosenNotes();
      renderAll();
      return;
    }
    if(kind==="store"){
      if(stores.some(function(x){ return normalizeText(x.name)===normalizeText(name); })) return alert("×—× ×•×ª ×›×‘×¨ ×§×™×™××ª");
      var sid = uid();
      stores.push({id:sid, name:name, active:true, createdAt:Date.now()});
      saveAll();
      if(__voucherDraft){
        if(!(__voucherDraft.storeIds||[]).includes(sid)) __voucherDraft.storeIds.push(sid);
      }
      refreshChosenNotes();
      renderAll();
      return;
    }
    if(kind==="cat"){
      if(categories.some(function(x){ return normalizeText(x.name)===normalizeText(name); })) return alert("×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª");
      var cid = uid();
      categories.push({id:cid, name:name, active:true, createdAt:Date.now()});
      saveAll();
      if(__voucherDraft){
        if(!(__voucherDraft.catIds||[]).includes(cid)) __voucherDraft.catIds.push(cid);
      }
      refreshChosenNotes();
      renderAll();
      return;
    }
  }
  window.openQuickAdd = openQuickAdd;

  function openPicker(mode, multi, presetSelected){
    // mode: brand / stores / cats
    __picker.mode = mode;
    __picker.multi = !!multi;
    __picker.kind = mode;
    __picker.selected = presetSelected ? presetSelected.slice() : (function(){
      if(!__voucherDraft) return [];
      if(mode==="brand") return __voucherDraft.brandId ? [__voucherDraft.brandId] : [];
      if(mode==="stores") return (__voucherDraft.storeIds||[]).slice();
      if(mode==="cats") return (__voucherDraft.catIds||[]).slice();
      return [];
    })();
    __picker.initial = __picker.selected.slice();

    document.getElementById("pickerSearch").value = "";
    document.getElementById("pickerTitle").textContent =
      (mode==="brand" ? "×‘×—×¨ ××•×ª×’" : (mode==="stores" ? "×‘×—×¨ ×—× ×•×™×•×ª" : "×‘×—×¨ ×§×˜×’×•×¨×™×•×ª"));

    renderPickerList();
    document.getElementById("pickerBackdrop").style.display = "flex";
  }
  window.openPicker = openPicker;

  function hidePicker(){
    document.getElementById("pickerBackdrop").style.display = "none";
    __pickerContext = null;
  }
  window.hidePicker = hidePicker;

  function closePickerModal(e){
    if(e.target === document.getElementById("pickerBackdrop")) hidePicker();
  }
  window.closePickerModal = closePickerModal;

  function renderPickerList(){
    var host = document.getElementById("pickerList");
    host.innerHTML = "";

    var q = normalizeText(document.getElementById("pickerSearch").value || "");
    var items = [];
    if(__picker.mode==="brand") items = activeItems(brands);
    else if(__picker.mode==="stores") items = activeItems(stores);
    else items = activeItems(categories);

    items = items.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });

    if(q){
      items = items.filter(function(x){ return normalizeText(x.name).indexOf(q)>=0; });
    }

    if(!items.length){
      host.innerHTML = '<div class="note">××™×Ÿ ×ª×•×¦××•×ª.</div>';
      return;
    }

    items.forEach(function(it){
      var row = document.createElement("div");
      row.className = "pickItem " + ((__picker.selected||[]).includes(it.id) ? "active" : "");
      var right = document.createElement("div");
      right.className = "right";

      var mark = document.createElement("div");
      mark.className = "badge";
      mark.textContent = ((__picker.selected||[]).includes(it.id) ? "× ×‘×—×¨" : (__picker.multi ? "×‘×—×¨" : "×‘×—×¨"));

      right.appendChild(mark);

      row.innerHTML = '<div>'+escapeHtml(it.name)+'</div>';
      row.appendChild(right);

      row.onclick = function(){
        if(__picker.multi){
          var idx = __picker.selected.indexOf(it.id);
          if(idx>=0) __picker.selected.splice(idx,1);
          else __picker.selected.push(it.id);
        } else {
          __picker.selected = [it.id];
        }
        renderPickerList();
      };

      host.appendChild(row);
    });
  }
  window.renderPickerList = renderPickerList;

  function pickerApply(){
    if(__pickerContext && __pickerContext.kind==="brandStores"){
      // apply brand<->stores links
      var brandId = __pickerContext.brandId;
      var selected = (__picker.selected||[]).slice();

      // remove old links for brand
      linksBrandStores = linksBrandStores.filter(function(l){ return l.brandId!==brandId; });
      // add new
      selected.forEach(function(sid){
        linksBrandStores.push({brandId:brandId, storeId:sid});
      });

      saveAll();
      hidePicker();
      openBrandDetail(brandId);
      renderAll();
      return;
    }

    if(__pickerContext && __pickerContext.kind==="storeBrands"){
      var storeId = __pickerContext.storeId;
      var bSel = (__picker.selected||[]).slice();

      // remove old links for store
      linksBrandStores = linksBrandStores.filter(function(l){ return l.storeId!==storeId; });
      // add new
      bSel.forEach(function(bid){
        linksBrandStores.push({brandId:bid, storeId:storeId});
      });

      saveAll();
      hidePicker();
      openStoreDetail(storeId);
      renderAll();
      return;
    }

    if(__pickerContext && __pickerContext.kind==="storeCats"){
      var storeId2 = __pickerContext.storeId;
      var cSel = (__picker.selected||[]).slice();

      storeCats = storeCats.filter(function(sc){ return sc.storeId!==storeId2; });
      cSel.forEach(function(cid){
        storeCats.push({storeId:storeId2, catId:cid});
      });

      saveAll();
      hidePicker();
      openStoreDetail(storeId2);
      renderAll();
      return;
    }

    // voucher draft
    if(!__voucherDraft){
      hidePicker();
      return;
    }

    if(__picker.mode==="brand"){
      __voucherDraft.brandId = (__picker.selected[0] || "");
    } else if(__picker.mode==="stores"){
      __voucherDraft.storeIds = (__picker.selected||[]).slice();
    } else if(__picker.mode==="cats"){
      __voucherDraft.catIds = (__picker.selected||[]).slice();
    }

    refreshChosenNotes();
    hidePicker();
  }
  window.pickerApply = pickerApply;

  function refreshChosenNotes(){
    // brand
    var bn = document.getElementById("brandChosenNote");
    var sn = document.getElementById("storesChosenNote");
    var cn = document.getElementById("catsChosenNote");
    if(!__voucherDraft){
      if(bn) bn.textContent = "×œ× × ×‘×—×¨";
      if(sn) sn.textContent = "×œ× × ×‘×—×¨×•";
      if(cn) cn.textContent = "×œ× × ×‘×—×¨×•";
      return;
    }
    var b = __voucherDraft.brandId ? nameById(brands, __voucherDraft.brandId) : "";
    if(bn) bn.textContent = b ? ("× ×‘×—×¨: " + b) : "×œ× × ×‘×—×¨";

    var storesNames = (__voucherDraft.storeIds||[]).map(function(id){ return nameById(stores,id); }).filter(Boolean);
    if(sn) sn.textContent = storesNames.length ? ("× ×‘×—×¨×•: " + storesNames.join(", ")) : "×œ× × ×‘×—×¨×•";

    var catsNames = (__voucherDraft.catIds||[]).map(function(id){ return nameById(categories,id); }).filter(Boolean);
    if(cn) cn.textContent = catsNames.length ? ("× ×‘×—×¨×•: " + catsNames.join(", ")) : "×œ× × ×‘×—×¨×•";
  }

  // ===== Save voucher =====
  function ensureVoucherHasBrandOrStore(v){
    return !!(v.brandId || (v.storeIds && v.storeIds.length));
  }

  function saveVoucher(){
    if(!__voucherDraft) return;

    // pull fields
    __voucherDraft.type = document.getElementById("vType").value;
    __voucherDraft.scope = document.getElementById("vScope").value;
    __voucherDraft.physical = Number(document.getElementById("vPhysical").value) ? 1 : 0;
    __voucherDraft.expiryISO = document.getElementById("vExpiry").value || "";
    __voucherDraft.code = document.getElementById("vCode").value || "";
    __voucherDraft.notes = document.getElementById("vNotes").value || "";

    // type specifics
    __voucherDraft.moneyValue = "";
    __voucherDraft.moneyUsed = "";
    __voucherDraft.moneyRemain = "";
    __voucherDraft.percentText = "";
    __voucherDraft.dealText = "";

    if(__voucherDraft.type==="×›×¡×¤×™"){
      __voucherDraft.moneyValue = (document.getElementById("moneyValue")||{}).value || "";
      __voucherDraft.moneyUsed = (document.getElementById("moneyUsed")||{}).value || "";
      __voucherDraft.moneyRemain = (document.getElementById("moneyRemain")||{}).value || "";
    } else if(__voucherDraft.type==="××—×•×–"){
      __voucherDraft.percentText = (document.getElementById("percentText")||{}).value || "";
    } else if(__voucherDraft.type==="1+1"){
      __voucherDraft.dealText = (document.getElementById("dealText")||{}).value || "";
    }

    // rule: ×—×•×‘×” ××•×ª×’ ××• ×—× ×•×ª
    if(!ensureVoucherHasBrandOrStore(__voucherDraft)){
      alert("×›×“×™ ×œ×©××•×¨: ×—×•×‘×” ×œ×‘×—×•×¨ ××•×ª×’ ××• ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×—× ×•×ª ××—×ª.");
      return;
    }

    __voucherDraft.updatedAt = Date.now();
    __voucherDraft.updatedBy = DEVICE_NAME;

    // auto archive sweep for this voucher
    __voucherDraft.archived = !!__voucherDraft.archived; // keep as is
    __voucherDraft.archivedReason = __voucherDraft.archivedReason || "";

    // expire -> archive
    if(!__voucherDraft.archived && isExpired(__voucherDraft)){
      __voucherDraft.archived = true;
      __voucherDraft.archivedReason = "expired";
    }
    // remain 0 -> archive
    if(!__voucherDraft.archived && __voucherDraft.type==="×›×¡×¤×™"){
      var rem = voucherAmountRemain(__voucherDraft);
      if(rem <= 0 && (String(__voucherDraft.moneyRemain).trim() !== "")){
        __voucherDraft.archived = true;
        __voucherDraft.archivedReason = "zero";
      }
    }

    if(editingVoucherId){
      var idx = vouchers.findIndex(function(x){ return x.id===editingVoucherId; });
      if(idx>=0){
        vouchers[idx] = __voucherDraft;
      }
    } else {
      vouchers.push(__voucherDraft);
    }

    saveAll();
    hideVoucherModal();
    renderAll();
  }
  window.saveVoucher = saveVoucher;

  function deleteVoucherById(id){
    vouchers = vouchers.filter(function(v){ return v.id !== id; });
    saveAll();
    renderAll();
  }

  function deleteVoucherFromModal(){
    if(!editingVoucherId) return;
    if(!confirm("×œ××—×•×§ ××ª ×”×©×•×‘×¨?")) return;
    deleteVoucherById(editingVoucherId);
    hideVoucherModal();
  }
  window.deleteVoucherFromModal = deleteVoucherFromModal;

  // ===== View voucher modal =====
  var viewingId = "";

  function openViewModal(id){
    autoArchiveSweep();

    var v = vouchers.find(function(x){ return x.id===id; });
    if(!v) return;
    viewingId = id;

    document.getElementById("viewTitle").textContent = voucherTitle(v);

    var body = document.getElementById("viewBody");
    body.innerHTML = "";

    function addRow(k, val){
      var row = document.createElement("div");
      row.className = "vrow";
      row.innerHTML = "<b>"+escapeHtml(k)+"</b><span>"+escapeHtml(val)+"</span>";
      body.appendChild(row);
    }

    addRow("×¡×•×’", v.type || "×›×œ×œ×™");
    addRow("×ª×§×£ ×¢×‘×•×¨", (v.scope==="stores" ? "×—× ×•×™×•×ª ××¡×•×™××•×ª" : "×›×œ ×”×¨×©×ª"));
    addRow("××•×ª×’", v.brandId ? nameById(brands, v.brandId) : "â€”");

    var sNames = (v.storeIds||[]).map(function(sid){ return nameById(stores,sid); }).filter(Boolean);
    addRow("×—× ×•×™×•×ª", sNames.length ? sNames.join(", ") : "â€”");

    var cNames = (v.catIds||[]).map(function(cid){ return nameById(categories,cid); }).filter(Boolean);
    addRow("×§×˜×’×•×¨×™×•×ª", cNames.length ? cNames.join(", ") : "â€”");

    addRow("×›×¨×˜×™×¡ ×¤×™×–×™", v.physical ? "×›×Ÿ" : "×œ×");
    addRow("×ª×•×§×£", v.expiryISO || "â€”");

    if(v.type==="×›×¡×¤×™"){
      addRow("×¢×¨×š", (String(v.moneyValue||"").trim()!=="" ? v.moneyValue : "â€”"));
      addRow("× ×•×¦×œ", (String(v.moneyUsed||"").trim()!=="" ? v.moneyUsed : "â€”"));
      addRow("×™×ª×¨×”", (String(v.moneyRemain||"").trim()!=="" ? v.moneyRemain : "â€”"));
    } else if(v.type==="××—×•×–"){
      addRow("×¤×™×¨×•×˜", v.percentText || "â€”");
    } else if(v.type==="1+1"){
      addRow("×¤×™×¨×•×˜", v.dealText || "â€”");
    }

    addRow("×§×•×“", v.code ? v.code : "â€”");
    addRow("×”×¢×¨×•×ª", v.notes ? v.notes : "â€”");

    document.getElementById("viewBackdrop").style.display = "flex";
  }
  window.openViewModal = openViewModal;

  function hideViewModal(){
    document.getElementById("viewBackdrop").style.display = "none";
    viewingId = "";
  }
  window.hideViewModal = hideViewModal;

  function closeViewModal(e){
    if(e.target === document.getElementById("viewBackdrop")) hideViewModal();
  }
  window.closeViewModal = closeViewModal;

  function copyCode(){
    if(!viewingId) return;
    var v = vouchers.find(function(x){ return x.id===viewingId; });
    if(!v) return;
    var code = String(v.code||"").trim();
    if(!code) return alert("××™×Ÿ ×§×•×“ ×œ×”×¢×ª×§×”");
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(code).then(function(){
          alert("×”×•×¢×ª×§ âœ…");
        }).catch(function(){
          fallbackCopy(code);
        });
      } else {
        fallbackCopy(code);
      }
    } catch(e){
      fallbackCopy(code);
    }
  }
  window.copyCode = copyCode;

  function fallbackCopy(text){
    var ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand("copy"); alert("×”×•×¢×ª×§ âœ…"); }
    catch(e){ alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§ ××•×˜×•××˜×™×ª. ×”×¢×ª×§ ×™×“× ×™×ª."); }
    ta.remove();
  }

  function openEditFromView(){
    if(!viewingId) return;
    var id = viewingId;
    hideViewModal();
    openVoucherModal(id);
  }
  window.openEditFromView = openEditFromView;

  function toggleArchiveFromView(){
    if(!viewingId) return;
    var v = vouchers.find(function(x){ return x.id===viewingId; });
    if(!v) return;

    if(v.archived){
      // restore
      v.archived = false;
      v.archivedReason = "";
      v.updatedAt = Date.now();
      v.updatedBy = DEVICE_NAME;
    } else {
      v.archived = true;
      v.archivedReason = "manual";
      v.updatedAt = Date.now();
      v.updatedBy = DEVICE_NAME;
    }

    saveAll();
    hideViewModal();
    renderAll();
  }
  window.toggleArchiveFromView = toggleArchiveFromView;

  function deleteVoucherFromView(){
    if(!viewingId) return;
    if(!confirm("×œ××—×•×§ ××ª ×”×©×•×‘×¨?")) return;
    var id = viewingId;
    hideViewModal();
    deleteVoucherById(id);
  }
  window.deleteVoucherFromView = deleteVoucherFromView;

  // ===== Reset =====
  function resetAll(){
    if(!confirm("××™×¤×•×¡ ××œ×?")) return;
    localStorage.clear();
    location.reload();
  }
  window.resetAll = resetAll;

  // ===== Helpers =====
  function escapeHtml(s){
    s = String(s);
    return s.replace(/[&<>"']/g, function(m){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[m];
    });
  }

  // ===== Final render =====
  function renderAll(){
    renderActive();
    renderArchive();
    renderManage();
    renderSyncLastLine();
    showLocalNoteIfYanir();
    maybeShowDeviceCard();
  }

  // init
  loadAll();
  renderAll();
</script>
</body>
</html>
