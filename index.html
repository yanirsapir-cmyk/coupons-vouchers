<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×§×•×¤×•× ×™× ×•×©×•×‘×¨×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;
      --warn:#b45309;
      --ok:#16a34a;
      --near:#fee2e2;
      --expired:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
      overflow:hidden;
    }
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .view{display:none}
    .view.active{display:block}

    .field{margin-top:10px; min-width:0; overflow:hidden;}
    label{font-weight:900}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff;
      max-width:100%;
    }
    input[type="date"]{width:100%;display:block;min-width:0;}
    textarea{min-height:100px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline > *{flex:1; min-width:160px}
    .inline .tinybtn{flex:0 0 auto; min-width:auto}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}
    .ok{background:var(--ok); color:#fff}
    .warn{background:#fff7ed; border:1px solid #fed7aa; color:var(--warn)}
    .tinybtn{
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      background:#f3f4f6; font-weight:900; cursor:pointer;
    }

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .toolbar-left{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .toolbar-right{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}

    .search{
      flex:1;
      min-width:220px;
    }

    .chips{
      display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; margin:10px 0 6px;
    }
    .chip{
      display:flex; align-items:center; gap:6px;
      font-weight:900; font-size:12px;
      background:#fff; border:1px solid var(--border);
      padding:6px 8px; border-radius:999px;
      white-space:nowrap; flex:0 0 auto;
      cursor:pointer;
    }
    .chip.active{background:var(--primary); color:#fff; border-color:var(--primary);}

    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
    }
    .rowtop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .title{font-weight:900; font-size:16px}
    .meta{color:#374151; font-weight:900; font-size:13px; margin-top:4px}
    .badges{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
      border:1px solid var(--border);
      background:var(--pill);
      white-space:nowrap;
    }
    .badge.near{background:var(--near); border-color:#fecaca}
    .badge.expired{background:var(--expired)}
    .badge.physical{background:#ecfeff; border-color:#a5f3fc}
    .badge.type{background:#eef2ff; border-color:#c7d2fe}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .actionbtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }

    .kv{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed var(--border); font-weight:900;}
    .kv:last-child{border-bottom:none}
    .kv span{color:#374151; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left;}

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:780px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
      max-height:90vh;
      overflow:auto;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modal-title{font-weight:900;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}

    @media(min-width:700px){ body{max-width:900px;margin:auto} }
  </style>
</head>

<body>
<h1>ğŸŸï¸ ×§×•×¤×•× ×™× ×•×©×•×‘×¨×™×</h1>

<div class="tabs">
  <button class="tabbtn active" type="button" onclick="showTab('active')">×¤×¢×™×œ×™×</button>
  <button class="tabbtn" type="button" onclick="showTab('archive')">××¨×›×™×•×Ÿ</button>
  <button class="tabbtn" type="button" onclick="showTab('manage')">× ×™×”×•×œ</button>
  <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
</div>

<section id="view-active" class="view active">
  <section class="card">
    <div class="toolbar">
      <div class="toolbar-left" style="flex:1;">
        <input id="q" class="search" placeholder="×—×™×¤×•×©: ×©× ×©×•×‘×¨ / ×¨×©×ª / ×—× ×•×ª" oninput="renderActive()">
        <select id="sortMode" onchange="renderActive()" style="max-width:220px;">
          <option value="smart" selected>××™×•×Ÿ ×—×›× (×›×•×œ×œ ×ª×•×§×£)</option>
          <option value="expiry">×ª×•×§×£ ×§×¨×•×‘</option>
          <option value="value">×™×ª×¨×” ×’×‘×•×”×”</option>
          <option value="name">×©× (×-×‘)</option>
        </select>
      </div>
      <div class="toolbar-right">
        <button class="btn primary" type="button" onclick="openVoucherModal(null)">+ ×”×•×¡×£ ×©×•×‘×¨</button>
      </div>
    </div>

    <div class="chips" id="filterChips"></div>

    <div class="note" id="activeHint"></div>

    <ul id="activeList"></ul>
  </section>
</section>

<section id="view-archive" class="view">
  <section class="card">
    <div class="toolbar">
      <div class="toolbar-left" style="flex:1;">
        <input id="q2" class="search" placeholder="×—×™×¤×•×© ×‘××¨×›×™×•×Ÿ" oninput="renderArchive()">
        <select id="sortArchive" onchange="renderArchive()" style="max-width:220px;">
          <option value="recent" selected>×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”</option>
          <option value="expiry">×ª×•×§×£</option>
          <option value="name">×©× (×-×‘)</option>
        </select>
      </div>
    </div>
    <ul id="archiveList"></ul>
  </section>
</section>

<section id="view-manage" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ××•×ª×’×™× / ×—× ×•×™×•×ª / ×§×˜×’×•×¨×™×•×ª</h2>

    <div class="chips">
      <div class="chip active" id="mg-brands" onclick="showManage('brands')">××•×ª×’×™×</div>
      <div class="chip" id="mg-stores" onclick="showManage('stores')">×—× ×•×™×•×ª</div>
      <div class="chip" id="mg-cats" onclick="showManage('cats')">×§×˜×’×•×¨×™×•×ª</div>
    </div>

    <div id="manage-brands">
      <h3>××•×ª×’×™× (×¨×©×ª ×¨××©×™×ª)</h3>
      <div class="inline">
        <input id="newBrandName" placeholder="×©× ××•×ª×’ (×œ××©×œ DREAM / LOVE)">
        <button class="btn primary" type="button" onclick="addBrand()">×”×•×¡×£</button>
      </div>
      <div class="note">××¤×©×¨ ×œ×©×™×™×š ×—× ×•×™×•×ª ×œ××•×ª×’ ×’× ××ª×•×š ×¢×¨×™×›×ª ×©×•×‘×¨.</div>
      <ul id="brandsList"></ul>
    </div>

    <div id="manage-stores" style="display:none;">
      <h3>×—× ×•×™×•×ª</h3>
      <div class="inline">
        <input id="newStoreName" placeholder="×©× ×—× ×•×ª (×œ××©×œ ×§×¡×˜×¨×•)">
        <button class="btn primary" type="button" onclick="addStore()">×”×•×¡×£</button>
      </div>
      <div class="note">×—× ×•×ª ×™×›×•×œ×” ×œ×”×©×ª×™×™×š ×œ×›××” ××•×ª×’×™×, ×•××¤×©×¨ ×œ×¡×•×•×’ ×œ×§×˜×’×•×¨×™×•×ª.</div>
      <ul id="storesList"></ul>
    </div>

    <div id="manage-cats" style="display:none;">
      <h3>×§×˜×’×•×¨×™×•×ª</h3>
      <div class="inline">
        <input id="newCatName" placeholder="×©× ×§×˜×’×•×¨×™×” (×œ××©×œ ××•×¤× ×” / ××¡×¢×“×•×ª)">
        <button class="btn primary" type="button" onclick="addCategory()">×”×•×¡×£</button>
      </div>
      <ul id="catsList"></ul>
    </div>

  </section>
</section>

<section id="view-data" class="view">
  <section class="card">
    <h2>×¡× ×›×¨×•×Ÿ ×•×’×™×‘×•×™</h2>
    <div class="note" id="syncStatusLine"></div>
    <div class="note" id="syncLastLine"></div>

    <div class="inline" style="margin-top:10px;">
      <button class="btn ghost" type="button" onclick="cloudPull()">××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ</button>
      <button class="btn ok" type="button" onclick="cloudPush()">×©×œ×— × ×ª×•× ×™× ×œ×¢× ×Ÿ</button>
      <button class="btn ghost" type="button" onclick="backupNow()">×’×™×‘×•×™ ×œ×§×•×‘×¥</button>
      <button class="btn ghost" type="button" onclick="triggerRestore()">×˜×¢×™× ×ª ×’×™×‘×•×™</button>
    </div>

    <input id="restoreFile" type="file" accept=".json,application/json" style="display:none" onchange="restoreFromFile(event)">

    <div class="note" style="margin-top:10px;">
      ×˜×™×¤: ×× ×™×© â€œ×”×ª× ×’×©×•×ªâ€ ×‘×™×Ÿ ××›×©×™×¨×™× â€” ×¤×©×•×˜ ××©×›×• ××”×¢× ×Ÿ ×•××– ×©×œ×—×• ××—×“×©.
      ×‘××§×¨×” ×©×œ ×”×ª× ×’×©×•×ª ×××™×ª×™×ª, <b>Yanir ×× ×¦×—</b>.
    </div>
  </section>

  <section class="card">
    <h2>×”×’×“×¨×•×ª ××›×©×™×¨</h2>
    <div class="note">×‘×¨×™×¨×ª ××—×“×œ: Yanir ×‘××›×©×™×¨ ××—×“, Wife ×‘××›×©×™×¨ ×”×©× ×™.</div>
    <div class="inline">
      <select id="deviceName" onchange="setDeviceName(this.value)">
        <option value="Yanir">Yanir</option>
        <option value="Wife">Wife</option>
      </select>
      <button class="btn danger" type="button" onclick="resetAll()">××™×¤×•×¡ ××§×•××™</button>
    </div>
  </section>
</section>

<!-- Voucher modal -->
<div id="voucherBackdrop" class="modal-backdrop" onclick="closeVoucherModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="voucherTitle">+ ×©×•×‘×¨ ×—×“×©</div>
      <div class="modal-actions">
        <button class="tinybtn" type="button" onclick="saveVoucher()">×©××™×¨×”</button>
        <button class="tinybtn" type="button" onclick="hideVoucherModal()">×¡×’×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>×©× ×”×©×•×‘×¨</label>
      <input id="v_title" placeholder="×œ××©×œ: ×©×•×‘×¨ DREAM / LOVE / ×§×¡×˜×¨×•">
    </div>

    <div class="field">
      <label>×¡×•×’</label>
      <select id="v_type" onchange="renderTypeFields()">
        <option value="money">×©×•×‘×¨ ×›×¡×¤×™</option>
        <option value="percent">××—×•×– ×”× ×—×”</option>
        <option value="bogo">1+1 / ××‘×¦×¢</option>
        <option value="generic" selected>×›×œ×œ×™</option>
      </select>
      <div class="note">×× ××©×”×• ×œ× ××ª××™× â€” ×‘×—×¨ â€œ×›×œ×œ×™â€ ×•×›×ª×•×‘ ×‘×¤×¨×˜×™×.</div>
    </div>

    <div class="field" style="margin-top:12px;">
      <label style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="v_physical" onchange="renderTypeFields()" style="width:18px;height:18px;margin:0">
        ×›×¨×˜×™×¡ ×¤×™×–×™ (××™×Ÿ ×§×•×“ ×œ×”×¢×ª×§×”)
      </label>
    </div>

    <div class="field" id="codeWrap">
      <label>×§×•×“ (××•×¤×¦×™×•× ×œ×™)</label>
      <input id="v_code" placeholder="×”×“×‘×§ ×§×•×“ ×›××Ÿ">
      <div class="note">××—×¨ ×›×š ×™×”×™×” ×›×¤×ª×•×¨ â€œ×”×¢×ª×§ ×§×•×“â€.</div>
    </div>

    <div class="field">
      <label>×ª×•×§×£ (××•×¤×¦×™×•× ×œ×™)</label>
      <input type="date" id="v_exp">
      <div class="note"><= 3 ×—×•×“×©×™× ×™×¡×•××Ÿ â€œ×§×¨×•×‘ ×œ×¤×§×™×¢×”â€ ×•×™×§×¤×•×¥ ×œ×¨××©.</div>
    </div>

    <div class="field" id="moneyWrap" style="display:none;">
      <h3>×¢×¨×š / × ×™×¦×•×œ</h3>
      <div class="inline">
        <input id="v_face" inputmode="decimal" placeholder="×¢×¨×š ××§×•×¨×™ (×œ××©×œ 500)">
        <input id="v_used" inputmode="decimal" placeholder="× ×•×¦×œ (×œ××©×œ 200)">
      </div>
      <div class="note">××™×Ÿ ×”×™×¡×˜×•×¨×™×” â€” ×¨×§ ×¡×›×•× × ×•×¦×œ/×™×ª×¨×” (×›××• ×©×‘×™×§×©×ª).</div>
    </div>

    <div class="field" id="percentWrap" style="display:none;">
      <h3>××—×•×–/×ª×§×¨×•×ª</h3>
      <input id="v_details_percent" placeholder='×œ××©×œ: "20% ×¢×“ 200â‚ª" ××• "20% ×¢×œ 200â‚ª"'>
      <div class="note">×× ×™×© â€œ×™×ª×¨×”â€ (×œ××©×œ × ×©××¨ 20â‚ª ××ª×•×š 200) â€” ××¤×©×¨ ×œ×”×©×ª××© ×‘×¢×¨×š/× ×•×¦×œ ×œ××¢×œ×”.</div>
    </div>

    <div class="field" id="bogoWrap" style="display:none;">
      <h3>×¤×™×¨×•×˜ ××‘×¦×¢</h3>
      <input id="v_details_bogo" placeholder='×œ××©×œ: "1+1 ×¢×œ ×§×¤×”", "2+1", "××ª× ×” ×‘×”×¦×˜×¨×¤×•×ª"'>
    </div>

    <div class="field">
      <label>×¤×¨×˜×™× / ×”×¢×¨×•×ª</label>
      <textarea id="v_notes" placeholder="×›×œ ××” ×©×—×©×•×‘ ×œ×–×›×•×¨â€¦"></textarea>
    </div>

    <div class="field">
      <h3>××•×ª×’×™× (×¨×©×ª ×¨××©×™×ª) â€” ×¨×‘ ×‘×—×™×¨×”</h3>
      <select id="v_brands" multiple size="5"></select>
      <div class="inline" style="margin-top:8px;">
        <input id="quickBrand" placeholder="×”×•×¡×£ ××•×ª×’ ×—×“×©â€¦">
        <button class="tinybtn" type="button" onclick="quickAddBrand()">×”×•×¡×£</button>
      </div>
    </div>

    <div class="field">
      <h3>×—× ×•×™×•×ª ×ª×§×¤×•×ª â€” ×¨×‘ ×‘×—×™×¨×”</h3>
      <select id="v_stores" multiple size="6"></select>
      <div class="inline" style="margin-top:8px;">
        <input id="quickStore" placeholder="×”×•×¡×£ ×—× ×•×ª ×—×“×©×”â€¦">
        <button class="tinybtn" type="button" onclick="quickAddStore()">×”×•×¡×£</button>
      </div>
      <div class="note">××¡×¤×™×§ ×œ×‘×—×•×¨ ×—× ×•×ª ××—×ª ××• ××•×ª×’ ××—×“ (×—×•×‘×” ×œ×¤×—×•×ª ××—×“).</div>
    </div>

  </div>
</div>

<!-- View voucher modal -->
<div id="viewBackdrop" class="modal-backdrop" onclick="closeViewModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="viewTitle">×©×•×‘×¨</div>
      <div class="modal-actions">
        <button class="tinybtn" type="button" onclick="copyCode()">×”×¢×ª×§ ×§×•×“</button>
        <button class="tinybtn" type="button" onclick="markAsUsed()">×¡××Ÿ × ×•×¦×œ/×¡×™×™×</button>
        <button class="tinybtn" type="button" onclick="editCurrent()">×¢×¨×™×›×”</button>
        <button class="tinybtn" type="button" onclick="hideViewModal()">×¡×’×•×¨</button>
      </div>
    </div>

    <div id="viewBody"></div>

    <div class="field" style="margin-top:12px;">
      <button class="btn danger" type="button" onclick="archiveCurrentManual()">×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ (×™×“× ×™)</button>
    </div>
  </div>
</div>

<script>
  // ===== Service Worker registration =====
  (function(){
    if (!("serviceWorker" in navigator)) return;
    navigator.serviceWorker.register("./sw.js").catch(function(){});
  })();

  // ===== CONFIG (××ª ×”-URL ×ª×¢×“×›×Ÿ ××—×¨×™ ×©×ª×™×¦×•×¨ Apps Script ×—×“×©) =====
  var SYNC_URL = "https://script.google.com/macros/s/AKfycbzq9M_mKke4GTDeVPIHHfF-NFu5Yb7MADNVdeaYiuIn_S4LmkqhYejJw7DT9vR7HZG6/exec";
  var SYNC_TOKEN = "CUPN_7f3a9c2e_YANIR_MASTER_2026";

  // ===== Storage keys =====
  var KEY = "couponApp_v1";
  var META_KEY = "couponApp_cloudMeta";
  var LAST_SYNC_AT_KEY = "couponApp_lastSyncAt";
  var DAY = 24*60*60*1000;
  var NEAR_DAYS = 90;

  // ===== Device =====
  function isIOS(){ return /iphone|ipad|ipod/i.test(navigator.userAgent); }
  var DEVICE_NAME = (function(){
    var saved = localStorage.getItem("deviceName_couponapp");
    if(saved) return saved;
    var guess = isIOS() ? "Wife" : "Yanir";
    localStorage.setItem("deviceName_couponapp", guess);
    return guess;
  })();

  function setDeviceName(name){
    DEVICE_NAME = name;
    localStorage.setItem("deviceName_couponapp", name);
    setSyncMsg("××›×©×™×¨: " + DEVICE_NAME);
  }
  window.setDeviceName = setDeviceName;

  function $(id){ return document.getElementById(id); }

  function safeJSONParse(s, fallback){ try{ return JSON.parse(s); }catch(e){ return fallback; } }
  function uid(){ return "v_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
  function now(){ return Date.now(); }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtDate(ms){
    if(!ms) return "â€”";
    var d = new Date(ms);
    return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
  }
  function isoToMs(iso){
    if(!iso) return 0;
    return new Date(iso + "T00:00:00").getTime();
  }
  function msToIso(ms){
    if(!ms) return "";
    var d = new Date(ms);
    return d.toISOString().slice(0,10);
  }

  // ===== Data model in memory =====
  var state = safeJSONParse(localStorage.getItem(KEY), null) || {
    brands: [],      // {id,name}
    stores: [],      // {id,name, categoryIds:[]}
    categories: [],  // {id,name}
    vouchers: []     // see below
  };

  function getLocalMeta(){
    return safeJSONParse(localStorage.getItem(META_KEY) || "null", { updatedAt:0, updatedBy:"" });
  }
  function setLocalMeta(meta){
    localStorage.setItem(META_KEY, JSON.stringify(meta || { updatedAt:0, updatedBy:"" }));
  }

  function saveLocal(){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  function setLastSyncNow(){
    localStorage.setItem(LAST_SYNC_AT_KEY, String(Date.now()));
    renderSyncLastLine();
  }
  function renderSyncLastLine(){
    var v = Number(localStorage.getItem(LAST_SYNC_AT_KEY) || "0");
    $("syncLastLine").textContent = v ? ("×¡×•× ×›×¨×Ÿ/× ××©×š ×œ××—×¨×•× ×”: " + fmtDate(v) + " " + (new Date(v).toTimeString().slice(0,5))) : "×¡×•× ×›×¨×Ÿ/× ××©×š ×œ××—×¨×•× ×”: â€”";
  }
  function setSyncMsg(msg){
    $("syncStatusLine").textContent = msg || "";
  }

  // ===== Tabs =====
  function showTab(key){
    var btns = document.querySelectorAll(".tabbtn");
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
    var views = document.querySelectorAll(".view");
    for(var j=0;j<views.length;j++) views[j].classList.remove("active");

    var idx=0, viewId="view-active";
    if(key==="archive"){ idx=1; viewId="view-archive"; }
    else if(key==="manage"){ idx=2; viewId="view-manage"; }
    else if(key==="data"){ idx=3; viewId="view-data"; }

    btns[idx].classList.add("active");
    $(viewId).classList.add("active");

    if(key==="active") renderActive();
    if(key==="archive") renderArchive();
    if(key==="manage") renderManage();
    if(key==="data"){
      $("deviceName").value = DEVICE_NAME;
      renderSyncLastLine();
      setSyncMsg("××›×©×™×¨: " + DEVICE_NAME);
    }
  }
  window.showTab = showTab;

  // ===== Manage subviews =====
  function showManage(which){
    $("mg-brands").classList.remove("active");
    $("mg-stores").classList.remove("active");
    $("mg-cats").classList.remove("active");
    $("manage-brands").style.display = "none";
    $("manage-stores").style.display = "none";
    $("manage-cats").style.display = "none";

    if(which==="brands"){
      $("mg-brands").classList.add("active");
      $("manage-brands").style.display = "block";
    } else if(which==="stores"){
      $("mg-stores").classList.add("active");
      $("manage-stores").style.display = "block";
    } else {
      $("mg-cats").classList.add("active");
      $("manage-cats").style.display = "block";
    }
  }
  window.showManage = showManage;

  // ===== Helpers =====
  function normalizeName(s){ return String(s||"").trim(); }
  function byName(a,b){ return String(a.name||"").localeCompare(String(b.name||""), "he"); }

  function findById(arr, id){
    for(var i=0;i<arr.length;i++) if(arr[i].id===id) return arr[i];
    return null;
  }
  function idsToNames(arr, ids){
    ids = Array.isArray(ids) ? ids : [];
    var names = [];
    for(var i=0;i<ids.length;i++){
      var o = findById(arr, ids[i]);
      if(o) names.push(o.name);
    }
    return names;
  }

  function remainingValue(v){
    var face = Number(v.faceValue || 0);
    var used = Number(v.usedValue || 0);
    if(!face) return null;
    var rem = face - used;
    if(rem < 0) rem = 0;
    return rem;
  }

  function isExpired(v){
    var exp = Number(v.expiresAt || 0);
    if(!exp) return false;
    return exp < (new Date().setHours(0,0,0,0));
  }

  function isNear(v){
    var exp = Number(v.expiresAt || 0);
    if(!exp) return false;
    var today0 = new Date().setHours(0,0,0,0);
    var diffDays = Math.floor((exp - today0) / DAY);
    return diffDays >= 0 && diffDays <= NEAR_DAYS;
  }

  function touch(v){
    v.updatedAt = Date.now();
    v.updatedBy = DEVICE_NAME;
    return v;
  }

  function autoArchiveRules(){
    var changed = false;
    state.vouchers.forEach(function(v){
      if(v.status !== "active") return;

      // expired -> archive
      if(isExpired(v)){
        v.status = "archived";
        v.archivedReason = "expired";
        touch(v);
        changed = true;
        return;
      }

      // spent -> archive for money/percent/generic/bogo if remaining becomes 0 and face exists
      var rem = remainingValue(v);
      if(rem !== null && rem === 0){
        v.status = "archived";
        v.archivedReason = "spent";
        touch(v);
        changed = true;
      }
    });
    if(changed) saveLocal();
  }

  // ===== Chips (filters) =====
  var activeChip = "all"; // all / near / expired (expired shouldn't appear in active after autoArchive, but keep) / brand:<id> / store:<id>
  function buildFilterChips(){
    var host = $("filterChips");
    host.innerHTML = "";

    function mk(label, key){
      var d = document.createElement("div");
      d.className = "chip" + (activeChip===key ? " active" : "");
      d.textContent = label;
      d.onclick = function(){ activeChip = key; renderActive(); };
      host.appendChild(d);
    }

    mk("×”×›×•×œ", "all");
    mk("×§×¨×•×‘ ×œ×¤×§×™×¢×” (â‰¤3 ×—×³)", "near");

    // dynamic: brands (top 10 alphabetic)
    var brands = state.brands.slice().sort(byName);
    brands.forEach(function(b){
      mk("ğŸ·ï¸ " + b.name, "brand:"+b.id);
    });

    // dynamic: stores (optional; keep smaller)
    var stores = state.stores.slice().sort(byName).slice(0, 10);
    stores.forEach(function(s){
      mk("ğŸ¬ " + s.name, "store:"+s.id);
    });
  }

  // ===== Render Active =====
  function matchQuery(v, q){
    q = (q||"").trim().toLowerCase();
    if(!q) return true;

    var title = String(v.title||"").toLowerCase();
    if(title.indexOf(q)>=0) return true;

    var bnames = idsToNames(state.brands, v.brandIds).join(" ").toLowerCase();
    var snames = idsToNames(state.stores, v.storeIds).join(" ").toLowerCase();
    if(bnames.indexOf(q)>=0) return true;
    if(snames.indexOf(q)>=0) return true;

    return false;
  }

  function brandFrequencyMap(){
    var freq = {};
    state.vouchers.forEach(function(v){
      if(v.status!=="active") return;
      (v.brandIds||[]).forEach(function(id){
        freq[id] = (freq[id]||0) + 1;
      });
    });
    return freq;
  }

  function smartCompare(a,b){
    // 1) near expiry first
    var an = isNear(a) ? 1 : 0;
    var bn = isNear(b) ? 1 : 0;
    if(bn !== an) return bn - an;

    // 2) brand repeats more first (max freq among its brands)
    var freq = brandFrequencyMap();
    function maxFreq(v){
      var ids = v.brandIds||[];
      var m = 0;
      for(var i=0;i<ids.length;i++) m = Math.max(m, freq[ids[i]]||0);
      return m;
    }
    var af = maxFreq(a), bf = maxFreq(b);
    if(bf !== af) return bf - af;

    // 3) remaining value desc
    var ar = remainingValue(a); if(ar===null) ar = -1;
    var br = remainingValue(b); if(br===null) br = -1;
    if(br !== ar) return br - ar;

    // 4) name
    return String(a.title||"").localeCompare(String(b.title||""), "he");
  }

  function renderVoucherItem(v){
    var li = document.createElement("li");

    var top = document.createElement("div");
    top.className = "rowtop";

    var left = document.createElement("div");
    left.style.flex = "1";

    var t = document.createElement("div");
    t.className = "title";
    t.textContent = v.title || "â€”";
    left.appendChild(t);

    var meta = document.createElement("div");
    meta.className = "meta";

    var bnames = idsToNames(state.brands, v.brandIds);
    var snames = idsToNames(state.stores, v.storeIds);

    var parts = [];
    if(bnames.length) parts.push("××•×ª×’: " + bnames.join(", "));
    if(snames.length) parts.push("×—× ×•×™×•×ª: " + snames.join(", "));
    meta.textContent = parts.length ? parts.join(" â€¢ ") : "â€”";
    left.appendChild(meta);

    var badges = document.createElement("div");
    badges.className = "badges";

    var typeLabel = (v.type==="money"?"×›×¡×¤×™":v.type==="percent"?"××—×•×–":v.type==="bogo"?"1+1":"×›×œ×œ×™");
    var bt = document.createElement("div");
    bt.className = "badge type";
    bt.textContent = "×¡×•×’: " + typeLabel;
    badges.appendChild(bt);

    if(v.isPhysical){
      var bp = document.createElement("div");
      bp.className = "badge physical";
      bp.textContent = "×›×¨×˜×™×¡ ×¤×™×–×™";
      badges.appendChild(bp);
    }

    if(v.expiresAt){
      var exp = document.createElement("div");
      exp.className = "badge" + (isExpired(v) ? " expired" : (isNear(v) ? " near" : ""));
      exp.textContent = "×ª×•×§×£: " + fmtDate(v.expiresAt);
      badges.appendChild(exp);
    }

    var rem = remainingValue(v);
    if(rem !== null){
      var bv = document.createElement("div");
      bv.className = "badge";
      bv.textContent = "×™×ª×¨×”: " + rem;
      badges.appendChild(bv);
    }

    left.appendChild(badges);

    var right = document.createElement("div");
    right.className = "actions";

    var viewBtn = document.createElement("button");
    viewBtn.className = "actionbtn";
    viewBtn.textContent = "×¤×ª×—";
    viewBtn.onclick = function(){ openViewModal(v.id); };
    right.appendChild(viewBtn);

    if(v.code && !v.isPhysical){
      var copyBtn = document.createElement("button");
      copyBtn.className = "actionbtn";
      copyBtn.textContent = "×”×¢×ª×§ ×§×•×“";
      copyBtn.onclick = function(e){ e.stopPropagation(); copyText(v.code); };
      right.appendChild(copyBtn);
    }

    var doneBtn = document.createElement("button");
    doneBtn.className = "actionbtn";
    doneBtn.textContent = "×¡×™×™×";
    doneBtn.onclick = function(e){ e.stopPropagation(); markAsUsedById(v.id); };
    right.appendChild(doneBtn);

    top.appendChild(left);
    top.appendChild(right);

    li.appendChild(top);
    return li;
  }

  function applyChipFilter(list){
    if(activeChip==="all") return list;
    if(activeChip==="near") return list.filter(isNear);

    if(activeChip.indexOf("brand:")===0){
      var id = activeChip.split(":")[1];
      return list.filter(function(v){ return (v.brandIds||[]).indexOf(id)>=0; });
    }
    if(activeChip.indexOf("store:")===0){
      var id2 = activeChip.split(":")[1];
      return list.filter(function(v){ return (v.storeIds||[]).indexOf(id2)>=0; });
    }
    return list;
  }

  function renderActive(){
    autoArchiveRules();
    buildFilterChips();

    var q = ($("q").value||"").trim();
    var sortMode = $("sortMode").value;

    var list = state.vouchers.filter(function(v){ return v.status==="active"; });
    list = applyChipFilter(list);
    list = list.filter(function(v){ return matchQuery(v, q); });

    if(sortMode==="smart"){
      list.sort(smartCompare);
    } else if(sortMode==="expiry"){
      list.sort(function(a,b){
        var ae = a.expiresAt || 0;
        var be = b.expiresAt || 0;
        // ones with expiry first
        if(!!be !== !!ae) return (be?1:0)-(ae?1:0);
        if(ae!==be) return ae - be;
        return String(a.title||"").localeCompare(String(b.title||""),"he");
      });
    } else if(sortMode==="value"){
      list.sort(function(a,b){
        var ar = remainingValue(a); if(ar===null) ar = -1;
        var br = remainingValue(b); if(br===null) br = -1;
        if(br!==ar) return br - ar;
        return String(a.title||"").localeCompare(String(b.title||""),"he");
      });
    } else {
      list.sort(function(a,b){ return String(a.title||"").localeCompare(String(b.title||""),"he"); });
    }

    $("activeHint").textContent = list.length ? ("××•×¦×’×™× " + list.length + " ×©×•×‘×¨×™×") : "××™×Ÿ ×©×•×‘×¨×™× ×œ×”×¦×’×” (× ×¡×• ×œ×”×¡×™×¨ ×¤×™×œ×˜×¨/×—×™×¤×•×©).";

    var ul = $("activeList");
    ul.innerHTML = "";
    list.forEach(function(v){ ul.appendChild(renderVoucherItem(v)); });
  }
  window.renderActive = renderActive;

  // ===== Archive =====
  function renderArchive(){
    var q = ($("q2").value||"").trim();
    var mode = $("sortArchive").value;

    var list = state.vouchers.filter(function(v){ return v.status==="archived"; });
    list = list.filter(function(v){ return matchQuery(v, q); });

    if(mode==="recent"){
      list.sort(function(a,b){ return (b.updatedAt||0)-(a.updatedAt||0); });
    } else if(mode==="expiry"){
      list.sort(function(a,b){
        var ae=a.expiresAt||0, be=b.expiresAt||0;
        if(ae!==be) return ae-be;
        return String(a.title||"").localeCompare(String(b.title||""),"he");
      });
    } else {
      list.sort(function(a,b){ return String(a.title||"").localeCompare(String(b.title||""),"he"); });
    }

    var ul = $("archiveList");
    ul.innerHTML = "";
    list.forEach(function(v){
      var li = document.createElement("li");
      li.appendChild(renderVoucherItem(v));
      // renderVoucherItem returns <li>, but we nested; keep it simple:
      ul.appendChild(renderVoucherItem(v));
    });
  }
  window.renderArchive = renderArchive;

  // ===== Manage: Brands/Stores/Cats =====
  function addBrand(){
    var name = normalizeName($("newBrandName").value);
    if(!name) return;
    if(state.brands.some(function(b){ return b.name===name; })) return alert("××•×ª×’ ×›×‘×¨ ×§×™×™×");
    state.brands.push({ id:uid(), name:name });
    $("newBrandName").value="";
    saveLocal();
    renderManage();
    renderActive();
  }
  window.addBrand = addBrand;

  function addStore(){
    var name = normalizeName($("newStoreName").value);
    if(!name) return;
    if(state.stores.some(function(s){ return s.name===name; })) return alert("×—× ×•×ª ×›×‘×¨ ×§×™×™××ª");
    state.stores.push({ id:uid(), name:name, categoryIds:[] });
    $("newStoreName").value="";
    saveLocal();
    renderManage();
    renderActive();
  }
  window.addStore = addStore;

  function addCategory(){
    var name = normalizeName($("newCatName").value);
    if(!name) return;
    if(state.categories.some(function(c){ return c.name===name; })) return alert("×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª");
    state.categories.push({ id:uid(), name:name });
    $("newCatName").value="";
    saveLocal();
    renderManage();
  }
  window.addCategory = addCategory;

  function removeBrand(id){
    if(!confirm("×œ××—×•×§ ××•×ª×’?")) return;
    state.brands = state.brands.filter(function(b){ return b.id!==id; });
    // remove from vouchers
    state.vouchers.forEach(function(v){
      v.brandIds = (v.brandIds||[]).filter(function(x){ return x!==id; });
    });
    saveLocal();
    renderManage(); renderActive();
  }

  function removeStore(id){
    if(!confirm("×œ××—×•×§ ×—× ×•×ª?")) return;
    state.stores = state.stores.filter(function(s){ return s.id!==id; });
    state.vouchers.forEach(function(v){
      v.storeIds = (v.storeIds||[]).filter(function(x){ return x!==id; });
    });
    saveLocal();
    renderManage(); renderActive();
  }

  function removeCategory(id){
    if(!confirm("×œ××—×•×§ ×§×˜×’×•×¨×™×”?")) return;
    state.categories = state.categories.filter(function(c){ return c.id!==id; });
    state.stores.forEach(function(s){
      s.categoryIds = (s.categoryIds||[]).filter(function(x){ return x!==id; });
    });
    saveLocal();
    renderManage();
  }

  function toggleStoreCat(storeId, catId, on){
    var s = findById(state.stores, storeId);
    if(!s) return;
    s.categoryIds = Array.isArray(s.categoryIds) ? s.categoryIds : [];
    var has = s.categoryIds.indexOf(catId)>=0;
    if(on && !has) s.categoryIds.push(catId);
    if(!on && has) s.categoryIds = s.categoryIds.filter(function(x){ return x!==catId; });
    saveLocal();
  }

  function renderManage(){
    // brands
    var bl = $("brandsList");
    bl.innerHTML = "";
    state.brands.slice().sort(byName).forEach(function(b){
      var li = document.createElement("li");
      li.innerHTML = '<div class="rowtop"><div class="title">'+escapeHtml(b.name)+'</div><div class="actions"><button class="actionbtn">××—×§</button></div></div>';
      li.querySelector("button").onclick = function(){ removeBrand(b.id); };
      bl.appendChild(li);
    });

    // stores
    var sl = $("storesList");
    sl.innerHTML = "";
    var cats = state.categories.slice().sort(byName);
    state.stores.slice().sort(byName).forEach(function(s){
      var li2 = document.createElement("li");
      var html = '<div class="rowtop"><div><div class="title">'+escapeHtml(s.name)+'</div><div class="meta">×¡×™×•×•×’×™×: '+
        (idsToNames(state.categories, s.categoryIds||[]).join(", ") || "â€”")+
        '</div></div><div class="actions"><button class="actionbtn">××—×§</button></div></div>';

      if(cats.length){
        html += '<div class="badges" style="margin-top:10px;">';
        cats.forEach(function(c){
          var on = (s.categoryIds||[]).indexOf(c.id)>=0;
          html += '<span class="badge" style="cursor:pointer;" data-cat="'+c.id+'" data-on="'+(on?1:0)+'">'+escapeHtml(c.name)+'</span>';
        });
        html += '</div><div class="note">×œ×—×™×¦×” ×¢×œ ×§×˜×’×•×¨×™×” ××•×¡×™×¤×”/××¡×™×¨×”.</div>';
      } else {
        html += '<div class="note" style="margin-top:10px;">××™×Ÿ ×§×˜×’×•×¨×™×•×ª ×¢×“×™×™×Ÿ.</div>';
      }

      li2.innerHTML = html;
      li2.querySelector("button").onclick = function(){ removeStore(s.id); };

      var badges = li2.querySelectorAll(".badge[data-cat]");
      for(var i=0;i<badges.length;i++){
        (function(el){
          el.onclick = function(){
            var catId = el.getAttribute("data-cat");
            var on = el.getAttribute("data-on")==="1";
            toggleStoreCat(s.id, catId, !on);
            renderManage();
          };
        })(badges[i]);
      }

      sl.appendChild(li2);
    });

    // cats
    var cl = $("catsList");
    cl.innerHTML = "";
    state.categories.slice().sort(byName).forEach(function(c){
      var li3 = document.createElement("li");
      li3.innerHTML = '<div class="rowtop"><div class="title">'+escapeHtml(c.name)+'</div><div class="actions"><button class="actionbtn">××—×§</button></div></div>';
      li3.querySelector("button").onclick = function(){ removeCategory(c.id); };
      cl.appendChild(li3);
    });
  }
  window.renderManage = renderManage;

  function escapeHtml(s){
    s = String(s);
    return s.replace(/[&<>"']/g, function(m){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[m];
    });
  }

  // ===== Voucher modal: add/edit =====
  var editId = null;

  function fillMultiSelect(sel, items, selectedIds){
    sel.innerHTML = "";
    items.slice().sort(byName).forEach(function(o){
      var opt = document.createElement("option");
      opt.value = o.id;
      opt.textContent = o.name;
      if((selectedIds||[]).indexOf(o.id)>=0) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  function getSelectedIds(sel){
    var out = [];
    for(var i=0;i<sel.options.length;i++){
      if(sel.options[i].selected) out.push(sel.options[i].value);
    }
    return out;
  }

  function renderTypeFields(){
    var type = $("v_type").value;
    var physical = $("v_physical").checked;

    $("codeWrap").style.display = physical ? "none" : "block";

    $("moneyWrap").style.display = (type==="money" || type==="percent") ? "block" : "none";
    $("percentWrap").style.display = (type==="percent") ? "block" : "none";
    $("bogoWrap").style.display = (type==="bogo") ? "block" : "none";
  }

  function openVoucherModal(id){
    editId = id;
    $("voucherBackdrop").style.display = "flex";
    $("voucherTitle").textContent = id ? "âœï¸ ×¢×¨×™×›×ª ×©×•×‘×¨" : "+ ×©×•×‘×¨ ×—×“×©";

    // fill lists
    fillMultiSelect($("v_brands"), state.brands, []);
    fillMultiSelect($("v_stores"), state.stores, []);

    // reset fields
    $("v_title").value = "";
    $("v_type").value = "generic";
    $("v_physical").checked = false;
    $("v_code").value = "";
    $("v_exp").value = "";
    $("v_face").value = "";
    $("v_used").value = "";
    $("v_details_percent").value = "";
    $("v_details_bogo").value = "";
    $("v_notes").value = "";
    $("quickBrand").value = "";
    $("quickStore").value = "";

    if(id){
      var v = state.vouchers.find(function(x){ return x.id===id; });
      if(v){
        $("v_title").value = v.title || "";
        $("v_type").value = v.type || "generic";
        $("v_physical").checked = !!v.isPhysical;
        $("v_code").value = v.code || "";
        $("v_exp").value = msToIso(v.expiresAt || 0);
        $("v_face").value = (v.faceValue!=null ? String(v.faceValue) : "");
        $("v_used").value = (v.usedValue!=null ? String(v.usedValue) : "");
        $("v_notes").value = v.notes || "";
        $("v_details_percent").value = v.detailsPercent || "";
        $("v_details_bogo").value = v.detailsBogo || "";
        fillMultiSelect($("v_brands"), state.brands, v.brandIds||[]);
        fillMultiSelect($("v_stores"), state.stores, v.storeIds||[]);
      }
    }

    renderTypeFields();
  }
  window.openVoucherModal = openVoucherModal;

  function hideVoucherModal(){
    $("voucherBackdrop").style.display = "none";
    editId = null;
  }
  window.hideVoucherModal = hideVoucherModal;

  function closeVoucherModal(e){
    if(e.target === $("voucherBackdrop")) hideVoucherModal();
  }
  window.closeVoucherModal = closeVoucherModal;

  function quickAddBrand(){
    var name = normalizeName($("quickBrand").value);
    if(!name) return;
    if(state.brands.some(function(b){ return b.name===name; })) return alert("××•×ª×’ ×›×‘×¨ ×§×™×™×");
    var id = uid();
    state.brands.push({ id:id, name:name });
    saveLocal();
    $("quickBrand").value="";
    fillMultiSelect($("v_brands"), state.brands, getSelectedIds($("v_brands")).concat([id]));
    renderManage();
    buildFilterChips();
  }
  window.quickAddBrand = quickAddBrand;

  function quickAddStore(){
    var name = normalizeName($("quickStore").value);
    if(!name) return;
    if(state.stores.some(function(s){ return s.name===name; })) return alert("×—× ×•×ª ×›×‘×¨ ×§×™×™××ª");
    var id = uid();
    state.stores.push({ id:id, name:name, categoryIds:[] });
    saveLocal();
    $("quickStore").value="";
    fillMultiSelect($("v_stores"), state.stores, getSelectedIds($("v_stores")).concat([id]));
    renderManage();
    buildFilterChips();
  }
  window.quickAddStore = quickAddStore;

  function saveVoucher(){
    var title = normalizeName($("v_title").value);
    if(!title) return alert("×—×•×‘×” ×©× ×©×•×‘×¨");

    var brandIds = getSelectedIds($("v_brands"));
    var storeIds = getSelectedIds($("v_stores"));
    if(!brandIds.length && !storeIds.length) return alert("×—×•×‘×” ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××•×ª×’ ××—×“ ××• ×—× ×•×ª ××—×ª");

    var type = $("v_type").value;
    var isPhysicalCard = $("v_physical").checked;
    var code = normalizeName($("v_code").value);
    var expIso = $("v_exp").value;
    var expiresAt = expIso ? isoToMs(expIso) : 0;

    var face = normalizeName($("v_face").value);
    var used = normalizeName($("v_used").value);
    var faceValue = face ? Number(face) : null;
    var usedValue = used ? Number(used) : null;
    if(faceValue!=null && isNaN(faceValue)) return alert("×¢×¨×š ××§×•×¨×™ ×œ× ×ª×§×™×Ÿ");
    if(usedValue!=null && isNaN(usedValue)) return alert("× ×•×¦×œ ×œ× ×ª×§×™×Ÿ");
    if(faceValue!=null && usedValue!=null && usedValue > faceValue) usedValue = faceValue;

    var notes = $("v_notes").value || "";
    var detailsPercent = $("v_details_percent").value || "";
    var detailsBogo = $("v_details_bogo").value || "";

    if(isPhysicalCard) code = ""; // enforce

    if(editId){
      var v = state.vouchers.find(function(x){ return x.id===editId; });
      if(!v) return;
      v.title = title;
      v.brandIds = brandIds;
      v.storeIds = storeIds;
      v.type = type;
      v.isPhysical = isPhysicalCard;
      v.code = code;
      v.expiresAt = expiresAt;
      v.faceValue = faceValue;
      v.usedValue = usedValue;
      v.notes = notes;
      v.detailsPercent = detailsPercent;
      v.detailsBogo = detailsBogo;
      touch(v);
    } else {
      var v2 = {
        id: uid(),
        title: title,
        brandIds: brandIds,
        storeIds: storeIds,
        type: type,
        isPhysical: isPhysicalCard,
        code: code,
        expiresAt: expiresAt,
        faceValue: faceValue,
        usedValue: usedValue,
        notes: notes,
        detailsPercent: detailsPercent,
        detailsBogo: detailsBogo,
        status: "active",
        archivedReason: "",
        updatedAt: 0,
        updatedBy: ""
      };
      touch(v2);
      state.vouchers.push(v2);
    }

    saveLocal();
    hideVoucherModal();
    autoArchiveRules();
    renderActive();
  }
  window.saveVoucher = saveVoucher;

  // ===== View modal =====
  var viewId = null;

  function openViewModal(id){
    viewId = id;
    var v = state.vouchers.find(function(x){ return x.id===id; });
    if(!v) return;

    $("viewBackdrop").style.display = "flex";
    $("viewTitle").textContent = v.title || "×©×•×‘×¨";

    var body = $("viewBody");
    body.innerHTML = "";

    function addKV(k, val){
      var row = document.createElement("div");
      row.className = "kv";
      row.innerHTML = "<b>"+escapeHtml(k)+"</b><span>"+escapeHtml(val==null?"â€”":String(val))+"</span>";
      body.appendChild(row);
    }

    addKV("×¡×•×’", (v.type==="money"?"×›×¡×¤×™":v.type==="percent"?"××—×•×–":v.type==="bogo"?"1+1":"×›×œ×œ×™"));
    addKV("×›×¨×˜×™×¡ ×¤×™×–×™", v.isPhysical ? "×›×Ÿ" : "×œ×");

    var bnames = idsToNames(state.brands, v.brandIds).join(", ") || "â€”";
    var snames = idsToNames(state.stores, v.storeIds).join(", ") || "â€”";
    addKV("××•×ª×’×™×", bnames);
    addKV("×—× ×•×™×•×ª", snames);

    addKV("×ª×•×§×£", v.expiresAt ? fmtDate(v.expiresAt) : "â€”");

    var rem = remainingValue(v);
    if(v.faceValue!=null) addKV("×¢×¨×š ××§×•×¨×™", v.faceValue);
    if(v.usedValue!=null) addKV("× ×•×¦×œ", v.usedValue);
    if(rem!=null) addKV("×™×ª×¨×”", rem);

    if(v.type==="percent" && v.detailsPercent) addKV("×¤×™×¨×•×˜ ××—×•×–/×ª×§×¨×”", v.detailsPercent);
    if(v.type==="bogo" && v.detailsBogo) addKV("×¤×™×¨×•×˜ ××‘×¦×¢", v.detailsBogo);

    addKV("×§×•×“", (v.isPhysical ? "â€”" : (v.code || "â€”")));
    addKV("×”×¢×¨×•×ª", (v.notes || "â€”"));

    // buttons enable/disable
    var copyBtn = document.querySelector("#viewBackdrop .modal-actions button:nth-child(1)");
    if(v.isPhysical || !v.code){
      copyBtn.disabled = true;
      copyBtn.style.opacity = "0.5";
    } else {
      copyBtn.disabled = false;
      copyBtn.style.opacity = "1";
    }
  }

  window.openViewModal = openViewModal;

  function hideViewModal(){
    $("viewBackdrop").style.display = "none";
    viewId = null;
  }
  window.hideViewModal = hideViewModal;

  function closeViewModal(e){
    if(e.target === $("viewBackdrop")) hideViewModal();
  }
  window.closeViewModal = closeViewModal;

  function copyText(text){
    try{
      if(!navigator.clipboard || !navigator.clipboard.writeText){
        alert("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ××•×˜×•××˜×™×ª â€” ×”×¢×ª×§ ×™×“× ×™×ª.");
        return;
      }
      navigator.clipboard.writeText(String(text||"")).then(function(){
        setSyncMsg("×”×•×¢×ª×§ âœ…");
      }).catch(function(){
        alert("×”×¢×ª×§×” × ×›×©×œ×” â€” ×”×¢×ª×§ ×™×“× ×™×ª.");
      });
    }catch(e){
      alert("×”×¢×ª×§×” × ×›×©×œ×” â€” ×”×¢×ª×§ ×™×“× ×™×ª.");
    }
  }

  function copyCode(){
    if(!viewId) return;
    var v = state.vouchers.find(function(x){ return x.id===viewId; });
    if(!v || v.isPhysical || !v.code) return;
    copyText(v.code);
  }
  window.copyCode = copyCode;

  function markAsUsedById(id){
    var v = state.vouchers.find(function(x){ return x.id===id; });
    if(!v) return;
    if(!confirm("×œ×¡××Ÿ ×›× ×•×¦×œ/×¡×™×™× ×•×œ×”×¢×‘×™×¨ ×œ××¨×›×™×•×Ÿ?")) return;

    v.status = "archived";
    v.archivedReason = "spent";
    // ×× ×™×© ×™×ª×¨×” ××¡×¤×¨×™×ª â€” × ××¤×¡ ××•×ª×” (×›×™ â€œ×¡×™×™×â€)
    if(v.faceValue!=null){
      v.usedValue = Number(v.faceValue)||0;
    }
    touch(v);
    saveLocal();
    renderActive();
    renderArchive();
  }

  function markAsUsed(){
    if(!viewId) return;
    markAsUsedById(viewId);
    hideViewModal();
  }
  window.markAsUsed = markAsUsed;

  function archiveCurrentManual(){
    if(!viewId) return;
    var v = state.vouchers.find(function(x){ return x.id===viewId; });
    if(!v) return;
    if(!confirm("×œ×”×¢×‘×™×¨ ×œ××¨×›×™×•×Ÿ ×™×“× ×™×ª?")) return;
    v.status = "archived";
    v.archivedReason = "manual";
    touch(v);
    saveLocal();
    hideViewModal();
    renderActive();
    renderArchive();
  }
  window.archiveCurrentManual = archiveCurrentManual;

  function editCurrent(){
    if(!viewId) return;
    var id = viewId;
    hideViewModal();
    openVoucherModal(id);
  }
  window.editCurrent = editCurrent;

  // ===== Backup / Restore =====
  function backupNow(){
    try{
      var backup = {
        v: 1,
        exportedAt: Date.now(),
        deviceName: DEVICE_NAME,
        meta: getLocalMeta(),
        payload: state
      };
      var blob = new Blob([JSON.stringify(backup, null, 2)], { type:"application/json" });
      var url = URL.createObjectURL(blob);

      var a = document.createElement("a");
      a.href = url;
      a.download = "coupons-backup-" + (new Date().toISOString().slice(0,10)) + ".json";
      a.rel = "noopener";
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} }, 1500);
      setSyncMsg("×’×™×‘×•×™ × ×•×¦×¨ âœ…");
    }catch(e){
      alert("×’×™×‘×•×™ × ×›×©×œ");
    }
  }
  window.backupNow = backupNow;

  function triggerRestore(){
    if(!confirm("×˜×¢×™× ×ª ×’×™×‘×•×™ ×ª×—×œ×™×£ × ×ª×•× ×™× ×‘××›×©×™×¨ ×”×–×”. ×œ×”××©×™×š?")) return;
    $("restoreFile").value = "";
    $("restoreFile").click();
  }
  window.triggerRestore = triggerRestore;

  function restoreFromFile(ev){
    try{
      var f = ev && ev.target && ev.target.files && ev.target.files[0];
      if(!f) return;
      var reader = new FileReader();
      reader.onload = function(){
        try{
          var obj = safeJSONParse(reader.result, null);
          if(!obj || !obj.payload) throw new Error("bad");
          state = obj.payload;
          saveLocal();
          if(obj.meta) setLocalMeta(obj.meta);
          setSyncMsg("×’×™×‘×•×™ × ×˜×¢×Ÿ âœ…");
          renderAll();
        }catch(e){
          alert("×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ");
        }
      };
      reader.readAsText(f);
      ev.target.value = "";
    }catch(e){
      alert("×˜×¢×™× ×ª ×’×™×‘×•×™ × ×›×©×œ×”");
    }
  }
  window.restoreFromFile = restoreFromFile;

  // ===== Cloud (manual) =====
  function doFetchJSON(url){
    return fetch(url, { cache:"no-store" }).then(function(r){ return r.json(); });
  }

  function cloudPull(){
    if(SYNC_URL.indexOf("PASTE_")===0) return alert("×¢×•×“ ×œ× ×¢×“×›× ×ª SYNC_URL ×‘×§×•×“ index.html");
    setSyncMsg("××•×©×š ××”×¢× ×Ÿ...");
    doFetchJSON(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN))
      .then(function(j){
        if(!j || !j.ok) throw new Error("bad");
        if(!j.data){
          setSyncMsg("××™×Ÿ × ×ª×•× ×™× ×‘×¢× ×Ÿ");
          return;
        }
        var remote = safeJSONParse(j.data, null);
        if(!remote) throw new Error("bad json");
        state = remote;
        saveLocal();
        setLocalMeta(j.meta || { updatedAt:0, updatedBy:"" });
        setSyncMsg("× ×˜×¢×Ÿ ××”×¢× ×Ÿ âœ…");
        setLastSyncNow();
        renderAll();
      })
      .catch(function(){
        setSyncMsg("××©×™×›×” ××”×¢× ×Ÿ × ×›×©×œ×” âŒ");
      });
  }
  window.cloudPull = cloudPull;

  function cloudPush(){
    if(SYNC_URL.indexOf("PASTE_")===0) return alert("×¢×•×“ ×œ× ×¢×“×›× ×ª SYNC_URL ×‘×§×•×“ index.html");

    // Wife guard: ×× Yanir ×¢×“×›×Ÿ ××—×¨×™×™×š â€” ××‘×§×©×™× ×œ××©×•×š ×§×•×“×.
    setSyncMsg("×‘×•×“×§ ××˜×...");
    doFetchJSON(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN) + "&meta=1")
      .then(function(metaResp){
        var remoteMeta = (metaResp && metaResp.meta) ? metaResp.meta : { updatedAt:0, updatedBy:"" };
        var localMeta = getLocalMeta();

        if(DEVICE_NAME !== "Yanir" &&
           (remoteMeta.updatedAt||0) > (localMeta.updatedAt||0) &&
           String(remoteMeta.updatedBy||"") === "Yanir"){
          alert("Yanir ×¢×“×›×Ÿ × ×ª×•× ×™× ×‘×¢× ×Ÿ ××—×¨×™ ×”×¤×¢× ×”××—×¨×•× ×” ×©×œ×š.\n××©×›×™ ×§×•×“× × ×ª×•× ×™× ××”×¢× ×Ÿ ×•××– × ×¡×™ ×©×•×‘ ×œ×©×œ×•×—.");
          setSyncMsg("× ×—×¡×: Yanir × ×™×¦×— â€” ××©×›×™ ×§×•×“× âœ…");
          return null;
        }

        var payloadStr = JSON.stringify(state);
        var url = SYNC_URL
          + "?token=" + encodeURIComponent(SYNC_TOKEN)
          + "&write=1"
          + "&by=" + encodeURIComponent(DEVICE_NAME)
          + "&data=" + encodeURIComponent(payloadStr);

        setSyncMsg("×©×•×œ×— ×œ×¢× ×Ÿ...");
        return doFetchJSON(url);
      })
      .then(function(w){
        if(!w) return;
        if(w && w.ok){
          setLocalMeta(w.meta || { updatedAt:Date.now(), updatedBy:DEVICE_NAME });
          setSyncMsg("× ×©×œ×— ×œ×¢× ×Ÿ âœ…");
          setLastSyncNow();
        } else {
          setSyncMsg("×©×œ×™×—×” ×œ×¢× ×Ÿ × ×›×©×œ×” âŒ");
        }
      })
      .catch(function(){
        setSyncMsg("×©×œ×™×—×” ×œ×¢× ×Ÿ × ×›×©×œ×” âŒ");
      });
  }
  window.cloudPush = cloudPush;

  // ===== Reset =====
  function resetAll(){
    if(!confirm("×œ××¤×¡ ×¨×§ ××ª ×”× ×ª×•× ×™× ×‘××›×©×™×¨ ×”×–×”?")) return;
    localStorage.removeItem(KEY);
    localStorage.removeItem(META_KEY);
    localStorage.removeItem(LAST_SYNC_AT_KEY);
    state = { brands:[], stores:[], categories:[], vouchers:[] };
    saveLocal();
    setLocalMeta({ updatedAt:0, updatedBy:"" });
    renderAll();
  }
  window.resetAll = resetAll;

  // ===== Init =====
  function renderAll(){
    renderManage();
    renderActive();
    renderArchive();
    buildFilterChips();
    $("deviceName").value = DEVICE_NAME;
    renderSyncLastLine();
  }

  // seed small defaults (optional)
  if(!state.categories.length){
    state.categories = [
      { id: uid(), name:"××•×¤× ×”" },
      { id: uid(), name:"××¡×¢×“×•×ª" },
      { id: uid(), name:"×¤××¨×" }
    ];
    saveLocal();
  }

  renderAll();
</script>

</body>
</html>
