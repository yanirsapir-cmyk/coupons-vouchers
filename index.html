<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×©×•×‘×¨×™× ×•×§×•×¤×•× ×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#dc2626; --warn:#f59e0b; --ok:#16a34a; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;

      /* Pastel status colors */
      --p-green:#d1fae5; --p-green-b:#34d399;
      --p-yellow:#fef3c7; --p-yellow-b:#fbbf24;
      --p-red:#fee2e2; --p-red-b:#f87171;
      --p-gray:#f3f4f6; --p-gray-b:#9ca3af;

      --soft-green:#e8f7ee; --soft-green-b:#6ee7b7;
      --soft-blue:#eef2ff; --soft-blue-b:#93c5fd;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    @media(min-width:700px){ body{max-width:900px;margin:auto} }

    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
      overflow:hidden;
    }
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}

    .view{display:none}
    .view.active{display:block}

    .field{margin-top:10px; min-width:0; overflow:hidden;}
    label{font-weight:900}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff;
      max-width:100%;
    }
    input[type="date"]{display:block}
    textarea{min-height:120px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline > *{flex:1; min-width:180px}
    .inline .fit{flex:0 0 auto; min-width:auto}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}
    .danger{background:var(--danger); color:#fff}
    .okbtn{background:#dcfce7; color:#166534; border:1px solid #86efac}
    .mutebtn{background:#f3f4f6; color:#111827; border:1px solid var(--border)}
    .syncPull{background:var(--soft-blue); color:#1e40af; border:1px solid var(--soft-blue-b)}
    .syncPush{background:var(--soft-green); color:#065f46; border:1px solid var(--soft-green-b)}

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    /* Add bubble (separate from search) */
    .addbubble{
      border:1px solid #c7f9d7;
      background:var(--soft-green);
      border-radius:18px;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .addbubble .title{font-weight:900;font-size:16px}
    .addbubble .sub{color:#065f46;font-weight:900;font-size:13px;margin-top:4px}
    .addbubble .cta{
      background:#ecfeff;
      border:1px solid #a5f3fc;
      color:#155e75;
    }

    /* Search bubble */
    .searchrow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .searchrow input{flex:1; min-width:220px}
    .searchrow .fit{flex:0 0 auto; min-width:auto}

    /* Filters rows */
    .filtersCol{display:flex; flex-direction:column; gap:8px; margin-top:10px;}
    .filtersRow{display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:4px;}
    .pillbtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:7px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
      background:#fff; border:1px solid var(--border);
      white-space:nowrap; cursor:pointer;
      flex:0 0 auto;
    }
    .pillbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .pillbtn.soft{background:var(--pill);}
    .pillbtn.warn{background:var(--p-red); border-color:var(--p-red-b);}

    /* Coupon list */
    .couponCard{
      background:#fff; border:1px solid var(--border);
      border-radius:18px; padding:12px;
      margin-bottom:10px;
      overflow:hidden;
    }
    .couponTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .couponTitle{
      font-weight:900; font-size:16px; margin:0;
      min-width:0;
    }
    .couponMeta{
      margin-top:6px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      color:#374151;
      font-weight:900;
      font-size:13px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:var(--pill);
      white-space:nowrap;
      font-size:12px;
      font-weight:900;
    }
    .badge.red{background:var(--p-red); border-color:var(--p-red-b);}
    .badge.yellow{background:var(--p-yellow); border-color:var(--p-yellow-b);}
    .badge.green{background:var(--p-green); border-color:var(--p-green-b);}
    .badge.gray{background:var(--p-gray); border-color:var(--p-gray-b);}
    .actions{
      display:flex; gap:8px; align-items:center; flex:0 0 auto;
      justify-content:flex-start;
    }
    .openbtn{
      background:#fff; border:1px solid var(--border); border-radius:12px;
      padding:8px 12px; font-weight:900; cursor:pointer; white-space:nowrap;
    }

    /* Status icon */
    .statusIcon{
      width:30px; height:30px;
      border-radius:12px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .statusIcon svg{width:16px;height:16px}
    .s-green{background:var(--p-green); border-color:var(--p-green-b);}
    .s-yellow{background:var(--p-yellow); border-color:var(--p-yellow-b);}
    .s-red{background:var(--p-red); border-color:var(--p-red-b);}
    .s-gray{background:var(--p-gray); border-color:var(--p-gray-b);}

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:780px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{font-weight:900;font-size:18px}
    .modalActions{display:flex;gap:10px;flex-wrap:wrap}
    .tiny{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }

    /* â€œAmountsâ€ block */
    .amountsBlock{
      margin-top:10px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      border-radius:16px;
      padding:12px;
    }
    .amountsGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media(min-width:700px){
      .amountsGrid{grid-template-columns:repeat(3, 1fr);}
    }
    .readonly{
      background:#f9fafb;
      color:#111827;
    }

    /* Manage lists */
    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    li span{flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-weight:900;}
    .btnGroup{display:flex; gap:8px; align-items:center; flex:0 0 auto}
    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      font-weight:900; line-height:1;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      min-width:40px;
    }
    .openSmall{
      background:#eef2ff;
      border:1px solid #c7d2fe;
      color:#1e40af;
      min-width:46px;
    }
    .enableBtn{
      background:#eff6ff;
      border:1px solid #93c5fd;
      color:#1e40af;
      min-width:46px;
    }
    .disabledTag{
      font-size:12px;
      font-weight:900;
      color:#6b7280;
      padding:4px 8px;
      border-radius:999px;
      border:1px dashed var(--border);
      background:#fafafa;
      white-space:nowrap;
    }

    details.dropdown{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    details.dropdown summary{
      cursor:pointer;
      font-weight:900;
      list-style:none;
    }
    details.dropdown summary::-webkit-details-marker{display:none}
    .choiceList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .choiceRow{
      display:flex; align-items:center; gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .choiceRow.active{
      background:#eef2ff;
      border-color:#93c5fd;
    }
    .choiceRow input{width:18px;height:18px;margin:0}

    .hr{height:1px;background:var(--border);margin:12px 0}
  </style>
</head>

<body>
  <h1>ğŸŸï¸ ×©×•×‘×¨×™× ×•×§×•×¤×•× ×™×</h1>

  <div class="tabs">
    <button class="tabbtn active" type="button" onclick="showTab('active')">×¤×¢×™×œ×™×</button>
    <button class="tabbtn" type="button" onclick="showTab('archive')">××¨×›×™×•×Ÿ</button>
    <button class="tabbtn" type="button" onclick="showTab('manage')">× ×™×”×•×œ</button>
    <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
  </div>

  <!-- ACTIVE -->
  <section id="view-active" class="view active">
    <section class="card">
      <div class="addbubble">
        <div>
          <div class="title">×™×¦×™×¨×ª ×©×•×‘×¨ ×—×“×©</div>
          <div class="sub">×œ×—×¥ ×›××Ÿ ×œ×”×•×¡×¤×ª ×©×•×‘×¨ ×—×“×©</div>
        </div>
        <button class="btn cta fit" type="button" onclick="openCouponEditor(null)">â• ×”×•×¡×£ ×©×•×‘×¨</button>
      </div>
    </section>

    <section class="card">
      <h2>×—×™×¤×•×© ×•×¡×™× ×•×Ÿ</h2>

      <div class="searchrow">
        <input id="searchActive" placeholder="×—×™×¤×•×©: ×©× ××•×ª×’ / ×—× ×•×ª / ×©×•×‘×¨" oninput="renderActive()" />
        <button class="btn ghost fit" type="button" onclick="clearActiveFilters()">× ×§×”</button>
      </div>

      <div class="note" id="searchTipActive">×˜×™×¤: ×—×¤×© ×œ×¤×™ ×—× ×•×ª â€” ×•×ª×¨××” ××™×œ×• ×©×•×‘×¨×™× ××§×‘×œ×™× ×©× (×’× ×× ×”× ×ª×—×ª ××•×ª×’ ××—×¨).</div>

      <div class="filtersCol">
        <div class="filtersRow">
          <button class="pillbtn active" id="actFilterAll" type="button" onclick="setActiveQuickFilter('all')">×”×›×œ</button>
          <button class="pillbtn warn" id="actFilterNear" type="button" onclick="setActiveQuickFilter('near')">×§×¨×•×‘ ×œ×¤×§×™×¢×”</button>
        </div>

        <div class="filtersRow" id="activeBrandRow"></div>
        <div class="filtersRow" id="activeStoreRow"></div>
        <div class="filtersRow" id="activeCatRow"></div>
      </div>
    </section>

    <section class="card">
      <h2>×©×•×‘×¨×™× ×¤×¢×™×œ×™×</h2>
      <div class="note" id="activeCount"></div>
      <div id="activeList"></div>
    </section>
  </section>

  <!-- ARCHIVE -->
  <section id="view-archive" class="view">
    <section class="card">
      <h2>×—×™×¤×•×© ×•×¡×™× ×•×Ÿ</h2>

      <div class="searchrow">
        <input id="searchArchive" placeholder="×—×™×¤×•×© ×‘××¨×›×™×•×Ÿ: ××•×ª×’ / ×—× ×•×ª / ×©×•×‘×¨" oninput="renderArchive()" />
        <button class="btn ghost fit" type="button" onclick="clearArchiveFilters()">× ×§×”</button>
      </div>

      <div class="filtersCol">
        <div class="filtersRow">
          <button class="pillbtn active" id="arcFilterAll" type="button" onclick="setArchiveQuickFilter('all')">×”×›×œ</button>
          <button class="pillbtn warn" id="arcFilterNear" type="button" onclick="setArchiveQuickFilter('near')">×§×¨×•×‘ ×œ×¤×§×™×¢×”</button>
        </div>

        <div class="filtersRow" id="archiveBrandRow"></div>
        <div class="filtersRow" id="archiveStoreRow"></div>
        <div class="filtersRow" id="archiveCatRow"></div>
      </div>
    </section>

    <section class="card">
      <h2>××¨×›×™×•×Ÿ</h2>
      <div class="note" id="archiveCount"></div>
      <div id="archiveList"></div>
    </section>
  </section>

  <!-- MANAGE -->
  <section id="view-manage" class="view">
    <section class="card">
      <h2>× ×™×”×•×œ</h2>
      <div class="note">×›××Ÿ ×× ×”×œ×™× ×©××•×ª + ×©×™×•×›×™× (××•×ª×’â†”×—× ×•×™×•×ªâ†”×§×˜×’×•×¨×™×•×ª). ××—×™×§×”/×”×©×‘×ª×” ×œ× ×©×•×‘×¨×ª ×”×™×¡×˜×•×¨×™×”.</div>
      <div class="inline">
        <input id="manageSearch" placeholder="×—×™×¤×•×© ×‘× ×™×”×•×œ..." oninput="renderManage()" />
        <button class="btn ghost fit" type="button" onclick="clearManageSearch()">× ×§×”</button>
      </div>
    </section>

    <section class="card">
      <h2>××•×ª×’×™×</h2>
      <div class="inline">
        <input id="newBrandName" placeholder="×”×•×¡×£ ××•×ª×’ ×—×“×©" />
        <button class="btn primary fit" type="button" onclick="addBrandFromManage()">×”×•×¡×£</button>
      </div>
      <ul id="brandsList"></ul>
    </section>

    <section class="card">
      <h2>×—× ×•×™×•×ª</h2>
      <div class="inline">
        <input id="newStoreName" placeholder="×”×•×¡×£ ×—× ×•×ª ×—×“×©×”" />
        <button class="btn primary fit" type="button" onclick="addStoreFromManage()">×”×•×¡×£</button>
      </div>
      <ul id="storesList"></ul>
    </section>

    <section class="card">
      <h2>×§×˜×’×•×¨×™×•×ª</h2>
      <div class="inline">
        <input id="newCatName" placeholder="×”×•×¡×£ ×§×˜×’×•×¨×™×” ×—×“×©×”" />
        <button class="btn primary fit" type="button" onclick="addCategoryFromManage()">×”×•×¡×£</button>
      </div>
      <ul id="catsList"></ul>
    </section>
  </section>

  <!-- DATA -->
  <section id="view-data" class="view">
    <section class="card">
      <h2>ğŸ”„ ×¡× ×›×¨×•×Ÿ</h2>
      <div class="note" id="syncStatusLine"></div>
      <div class="note" id="syncLastLine"></div>

      <div class="inline" style="margin-top:10px;">
        <button class="btn syncPull fit" type="button" onclick="syncPullNow()">××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ</button>
        <button class="btn syncPush fit" type="button" onclick="syncPushNow()">×©×œ×— × ×ª×•× ×™× ×œ×¢× ×Ÿ</button>
        <button class="btn ghost fit" type="button" onclick="backupNow()">×’×™×‘×•×™ ×œ×§×•×‘×¥</button>
        <button class="btn ghost fit" type="button" onclick="triggerRestore()">×˜×¢×™× ×ª ×’×™×‘×•×™ ××§×•×‘×¥</button>
      </div>

      <input id="restoreFile" type="file" accept=".json,application/json" style="display:none" onchange="restoreFromFile(event)">

      <div class="note" id="syncLocalNote" style="display:none; margin-top:10px;"></div>
    </section>

    <section class="card" id="deviceCard" style="display:none;">
      <h2>×”×’×“×¨×•×ª ××›×©×™×¨ (×¨×§ Yanir)</h2>
      <div class="note">×”××¡×š ×”×–×” ××•×¡×ª×¨ ××©×™×¨×œ×™ ×›×“×™ ×œ× ×œ×‘×œ×‘×œ. ×”×•× ×§×•×‘×¢ ××™ â€œ×”×©×â€ ×©× ×©×œ×— ×œ××˜×”-×“××˜× ×‘×¢× ×Ÿ.</div>
      <div class="field">
        <label>×©× ××›×©×™×¨/××©×ª××© (×œ×¢× ×Ÿ)</label>
        <select id="deviceNameSelect" onchange="changeDeviceName()">
          <option value="Yanir">Yanir</option>
          <option value="×©×™×¨×œ×™">×©×™×¨×œ×™</option>
        </select>
        <div class="note">×”×©××¨ â€œYanirâ€ ××¦×œ×š.</div>
      </div>
    </section>

    <section class="card">
      <h2>×›×œ×™ ×‘×“×™×§×”</h2>
      <div class="note">××•×—×§ ×¨×§ ×©×•×‘×¨×™× (×œ× ××•×—×§ ××•×ª×’×™×/×—× ×•×™×•×ª/×§×˜×’×•×¨×™×•×ª).</div>
      <button class="btn danger" type="button" onclick="clearCouponsOnly()">××—×§ ×©×•×‘×¨×™×</button>
    </section>

    <section class="card">
      <h2>××™×¤×•×¡ ××œ×</h2>
      <div class="note">××•×—×§ ×”×›×œ ××”××›×©×™×¨ (×©×•×‘×¨×™×+××•×ª×’×™×+×—× ×•×™×•×ª+×§×˜×’×•×¨×™×•×ª).</div>
      <button class="btn danger" type="button" onclick="resetAll()">××™×¤×•×¡ ××œ×</button>
    </section>
  </section>

  <!-- Coupon editor modal -->
  <div id="couponBackdrop" class="backdrop" onclick="closeCouponModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHeader">
        <div class="modalTitle" id="couponModalTitle">×©×•×‘×¨</div>
        <div class="modalActions">
          <button class="tiny" type="button" onclick="saveCoupon()">×©××™×¨×”</button>
          <button class="tiny" type="button" onclick="hideCouponModal()">×¡×’×•×¨</button>
        </div>
      </div>

      <div class="field">
        <label>×¡×•×’ ×©×•×‘×¨</label>
        <select id="cType" onchange="renderCouponTypeUI()">
          <option value="×›×¡×¤×™" selected>×›×¡×¤×™</option>
          <option value="××—×•×–" >××—×•×–</option>
          <option value="1+1" >1+1</option>
          <option value="×¤×¨×™×˜/××ª× ×”" >×¤×¨×™×˜/××ª× ×”</option>
          <option value="×›×œ×œ×™" >×›×œ×œ×™</option>
        </select>
        <div class="note">×‘×¨×™×¨×ª ××—×“×œ: ×›×¡×¤×™.</div>
      </div>

      <div class="field">
        <label>××•×ª×’</label>
        <button class="btn ghost" type="button" onclick="openPickBrand()">×‘×—×¨ ××•×ª×’</button>
        <div class="note" id="pickedBrandLine">×œ× × ×‘×—×¨ ××•×ª×’</div>

        <div class="inline" style="margin-top:10px;">
          <input id="newBrandInline" placeholder="××• ×¦×•×¨ ××•×ª×’ ×—×“×© ×›××Ÿ (×œ×“×•×’××”: dream / LOVE)" />
          <button class="btn primary fit" type="button" onclick="createBrandInline()">×¦×•×¨</button>
        </div>
      </div>

      <div class="field" id="scopeField" style="display:none;">
        <label>×ª×•×§×£ ×”×©×•×‘×¨</label>
        <select id="cScope" onchange="renderScopeUI()">
          <option value="all" selected>×ª×§×£ ×œ×›×œ ×”×¨×©×ª</option>
          <option value="some">×¨×§ ×—× ×•×™×•×ª ××¡×•×™××•×ª</option>
        </select>
        <div class="note">×‘×—×¨ ××•×ª×’ ×§×•×“× â€” ×•××– ×ª×•×›×œ ×œ×”×—×œ×™×˜ ×× ×–×” ×œ×›×œ ×”×¨×©×ª ××• ×¨×§ ×—× ×•×™×•×ª ××¡×•×™××•×ª.</div>
      </div>

      <div class="field" id="storesField" style="display:none;">
        <label id="storesLabel">×—× ×•×™×•×ª ×ª×§×¤×•×ª</label>

        <details class="dropdown">
          <summary id="storesSummary">×‘×—×¨ ×—× ×•×™×•×ª</summary>
          <div class="choiceList" id="storesChoices"></div>

          <div class="inline" style="margin-top:10px;">
            <input id="newStoreInline" placeholder="×”×•×¡×£ ×—× ×•×ª ×—×“×©×” (×œ×“×•×’××”: ×¤×•×§×¡)" />
            <button class="btn primary fit" type="button" onclick="createStoreInline()">×”×•×¡×£</button>
          </div>
        </details>

        <div class="note" id="storesNote"></div>
      </div>

      <div class="field">
        <label>×§×˜×’×•×¨×™×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
        <details class="dropdown">
          <summary id="catsSummary">×‘×—×¨ ×§×˜×’×•×¨×™×•×ª</summary>
          <div class="choiceList" id="catsChoices"></div>

          <div class="inline" style="margin-top:10px;">
            <input id="newCatInline" placeholder="×”×•×¡×£ ×§×˜×’×•×¨×™×” ×—×“×©×” (×œ×“×•×’××”: ×‘×™×’×•×“)" />
            <button class="btn primary fit" type="button" onclick="createCategoryInline()">×”×•×¡×£</button>
          </div>
        </details>
      </div>

      <div class="field">
        <label>×›×¨×˜×™×¡ ×¤×™×–×™</label>
        <select id="cPhysical">
          <option value="no" selected>×œ×</option>
          <option value="yes">×›×Ÿ</option>
        </select>
      </div>

      <div class="field" id="codeField">
        <label>×§×•×“ (××•×¤×¦×™×•× ×œ×™)</label>
        <textarea id="cCode" placeholder="×”×“×‘×§ ×›××Ÿ ×§×•×“ / ××¡×¤×¨ ×©×•×‘×¨ / ×›×œ ×“×‘×¨ ×©×ª×¨×¦×”..."></textarea>
        <div class="note">
          ×‘×ª×•×š ×©×•×‘×¨ ×§×™×™× ×™×”×™×” ×›×¤×ª×•×¨ â€œ×”×¢×ª×§ ×§×•×“â€ (×× ×™×© ×§×•×“).
        </div>
      </div>

      <div class="field">
        <label>×ª×•×§×£ (××•×¤×¦×™×•× ×œ×™)</label>
        <input type="date" id="cExpiry" />
        <div class="note">×¤×•×¨××˜ ×ª×¦×•×’×” ×‘××¤×œ×™×§×¦×™×”: dd/mm/yyyy</div>
      </div>

      <div class="amountsBlock" id="amountsBlock">
        <div style="font-weight:900; margin-bottom:8px;">×¡×›×•××™×</div>
        <div class="amountsGrid">
          <div>
            <label>×¡×›×•× ×©×•×‘×¨ (â‚ª)</label>
            <input id="cTotal" type="number" inputmode="decimal" placeholder="×œ×“×•×’××”: 500" oninput="recalcRemaining()" />
          </div>
          <div>
            <label>× ×•×¦×œ (â‚ª)</label>
            <input id="cUsed" type="number" inputmode="decimal" placeholder="×œ×“×•×’××”: 200" oninput="recalcRemaining()" />
          </div>
          <div>
            <label>×™×ª×¨×” (â‚ª)</label>
            <input id="cRemaining" class="readonly" type="number" readonly />
          </div>
        </div>
        <div class="note">×”×™×ª×¨×” ××—×•×©×‘×ª ××•×˜×•××˜×™×ª: ×¡×›×•× ×¤×—×•×ª × ×•×¦×œ.</div>
      </div>

      <div class="field">
        <label>×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
        <textarea id="cNotes" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™× / ×ª× ××™× / ×›×œ ××” ×©×ª×¨×¦×”..."></textarea>
      </div>

      <div class="hr"></div>

      <div class="inline">
        <button class="btn okbtn fit" type="button" onclick="markCouponConsumed()">×¡××Ÿ ×›× ×•×¦×œ / ×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ</button>
        <button class="btn danger fit" type="button" onclick="deleteCoupon()">××—×§ ×©×•×‘×¨</button>
      </div>

      <div class="note" id="couponModalHint"></div>
    </div>
  </div>

  <!-- Picker modal (brand/store/cat + manage details) -->
  <div id="pickerBackdrop" class="backdrop" onclick="closePickerModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHeader">
        <div class="modalTitle" id="pickerTitle">×‘×—×™×¨×”</div>
        <div class="modalActions">
          <button class="tiny" type="button" onclick="pickerConfirm()">××™×©×•×¨</button>
          <button class="tiny" type="button" onclick="hidePicker()">×¡×’×•×¨</button>
        </div>
      </div>

      <div class="field">
        <label>×—×™×¤×•×©</label>
        <input id="pickerSearch" placeholder="×—×¤×©..." oninput="renderPickerList()" />
      </div>

      <div id="pickerList" class="choiceList"></div>

      <div class="hr"></div>

      <div id="pickerBottom"></div>
    </div>
  </div>

<script>
  // ===== Service Worker registration =====
  (function(){
    if (!("serviceWorker" in navigator)) return;
    navigator.serviceWorker.register("./sw.js").catch(function(){});
  })();

  // ===== Sync Config =====
  var __isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

  var SYNC_URL = "https://script.google.com/macros/s/AKfycbzq9M_mKke4GTDeVPIHHfF-NFu5Yb7MADNVdeaYiuIn_S4LmkqhYejJw7DT9vR7HZG6/exec";
  var SYNC_TOKEN = "YANIR_COUPONS_T0K3N_9f0dA_2026";

  var DEVICE_NAME = (function(){
    var saved = localStorage.getItem("deviceName");
    if(saved) return saved;
    var guess = __isIOS ? "×©×™×¨×œ×™" : "Yanir";
    localStorage.setItem("deviceName", guess);
    return guess;
  })();

  var META_KEY = "cloudMeta";
  var LAST_SYNC_AT_KEY = "lastSyncAtCoupons";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtDateTime(ms){
    if(!ms) return "";
    var d = new Date(ms);
    return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate()) + " " + pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  }
  function fmtDateIL(iso){
    if(!iso) return "";
    // iso YYYY-MM-DD
    var parts = String(iso).split("-");
    if(parts.length!==3) return iso;
    return parts[2] + "/" + parts[1] + "/" + parts[0];
  }
  function isoDateMs(iso){
    if(!iso) return 0;
    return new Date(iso + "T00:00:00").getTime();
  }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function safeJSONParse(s, fallback){ try{ return JSON.parse(s); } catch(e){ return fallback; } }

  function setSyncMsg(msg){
    var el = document.getElementById("syncStatusLine");
    if(el) el.textContent = msg || "";
  }
  function setLastSyncNow(){
    var now = Date.now();
    localStorage.setItem(LAST_SYNC_AT_KEY, String(now));
    renderSyncLastLine();
  }
  function renderSyncLastLine(){
    var el = document.getElementById("syncLastLine");
    if(!el) return;
    var v = Number(localStorage.getItem(LAST_SYNC_AT_KEY) || "0");
    el.textContent = v ? ("×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: " + fmtDateTime(v)) : "×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: â€”";
  }
  function getLocalMeta(){
    return safeJSONParse(localStorage.getItem(META_KEY) || "null", { updatedAt:0, updatedBy:"" });
  }
  function setLocalMeta(meta){
    localStorage.setItem(META_KEY, JSON.stringify(meta || { updatedAt:0, updatedBy:"" }));
  }

  function doFetchJSON(url){
    return fetch(url, { cache:"no-store" }).then(function(r){ return r.json(); });
  }

  function localPayload(){
    return {
      v: 1,
      brands: brands,
      stores: stores,
      categories: categories,
      links: links,
      coupons: coupons
    };
  }

  function applyRemote(remote, meta){
    // accept only expected structure
    brands = Array.isArray(remote.brands) ? remote.brands : [];
    stores = Array.isArray(remote.stores) ? remote.stores : [];
    categories = Array.isArray(remote.categories) ? remote.categories : [];
    links = remote.links && typeof remote.links==="object" ? remote.links : { brandStores:{}, brandCats:{}, storeBrands:{}, storeCats:{}, catBrands:{}, catStores:{} };
    coupons = Array.isArray(remote.coupons) ? remote.coupons : [];

    persistAll();
    setLocalMeta(meta || { updatedAt:0, updatedBy:"" });

    renderAll();
  }

  function syncPullNow(){
    setSyncMsg("×˜×•×¢×Ÿ ××”×¢× ×Ÿ...");
    doFetchJSON(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN))
      .then(function(j){
        if(!j || !j.ok) throw new Error("bad");
        if(!j.data){
          setSyncMsg("××™×Ÿ × ×ª×•× ×™× ×‘×¢× ×Ÿ");
          renderSyncLastLine();
          return;
        }
        var remote = safeJSONParse(j.data, null);
        if(!remote) throw new Error("bad json");
        applyRemote(remote, j.meta);
        setSyncMsg("× ×˜×¢×Ÿ ××”×¢× ×Ÿ âœ…");
        setLastSyncNow();
      })
      .catch(function(){
        setSyncMsg("×˜×¢×™× ×” ××”×¢× ×Ÿ × ×›×©×œ×” âŒ");
        renderSyncLastLine();
      });
  }
  window.syncPullNow = syncPullNow;

  function syncPushNow(){
    if(!confirm("×œ×©×œ×•×— ××ª ×”× ×ª×•× ×™× ×©×œ ×”××›×©×™×¨ ×”×–×” ×œ×¢× ×Ÿ? (×–×” ×™×—×œ×™×£ ××ª ××” ×©×‘×¢× ×Ÿ)")) return;

    setSyncMsg("×©×•×œ×— ×œ×¢× ×Ÿ...");
    var payloadStr = JSON.stringify(localPayload());
    var url = SYNC_URL
      + "?token=" + encodeURIComponent(SYNC_TOKEN)
      + "&write=1"
      + "&by=" + encodeURIComponent(DEVICE_NAME)
      + "&data=" + encodeURIComponent(payloadStr);

    doFetchJSON(url)
      .then(function(w){
        if(w && w.ok){
          setLocalMeta(w.meta || getLocalMeta());
          setSyncMsg("× ×©×œ×— ×œ×¢× ×Ÿ âœ…");
          setLastSyncNow();
        } else {
          setSyncMsg("×©×œ×™×—×” ×œ×¢× ×Ÿ × ×›×©×œ×” âŒ");
        }
      })
      .catch(function(){
        setSyncMsg("×©×œ×™×—×” ×œ×¢× ×Ÿ × ×›×©×œ×” âŒ");
      });
  }
  window.syncPushNow = syncPushNow;

  function showLocalNoteIfYanir(){
    var el = document.getElementById("syncLocalNote");
    if(!el) return;
    if(DEVICE_NAME === "Yanir"){
      el.style.display = "block";
      el.textContent = "×”×¢×¨×” (×¨×§ ××¦×œ×š): ×× ××©×”×• ×œ× ××¡×ª×“×¨ ×‘×™×Ÿ ××›×©×™×¨×™× â€” ×”×©×ª××© ×‘×›×¤×ª×•×¨×™× ×”××•×“×’×©×™×: â€œ××©×•×š × ×ª×•× ×™×â€ / â€œ×©×œ×— × ×ª×•× ×™×â€.";
    } else {
      el.style.display = "none";
    }
  }

  // ===== Backup / Restore =====
  function backupNow(){
    try{
      var backup = {
        v: 1,
        exportedAt: Date.now(),
        deviceName: DEVICE_NAME,
        meta: getLocalMeta(),
        payload: localPayload()
      };
      var blob = new Blob([JSON.stringify(backup, null, 2)], { type:"application/json" });
      var url = URL.createObjectURL(blob);

      var a = document.createElement("a");
      a.href = url;
      a.download = "coupons-backup-" + (new Date().toISOString().slice(0,10)) + ".json";
      a.rel = "noopener";
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} }, 1500);
      setSyncMsg("×’×™×‘×•×™ × ×•×¦×¨ âœ…");
    } catch(e){
      alert("×’×™×‘×•×™ × ×›×©×œ");
    }
  }
  window.backupNow = backupNow;

  function triggerRestore(){
    if(!confirm("×˜×¢×™× ×ª ×’×™×‘×•×™ ×ª×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×‘××›×©×™×¨ ×”×–×”. ×œ×”××©×™×š?")) return;
    var inp = document.getElementById("restoreFile");
    if(!inp) return;
    inp.value = "";
    inp.click();
  }
  window.triggerRestore = triggerRestore;

  function restoreFromFile(ev){
    try{
      var f = ev && ev.target && ev.target.files && ev.target.files[0];
      if(!f) return;

      var reader = new FileReader();
      reader.onload = function(){
        try{
          var obj = safeJSONParse(reader.result, null);
          if(!obj || !obj.payload) throw new Error("bad");

          var p = obj.payload || {};
          applyRemote(p, obj.meta || {updatedAt:0, updatedBy:""});

          setSyncMsg("×’×™×‘×•×™ × ×˜×¢×Ÿ âœ…");
        } catch(e){
          alert("×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ");
        }
      };
      reader.readAsText(f);
      ev.target.value = "";
    } catch(e){
      alert("×˜×¢×™× ×ª ×’×™×‘×•×™ × ×›×©×œ×”");
    }
  }
  window.restoreFromFile = restoreFromFile;

  // ===== Storage =====
  var KEY_BRANDS = "c_brands";
  var KEY_STORES = "c_stores";
  var KEY_CATS = "c_categories";
  var KEY_LINKS = "c_links";
  var KEY_COUPONS = "c_coupons";

  function uid(prefix){ return (prefix||"id") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
  function normName(s){ return String(s||"").trim(); }
  function escapeHtml(s){
    s = String(s);
    return s.replace(/[&<>"']/g, function(m){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[m];
    });
  }

  function loadDefault(key, def){
    var v = safeJSONParse(localStorage.getItem(key), null);
    return v==null ? def : v;
  }

  // Entities have: {id, name, disabled:boolean}
  var brands = loadDefault(KEY_BRANDS, [
    {id: uid("b"), name:"Dream", disabled:false},
    {id: uid("b"), name:"LOVE", disabled:false}
  ]);
  var stores = loadDefault(KEY_STORES, [
    {id: uid("s"), name:"×¤×•×§×¡", disabled:false},
    {id: uid("s"), name:"×××¨×™×§×Ÿ ××™×’×œ", disabled:false},
    {id: uid("s"), name:"×§×¡×˜×¨×•", disabled:false}
  ]);
  var categories = loadDefault(KEY_CATS, [
    {id: uid("k"), name:"×‘×™×’×•×“", disabled:false},
    {id: uid("k"), name:"××¡×¢×“×•×ª", disabled:false}
  ]);

  // Links structure: store <-> brand, and both <-> categories
  var links = loadDefault(KEY_LINKS, {
    brandStores:{}, // brandId -> [storeId]
    brandCats:{},   // brandId -> [catId]
    storeBrands:{}, // storeId -> [brandId]
    storeCats:{},   // storeId -> [catId]
    catBrands:{},   // catId -> [brandId]
    catStores:{}    // catId -> [storeId]
  });

  // Coupon structure:
  // {
  //  id, createdAt, updatedAt,
  //  brandId,
  //  scope: "all"|"some",
  //  storeIds: [],
  //  highlightStoreIds: [], // for scope all, optional favorites
  //  catIds: [],
  //  type,
  //  physical:boolean,
  //  code, notes,
  //  expiryISO,
  //  total:number|null, used:number|null,
  //  consumedManual:boolean,
  //  archived:boolean, archivedAt, archivedReason
  // }
  var coupons = loadDefault(KEY_COUPONS, []);

  function persistAll(){
    localStorage.setItem(KEY_BRANDS, JSON.stringify(brands));
    localStorage.setItem(KEY_STORES, JSON.stringify(stores));
    localStorage.setItem(KEY_CATS, JSON.stringify(categories));
    localStorage.setItem(KEY_LINKS, JSON.stringify(links));
    localStorage.setItem(KEY_COUPONS, JSON.stringify(coupons));
  }

  function getById(arr, id){
    for(var i=0;i<arr.length;i++){ if(arr[i].id===id) return arr[i]; }
    return null;
  }
  function isDisabledEntity(arr, id){
    var x = getById(arr,id);
    return x ? !!x.disabled : false;
  }
  function listActiveEntities(arr){
    return arr.filter(function(x){ return !x.disabled; }).slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); });
  }
  function ensureLinksArray(map, key){
    if(!map[key]) map[key]=[];
    if(!Array.isArray(map[key])) map[key]=[];
    return map[key];
  }
  function setLink(map, key, arr){
    map[key] = Array.isArray(arr) ? arr : [];
  }
  function uniq(arr){
    var out=[]; var seen={};
    (arr||[]).forEach(function(x){
      if(x==null) return;
      var k=String(x);
      if(seen[k]) return;
      seen[k]=1; out.push(x);
    });
    return out;
  }
  function removeFromArray(arr, val){
    return (arr||[]).filter(function(x){ return x!==val; });
  }

  // ===== Auto-archive rules =====
  var DAY = 24*60*60*1000;
  var NEAR_DAYS = 90; // 3 months approx

  function computeRemaining(c){
    var total = Number(c.total || 0);
    var used = Number(c.used || 0);
    var rem = total - used;
    if(!isFinite(rem)) rem = 0;
    return Math.max(0, Math.round(rem*100)/100);
  }
  function hasValueType(t){
    return (t==="×›×¡×¤×™" || t==="××—×•×–");
  }
  function isExpired(c){
    if(!c.expiryISO) return false;
    var exp = isoDateMs(c.expiryISO);
    if(!exp) return false;
    // expiry day inclusive: we treat as expired if today > expiry
    var now0 = isoDateMs(todayISO());
    return now0 > exp;
  }
  function isNearExpiry(c){
    if(!c.expiryISO) return false;
    var exp = isoDateMs(c.expiryISO);
    if(!exp) return false;
    var now0 = isoDateMs(todayISO());
    var diffDays = Math.floor((exp - now0)/DAY);
    return diffDays >= 0 && diffDays <= NEAR_DAYS;
  }
  function isUnavailable(c){
    // archived or expired or remaining=0 for value types or consumedManual for no-value
    if(c.archived) return true;
    if(isExpired(c)) return true;
    if(hasValueType(c.type)){
      return computeRemaining(c) <= 0;
    }
    return !!c.consumedManual;
  }
  function ensureArchiveState(c){
    // If becomes unavailable -> move to archive automatically
    var expired = isExpired(c);
    var reason = "";
    if(expired) reason = "×¤×’ ×ª×•×§×£";
    else if(hasValueType(c.type) && computeRemaining(c)<=0) reason = "×™×ª×¨×” 0";
    else if(!hasValueType(c.type) && c.consumedManual) reason = "× ×•×¦×œ";
    else return c;

    if(!c.archived){
      c.archived = true;
      c.archivedAt = Date.now();
      c.archivedReason = reason || "×œ× ×–××™×Ÿ";
      c.updatedAt = Date.now();
    }
    return c;
  }
  function normalizeCoupons(){
    coupons = (coupons||[]).map(function(c){
      c = c || {};
      if(!c.id) c.id = uid("c");
      if(!c.createdAt) c.createdAt = Date.now();
      if(!c.updatedAt) c.updatedAt = c.createdAt;
      if(!c.type) c.type = "×›×¡×¤×™";
      if(c.scope!=="some") c.scope="all";
      c.storeIds = Array.isArray(c.storeIds) ? uniq(c.storeIds) : [];
      c.highlightStoreIds = Array.isArray(c.highlightStoreIds) ? uniq(c.highlightStoreIds) : [];
      c.catIds = Array.isArray(c.catIds) ? uniq(c.catIds) : [];
      c.code = String(c.code||"");
      c.notes = String(c.notes||"");
      c.expiryISO = c.expiryISO ? String(c.expiryISO) : "";
      c.physical = !!c.physical;
      c.total = (c.total==null || c.total==="") ? null : Number(c.total);
      c.used = (c.used==null || c.used==="") ? null : Number(c.used);
      if(hasValueType(c.type)){
        if(c.total==null) c.total = 0;
        if(c.used==null) c.used = 0;
      } else {
        c.total = null; c.used = null;
      }
      c.consumedManual = !!c.consumedManual;
      c.archived = !!c.archived;
      c.archivedAt = Number(c.archivedAt||0);
      c.archivedReason = String(c.archivedReason||"");
      return ensureArchiveState(c);
    });
    persistAll();
  }

  normalizeCoupons();

  // ===== Tabs =====
  function showTab(key){
    var btns = document.querySelectorAll(".tabbtn");
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
    var views = document.querySelectorAll(".view");
    for(var j=0;j<views.length;j++) views[j].classList.remove("active");

    var idx = 0, viewId = "view-active";
    if(key==="archive"){ idx=1; viewId="view-archive"; }
    else if(key==="manage"){ idx=2; viewId="view-manage"; }
    else if(key==="data"){ idx=3; viewId="view-data"; }

    btns[idx].classList.add("active");
    document.getElementById(viewId).classList.add("active");

    // render when switching
    if(key==="active") renderActive();
    if(key==="archive") renderArchive();
    if(key==="manage") renderManage();
    if(key==="data") {
      renderSyncLastLine();
      showLocalNoteIfYanir();
      renderDeviceCard();
    }
  }
  window.showTab = showTab;

  // ===== Filters (Active/Archive) =====
  var activeQuick = "all"; // all | near
  var archiveQuick = "all";

  var activeFilters = { brandId:"", storeId:"", catId:"" };
  var archiveFilters = { brandId:"", storeId:"", catId:"" };

  function clearActiveFilters(){
    document.getElementById("searchActive").value = "";
    activeQuick = "all";
    activeFilters = { brandId:"", storeId:"", catId:"" };
    renderActive();
  }
  window.clearActiveFilters = clearActiveFilters;

  function clearArchiveFilters(){
    document.getElementById("searchArchive").value = "";
    archiveQuick = "all";
    archiveFilters = { brandId:"", storeId:"", catId:"" };
    renderArchive();
  }
  window.clearArchiveFilters = clearArchiveFilters;

  function setActiveQuickFilter(x){
    activeQuick = x;
    renderActive();
  }
  window.setActiveQuickFilter = setActiveQuickFilter;

  function setArchiveQuickFilter(x){
    archiveQuick = x;
    renderArchive();
  }
  window.setArchiveQuickFilter = setArchiveQuickFilter;

  function buildFilterRows(){
    // Active rows
    buildEntityRow("activeBrandRow", "××•×ª×’×™×", listActiveEntities(brands), activeFilters.brandId, function(id){ activeFilters.brandId=id; renderActive(); }, true);
    buildEntityRow("activeStoreRow", "×—× ×•×™×•×ª", listActiveEntities(stores), activeFilters.storeId, function(id){ activeFilters.storeId=id; renderActive(); }, true);
    buildEntityRow("activeCatRow", "×§×˜×’×•×¨×™×•×ª", listActiveEntities(categories), activeFilters.catId, function(id){ activeFilters.catId=id; renderActive(); }, true);

    // Archive rows
    buildEntityRow("archiveBrandRow", "××•×ª×’×™×", listActiveEntities(brands), archiveFilters.brandId, function(id){ archiveFilters.brandId=id; renderArchive(); }, true);
    buildEntityRow("archiveStoreRow", "×—× ×•×™×•×ª", listActiveEntities(stores), archiveFilters.storeId, function(id){ archiveFilters.storeId=id; renderArchive(); }, true);
    buildEntityRow("archiveCatRow", "×§×˜×’×•×¨×™×•×ª", listActiveEntities(categories), archiveFilters.catId, function(id){ archiveFilters.catId=id; renderArchive(); }, true);
  }

  function buildEntityRow(containerId, title, items, selectedId, onSelect, includeAny){
    var host = document.getElementById(containerId);
    host.innerHTML = "";

    // label-like pill
    var lab = document.createElement("div");
    lab.className = "badge";
    lab.textContent = title;
    host.appendChild(lab);

    if(includeAny){
      var anyBtn = document.createElement("button");
      anyBtn.className = "pillbtn " + (!selectedId ? "active": "");
      anyBtn.type="button";
      anyBtn.textContent = "×”×›×œ";
      anyBtn.onclick = function(){ onSelect(""); };
      host.appendChild(anyBtn);
    }

    items.forEach(function(it){
      var b = document.createElement("button");
      b.className = "pillbtn " + (selectedId===it.id ? "active":"");
      b.type="button";
      b.textContent = it.name;
      b.onclick = function(){ onSelect(it.id); };
      host.appendChild(b);
    });
  }

  // ===== Status icon SVG =====
  function ticketSVG(){
    return '<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">'+
      '<path d="M4 7.5c0-.828.672-1.5 1.5-1.5h13c.828 0 1.5.672 1.5 1.5v2a2 2 0 0 0 0 4v2c0 .828-.672 1.5-1.5 1.5h-13C4.672 19 4 18.328 4 17.5v-2a2 2 0 0 0 0-4v-2Z" stroke="currentColor" stroke-width="2" />'+
      '<path d="M9 8.5v9" stroke="currentColor" stroke-width="2" stroke-dasharray="2 2"/>'+
    '</svg>';
  }

  function getStatusClass(c){
    // Precedence: gray (archived/unavailable) > red (near expiry) > yellow (partial) > green (full/active)
    if(c.archived || isExpired(c) || (hasValueType(c.type) && computeRemaining(c)<=0) || (!hasValueType(c.type) && c.consumedManual)) return "s-gray";

    if(isNearExpiry(c)) return "s-red";

    if(hasValueType(c.type)){
      var used = Number(c.used||0);
      var rem = computeRemaining(c);
      if(used>0 && rem>0) return "s-yellow";
      return "s-green";
    }
    // no-value types: active = green unless near expiry (handled above)
    return "s-green";
  }

  // ===== Sorting =====
  function brandFrequencyMap(activeOnly){
    var map = {};
    (coupons||[]).forEach(function(c){
      if(activeOnly && c.archived) return;
      if(!c.brandId) return;
      map[c.brandId] = (map[c.brandId]||0) + 1;
    });
    return map;
  }

  function sortActiveCoupons(list){
    var freq = brandFrequencyMap(true);
    return list.slice().sort(function(a,b){
      // near-expiry first (<= 3 months) regardless
      var an = isNearExpiry(a) ? 1:0;
      var bn = isNearExpiry(b) ? 1:0;
      if(bn!==an) return bn-an;

      // brand frequency desc
      var af = freq[a.brandId]||0;
      var bf = freq[b.brandId]||0;
      if(bf!==af) return bf-af;

      // remaining desc (only if value)
      var ar = hasValueType(a.type) ? computeRemaining(a) : 0;
      var br = hasValueType(b.type) ? computeRemaining(b) : 0;
      if(br!==ar) return br-ar;

      // alphabetical by brand then id
      var ab = (getById(brands,a.brandId)||{name:""}).name || "";
      var bb = (getById(brands,b.brandId)||{name:""}).name || "";
      var cmp = ab.localeCompare(bb,"he");
      if(cmp!==0) return cmp;

      return String(a.id).localeCompare(String(b.id));
    });
  }

  function sortArchiveCoupons(list){
    return list.slice().sort(function(a,b){
      return (b.archivedAt||0) - (a.archivedAt||0);
    });
  }

  // ===== Display title line rules =====
  function couponDisplayTitle(c){
    var brand = getById(brands, c.brandId);
    var bname = brand ? brand.name : "××•×ª×’ ×œ× ×™×“×•×¢";

    // If store-specific (some), show brand then first store
    if(c.scope==="some"){
      var st = (c.storeIds||[]).map(function(id){ return getById(stores,id); }).filter(Boolean);
      var first = st.length ? st[0].name : "";
      if(first) return bname + " â€” " + first;
      return bname;
    }

    // all network: show brand + up to 2 highlighted stores (if exist)
    var hs = (c.highlightStoreIds||[]).map(function(id){ return getById(stores,id); }).filter(Boolean).map(function(x){return x.name;});
    if(hs.length){
      var shown = hs.slice(0,2);
      var extra = hs.length - shown.length;
      return bname + " â€” " + shown.join(", ") + (extra>0 ? " +" + extra : "");
    }
    return bname;
  }

  function couponStoresLine(c){
    // If scope some -> list stores
    if(c.scope==="some"){
      var st = (c.storeIds||[]).map(function(id){ return getById(stores,id); }).filter(Boolean).map(function(x){return x.name;});
      if(!st.length) return "";
      return "×¨×§ ×‘×—× ×•×™×•×ª: " + st.slice(0,3).join(", ") + (st.length>3 ? " +" + (st.length-3) : "");
    }

    // scope all: if highlight stores exist show them, else show nothing (no "-")
    var hs = (c.highlightStoreIds||[]).map(function(id){ return getById(stores,id); }).filter(Boolean).map(function(x){return x.name;});
    if(hs.length){
      return "×—× ×•×™×•×ª ×¢×™×§×¨×™×•×ª: " + hs.slice(0,3).join(", ") + (hs.length>3 ? " +" + (hs.length-3) : "");
    }
    return "";
  }

  function couponSearchText(c){
    var brand = getById(brands, c.brandId);
    var bname = brand ? brand.name : "";
    var storeNames = (c.storeIds||[]).concat(c.highlightStoreIds||[]).map(function(id){
      var s = getById(stores,id); return s ? s.name : "";
    }).join(" ");
    var notes = (c.notes||"");
    return (bname + " " + storeNames + " " + notes).toLowerCase();
  }

  // ===== Render Active / Archive =====
  function matchesFilters(c, quick, f, searchText){
    // apply quick filter
    if(quick==="near" && !isNearExpiry(c)) return false;

    // brand filter
    if(f.brandId && c.brandId !== f.brandId) return false;

    // store filter: match in either storeIds or highlightStoreIds
    if(f.storeId){
      var all = (c.storeIds||[]).concat(c.highlightStoreIds||[]);
      if(all.indexOf(f.storeId)<0) return false;
    }

    // cat filter: coupon catIds
    if(f.catId){
      if((c.catIds||[]).indexOf(f.catId)<0) return false;
    }

    // search
    if(searchText){
      var hay = couponSearchText(c);
      if(hay.indexOf(searchText)<0) return false;
    }

    return true;
  }

  function renderActive(){
    normalizeCoupons();
    buildFilterRows();

    // quick buttons highlight
    document.getElementById("actFilterAll").classList.toggle("active", activeQuick==="all");
    document.getElementById("actFilterNear").classList.toggle("active", activeQuick==="near");

    var q = (document.getElementById("searchActive").value || "").trim().toLowerCase();

    var list = coupons.filter(function(c){
      // active means NOT archived
      if(c.archived) return false;
      // if expired or remaining 0 etc, normalizeCoupons should have archived it already
      return matchesFilters(c, activeQuick, activeFilters, q);
    });

    list = sortActiveCoupons(list);

    document.getElementById("activeCount").textContent = "××•×¦×’×™×: " + list.length;

    var host = document.getElementById("activeList");
    host.innerHTML = "";
    if(!list.length){
      host.innerHTML = '<div class="note">××™×Ÿ ×©×•×‘×¨×™× ×œ×”×¦×’×”.</div>';
      return;
    }

    list.forEach(function(c){
      host.appendChild(renderCouponCard(c, false));
    });
  }

  function renderArchive(){
    normalizeCoupons();
    buildFilterRows();

    document.getElementById("arcFilterAll").classList.toggle("active", archiveQuick==="all");
    document.getElementById("arcFilterNear").classList.toggle("active", archiveQuick==="near");

    var q = (document.getElementById("searchArchive").value || "").trim().toLowerCase();

    var list = coupons.filter(function(c){
      if(!c.archived) return false;
      return matchesFilters(c, archiveQuick, archiveFilters, q);
    });

    list = sortArchiveCoupons(list);

    document.getElementById("archiveCount").textContent = "××•×¦×’×™×: " + list.length;

    var host = document.getElementById("archiveList");
    host.innerHTML = "";
    if(!list.length){
      host.innerHTML = '<div class="note">××™×Ÿ ×¤×¨×™×˜×™× ×‘××¨×›×™×•×Ÿ ×œ×”×¦×’×”.</div>';
      return;
    }

    list.forEach(function(c){
      host.appendChild(renderCouponCard(c, true));
    });
  }

  function renderCouponCard(c, isArchive){
    var card = document.createElement("div");
    card.className = "couponCard";

    var top = document.createElement("div");
    top.className = "couponTop";

    var left = document.createElement("div");
    left.style.minWidth = "0";
    left.style.flex = "1";

    var title = document.createElement("div");
    title.className = "couponTitle";
    title.textContent = couponDisplayTitle(c);

    var meta = document.createElement("div");
    meta.className = "couponMeta";

    // Type badge
    var tBadge = document.createElement("span");
    tBadge.className = "badge";
    tBadge.textContent = "×¡×•×’: " + (c.type||"");
    meta.appendChild(tBadge);

    // Physical
    if(c.physical){
      var pBadge = document.createElement("span");
      pBadge.className = "badge";
      pBadge.textContent = "×›×¨×˜×™×¡ ×¤×™×–×™";
      meta.appendChild(pBadge);
    }

    // Expiry
    if(c.expiryISO){
      var expB = document.createElement("span");
      var near = isNearExpiry(c);
      var expd = isExpired(c);
      expB.className = "badge " + (expd ? "gray" : near ? "red" : "soft");
      expB.textContent = "×ª×•×§×£: " + fmtDateIL(c.expiryISO);
      meta.appendChild(expB);
    }

    // Amount info
    if(hasValueType(c.type)){
      var rem = computeRemaining(c);
      var used = Number(c.used||0);

      var b = document.createElement("span");
      var cls = "green";
      if(isNearExpiry(c)) cls = "red";
      else if(used>0 && rem>0) cls = "yellow";
      b.className = "badge " + cls;
      b.textContent = "×™×ª×¨×”: â‚ª" + rem;
      meta.appendChild(b);
    }

    // Store line if needed
    var storeLine = couponStoresLine(c);
    if(storeLine){
      var sB = document.createElement("span");
      sB.className = "badge";
      sB.textContent = storeLine;
      meta.appendChild(sB);
    }

    left.appendChild(title);
    left.appendChild(meta);

    var actions = document.createElement("div");
    actions.className = "actions";

    // Status icon on the left of "Open" (as requested)
    var icon = document.createElement("div");
    icon.className = "statusIcon " + getStatusClass(c);
    icon.innerHTML = ticketSVG();
    actions.appendChild(icon);

    var open = document.createElement("button");
    open.className = "openbtn";
    open.type="button";
    open.textContent = "×¤×ª×—";
    open.onclick = function(){ openCouponEditor(c.id); };
    actions.appendChild(open);

    top.appendChild(left);
    top.appendChild(actions);

    card.appendChild(top);
    return card;
  }

  // ===== Coupon editor modal =====
  var editingCouponId = null;
  var pickedBrandId = "";
  var pickedStoreIds = [];
  var pickedHighlightStoreIds = [];
  var pickedCatIds = [];

  function openCouponEditor(couponId){
    editingCouponId = couponId;
    var c = couponId ? getCouponById(couponId) : null;

    document.getElementById("couponModalTitle").textContent = couponId ? "âœï¸ ×¢×¨×™×›×ª ×©×•×‘×¨" : "â• ×™×¦×™×¨×ª ×©×•×‘×¨ ×—×“×©";
    document.getElementById("couponModalHint").textContent = "";

    // defaults
    document.getElementById("cType").value = (c && c.type) ? c.type : "×›×¡×¤×™"; // default monetary
    document.getElementById("cPhysical").value = (c && c.physical) ? "yes" : "no";
    document.getElementById("cCode").value = c ? (c.code||"") : "";
    document.getElementById("cNotes").value = c ? (c.notes||"") : "";
    document.getElementById("cExpiry").value = c ? (c.expiryISO||"") : "";

    // brand / stores / cats
    pickedBrandId = c ? (c.brandId||"") : "";
    pickedStoreIds = c ? (c.storeIds||[]) : [];
    pickedHighlightStoreIds = c ? (c.highlightStoreIds||[]) : [];
    pickedCatIds = c ? (c.catIds||[]) : [];

    // scope hidden until brand chosen
    document.getElementById("scopeField").style.display = pickedBrandId ? "block" : "none";
    document.getElementById("storesField").style.display = pickedBrandId ? "block" : "none";

    document.getElementById("cScope").value = c ? (c.scope||"all") : "all";

    // amounts
    if(hasValueType(document.getElementById("cType").value)){
      document.getElementById("amountsBlock").style.display = "block";
      document.getElementById("cTotal").value = c ? Number(c.total||0) : "";
      document.getElementById("cUsed").value = c ? Number(c.used||0) : "";
    } else {
      document.getElementById("amountsBlock").style.display = "none";
      document.getElementById("cTotal").value = "";
      document.getElementById("cUsed").value = "";
      document.getElementById("cRemaining").value = "";
    }

    // consumed/archive buttons context
    var delBtn = document.querySelector("#couponBackdrop .btn.danger");
    delBtn.style.display = couponId ? "inline-flex" : "none";

    renderPickedBrandLine();
    renderCouponTypeUI();
    renderScopeUI();
    renderStoreChoices();
    renderCatChoices();
    recalcRemaining();

    document.getElementById("couponBackdrop").style.display = "flex";
  }
  window.openCouponEditor = openCouponEditor;

  function hideCouponModal(){
    document.getElementById("couponBackdrop").style.display = "none";
    editingCouponId = null;
  }
  window.hideCouponModal = hideCouponModal;

  function closeCouponModal(e){
    if(e.target === document.getElementById("couponBackdrop")) hideCouponModal();
  }
  window.closeCouponModal = closeCouponModal;

  function renderCouponTypeUI(){
    var t = document.getElementById("cType").value;
    var isVal = hasValueType(t);

    document.getElementById("amountsBlock").style.display = isVal ? "block" : "none";
    // code field always shown (even physical), because physical still may have number to paste; user asked only remove hint text near physical
    document.getElementById("codeField").style.display = "block";

    // if switching to non-value, clear amount fields
    if(!isVal){
      document.getElementById("cTotal").value = "";
      document.getElementById("cUsed").value = "";
      document.getElementById("cRemaining").value = "";
    } else {
      recalcRemaining();
    }

    renderActive();
    renderArchive();
  }
  window.renderCouponTypeUI = renderCouponTypeUI;

  function renderScopeUI(){
    var hasBrand = !!pickedBrandId;
    document.getElementById("scopeField").style.display = hasBrand ? "block" : "none";
    document.getElementById("storesField").style.display = hasBrand ? "block" : "none";

    if(!hasBrand) return;

    var scope = document.getElementById("cScope").value;
    var lbl = document.getElementById("storesLabel");
    var note = document.getElementById("storesNote");

    if(scope==="all"){
      lbl.textContent = "×—× ×•×™×•×ª ×¢×™×§×¨×™×•×ª (××•×¤×¦×™×•× ×œ×™)";
      note.textContent = "×× ×‘×—×¨×ª ×ª×§×£ ×œ×›×œ ×”×¨×©×ª â€” ××¤×©×¨ ×œ×”×©××™×¨ ×‘×œ×™ ×—× ×•×™×•×ª. ×× ×ª×‘×—×¨ ×—× ×•×™×•×ª ×›××Ÿ, ×–×” ×¨×§ â€˜××•×¢×“×¤×™×â€™ ×œ×ª×¦×•×’×”.";
    } else {
      lbl.textContent = "×—× ×•×™×•×ª ×ª×§×¤×•×ª (×—×•×‘×”)";
      note.textContent = "×‘×—×¨ ×œ×¤×—×•×ª ×—× ×•×ª ××—×ª.";
    }

    // update store summary
    renderStoreChoices();
  }
  window.renderScopeUI = renderScopeUI;

  function renderPickedBrandLine(){
    var el = document.getElementById("pickedBrandLine");
    var b = pickedBrandId ? getById(brands,pickedBrandId) : null;
    if(!b){
      el.innerHTML = "<b>×œ× × ×‘×—×¨ ××•×ª×’</b>";
      document.getElementById("scopeField").style.display = "none";
      document.getElementById("storesField").style.display = "none";
      return;
    }
    el.innerHTML = "× ×‘×—×¨ ××•×ª×’: <b>" + escapeHtml(b.name) + "</b>";
    document.getElementById("scopeField").style.display = "block";
    document.getElementById("storesField").style.display = "block";
  }

  function recalcRemaining(){
    var t = document.getElementById("cType").value;
    if(!hasValueType(t)) return;
    var total = Number(document.getElementById("cTotal").value || 0);
    var used = Number(document.getElementById("cUsed").value || 0);
    if(!isFinite(total)) total = 0;
    if(!isFinite(used)) used = 0;
    var rem = total - used;
    if(!isFinite(rem)) rem = 0;
    rem = Math.max(0, Math.round(rem*100)/100);
    document.getElementById("cRemaining").value = rem;
  }
  window.recalcRemaining = recalcRemaining;

  function getCouponById(id){
    for(var i=0;i<coupons.length;i++){ if(coupons[i].id===id) return coupons[i]; }
    return null;
  }

  function saveCoupon(){
    // validations:
    // Must have brand (as per your simplified requirement)
    if(!pickedBrandId) return alert("×‘×—×¨ ××•×ª×’ ××• ×¦×•×¨ ××•×ª×’ ×—×“×© ×œ×¤× ×™ ×©××™×¨×”.");

    var type = document.getElementById("cType").value || "×›×¡×¤×™";
    var scope = document.getElementById("cScope").value || "all";

    var physical = (document.getElementById("cPhysical").value === "yes");
    var code = document.getElementById("cCode").value || "";
    var notes = document.getElementById("cNotes").value || "";
    var expiry = document.getElementById("cExpiry").value || "";

    var catIds = pickedCatIds.slice();

    var storeIds = [];
    var highlightIds = [];

    if(scope==="some"){
      storeIds = pickedStoreIds.slice();
      if(!storeIds.length) return alert("×‘×—×¨ ×œ×¤×—×•×ª ×—× ×•×ª ××—×ª (×›×™ ×‘×—×¨×ª '×¨×§ ×—× ×•×™×•×ª ××¡×•×™××•×ª').");
      highlightIds = [];
    } else {
      // all network: store selection is optional but saved as highlights
      highlightIds = pickedHighlightStoreIds.slice();
      storeIds = [];
    }

    var total = null, used = null;
    if(hasValueType(type)){
      total = Number(document.getElementById("cTotal").value || 0);
      used = Number(document.getElementById("cUsed").value || 0);
      if(!isFinite(total)) total = 0;
      if(!isFinite(used)) used = 0;
      if(used<0) used=0;
      if(total<0) total=0;
    }

    var now = Date.now();

    if(editingCouponId){
      var c = getCouponById(editingCouponId);
      if(!c) return alert("×©×•×‘×¨ ×œ× × ××¦×.");
      c.type = type;
      c.brandId = pickedBrandId;
      c.scope = scope;
      c.storeIds = storeIds;
      c.highlightStoreIds = highlightIds;
      c.catIds = catIds;
      c.physical = physical;
      c.code = code;
      c.notes = notes;
      c.expiryISO = expiry;
      c.total = total;
      c.used = used;
      c.updatedAt = now;

      // if edited from archive and becomes available again: allow by explicit action (restore)
      // we keep archived unless user restores from archive
      // but if user adjusts used/expiry to make it available, we keep it archived until they restore (prevents surprises)
      // (User can restore via "×”×—×–×¨ ×œ×¤×¢×™×œ" button in archive open screen â€” implemented below)
      ensureArchiveState(c);
    } else {
      var c2 = {
        id: uid("c"),
        createdAt: now,
        updatedAt: now,
        type: type,
        brandId: pickedBrandId,
        scope: scope,
        storeIds: storeIds,
        highlightStoreIds: highlightIds,
        catIds: catIds,
        physical: physical,
        code: code,
        notes: notes,
        expiryISO: expiry,
        total: total,
        used: used,
        consumedManual: false,
        archived: false,
        archivedAt: 0,
        archivedReason: ""
      };
      coupons.push(ensureArchiveState(c2));
    }

    persistAll();
    normalizeCoupons();
    hideCouponModal();
    renderAll();
  }
  window.saveCoupon = saveCoupon;

  function markCouponConsumed(){
    if(!editingCouponId){
      alert("×©××•×¨ ××ª ×”×©×•×‘×¨ ×§×•×“×, ×•××– ×ª×•×›×œ ×œ×”×¢×‘×™×¨ ×œ××¨×›×™×•×Ÿ.");
      return;
    }
    var c = getCouponById(editingCouponId);
    if(!c) return;

    if(hasValueType(c.type)){
      // set used = total
      c.used = Number(c.total||0);
    } else {
      c.consumedManual = true;
    }
    c.updatedAt = Date.now();
    ensureArchiveState(c);

    persistAll();
    normalizeCoupons();
    hideCouponModal();
    renderAll();
  }
  window.markCouponConsumed = markCouponConsumed;

  function deleteCoupon(){
    if(!editingCouponId) return;
    if(!confirm("×œ××—×•×§ ×©×•×‘×¨ ×œ×¦××™×ª×•×ª ××”××›×©×™×¨? (×œ× ××•××œ×¥ ×‘×“×¨×š ×›×œ×œ)")) return;

    coupons = coupons.filter(function(x){ return x.id !== editingCouponId; });
    persistAll();
    normalizeCoupons();
    hideCouponModal();
    renderAll();
  }
  window.deleteCoupon = deleteCoupon;

  // ===== Brand picker + inline create =====
  var pickerMode = ""; // "brandPick" | "brandOpen" | "storeOpen" | "catOpen"
  var pickerMulti = false;
  var pickerSelected = []; // ids
  var pickerContext = {};  // for manage details etc.

  function openPickBrand(){
    pickerMode = "brandPick";
    pickerMulti = false;
    pickerSelected = pickedBrandId ? [pickedBrandId] : [];
    pickerContext = {};
    showPicker("×‘×—×¨ ××•×ª×’", listActiveEntities(brands), false, true);
  }
  window.openPickBrand = openPickBrand;

  function createBrandInline(){
    var name = normName(document.getElementById("newBrandInline").value);
    if(!name) return;

    // check exists
    var existing = brands.find(function(b){ return String(b.name).toLowerCase() === name.toLowerCase(); });
    if(existing){
      if(existing.disabled){
        if(confirm('×”××•×ª×’ "'+existing.name+'" ×§×™×™× ××š ××•×©×‘×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?')){
          existing.disabled = false;
          persistAll();
          pickedBrandId = existing.id;
          renderPickedBrandLine();
          renderScopeUI();
          renderStoreChoices();
          renderCatChoices();
          document.getElementById("newBrandInline").value = "";
          alert("×”××•×ª×’ ×”×•×—×–×¨ ×œ×¤×¢×™×œ âœ…");
          return;
        }
      }
      alert("×”××•×ª×’ ×›×‘×¨ ×§×™×™×.");
      return;
    }

    var b = { id: uid("b"), name: name, disabled:false };
    brands.push(b);
    persistAll();

    pickedBrandId = b.id;
    document.getElementById("newBrandInline").value = "";

    renderPickedBrandLine();
    renderScopeUI();
    renderStoreChoices();
    renderCatChoices();
    renderAll();
  }
  window.createBrandInline = createBrandInline;

  function createStoreInline(){
    var name = normName(document.getElementById("newStoreInline").value);
    if(!name) return;

    var existing = stores.find(function(s){ return String(s.name).toLowerCase() === name.toLowerCase(); });
    if(existing){
      if(existing.disabled){
        if(confirm('×”×—× ×•×ª "'+existing.name+'" ×§×™×™××ª ××š ××•×©×‘×ª×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?')){
          existing.disabled = false;
          persistAll();
          document.getElementById("newStoreInline").value = "";
          renderStoreChoices();
          alert("×”×—× ×•×ª ×”×•×—×–×¨×” ×œ×¤×¢×™×œ âœ…");
          return;
        }
      }
      alert("×”×—× ×•×ª ×›×‘×¨ ×§×™×™××ª.");
      return;
    }

    var s = { id: uid("s"), name: name, disabled:false };
    stores.push(s);
    persistAll();
    document.getElementById("newStoreInline").value = "";
    renderStoreChoices();
    renderAll();
  }
  window.createStoreInline = createStoreInline;

  function createCategoryInline(){
    var name = normName(document.getElementById("newCatInline").value);
    if(!name) return;

    var existing = categories.find(function(k){ return String(k.name).toLowerCase() === name.toLowerCase(); });
    if(existing){
      if(existing.disabled){
        if(confirm('×”×§×˜×’×•×¨×™×” "'+existing.name+'" ×§×™×™××ª ××š ××•×©×‘×ª×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?')){
          existing.disabled = false;
          persistAll();
          document.getElementById("newCatInline").value = "";
          renderCatChoices();
          alert("×”×§×˜×’×•×¨×™×” ×”×•×—×–×¨×” ×œ×¤×¢×™×œ âœ…");
          return;
        }
      }
      alert("×”×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª.");
      return;
    }

    var k = { id: uid("k"), name:name, disabled:false };
    categories.push(k);
    persistAll();
    document.getElementById("newCatInline").value = "";
    renderCatChoices();
    renderAll();
  }
  window.createCategoryInline = createCategoryInline;

  function renderStoreChoices(){
    var scope = document.getElementById("cScope").value || "all";
    var list = listActiveEntities(stores);

    var host = document.getElementById("storesChoices");
    host.innerHTML = "";

    var selected = (scope==="some") ? pickedStoreIds : pickedHighlightStoreIds;

    list.forEach(function(s){
      var row = document.createElement("label");
      row.className = "choiceRow " + (selected.indexOf(s.id)>=0 ? "active" : "");
      row.innerHTML = '<input type="checkbox" '+(selected.indexOf(s.id)>=0?'checked':'')+' />' +
                      '<div style="font-weight:900;">'+escapeHtml(s.name)+'</div>';
      var cb = row.querySelector("input");
      cb.onchange = function(){
        if(scope==="some"){
          if(cb.checked) pickedStoreIds = uniq(pickedStoreIds.concat([s.id]));
          else pickedStoreIds = removeFromArray(pickedStoreIds, s.id);
        } else {
          if(cb.checked) pickedHighlightStoreIds = uniq(pickedHighlightStoreIds.concat([s.id]));
          else pickedHighlightStoreIds = removeFromArray(pickedHighlightStoreIds, s.id);
        }
        renderStoreChoices();
      };
      host.appendChild(row);
    });

    var summary = document.getElementById("storesSummary");
    var names = selected.map(function(id){
      var x = getById(stores,id); return x ? x.name : "";
    }).filter(Boolean);

    if(!names.length){
      summary.textContent = (scope==="some") ? "×‘×—×¨ ×—× ×•×™×•×ª" : "×‘×—×¨ ×—× ×•×™×•×ª ×¢×™×§×¨×™×•×ª (××•×¤×¦×™×•× ×œ×™)";
    } else {
      summary.textContent = "× ×‘×—×¨×•: " + names.slice(0,2).join(", ") + (names.length>2 ? " +" + (names.length-2) : "");
    }
  }

  function renderCatChoices(){
    var list = listActiveEntities(categories);
    var host = document.getElementById("catsChoices");
    host.innerHTML = "";

    list.forEach(function(k){
      var row = document.createElement("label");
      row.className = "choiceRow " + (pickedCatIds.indexOf(k.id)>=0 ? "active":"");
      row.innerHTML = '<input type="checkbox" '+(pickedCatIds.indexOf(k.id)>=0?'checked':'')+' />' +
                      '<div style="font-weight:900;">'+escapeHtml(k.name)+'</div>';
      var cb = row.querySelector("input");
      cb.onchange = function(){
        if(cb.checked) pickedCatIds = uniq(pickedCatIds.concat([k.id]));
        else pickedCatIds = removeFromArray(pickedCatIds, k.id);
        renderCatChoices();
      };
      host.appendChild(row);
    });

    var sum = document.getElementById("catsSummary");
    var names = pickedCatIds.map(function(id){
      var x = getById(categories,id); return x ? x.name : "";
    }).filter(Boolean);
    sum.textContent = names.length ? ("× ×‘×—×¨×•: " + names.slice(0,2).join(", ") + (names.length>2 ? " +" + (names.length-2) : "")) : "×‘×—×¨ ×§×˜×’×•×¨×™×•×ª";
  }

  // ===== Picker modal (generic) =====
  function showPicker(title, items, multi, allowCreate){
    pickerMulti = !!multi;

    document.getElementById("pickerTitle").textContent = title;
    document.getElementById("pickerSearch").value = "";
    document.getElementById("pickerBackdrop").style.display = "flex";

    pickerContext.items = items.slice(); // cache
    pickerContext.allowCreate = !!allowCreate;

    renderPickerList();
    renderPickerBottom();
  }

  function hidePicker(){
    document.getElementById("pickerBackdrop").style.display = "none";
    pickerMode = "";
    pickerSelected = [];
    pickerContext = {};
  }
  window.hidePicker = hidePicker;

  function closePickerModal(e){
    if(e.target === document.getElementById("pickerBackdrop")) hidePicker();
  }
  window.closePickerModal = closePickerModal;

  function renderPickerList(){
    var host = document.getElementById("pickerList");
    host.innerHTML = "";

    var q = (document.getElementById("pickerSearch").value || "").trim().toLowerCase();
    var items = (pickerContext.items || []).filter(function(it){
      if(!q) return true;
      return String(it.name||"").toLowerCase().indexOf(q)>=0;
    });

    if(!items.length){
      host.innerHTML = '<div class="note">××™×Ÿ ×ª×•×¦××•×ª.</div>';
      return;
    }

    items.forEach(function(it){
      var isOn = pickerSelected.indexOf(it.id)>=0;
      var row = document.createElement("label");
      row.className = "choiceRow " + (isOn ? "active":"");
      row.innerHTML = '<input type="'+(pickerMulti?'checkbox':'radio')+'" name="pickerOne" '+(isOn?'checked':'')+' />' +
                      '<div style="font-weight:900;">'+escapeHtml(it.name)+'</div>';
      var inp = row.querySelector("input");
      inp.onchange = function(){
        if(pickerMulti){
          if(inp.checked) pickerSelected = uniq(pickerSelected.concat([it.id]));
          else pickerSelected = removeFromArray(pickerSelected, it.id);
        } else {
          pickerSelected = [it.id];
        }
        renderPickerList();
      };
      host.appendChild(row);
    });
  }

  function renderPickerBottom(){
    var bottom = document.getElementById("pickerBottom");
    bottom.innerHTML = "";

    if(pickerMode==="brandPick"){
      bottom.innerHTML = '<div class="note">×‘×—×¨ ××•×ª×’ ×§×™×™×. ×× ×—×¡×¨ â€” ×¡×’×•×¨ ×•×—×–×•×¨ ×œ×™×¦×™×¨×ª ×©×•×‘×¨ ×›×“×™ ×œ×™×¦×•×¨ ××•×ª×’ ×—×“×©.</div>';
    } else {
      bottom.innerHTML = '<div class="note">× ×™×”×•×œ ×§×©×¨×™× ××ª×‘×¦×¢ ×‘××¡×›×™ â€œ×¤×ª×—â€.</div>';
    }
  }

  function pickerConfirm(){
    if(pickerMode==="brandPick"){
      if(!pickerSelected.length) return alert("×‘×—×¨ ××•×ª×’.");
      pickedBrandId = pickerSelected[0];
      renderPickedBrandLine();
      renderScopeUI();
      renderStoreChoices();
      renderCatChoices();
      hidePicker();
      return;
    }

    // Other picker modes used for manage details (handled there)
    hidePicker();
  }
  window.pickerConfirm = pickerConfirm;

  // ===== Manage tab (lists + open details) =====
  function clearManageSearch(){
    document.getElementById("manageSearch").value = "";
    renderManage();
  }
  window.clearManageSearch = clearManageSearch;

  function addBrandFromManage(){
    var name = normName(document.getElementById("newBrandName").value);
    if(!name) return;

    var existing = brands.find(function(b){ return String(b.name).toLowerCase()===name.toLowerCase(); });
    if(existing){
      if(existing.disabled){
        if(confirm('×”××•×ª×’ "'+existing.name+'" ×§×™×™× ××š ××•×©×‘×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?')){
          existing.disabled=false;
          persistAll();
          renderManage();
          document.getElementById("newBrandName").value="";
          alert("×”××•×ª×’ ×”×•×—×–×¨ ×œ×¤×¢×™×œ âœ…");
          return;
        }
      }
      alert("×”××•×ª×’ ×›×‘×¨ ×§×™×™×.");
      return;
    }

    brands.push({id:uid("b"), name:name, disabled:false});
    persistAll();
    document.getElementById("newBrandName").value="";
    renderManage();
    renderAll();
  }
  window.addBrandFromManage = addBrandFromManage;

  function addStoreFromManage(){
    var name = normName(document.getElementById("newStoreName").value);
    if(!name) return;

    var existing = stores.find(function(s){ return String(s.name).toLowerCase()===name.toLowerCase(); });
    if(existing){
      if(existing.disabled){
        if(confirm('×”×—× ×•×ª "'+existing.name+'" ×§×™×™××ª ××š ××•×©×‘×ª×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?')){
          existing.disabled=false;
          persistAll();
          renderManage();
          document.getElementById("newStoreName").value="";
          alert("×”×—× ×•×ª ×”×•×—×–×¨×” ×œ×¤×¢×™×œ âœ…");
          return;
        }
      }
      alert("×”×—× ×•×ª ×›×‘×¨ ×§×™×™××ª.");
      return;
    }

    stores.push({id:uid("s"), name:name, disabled:false});
    persistAll();
    document.getElementById("newStoreName").value="";
    renderManage();
    renderAll();
  }
  window.addStoreFromManage = addStoreFromManage;

  function addCategoryFromManage(){
    var name = normName(document.getElementById("newCatName").value);
    if(!name) return;

    var existing = categories.find(function(k){ return String(k.name).toLowerCase()===name.toLowerCase(); });
    if(existing){
      if(existing.disabled){
        if(confirm('×”×§×˜×’×•×¨×™×” "'+existing.name+'" ×§×™×™××ª ××š ××•×©×‘×ª×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?')){
          existing.disabled=false;
          persistAll();
          renderManage();
          document.getElementById("newCatName").value="";
          alert("×”×§×˜×’×•×¨×™×” ×”×•×—×–×¨×” ×œ×¤×¢×™×œ âœ…");
          return;
        }
      }
      alert("×”×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª.");
      return;
    }

    categories.push({id:uid("k"), name:name, disabled:false});
    persistAll();
    document.getElementById("newCatName").value="";
    renderManage();
    renderAll();
  }
  window.addCategoryFromManage = addCategoryFromManage;

  function renderManage(){
    var q = (document.getElementById("manageSearch").value || "").trim().toLowerCase();

    // Brands list
    var bl = document.getElementById("brandsList");
    bl.innerHTML = "";
    brands.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(b){
      if(q && b.name.toLowerCase().indexOf(q)<0) return;
      bl.appendChild(renderManageRow("brand", b));
    });

    // Stores list
    var sl = document.getElementById("storesList");
    sl.innerHTML = "";
    stores.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(s){
      if(q && s.name.toLowerCase().indexOf(q)<0) return;
      sl.appendChild(renderManageRow("store", s));
    });

    // Categories list
    var cl = document.getElementById("catsList");
    cl.innerHTML = "";
    categories.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(k){
      if(q && k.name.toLowerCase().indexOf(q)<0) return;
      cl.appendChild(renderManageRow("cat", k));
    });
  }

  function renderManageRow(kind, item){
    var li = document.createElement("li");

    var left = document.createElement("div");
    left.style.display="flex";
    left.style.alignItems="center";
    left.style.gap="8px";
    left.style.minWidth="0";
    left.style.flex="1";

    var name = document.createElement("span");
    name.textContent = item.name;

    left.appendChild(name);

    if(item.disabled){
      var tag = document.createElement("span");
      tag.className="disabledTag";
      tag.textContent="××•×©×‘×ª";
      left.appendChild(tag);
    }

    var grp = document.createElement("div");
    grp.className = "btnGroup";

    // Open details (blue arrow)
    var open = document.createElement("button");
    open.className = "iconbtn openSmall";
    open.type="button";
    open.title="×¤×ª×—";
    open.textContent = "â¤´";
    open.onclick = function(){
      if(kind==="brand") openBrandDetails(item.id);
      else if(kind==="store") openStoreDetails(item.id);
      else openCatDetails(item.id);
    };

    // Edit name
    var edit = document.createElement("button");
    edit.className = "iconbtn";
    edit.type="button";
    edit.title="×©× ×” ×©×";
    edit.textContent = "âœï¸";
    edit.onclick = function(){
      var next = (prompt("×©× ×—×“×©:", item.name) || "").trim();
      if(!next) return;
      var exists = null;
      if(kind==="brand") exists = brands.find(function(x){ return x.id!==item.id && x.name.toLowerCase()===next.toLowerCase(); });
      if(kind==="store") exists = stores.find(function(x){ return x.id!==item.id && x.name.toLowerCase()===next.toLowerCase(); });
      if(kind==="cat") exists = categories.find(function(x){ return x.id!==item.id && x.name.toLowerCase()===next.toLowerCase(); });
      if(exists) return alert("×©× ×›×‘×¨ ×§×™×™×.");

      item.name = next;
      persistAll();
      renderAll();
    };

    // Enable/Disable
    var en = document.createElement("button");
    en.className = "iconbtn enableBtn";
    en.type="button";
    en.title = item.disabled ? "×”×—×–×¨ ×œ×¤×¢×™×œ" : "×”×©×‘×ª";
    en.textContent = item.disabled ? "âœ…" : "â›”";
    en.onclick = function(){
      if(item.disabled){
        item.disabled = false;
      } else {
        if(!confirm("×œ×”×©×‘×™×ª? (×œ× ××•×—×§ ×”×™×¡×˜×•×¨×™×”)")) return;
        item.disabled = true;
      }
      persistAll();
      renderAll();
    };

    grp.appendChild(open);
    grp.appendChild(edit);
    grp.appendChild(en);

    li.appendChild(left);
    li.appendChild(grp);

    return li;
  }

  // ===== Manage Details Modals (reuse picker modal UI) =====
  var detailsKind = ""; // brand|store|cat
  var detailsId = "";

  function openBrandDetails(brandId){
    var b = getById(brands,brandId);
    if(!b) return;

    detailsKind="brand"; detailsId=brandId;

    var storeIds = ensureLinksArray(links.brandStores, brandId).slice();
    var catIds = ensureLinksArray(links.brandCats, brandId).slice();

    showDetailsModal(
      "××•×ª×’: " + b.name,
      [
        { title:"×—× ×•×™×•×ª ××©×•×™×›×•×ª", list:listActiveEntities(stores), selected:storeIds, onSave:function(sel){ setBrandStores(brandId, sel); } },
        { title:"×§×˜×’×•×¨×™×•×ª ×œ××•×ª×’", list:listActiveEntities(categories), selected:catIds, onSave:function(sel){ setBrandCats(brandId, sel); } }
      ],
      function(){
        var name = (prompt("×©× ×—×“×© ×œ××•×ª×’:", b.name) || "").trim();
        if(!name) return;
        if(brands.some(function(x){ return x.id!==b.id && x.name.toLowerCase()===name.toLowerCase(); })) return alert("×©× ×›×‘×¨ ×§×™×™×.");
        b.name=name; persistAll(); renderAll();
        // reopen
        openBrandDetails(brandId);
      }
    );
  }

  function openStoreDetails(storeId){
    var s = getById(stores,storeId);
    if(!s) return;

    detailsKind="store"; detailsId=storeId;

    var brandIds = ensureLinksArray(links.storeBrands, storeId).slice();
    var catIds = ensureLinksArray(links.storeCats, storeId).slice();

    showDetailsModal(
      "×—× ×•×ª: " + s.name,
      [
        { title:"××•×ª×’×™× ×©×œ ×”×—× ×•×ª", list:listActiveEntities(brands), selected:brandIds, onSave:function(sel){ setStoreBrands(storeId, sel); } },
        { title:"×§×˜×’×•×¨×™×•×ª ×œ×—× ×•×ª", list:listActiveEntities(categories), selected:catIds, onSave:function(sel){ setStoreCats(storeId, sel); } }
      ],
      function(){
        var name = (prompt("×©× ×—×“×© ×œ×—× ×•×ª:", s.name) || "").trim();
        if(!name) return;
        if(stores.some(function(x){ return x.id!==s.id && x.name.toLowerCase()===name.toLowerCase(); })) return alert("×©× ×›×‘×¨ ×§×™×™×.");
        s.name=name; persistAll(); renderAll();
        openStoreDetails(storeId);
      }
    );
  }

  function openCatDetails(catId){
    var k = getById(categories,catId);
    if(!k) return;

    detailsKind="cat"; detailsId=catId;

    var brandIds = ensureLinksArray(links.catBrands, catId).slice();
    var storeIds = ensureLinksArray(links.catStores, catId).slice();

    showDetailsModal(
      "×§×˜×’×•×¨×™×”: " + k.name,
      [
        { title:"××•×ª×’×™× ×‘×§×˜×’×•×¨×™×”", list:listActiveEntities(brands), selected:brandIds, onSave:function(sel){ setCatBrands(catId, sel); } },
        { title:"×—× ×•×™×•×ª ×‘×§×˜×’×•×¨×™×”", list:listActiveEntities(stores), selected:storeIds, onSave:function(sel){ setCatStores(catId, sel); } }
      ],
      function(){
        var name = (prompt("×©× ×—×“×© ×œ×§×˜×’×•×¨×™×”:", k.name) || "").trim();
        if(!name) return;
        if(categories.some(function(x){ return x.id!==k.id && x.name.toLowerCase()===name.toLowerCase(); })) return alert("×©× ×›×‘×¨ ×§×™×™×.");
        k.name=name; persistAll(); renderAll();
        openCatDetails(catId);
      }
    );
  }

  function showDetailsModal(title, sections, onRename){
    // Use picker modal as details UI
    document.getElementById("pickerBackdrop").style.display = "flex";
    document.getElementById("pickerTitle").textContent = title;

    // lock picker search for details
    document.getElementById("pickerSearch").value = "";
    document.getElementById("pickerSearch").placeholder = "×˜×™×¤: ×¡××Ÿ/×‘×˜×œ ×¡×™××•×Ÿ ×›×“×™ ×œ×©×™×™×š";

    var host = document.getElementById("pickerList");
    host.innerHTML = "";

    sections.forEach(function(sec, idx){
      var h = document.createElement("div");
      h.className = "badge";
      h.style.marginTop = "8px";
      h.textContent = sec.title;
      host.appendChild(h);

      sec.list.forEach(function(it){
        var isOn = sec.selected.indexOf(it.id)>=0;
        var row = document.createElement("label");
        row.className = "choiceRow " + (isOn ? "active":"");
        row.innerHTML = '<input type="checkbox" '+(isOn?'checked':'')+' />' +
                        '<div style="font-weight:900;">'+escapeHtml(it.name)+'</div>';
        var cb = row.querySelector("input");
        cb.onchange = function(){
          if(cb.checked) sec.selected = uniq(sec.selected.concat([it.id]));
          else sec.selected = removeFromArray(sec.selected, it.id);
          row.classList.toggle("active", cb.checked);
        };
        host.appendChild(row);
      });

      // small separator
      if(idx < sections.length-1){
        var sep = document.createElement("div");
        sep.className = "hr";
        host.appendChild(sep);
      }
    });

    var bottom = document.getElementById("pickerBottom");
    bottom.innerHTML = "";

    var row = document.createElement("div");
    row.className = "inline";

    var saveBtn = document.createElement("button");
    saveBtn.className = "btn primary fit";
    saveBtn.type="button";
    saveBtn.textContent = "×©××™×¨×”";
    saveBtn.onclick = function(){
      // commit all section changes
      sections.forEach(function(sec){
        sec.onSave(sec.selected.slice());
      });
      persistAll();
      renderAll();
      alert("× ×©××¨ âœ…");
    };

    var renameBtn = document.createElement("button");
    renameBtn.className = "btn ghost fit";
    renameBtn.type="button";
    renameBtn.textContent = "×©× ×” ×©×";
    renameBtn.onclick = function(){ onRename && onRename(); };

    var closeBtn = document.createElement("button");
    closeBtn.className = "btn mutebtn fit";
    closeBtn.type="button";
    closeBtn.textContent = "×¡×’×•×¨";
    closeBtn.onclick = function(){ hidePicker(); };

    row.appendChild(saveBtn);
    row.appendChild(renameBtn);
    row.appendChild(closeBtn);

    bottom.appendChild(row);

    // Override confirm button in header (we're in details mode)
    // We'll repurpose "××™×©×•×¨" as save
    var confirmBtn = document.querySelector("#pickerBackdrop .modalActions .tiny");
    if(confirmBtn){
      confirmBtn.textContent = "×©××™×¨×”";
      confirmBtn.onclick = saveBtn.onclick;
    }
  }

  // ===== Link setters (keep both directions consistent) =====
  function setBrandStores(brandId, storeIds){
    storeIds = uniq(storeIds);

    // brand -> stores
    setLink(links.brandStores, brandId, storeIds);

    // update store -> brands
    // remove brand from all stores, then add to selected
    Object.keys(links.storeBrands).forEach(function(sid){
      links.storeBrands[sid] = removeFromArray(ensureLinksArray(links.storeBrands, sid), brandId);
      if(!links.storeBrands[sid].length) delete links.storeBrands[sid];
    });
    storeIds.forEach(function(sid){
      var arr = ensureLinksArray(links.storeBrands, sid);
      setLink(links.storeBrands, sid, uniq(arr.concat([brandId])));
    });

    // keep cat cross maps untouched here
  }

  function setBrandCats(brandId, catIds){
    catIds = uniq(catIds);
    setLink(links.brandCats, brandId, catIds);

    // cat -> brands: remove brand from all cats, then add
    Object.keys(links.catBrands).forEach(function(cid){
      links.catBrands[cid] = removeFromArray(ensureLinksArray(links.catBrands, cid), brandId);
      if(!links.catBrands[cid].length) delete links.catBrands[cid];
    });
    catIds.forEach(function(cid){
      var arr = ensureLinksArray(links.catBrands, cid);
      setLink(links.catBrands, cid, uniq(arr.concat([brandId])));
    });
  }

  function setStoreBrands(storeId, brandIds){
    brandIds = uniq(brandIds);
    setLink(links.storeBrands, storeId, brandIds);

    // brand -> stores: remove store from all brands, then add
    Object.keys(links.brandStores).forEach(function(bid){
      links.brandStores[bid] = removeFromArray(ensureLinksArray(links.brandStores, bid), storeId);
      if(!links.brandStores[bid].length) delete links.brandStores[bid];
    });
    brandIds.forEach(function(bid){
      var arr = ensureLinksArray(links.brandStores, bid);
      setLink(links.brandStores, bid, uniq(arr.concat([storeId])));
    });
  }

  function setStoreCats(storeId, catIds){
    catIds = uniq(catIds);
    setLink(links.storeCats, storeId, catIds);

    // cat -> stores: remove store from all cats, then add
    Object.keys(links.catStores).forEach(function(cid){
      links.catStores[cid] = removeFromArray(ensureLinksArray(links.catStores, cid), storeId);
      if(!links.catStores[cid].length) delete links.catStores[cid];
    });
    catIds.forEach(function(cid){
      var arr = ensureLinksArray(links.catStores, cid);
      setLink(links.catStores, cid, uniq(arr.concat([storeId])));
    });
  }

  function setCatBrands(catId, brandIds){
    brandIds = uniq(brandIds);
    setLink(links.catBrands, catId, brandIds);

    // brandCats: remove cat from all brands, add for selected
    Object.keys(links.brandCats).forEach(function(bid){
      links.brandCats[bid] = removeFromArray(ensureLinksArray(links.brandCats, bid), catId);
      if(!links.brandCats[bid].length) delete links.brandCats[bid];
    });
    brandIds.forEach(function(bid){
      var arr = ensureLinksArray(links.brandCats, bid);
      setLink(links.brandCats, bid, uniq(arr.concat([catId])));
    });
  }

  function setCatStores(catId, storeIds){
    storeIds = uniq(storeIds);
    setLink(links.catStores, catId, storeIds);

    // storeCats: remove cat from all stores, add for selected
    Object.keys(links.storeCats).forEach(function(sid){
      links.storeCats[sid] = removeFromArray(ensureLinksArray(links.storeCats, sid), catId);
      if(!links.storeCats[sid].length) delete links.storeCats[sid];
    });
    storeIds.forEach(function(sid){
      var arr = ensureLinksArray(links.storeCats, sid);
      setLink(links.storeCats, sid, uniq(arr.concat([catId])));
    });
  }

  // ===== Data tools =====
  function clearCouponsOnly(){
    if(!confirm("×œ××—×•×§ ××ª ×›×œ ×”×©×•×‘×¨×™×?")) return;
    coupons = [];
    persistAll();
    renderAll();
  }
  window.clearCouponsOnly = clearCouponsOnly;

  function resetAll(){
    if(!confirm("××™×¤×•×¡ ××œ×?")) return;
    localStorage.clear();
    location.reload();
  }
  window.resetAll = resetAll;

  // ===== Device settings (Yanir only) =====
  function renderDeviceCard(){
    var card = document.getElementById("deviceCard");
    if(!card) return;
    if(DEVICE_NAME === "Yanir"){
      card.style.display = "block";
      var sel = document.getElementById("deviceNameSelect");
      if(sel) sel.value = DEVICE_NAME;
    } else {
      card.style.display = "none";
    }
  }
  function changeDeviceName(){
    var sel = document.getElementById("deviceNameSelect");
    if(!sel) return;
    DEVICE_NAME = sel.value || "Yanir";
    localStorage.setItem("deviceName", DEVICE_NAME);
    renderDeviceCard();
    showLocalNoteIfYanir();
  }
  window.changeDeviceName = changeDeviceName;

  // ===== Copy code in coupon (in â€œopenâ€) =====
  // We include inside editor: if code exists add a quick copy button in hint
  function updateCopyHint(){
    if(!editingCouponId) return;
    var c = getCouponById(editingCouponId);
    if(!c) return;
    var hint = document.getElementById("couponModalHint");
    if(!hint) return;

    var code = String(document.getElementById("cCode").value || "").trim();
    if(!code){
      hint.textContent = "××™×Ÿ ×§×•×“ ×œ×”×¢×ª×§×”.";
      return;
    }
    hint.innerHTML = '×™×© ×§×•×“. <button class="tiny" type="button" onclick="copyCurrentCode()">×”×¢×ª×§ ×§×•×“</button>';
  }
  window.copyCurrentCode = function(){
    var code = String(document.getElementById("cCode").value || "").trim();
    if(!code) return;
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(code).then(function(){
          alert("×”×•×¢×ª×§ âœ…");
        }).catch(function(){
          fallbackCopy(code);
        });
      } else {
        fallbackCopy(code);
      }
    } catch(e){
      fallbackCopy(code);
    }
  };
  function fallbackCopy(text){
    try{
      var ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("×”×•×¢×ª×§ âœ…");
    } catch(e){
      alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§. ×ª×¢×ª×™×§ ×™×“× ×™×ª.");
    }
  }

  // Observe code changes to refresh hint
  document.getElementById("cCode").addEventListener("input", function(){ updateCopyHint(); });

  // When opening editor, we set hint as well
  var _origOpen = openCouponEditor;
  openCouponEditor = function(id){
    _origOpen(id);
    if(id){
      updateCopyHint();
      // If coupon is archived, show restore action hint
      var c = getCouponById(id);
      if(c && c.archived){
        var hint = document.getElementById("couponModalHint");
        var msg = "×”×©×•×‘×¨ ×‘××¨×›×™×•×Ÿ (" + (c.archivedReason||"") + "). ";
        msg += '×›×“×™ ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ: <button class="tiny" type="button" onclick="restoreCoupon()">×”×—×–×¨ ×œ×¤×¢×™×œ</button>';
        hint.innerHTML = msg;
      }
    } else {
      document.getElementById("couponModalHint").textContent = "";
    }
  };
  window.openCouponEditor = openCouponEditor;

  window.restoreCoupon = function(){
    if(!editingCouponId) return;
    var c = getCouponById(editingCouponId);
    if(!c) return;

    // restore only if it is actually available now (not expired and not remaining 0 etc.)
    c.archived = false;
    c.archivedAt = 0;
    c.archivedReason = "";
    // But if still unavailable, it will auto-archive again
    c.updatedAt = Date.now();
    c.consumedManual = false; // allow restore for non-value types too (user can mark consumed again)
    ensureArchiveState(c);

    persistAll();
    normalizeCoupons();
    hideCouponModal();
    renderAll();
  };

  // ===== Render All =====
  function renderAll(){
    renderActive();
    renderArchive();
    renderManage();

    renderSyncLastLine();
    showLocalNoteIfYanir();
    renderDeviceCard();
  }

  // Initial render
  renderAll();
  setSyncMsg("××§×•××™ (" + DEVICE_NAME + ")");
  renderSyncLastLine();
</script>
</body>
</html>
