<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×§×•×¤×•× ×™× ×•×©×•×‘×¨×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;
      --warn:#b45309;
      --ok:#16a34a;
      --near:#fee2e2;
      --nearText:#991b1b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
      overflow:hidden;
    }
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}

    .view{display:none}
    .view.active{display:block}

    .field{margin-top:10px; min-width:0; overflow:hidden;}
    label{font-weight:900}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff; max-width:100%;
    }
    textarea{min-height:120px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline input{flex:1; min-width:180px}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}
    .ok{background:var(--ok); color:#fff}

    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      font-weight:900; line-height:1; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      min-width:40px;
    }

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    .filters{
      display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; margin:8px 0 10px;
    }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      padding:7px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      cursor:pointer;
      flex:0 0 auto;
    }
    .chip.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .chip.soft{background:#f8fafc}
    .chip.warn{background:#fffbeb;border-color:#fed7aa;color:#b45309}
    .chip.warn.active{background:#f59e0b; color:#111827; border-color:#f59e0b;}

    .searchrow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .searchrow input{flex:1; min-width:200px}
    .small{
      font-size:12px; color:var(--muted); font-weight:900;
    }

    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    li span{flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .btn-group{display:flex; gap:8px; align-items:center; flex:0 0 auto}

    .vcard{border:1px solid var(--border); border-radius:16px; background:#fff; padding:10px; margin-bottom:10px;}
    .vhead{display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:8px;}
    .vtitle{font-weight:900; font-size:16px; line-height:1.2;}
    .badges{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;}
    .badge{display:inline-flex; align-items:center; justify-content:center; padding:5px 8px; border-radius:999px; font-weight:900; font-size:12px; border:1px solid var(--border); background:var(--pill); white-space:nowrap;}
    .badge.near{background:var(--near); color:var(--nearText); border-color:#fecaca;}
    .badge.arch{background:#f1f5f9; color:#334155}
    .badge.phys{background:#ecfeff; color:#155e75; border-color:#a5f3fc;}
    .badge.type{background:#eef2ff; color:#1e40af; border-color:#c7d2fe;}
    .badge.cat{background:#f0fdf4; color:#166534; border-color:#bbf7d0;}
    .vrow{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-top:1px dashed var(--border); align-items:center;}
    .vrow:first-child{border-top:none}
    .vrow b{white-space:nowrap}
    .vrow span{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; color:#374151; font-weight:900;}

    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; padding:14px; z-index:9999;}
    .modal{width:100%; max-width:760px; background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:0 16px 50px rgba(0,0,0,0.2); padding:14px; max-height:86vh; overflow:auto;}
    .modal-header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; position:sticky; top:0; background:#fff; padding-bottom:8px; border-bottom:1px solid var(--border); z-index:2;}
    .modal-title{font-weight:900;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tiny{padding:8px 10px; border-radius:12px; border:1px solid var(--border); background:#f3f4f6; font-weight:900; cursor:pointer; white-space:nowrap;}
    .tiny.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    .tiny.danger{background:var(--danger); color:#fff; border-color:var(--danger)}
    .tiny.ok{background:var(--ok); color:#fff; border-color:var(--ok)}
    .tiny.ghost{background:#eef2ff; color:#1e40af; border-color:#c7d2fe}

    .pickerList{display:flex; flex-direction:column; gap:8px; margin-top:10px;}
    .pickItem{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--border); border-radius:14px; background:#fff; cursor:pointer; font-weight:900;}
    .pickItem.active{border-color:var(--primary); box-shadow:0 0 0 2px rgba(37,99,235,0.15)}
    .pickItem .right{display:flex; gap:8px; align-items:center}

    @media(min-width:700px){ body{max-width:900px;margin:auto} }
  </style>
</head>

<body>
<h1>ğŸŸï¸ ×§×•×¤×•× ×™× ×•×©×•×‘×¨×™×</h1>

<div class="tabs">
  <button class="tabbtn active" type="button" onclick="showTab('active')">×¤×¢×™×œ×™×</button>
  <button class="tabbtn" type="button" onclick="showTab('archive')">××¨×›×™×•×Ÿ</button>
  <button class="tabbtn" type="button" onclick="showTab('manage')">× ×™×”×•×œ</button>
  <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
</div>

<section id="view-active" class="view active">
  <section class="card">
    <div class="inline" style="justify-content:space-between;">
      <div style="font-weight:900;">××” ×¢×•×©×™×?</div>
      <button class="btn ok" type="button" onclick="openVoucherModal(null)">â• ×”×•×¡×£ ×©×•×‘×¨</button>
    </div>
    <div class="note">×˜×™×¤: ×× ×©×•×‘×¨ ×§×¨×•×‘ ×œ×¤×§×™×¢×” (â‰¤ 3 ×—×•×“×©×™×) ×”×•× ×™×§×¤×•×¥ ×œ×¨××© ×•×™×§×‘×œ ×¡×™××•×Ÿ.</div>
  </section>

  <section class="card">
    <h2>×—×™×¤×•×© ×•×¡×™× ×•×Ÿ</h2>

    <div class="searchrow">
      <input id="searchInputActive" placeholder="×—×™×¤×•×© ×œ×¤×™ ××•×ª×’ / ×—× ×•×ª / ×˜×§×¡×˜ ×—×•×¤×©×™..." oninput="renderActive()">
      <select id="sortActive" onchange="renderActive()">
        <option value="smart" selected>××™×•×Ÿ ×—×›× (×¤×§×™×¢×”/×ª×“×™×¨×•×ª/×™×ª×¨×”/×-×‘)</option>
        <option value="expiry">×ª×•×§×£ ×”×›×™ ×§×¨×•×‘</option>
        <option value="brand">××•×ª×’ ×-×‘</option>
        <option value="amount">×™×ª×¨×” ×”×›×™ ×’×‘×•×”×”</option>
      </select>
    </div>

    <div class="filters" id="rowTopActive"></div>

    <div class="small">×§×˜×’×•×¨×™×•×ª</div>
    <div class="filters" id="rowCatsActive"></div>

    <div class="small">××•×ª×’×™×</div>
    <div class="filters" id="rowBrandsActive"></div>

    <div class="small">×—× ×•×™×•×ª</div>
    <div class="filters" id="rowStoresActive"></div>

    <div id="activeList" style="margin-top:10px;"></div>
  </section>
</section>

<section id="view-archive" class="view">
  <section class="card">
    <h2>××¨×›×™×•×Ÿ</h2>

    <div class="searchrow">
      <input id="searchInputArchive" placeholder="×—×™×¤×•×© ×‘××¨×›×™×•×Ÿ ×œ×¤×™ ××•×ª×’ / ×—× ×•×ª / ×˜×§×¡×˜..." oninput="renderArchive()">
      <select id="sortArchive" onchange="renderArchive()">
        <option value="smart" selected>××™×•×Ÿ ×—×›×</option>
        <option value="expiry">×ª×•×§×£ ×”×›×™ ×§×¨×•×‘</option>
        <option value="brand">××•×ª×’ ×-×‘</option>
        <option value="amount">×™×ª×¨×” ×”×›×™ ×’×‘×•×”×”</option>
      </select>
    </div>

    <div class="filters" id="rowTopArchive"></div>

    <div class="small">×§×˜×’×•×¨×™×•×ª</div>
    <div class="filters" id="rowCatsArchive"></div>

    <div class="small">××•×ª×’×™×</div>
    <div class="filters" id="rowBrandsArchive"></div>

    <div class="small">×—× ×•×™×•×ª</div>
    <div class="filters" id="rowStoresArchive"></div>

    <div id="archiveList" style="margin-top:10px;"></div>
  </section>
</section>

<section id="view-manage" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ</h2>

    <div class="filters" id="manageTabs"></div>

    <div id="manageBrands" style="display:none;">
      <div class="inline">
        <input id="newBrandName" placeholder="×©× ××•×ª×’/×¨×©×ª">
        <button class="btn primary" type="button" onclick="addBrand()">×”×•×¡×£</button>
      </div>
      <div class="note">××—×™×§×” ×›××Ÿ ×œ× ××•×—×§×ª ×©×•×‘×¨×™× ×§×™×™××™× â€” ×¨×§ ××©×‘×™×ª×” ××ª ×”×©×.</div>
      <ul id="brandsList"></ul>
    </div>

    <div id="manageStores" style="display:none;">
      <div class="inline">
        <input id="newStoreName" placeholder="×©× ×—× ×•×ª">
        <button class="btn primary" type="button" onclick="addStore()">×”×•×¡×£</button>
      </div>
      <div class="note">××¤×©×¨ ×œ×©×™×™×š ×—× ×•×ª ×œ×›××” ××•×ª×’×™× + ×œ×§×˜×’×•×¨×™×•×ª.</div>
      <ul id="storesList"></ul>
    </div>

    <div id="manageCats" style="display:none;">
      <div class="inline">
        <input id="newCatName" placeholder="×©× ×§×˜×’×•×¨×™×” (×œ××©×œ: ××•×¤× ×”, ××¡×¢×“×•×ª...)">
        <button class="btn primary" type="button" onclick="addCategory()">×”×•×¡×£</button>
      </div>
      <div class="note">××—×™×§×” = ×”×©×‘×ª×” ×‘×œ×‘×“ (×œ× ××•×—×§ ×”×™×¡×˜×•×¨×™×”).</div>
      <ul id="catsList"></ul>
    </div>
  </section>
</section>

<section id="view-data" class="view">
  <section class="card">
    <h2>ğŸ”„ ×¡× ×›×¨×•×Ÿ</h2>
    <div class="note" id="syncStatusLine"></div>
    <div class="note" id="syncLastLine"></div>

    <div class="inline" style="margin-top:10px;">
      <button class="btn ghost" type="button" onclick="syncPullNow()">××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ</button>
      <button class="btn ghost" type="button" onclick="syncPushNow()">×©×œ×— × ×ª×•× ×™× ×œ×¢× ×Ÿ</button>
      <button class="btn ghost" type="button" onclick="backupNow()">×’×™×‘×•×™ ×œ×§×•×‘×¥</button>
      <button class="btn ghost" type="button" onclick="triggerRestore()">×˜×¢×™× ×ª ×’×™×‘×•×™</button>
    </div>
    <input id="restoreFile" type="file" accept=".json,application/json" style="display:none" onchange="restoreFromFile(event)">
    <div class="note" id="syncLocalNote" style="display:none; margin-top:10px;"></div>
  </section>

  <section class="card" id="deviceCard" style="display:none;">
    <h2>âš™ï¸ ×–×”×•×ª ××›×©×™×¨ (×¨×§ ×œ×¡× ×›×¨×•×Ÿ)</h2>
    <div class="note">××©××© ×¨×§ ×›×“×™ ×œ×–×”×•×ª ××™ ×¢×“×›×Ÿ ××—×¨×•×Ÿ ×•×œ×©××•×¨ â€œYanir ×× ×¦×—â€ ×›×‘×¨×™×¨×ª ××—×“×œ.</div>
    <div class="field">
      <label>×©× ××›×©×™×¨</label>
      <select id="deviceNameSelect" onchange="saveDeviceName()">
        <option value="Yanir">Yanir</option>
        <option value="×©×™×¨×œ×™">×©×™×¨×œ×™</option>
      </select>
    </div>
  </section>

  <section class="card">
    <h2>××™×¤×•×¡</h2>
    <div class="note">××•×—×§ ×”×›×œ ××”××›×©×™×¨ (××•××œ×¥ ×œ×‘×¦×¢ ×’×™×‘×•×™ ×œ×¤× ×™).</div>
    <button class="btn danger" type="button" onclick="resetAll()">××™×¤×•×¡ ××œ×</button>
  </section>
</section>

<!-- Voucher modal -->
<div id="voucherBackdrop" class="modal-backdrop" onclick="closeVoucherModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="voucherModalTitle">â• ×©×•×‘×¨ ×—×“×©</div>
      <div class="modal-actions">
        <button class="tiny primary" type="button" onclick="saveVoucher()">×©××™×¨×”</button>
        <button class="tiny" type="button" onclick="hideVoucherModal()">×¡×’×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>×¡×•×’ ×©×•×‘×¨</label>
      <select id="vType" onchange="renderVoucherTypeFields()">
        <option value="×›×¡×¤×™">×›×¡×¤×™</option>
        <option value="××—×•×–">××—×•×–</option>
        <option value="1+1">1+1</option>
        <option value="×›×œ×œ×™" selected>×›×œ×œ×™</option>
      </select>
      <div class="note">×× ×—×¡×¨ ×¡×•×’ â€œ×§×¨×™×˜×™â€ ×‘×¢×ª×™×“ â€” × ×•×¡×™×£ ××¡×š ×™×™×¢×•×“×™.</div>
    </div>

    <div class="field">
      <label>×ª×§×£ ×¢×‘×•×¨</label>
      <select id="vScope">
        <option value="all" selected>×›×œ ×”×¨×©×ª</option>
        <option value="stores">×—× ×•×™×•×ª ××¡×•×™××•×ª</option>
      </select>
    </div>

    <div class="field">
      <label>××•×ª×’/×¨×©×ª</label>
      <div class="inline">
        <button class="btn ghost" type="button" onclick="openPicker('brand', false)">×‘×—×¨ ××•×ª×’</button>
        <button class="btn ghost" type="button" onclick="openQuickAdd('brand')">+ ××•×ª×’ ×—×“×©</button>
      </div>
      <div class="note" id="brandChosenNote">×œ× × ×‘×—×¨</div>
    </div>

    <div class="field">
      <label>×—× ×•×™×•×ª ×ª×§×¤×•×ª</label>
      <div class="inline">
        <button class="btn ghost" type="button" onclick="openPicker('stores', true)">×‘×—×¨ ×—× ×•×™×•×ª</button>
        <button class="btn ghost" type="button" onclick="openQuickAdd('store')">+ ×—× ×•×ª ×—×“×©×”</button>
      </div>
      <div class="note" id="storesChosenNote">×œ× × ×‘×—×¨×•</div>
    </div>

    <div class="field">
      <label>×§×˜×’×•×¨×™×•×ª</label>
      <div class="inline">
        <button class="btn ghost" type="button" onclick="openPicker('cats', true)">×‘×—×¨ ×§×˜×’×•×¨×™×•×ª</button>
        <button class="btn ghost" type="button" onclick="openQuickAdd('cat')">+ ×§×˜×’×•×¨×™×” ×—×“×©×”</button>
      </div>
      <div class="note" id="catsChosenNote">×œ× × ×‘×—×¨×•</div>
    </div>

    <div class="field">
      <label>×›×¨×˜×™×¡ ×¤×™×–×™</label>
      <select id="vPhysical">
        <option value="0" selected>×œ×</option>
        <option value="1">×›×Ÿ</option>
      </select>
    </div>

    <div class="field">
      <label>×ª×•×§×£ (××•×¤×¦×™×•× ×œ×™)</label>
      <input type="date" id="vExpiry">
    </div>

    <div class="field" id="codeField">
      <label>×§×•×“ (××•×¤×¦×™×•× ×œ×™)</label>
      <input id="vCode" placeholder="×”×“×‘×§/×›×ª×•×‘ ×§×•×“ ×›××Ÿ...">
    </div>

    <div id="typeFields"></div>

    <div class="field">
      <label>×”×¢×¨×•×ª</label>
      <textarea id="vNotes" placeholder="×˜×§×¡×˜ ×—×•×¤×©×™..."></textarea>
    </div>

    <div class="field">
      <button class="btn danger" type="button" onclick="deleteVoucherFromModal()">ğŸ—‘ï¸ ××—×™×§×ª ×©×•×‘×¨</button>
      <div class="note">××—×™×§×” ××•×—×§×ª ××ª ×”×©×•×‘×¨ ×¢×¦××• (×œ× ×¨×§ ××¢×‘×™×¨×” ×œ××¨×›×™×•×Ÿ).</div>
    </div>
  </div>
</div>

<!-- View modal -->
<div id="viewBackdrop" class="modal-backdrop" onclick="closeViewModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="viewTitle">×©×•×‘×¨</div>
      <div class="modal-actions">
        <button class="tiny ghost" type="button" onclick="copyCode()">×”×¢×ª×§ ×§×•×“</button>
        <button class="tiny" type="button" onclick="openEditFromView()">×¢×¨×™×›×”</button>
        <button class="tiny ok" type="button" onclick="toggleArchiveFromView()">×”×¢×‘×¨/×”×—×–×¨ ××¨×›×™×•×Ÿ</button>
        <button class="tiny danger" type="button" onclick="deleteVoucherFromView()">××—×™×§×”</button>
        <button class="tiny" type="button" onclick="hideViewModal()">×¡×’×•×¨</button>
      </div>
    </div>
    <div id="viewBody"></div>
  </div>
</div>

<!-- Picker modal -->
<div id="pickerBackdrop" class="modal-backdrop" onclick="closePickerModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="pickerTitle">×‘×—×™×¨×”</div>
      <div class="modal-actions">
        <button class="tiny primary" type="button" onclick="pickerApply()">××™×©×•×¨</button>
        <button class="tiny" type="button" onclick="hidePicker()">×¡×’×•×¨</button>
      </div>
    </div>
    <div class="field">
      <label>×—×™×¤×•×©</label>
      <input id="pickerSearch" placeholder="×—×¤×©..." oninput="renderPickerList()">
    </div>
    <div class="pickerList" id="pickerList"></div>
  </div>
</div>

<script>
  // SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  // ===== CONFIG (××•×›×Ÿ, ×œ× ×¦×¨×™×š ×œ×©× ×•×ª ×›×œ×•×) =====
  const SYNC_URL = "https://script.google.com/macros/s/AKfycbzq9M_mKke4GTDeVPIHHfF-NFu5Yb7MADNVdeaYiuIn_S4LmkqhYejJw7DT9vR7HZG6/exec";
  const SYNC_TOKEN = "CUPN_7f3a9c2e_YANIR_MASTER_2026";

  const __isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

  let DEVICE_NAME = (function(){
    const saved = localStorage.getItem("deviceName");
    if(saved) return saved;
    const guess = __isIOS ? "×©×™×¨×œ×™" : "Yanir";
    localStorage.setItem("deviceName", guess);
    return guess;
  })();

  const META_KEY = "cloudMeta";
  const LAST_SYNC_AT_KEY = "lastSyncAt";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtDateTime(ms){
    if(!ms) return "";
    const d = new Date(ms);
    return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate()) + " " + pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  }
  function setLastSyncNow(){
    const now = Date.now();
    localStorage.setItem(LAST_SYNC_AT_KEY, String(now));
    renderSyncLastLine();
  }
  function renderSyncLastLine(){
    const el = document.getElementById("syncLastLine");
    if(!el) return;
    const v = Number(localStorage.getItem(LAST_SYNC_AT_KEY) || "0");
    el.textContent = v ? ("×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: " + fmtDateTime(v)) : "×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: â€”";
  }
  function setSyncMsg(msg){
    const el = document.getElementById("syncStatusLine");
    if(el) el.textContent = msg || "";
  }
  function safeJSONParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }
  function getLocalMeta(){
    return safeJSONParse(localStorage.getItem(META_KEY) || "null", { updatedAt:0, updatedBy:"" });
  }
  function setLocalMeta(meta){
    localStorage.setItem(META_KEY, JSON.stringify(meta || { updatedAt:0, updatedBy:"" }));
  }
  function doFetchJSON(url){
    return fetch(url, { cache:"no-store" }).then(r => r.json());
  }

  function localPayload(){
    return {
      brands: safeJSONParse(localStorage.getItem("brands") || "[]", []),
      stores: safeJSONParse(localStorage.getItem("stores") || "[]", []),
      categories: safeJSONParse(localStorage.getItem("categories") || "[]", []),
      vouchers: safeJSONParse(localStorage.getItem("vouchers") || "[]", []),
      linksBrandStores: safeJSONParse(localStorage.getItem("linksBrandStores") || "[]", []),
      storeCats: safeJSONParse(localStorage.getItem("storeCats") || "[]", [])
    };
  }

  function applyRemote(remote, meta){
    localStorage.setItem("brands", JSON.stringify(remote.brands || []));
    localStorage.setItem("stores", JSON.stringify(remote.stores || []));
    localStorage.setItem("categories", JSON.stringify(remote.categories || []));
    localStorage.setItem("vouchers", JSON.stringify(remote.vouchers || []));
    localStorage.setItem("linksBrandStores", JSON.stringify(remote.linksBrandStores || []));
    localStorage.setItem("storeCats", JSON.stringify(remote.storeCats || []));
    setLocalMeta(meta || { updatedAt:0, updatedBy:"" });

    loadAll();
    renderAll();
  }

  function syncPullNow(){
    setSyncMsg("×˜×•×¢×Ÿ ××”×¢× ×Ÿ...");
    doFetchJSON(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN))
      .then(j=>{
        if(!j || !j.ok) throw new Error("bad");
        if(!j.data){ setSyncMsg("××™×Ÿ × ×ª×•× ×™× ×‘×¢× ×Ÿ"); return; }
        const remote = safeJSONParse(j.data, null);
        if(!remote) throw new Error("bad json");
        applyRemote(remote, j.meta);
        setSyncMsg("× ×˜×¢×Ÿ ××”×¢× ×Ÿ âœ…");
        setLastSyncNow();
      })
      .catch(()=>{
        setSyncMsg("×˜×¢×™× ×” ××”×¢× ×Ÿ × ×›×©×œ×” âŒ");
      });
  }
  window.syncPullNow = syncPullNow;

  function syncPushNow(){
    try{
      setSyncMsg("×©×•×œ×— ×œ×¢× ×Ÿ...");
      const payloadStr = JSON.stringify(localPayload());
      const url = SYNC_URL
        + "?token=" + encodeURIComponent(SYNC_TOKEN)
        + "&write=1"
        + "&by=" + encodeURIComponent(DEVICE_NAME)
        + "&data=" + encodeURIComponent(payloadStr);
      doFetchJSON(url).then(w=>{
        if(w && w.ok){
          setLocalMeta(w.meta || getLocalMeta());
          setSyncMsg("× ×©×œ×— ×œ×¢× ×Ÿ âœ…");
          setLastSyncNow();
        } else {
          setSyncMsg("×©×œ×™×—×” × ×›×©×œ×” âŒ");
        }
      }).catch(()=> setSyncMsg("×©×œ×™×—×” × ×›×©×œ×” âŒ"));
    } catch(e){
      setSyncMsg("×©×œ×™×—×” × ×›×©×œ×” âŒ");
    }
  }
  window.syncPushNow = syncPushNow;

  function showLocalNoteIfYanir(){
    const el = document.getElementById("syncLocalNote");
    if(!el) return;
    if(DEVICE_NAME === "Yanir"){
      el.style.display = "block";
      el.textContent = "×”×¢×¨×” (×¨×§ ××¦×œ×š): ×× ××ª×” ×œ× ×¨×•××” ×¢×“×›×•× ×™× â€” ×œ×—×¥ '××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ'.";
    } else {
      el.style.display = "none";
    }
  }

  function maybeShowDeviceCard(){
    const card = document.getElementById("deviceCard");
    if(!card) return;
    if(DEVICE_NAME === "Yanir"){
      card.style.display = "block";
      const sel = document.getElementById("deviceNameSelect");
      if(sel) sel.value = DEVICE_NAME;
    } else {
      card.style.display = "none";
    }
  }

  function saveDeviceName(){
    const sel = document.getElementById("deviceNameSelect");
    if(!sel) return;
    DEVICE_NAME = sel.value;
    localStorage.setItem("deviceName", DEVICE_NAME);
    showLocalNoteIfYanir();
    maybeShowDeviceCard();
  }
  window.saveDeviceName = saveDeviceName;

  // Backup/restore
  function backupNow(){
    const backup = { v:1, exportedAt:Date.now(), deviceName:DEVICE_NAME, meta:getLocalMeta(), payload:localPayload() };
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "coupons-backup-" + (new Date().toISOString().slice(0,10)) + ".json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(e){} }, 1500);
    setSyncMsg("×’×™×‘×•×™ × ×•×¦×¨ âœ…");
  }
  window.backupNow = backupNow;

  function triggerRestore(){
    if(!confirm("×˜×¢×™× ×ª ×’×™×‘×•×™ ×ª×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×‘××›×©×™×¨ ×”×–×”. ×œ×”××©×™×š?")) return;
    const inp = document.getElementById("restoreFile");
    inp.value = "";
    inp.click();
  }
  window.triggerRestore = triggerRestore;

  function restoreFromFile(ev){
    const f = ev?.target?.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const obj = safeJSONParse(reader.result, null);
      if(!obj || !obj.payload) return alert("×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ");
      const p = obj.payload || {};
      localStorage.setItem("brands", JSON.stringify(p.brands || []));
      localStorage.setItem("stores", JSON.stringify(p.stores || []));
      localStorage.setItem("categories", JSON.stringify(p.categories || []));
      localStorage.setItem("vouchers", JSON.stringify(p.vouchers || []));
      localStorage.setItem("linksBrandStores", JSON.stringify(p.linksBrandStores || []));
      localStorage.setItem("storeCats", JSON.stringify(p.storeCats || []));
      if(obj.meta) setLocalMeta(obj.meta);
      loadAll();
      renderAll();
      setSyncMsg("×’×™×‘×•×™ × ×˜×¢×Ÿ âœ…");
    };
    reader.readAsText(f);
    ev.target.value = "";
  }
  window.restoreFromFile = restoreFromFile;

  // ===== Data model =====
  function uid(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function parseISO(iso){
    if(!iso) return 0;
    const t = Date.parse(iso + "T00:00:00");
    return isNaN(t) ? 0 : t;
  }
  const NEAR_MS = (()=>{ const n=new Date(); const d=new Date(n.getFullYear(), n.getMonth()+3, n.getDate()); return d.getTime(); })();

  let brands = [];
  let stores = [];
  let categories = [];
  let vouchers = [];
  let linksBrandStores = [];
  let storeCats = [];

  function loadAll(){
    brands = safeJSONParse(localStorage.getItem("brands") || "[]", []);
    stores = safeJSONParse(localStorage.getItem("stores") || "[]", []);
    categories = safeJSONParse(localStorage.getItem("categories") || "[]", []);
    vouchers = safeJSONParse(localStorage.getItem("vouchers") || "[]", []);
    linksBrandStores = safeJSONParse(localStorage.getItem("linksBrandStores") || "[]", []);
    storeCats = safeJSONParse(localStorage.getItem("storeCats") || "[]", []);
    autoArchiveSweep();
  }

  function saveAll(){
    localStorage.setItem("brands", JSON.stringify(brands));
    localStorage.setItem("stores", JSON.stringify(stores));
    localStorage.setItem("categories", JSON.stringify(categories));
    localStorage.setItem("vouchers", JSON.stringify(vouchers));
    localStorage.setItem("linksBrandStores", JSON.stringify(linksBrandStores));
    localStorage.setItem("storeCats", JSON.stringify(storeCats));
  }

  function nameById(arr, id){ return (arr.find(x=>x.id===id) || {}).name || ""; }
  function activeItems(arr){ return arr.filter(x=>x && x.active); }
  function normalizeText(s){ return String(s||"").trim().toLowerCase(); }

  function voucherAmountRemain(v){
    const r = Number(v.moneyRemain);
    return isNaN(r) ? 0 : r;
  }
  function voucherExpiryMs(v){ return parseISO(v.expiryISO); }
  function isNearExpiry(v){
    const em = voucherExpiryMs(v);
    if(!em) return false;
    return em <= NEAR_MS && em >= Date.now() - 24*60*60*1000;
  }
  function isExpired(v){
    const em = voucherExpiryMs(v);
    if(!em) return false;
    const today = parseISO(todayISO());
    return em && em < today;
  }

  function autoArchiveSweep(){
    let changed = false;
    vouchers.forEach(v=>{
      if(v.archived) return;
      if(isExpired(v)){ v.archived=true; v.archivedReason="expired"; changed=true; return; }
      if(v.type==="×›×¡×¤×™"){
        const rem = voucherAmountRemain(v);
        if(rem<=0 && String(v.moneyRemain).trim()!==""){ v.archived=true; v.archivedReason="zero"; changed=true; }
      }
    });
    if(changed) saveAll();
  }

  function emptyVoucher(){
    return {
      id: uid(),
      createdAt: Date.now(),
      updatedAt: Date.now(),
      updatedBy: DEVICE_NAME,
      type: "×›×œ×œ×™",
      scope: "all",
      brandId: "",
      storeIds: [],
      catIds: [],
      physical: 0,
      expiryISO: "",
      code: "",
      notes: "",
      moneyValue: "", moneyUsed: "", moneyRemain: "",
      percentText: "", dealText: "",
      archived: false, archivedReason: ""
    };
  }

  function voucherTitle(v){
    const b = v.brandId ? nameById(brands, v.brandId) : "";
    const ss = (v.storeIds||[]).map(id=>nameById(stores,id)).filter(Boolean);
    if(b){
      if(v.scope==="stores" && ss.length){
        const first2 = ss.slice(0,2);
        const plus = (ss.length>2) ? (" +" + (ss.length-2)) : "";
        return b + " Â· ×¨×§: " + first2.join(", ") + plus;
      } else {
        if(ss.length){
          const f2 = ss.slice(0,2);
          const p = (ss.length>2) ? (" +" + (ss.length-2)) : "";
          return b + " Â· " + f2.join(", ") + p;
        }
        return b;
      }
    }
    if(ss.length){
      const s2 = ss.slice(0,2);
      const pl = (ss.length>2) ? (" +" + (ss.length-2)) : "";
      return s2.join(", ") + pl;
    }
    return "×©×•×‘×¨";
  }

  function voucherSearchHaystack(v){
    const parts = [];
    parts.push(voucherTitle(v));
    if(v.brandId) parts.push(nameById(brands, v.brandId));
    (v.storeIds||[]).forEach(id=>parts.push(nameById(stores,id)));
    (v.catIds||[]).forEach(id=>parts.push(nameById(categories,id)));
    parts.push(v.notes||"", v.code||"", v.percentText||"", v.dealText||"");
    return normalizeText(parts.join(" | "));
  }

  // Tabs
  function showTab(key){
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    const map = {active:0,archive:1,manage:2,data:3};
    const idx = map[key] ?? 0;
    document.querySelectorAll(".tabbtn")[idx].classList.add("active");
    document.getElementById("view-"+key).classList.add("active");
  }
  window.showTab = showTab;

  // Filters state
  const filterActive = { top:"all", catId:"", brandId:"", storeId:"" };
  const filterArchive = { top:"all", catId:"", brandId:"", storeId:"" };

  function buildTopRow(hostId, state, onChange){
    const host = document.getElementById(hostId); host.innerHTML="";
    const all = document.createElement("div");
    all.className = "chip " + (state.top==="all" ? "active" : "");
    all.textContent = "×”×›×œ";
    all.onclick = ()=>{ state.top="all"; onChange(); };
    host.appendChild(all);

    const near = document.createElement("div");
    near.className = "chip warn " + (state.top==="near" ? "active" : "");
    near.textContent = "×§×¨×•×‘ ×œ×¤×§×™×¢×”";
    near.onclick = ()=>{ state.top="near"; onChange(); };
    host.appendChild(near);
  }

  function buildEntityRow(hostId, items, selectedId, placeholder, onPick){
    const host = document.getElementById(hostId); host.innerHTML="";
    const first = document.createElement("div");
    first.className = "chip soft " + (!selectedId ? "active" : "");
    first.textContent = placeholder;
    first.onclick = ()=>onPick("");
    host.appendChild(first);

    items.forEach(it=>{
      const chip = document.createElement("div");
      chip.className = "chip " + (selectedId===it.id ? "active" : "");
      chip.textContent = it.name;
      chip.onclick = ()=>onPick(it.id);
      host.appendChild(chip);
    });
  }

  function brandUsageCounts(vs){
    const map = {};
    vs.forEach(v=>{
      const bid = v.brandId||"";
      if(!bid) return;
      map[bid]=(map[bid]||0)+1;
    });
    return map;
  }

  function smartSort(vs, usageMap){
    return vs.slice().sort((a,b)=>{
      const an = isNearExpiry(a)?1:0, bn = isNearExpiry(b)?1:0;
      if(bn!==an) return bn-an;
      const au = a.brandId ? (usageMap[a.brandId]||0) : 0;
      const bu = b.brandId ? (usageMap[b.brandId]||0) : 0;
      if(bu!==au) return bu-au;
      const ar = voucherAmountRemain(a), br = voucherAmountRemain(b);
      if(br!==ar) return br-ar;
      return voucherTitle(a).localeCompare(voucherTitle(b),"he");
    });
  }

  function sortByMode(vs, mode){
    if(mode==="expiry"){
      return vs.slice().sort((a,b)=>{
        const ae=voucherExpiryMs(a)||9e18, be=voucherExpiryMs(b)||9e18;
        if(ae!==be) return ae-be;
        return voucherTitle(a).localeCompare(voucherTitle(b),"he");
      });
    }
    if(mode==="brand"){
      return vs.slice().sort((a,b)=>{
        const an=(a.brandId?nameById(brands,a.brandId):"");
        const bn=(b.brandId?nameById(brands,b.brandId):"");
        const c=an.localeCompare(bn,"he");
        if(c) return c;
        return voucherTitle(a).localeCompare(voucherTitle(b),"he");
      });
    }
    if(mode==="amount"){
      return vs.slice().sort((a,b)=>{
        const ar=voucherAmountRemain(a), br=voucherAmountRemain(b);
        if(br!==ar) return br-ar;
        return voucherTitle(a).localeCompare(voucherTitle(b),"he");
      });
    }
    return vs;
  }

  function filterVouchers(vs, state, searchText){
    const q = normalizeText(searchText||"");
    return vs.filter(v=>{
      if(state.top==="near" && !isNearExpiry(v)) return false;
      if(state.catId && !(v.catIds||[]).includes(state.catId)) return false;
      if(state.brandId && v.brandId!==state.brandId) return false;
      if(state.storeId && !(v.storeIds||[]).includes(state.storeId)) return false;
      if(q) return voucherSearchHaystack(v).includes(q);
      return true;
    });
  }

  function escapeHtml(s){
    s = String(s);
    return s.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[m]);
  }

  function renderVoucherCard(v){
    const div = document.createElement("div");
    div.className="vcard";
    const head = document.createElement("div");
    head.className="vhead";

    const left = document.createElement("div");
    left.style.minWidth="0";

    const title = document.createElement("div");
    title.className="vtitle";
    title.textContent=voucherTitle(v);

    const badges = document.createElement("div");
    badges.className="badges";

    const bType = document.createElement("div");
    bType.className="badge type";
    bType.textContent="×¡×•×’: " + (v.type||"×›×œ×œ×™");
    badges.appendChild(bType);

    if(v.physical){
      const bp=document.createElement("div");
      bp.className="badge phys";
      bp.textContent="×›×¨×˜×™×¡ ×¤×™×–×™";
      badges.appendChild(bp);
    }

    const cats=(v.catIds||[]).map(id=>nameById(categories,id)).filter(Boolean);
    if(cats.length){
      const bc=document.createElement("div");
      bc.className="badge cat";
      bc.textContent="×§×˜×’×•×¨×™×•×ª: " + cats.slice(0,2).join(", ") + (cats.length>2 ? " +" + (cats.length-2) : "");
      badges.appendChild(bc);
    }

    if(isNearExpiry(v)){
      const be=document.createElement("div");
      be.className="badge near";
      be.textContent="×§×¨×•×‘ ×œ×¤×§×™×¢×”";
      badges.appendChild(be);
    }
    if(v.archived){
      const ba=document.createElement("div");
      ba.className="badge arch";
      ba.textContent="××¨×›×™×•×Ÿ";
      badges.appendChild(ba);
    }

    left.appendChild(title);
    left.appendChild(badges);

    const right = document.createElement("div");
    right.className="btn-group";
    const openBtn = document.createElement("button");
    openBtn.className="iconbtn";
    openBtn.type="button";
    openBtn.textContent="×¤×ª×—";
    openBtn.onclick=()=>openViewModal(v.id);
    right.appendChild(openBtn);

    head.appendChild(left);
    head.appendChild(right);
    div.appendChild(head);

    const expiry = v.expiryISO ? v.expiryISO : "â€”";
    div.insertAdjacentHTML("beforeend", `<div class="vrow"><b>×ª×•×§×£</b><span>${escapeHtml(expiry)}</span></div>`);
    const brandName = v.brandId ? nameById(brands, v.brandId) : "â€”";
    div.insertAdjacentHTML("beforeend", `<div class="vrow"><b>××•×ª×’</b><span>${escapeHtml(brandName||"â€”")}</span></div>`);
    const storesNames=(v.storeIds||[]).map(id=>nameById(stores,id)).filter(Boolean);
    div.insertAdjacentHTML("beforeend", `<div class="vrow"><b>×—× ×•×™×•×ª</b><span>${escapeHtml(storesNames.length?storesNames.join(", "):"â€”")}</span></div>`);

    if(v.type==="×›×¡×¤×™"){
      const val = String(v.moneyValue||"").trim()!=="" ? v.moneyValue : "â€”";
      const used = String(v.moneyUsed||"").trim()!=="" ? v.moneyUsed : "â€”";
      const rem = String(v.moneyRemain||"").trim()!=="" ? v.moneyRemain : "â€”";
      div.insertAdjacentHTML("beforeend", `<div class="vrow"><b>×©×´×—</b><span>×¢×¨×š: ${escapeHtml(val)} | × ×•×¦×œ: ${escapeHtml(used)} | ×™×ª×¨×”: ${escapeHtml(rem)}</span></div>`);
    } else if(v.type==="××—×•×–"){
      div.insertAdjacentHTML("beforeend", `<div class="vrow"><b>×¤×™×¨×•×˜</b><span>${escapeHtml(v.percentText||"â€”")}</span></div>`);
    } else if(v.type==="1+1"){
      div.insertAdjacentHTML("beforeend", `<div class="vrow"><b>×¤×™×¨×•×˜</b><span>${escapeHtml(v.dealText||"â€”")}</span></div>`);
    }

    return div;
  }

  function renderActive(){
    autoArchiveSweep();
    buildTopRow("rowTopActive", filterActive, renderActive);
    buildEntityRow("rowCatsActive", activeItems(categories), filterActive.catId, "×›×œ ×”×§×˜×’×•×¨×™×•×ª", id=>{filterActive.catId=id; renderActive();});
    buildEntityRow("rowBrandsActive", activeItems(brands), filterActive.brandId, "×›×œ ×”××•×ª×’×™×", id=>{filterActive.brandId=id; renderActive();});
    buildEntityRow("rowStoresActive", activeItems(stores), filterActive.storeId, "×›×œ ×”×—× ×•×™×•×ª", id=>{filterActive.storeId=id; renderActive();});

    const listHost=document.getElementById("activeList");
    const sortMode=document.getElementById("sortActive").value;
    const q=document.getElementById("searchInputActive").value||"";

    let vs = vouchers.filter(v=>!v.archived);
    vs = filterVouchers(vs, filterActive, q);
    const usage = brandUsageCounts(vouchers.filter(v=>!v.archived));
    vs = (sortMode==="smart") ? smartSort(vs, usage) : sortByMode(vs, sortMode);
    vs = vs.slice().sort((a,b)=> (isNearExpiry(b)?1:0) - (isNearExpiry(a)?1:0) );

    listHost.innerHTML="";
    if(!vs.length){ listHost.innerHTML='<div class="note">××™×Ÿ ×©×•×‘×¨×™× ×œ×”×¦×’×” (× ×¡×” ×œ×”×•×¨×™×“ ×¡×™× ×•×Ÿ).</div>'; return; }
    vs.forEach(v=>listHost.appendChild(renderVoucherCard(v)));
  }
  window.renderActive = renderActive;

  function renderArchive(){
    buildTopRow("rowTopArchive", filterArchive, renderArchive);
    buildEntityRow("rowCatsArchive", activeItems(categories), filterArchive.catId, "×›×œ ×”×§×˜×’×•×¨×™×•×ª", id=>{filterArchive.catId=id; renderArchive();});
    buildEntityRow("rowBrandsArchive", activeItems(brands), filterArchive.brandId, "×›×œ ×”××•×ª×’×™×", id=>{filterArchive.brandId=id; renderArchive();});
    buildEntityRow("rowStoresArchive", activeItems(stores), filterArchive.storeId, "×›×œ ×”×—× ×•×™×•×ª", id=>{filterArchive.storeId=id; renderArchive();});

    const listHost=document.getElementById("archiveList");
    const sortMode=document.getElementById("sortArchive").value;
    const q=document.getElementById("searchInputArchive").value||"";

    let vs = vouchers.filter(v=>!!v.archived);
    vs = filterVouchers(vs, filterArchive, q);
    const usage = brandUsageCounts(vouchers.filter(v=>!!v.archived));
    vs = (sortMode==="smart") ? smartSort(vs, usage) : sortByMode(vs, sortMode);
    vs = vs.slice().sort((a,b)=> (isNearExpiry(b)?1:0) - (isNearExpiry(a)?1:0) );

    listHost.innerHTML="";
    if(!vs.length){ listHost.innerHTML='<div class="note">××™×Ÿ ×©×•×‘×¨×™× ×‘××¨×›×™×•×Ÿ ×œ×¤×™ ×”×¡×™× ×•×Ÿ.</div>'; return; }
    vs.forEach(v=>listHost.appendChild(renderVoucherCard(v)));
  }
  window.renderArchive = renderArchive;

  // ===== Manage (simple lists only â€“ ×›××• ×§×•×“×) =====
  let manageTab="brands";
  function renderManageTabs(){
    const host=document.getElementById("manageTabs"); host.innerHTML="";
    const mk=(key,label)=>{
      const c=document.createElement("div");
      c.className="chip " + (manageTab===key?"active":"");
      c.textContent=label;
      c.onclick=()=>{manageTab=key; renderManage();};
      host.appendChild(c);
    };
    mk("brands","××•×ª×’×™×"); mk("stores","×—× ×•×™×•×ª"); mk("cats","×§×˜×’×•×¨×™×•×ª");
  }
  function renderManage(){
    renderManageTabs();
    document.getElementById("manageBrands").style.display=(manageTab==="brands"?"block":"none");
    document.getElementById("manageStores").style.display=(manageTab==="stores"?"block":"none");
    document.getElementById("manageCats").style.display=(manageTab==="cats"?"block":"none");

    if(manageTab==="brands") renderBrandsList();
    if(manageTab==="stores") renderStoresList();
    if(manageTab==="cats") renderCatsList();
  }

  function toggleActive(arr,id){
    const obj=arr.find(x=>x.id===id); if(!obj) return;
    if(!confirm(obj.active ? "×œ×”×©×‘×™×ª? (×œ× ××•×—×§ ×”×™×¡×˜×•×¨×™×”)" : "×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?")) return;
    obj.active=!obj.active;
    saveAll(); renderAll();
  }
  function editName(arr,id,label){
    const obj=arr.find(x=>x.id===id); if(!obj) return;
    const next=(prompt("×©× ×—×“×©:", obj.name)||"").trim();
    if(!next) return;
    if(arr.some(x=>x.id!==id && normalizeText(x.name)===normalizeText(next))) return alert("×›×‘×¨ ×§×™×™× ×‘×©× ×”×–×”");
    obj.name=next;
    saveAll(); renderAll();
  }

  function renderBrandsList(){
    const ul=document.getElementById("brandsList"); ul.innerHTML="";
    brands.slice().sort((a,b)=>a.name.localeCompare(b.name,"he")).forEach(b=>{
      const li=document.createElement("li");
      li.innerHTML=`<span>${escapeHtml(b.name)}${b.active?"":" (××•×©×‘×ª)"}</span>
        <div class="btn-group">
          <button class="iconbtn" type="button">âœï¸</button>
          <button class="iconbtn" type="button">${b.active?"âŒ":"â†©ï¸"}</button>
        </div>`;
      li.querySelectorAll("button")[0].onclick=()=>editName(brands,b.id,"××•×ª×’");
      li.querySelectorAll("button")[1].onclick=()=>toggleActive(brands,b.id);
      ul.appendChild(li);
    });
  }
  function renderStoresList(){
    const ul=document.getElementById("storesList"); ul.innerHTML="";
    stores.slice().sort((a,b)=>a.name.localeCompare(b.name,"he")).forEach(s=>{
      const li=document.createElement("li");
      li.innerHTML=`<span>${escapeHtml(s.name)}${s.active?"":" (××•×©×‘×ª)"}</span>
        <div class="btn-group">
          <button class="iconbtn" type="button">âœï¸</button>
          <button class="iconbtn" type="button">${s.active?"âŒ":"â†©ï¸"}</button>
        </div>`;
      li.querySelectorAll("button")[0].onclick=()=>editName(stores,s.id,"×—× ×•×ª");
      li.querySelectorAll("button")[1].onclick=()=>toggleActive(stores,s.id);
      ul.appendChild(li);
    });
  }
  function renderCatsList(){
    const ul=document.getElementById("catsList"); ul.innerHTML="";
    categories.slice().sort((a,b)=>a.name.localeCompare(b.name,"he")).forEach(c=>{
      const li=document.createElement("li");
      li.innerHTML=`<span>${escapeHtml(c.name)}${c.active?"":" (××•×©×‘×ª)"}</span>
        <div class="btn-group">
          <button class="iconbtn" type="button">âœï¸</button>
          <button class="iconbtn" type="button">${c.active?"âŒ":"â†©ï¸"}</button>
        </div>`;
      li.querySelectorAll("button")[0].onclick=()=>editName(categories,c.id,"×§×˜×’×•×¨×™×”");
      li.querySelectorAll("button")[1].onclick=()=>toggleActive(categories,c.id);
      ul.appendChild(li);
    });
  }

  function addBrand(){
    const v=(document.getElementById("newBrandName").value||"").trim();
    if(!v) return;
    if(brands.some(x=>normalizeText(x.name)===normalizeText(v))) return alert("××•×ª×’ ×›×‘×¨ ×§×™×™×");
    brands.push({id:uid(), name:v, active:true, createdAt:Date.now()});
    document.getElementById("newBrandName").value="";
    saveAll(); renderAll();
  }
  window.addBrand=addBrand;

  function addStore(){
    const v=(document.getElementById("newStoreName").value||"").trim();
    if(!v) return;
    if(stores.some(x=>normalizeText(x.name)===normalizeText(v))) return alert("×—× ×•×ª ×›×‘×¨ ×§×™×™××ª");
    stores.push({id:uid(), name:v, active:true, createdAt:Date.now()});
    document.getElementById("newStoreName").value="";
    saveAll(); renderAll();
  }
  window.addStore=addStore;

  function addCategory(){
    const v=(document.getElementById("newCatName").value||"").trim();
    if(!v) return;
    if(categories.some(x=>normalizeText(x.name)===normalizeText(v))) return alert("×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª");
    categories.push({id:uid(), name:v, active:true, createdAt:Date.now()});
    document.getElementById("newCatName").value="";
    saveAll(); renderAll();
  }
  window.addCategory=addCategory;

  // ===== Voucher add/edit & picker & view (××•×ª×• ×× ×’× ×•×Ÿ, ×§×™×¦×¨×ª×™ ×›××Ÿ ××ª ×”×§×•×“ ×œ×˜××‘) =====
  let __voucherDraft=null;
  let editingVoucherId="";
  let viewingId="";
  let __picker={ mode:"", multi:false, selected:[] };

  function refreshChosenNotes(){
    const bn=document.getElementById("brandChosenNote");
    const sn=document.getElementById("storesChosenNote");
    const cn=document.getElementById("catsChosenNote");
    if(!__voucherDraft){ bn.textContent="×œ× × ×‘×—×¨"; sn.textContent="×œ× × ×‘×—×¨×•"; cn.textContent="×œ× × ×‘×—×¨×•"; return; }
    const b=__voucherDraft.brandId?nameById(brands,__voucherDraft.brandId):"";
    bn.textContent=b?("× ×‘×—×¨: "+b):"×œ× × ×‘×—×¨";
    const sNames=(__voucherDraft.storeIds||[]).map(id=>nameById(stores,id)).filter(Boolean);
    sn.textContent=sNames.length?("× ×‘×—×¨×•: "+sNames.join(", ")):"×œ× × ×‘×—×¨×•";
    const cNames=(__voucherDraft.catIds||[]).map(id=>nameById(categories,id)).filter(Boolean);
    cn.textContent=cNames.length?("× ×‘×—×¨×•: "+cNames.join(", ")):"×œ× × ×‘×—×¨×•";
  }

  function openVoucherModal(id){
    autoArchiveSweep();
    editingVoucherId=id||"";
    const v = id ? vouchers.find(x=>x.id===id) : null;
    __voucherDraft = v ? JSON.parse(JSON.stringify(v)) : emptyVoucher();

    document.getElementById("voucherModalTitle").textContent = id ? "âœï¸ ×¢×¨×™×›×ª ×©×•×‘×¨" : "â• ×©×•×‘×¨ ×—×“×©";
    document.getElementById("vType").value = __voucherDraft.type || "×›×œ×œ×™";
    document.getElementById("vScope").value = __voucherDraft.scope || "all";
    document.getElementById("vPhysical").value = String(__voucherDraft.physical?1:0);
    document.getElementById("vExpiry").value = __voucherDraft.expiryISO || "";
    document.getElementById("vCode").value = __voucherDraft.code || "";
    document.getElementById("vNotes").value = __voucherDraft.notes || "";

    refreshChosenNotes();
    renderVoucherTypeFields();

    const delBtn=document.querySelector("#voucherBackdrop .btn.danger");
    delBtn.style.display = id ? "block" : "none";

    document.getElementById("voucherBackdrop").style.display="flex";
  }
  window.openVoucherModal=openVoucherModal;

  function hideVoucherModal(){
    document.getElementById("voucherBackdrop").style.display="none";
    __voucherDraft=null; editingVoucherId="";
  }
  window.hideVoucherModal=hideVoucherModal;

  function closeVoucherModal(e){
    if(e.target===document.getElementById("voucherBackdrop")) hideVoucherModal();
  }
  window.closeVoucherModal=closeVoucherModal;

  function renderVoucherTypeFields(){
    const t=document.getElementById("vType").value;
    const host=document.getElementById("typeFields");
    host.innerHTML="";
    if(t==="×›×¡×¤×™"){
      host.innerHTML =
        '<div class="field"><label>×¢×¨×š (×©×´×—)</label><input id="moneyValue" inputmode="decimal" placeholder="×œ××©×œ 500"></div>'+
        '<div class="field"><label>× ×•×¦×œ (×©×´×—)</label><input id="moneyUsed" inputmode="decimal" placeholder="×œ××©×œ 200"></div>'+
        '<div class="field"><label>×™×ª×¨×” (×©×´×—)</label><input id="moneyRemain" inputmode="decimal" placeholder="×œ××©×œ 300"></div>'+
        '<div class="note">×›××©×¨ ×™×ª×¨×” ××’×™×¢×” ×œ-0 â€” ×”×©×•×‘×¨ ×™×¢×‘×•×¨ ××•×˜×•××˜×™×ª ×œ××¨×›×™×•×Ÿ.</div>';
      document.getElementById("moneyValue").value=__voucherDraft?.moneyValue||"";
      document.getElementById("moneyUsed").value=__voucherDraft?.moneyUsed||"";
      document.getElementById("moneyRemain").value=__voucherDraft?.moneyRemain||"";
    } else if(t==="××—×•×–"){
      host.innerHTML = '<div class="field"><label>×¤×™×¨×•×˜</label><input id="percentText" placeholder="×œ××©×œ 20% ×”× ×—×” ×¢×“ 200 ×©×´×—"></div>';
      document.getElementById("percentText").value=__voucherDraft?.percentText||"";
    } else if(t==="1+1"){
      host.innerHTML = '<div class="field"><label>×¤×™×¨×•×˜</label><input id="dealText" placeholder="×œ××©×œ 1+1 ×¢×œ ×¤×¨×™×˜ ×©× ×™"></div>';
      document.getElementById("dealText").value=__voucherDraft?.dealText||"";
    } else {
      host.innerHTML = '<div class="note">×¡×•×’ ×›×œ×œ×™ â€” ×¤×¨×˜×™× ×‘×”×¢×¨×•×ª.</div>';
    }
  }
  window.renderVoucherTypeFields=renderVoucherTypeFields;

  function openQuickAdd(kind){
    const label = kind==="brand" ? "××•×ª×’" : (kind==="store" ? "×—× ×•×ª" : "×§×˜×’×•×¨×™×”");
    const name = (prompt("×©× "+label+" ×—×“×©:") || "").trim();
    if(!name) return;

    if(kind==="brand"){
      if(brands.some(x=>normalizeText(x.name)===normalizeText(name))) return alert("××•×ª×’ ×›×‘×¨ ×§×™×™×");
      const id=uid();
      brands.push({id,name,active:true,createdAt:Date.now()});
      saveAll();
      if(__voucherDraft) __voucherDraft.brandId=id;
      refreshChosenNotes();
      renderAll();
      return;
    }
    if(kind==="store"){
      if(stores.some(x=>normalizeText(x.name)===normalizeText(name))) return alert("×—× ×•×ª ×›×‘×¨ ×§×™×™××ª");
      const id=uid();
      stores.push({id,name,active:true,createdAt:Date.now()});
      saveAll();
      if(__voucherDraft && !(__voucherDraft.storeIds||[]).includes(id)) __voucherDraft.storeIds.push(id);
      refreshChosenNotes();
      renderAll();
      return;
    }
    if(kind==="cat"){
      if(categories.some(x=>normalizeText(x.name)===normalizeText(name))) return alert("×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª");
      const id=uid();
      categories.push({id,name,active:true,createdAt:Date.now()});
      saveAll();
      if(__voucherDraft && !(__voucherDraft.catIds||[]).includes(id)) __voucherDraft.catIds.push(id);
      refreshChosenNotes();
      renderAll();
    }
  }
  window.openQuickAdd=openQuickAdd;

  function openPicker(mode, multi){
    __picker.mode=mode;
    __picker.multi=!!multi;
    __picker.selected = (()=>{
      if(!__voucherDraft) return [];
      if(mode==="brand") return __voucherDraft.brandId ? [__voucherDraft.brandId] : [];
      if(mode==="stores") return (__voucherDraft.storeIds||[]).slice();
      return (__voucherDraft.catIds||[]).slice();
    })();
    document.getElementById("pickerSearch").value="";
    document.getElementById("pickerTitle").textContent = mode==="brand" ? "×‘×—×¨ ××•×ª×’" : (mode==="stores" ? "×‘×—×¨ ×—× ×•×™×•×ª" : "×‘×—×¨ ×§×˜×’×•×¨×™×•×ª");
    renderPickerList();
    document.getElementById("pickerBackdrop").style.display="flex";
  }
  window.openPicker=openPicker;

  function hidePicker(){ document.getElementById("pickerBackdrop").style.display="none"; }
  window.hidePicker=hidePicker;

  function closePickerModal(e){ if(e.target===document.getElementById("pickerBackdrop")) hidePicker(); }
  window.closePickerModal=closePickerModal;

  function renderPickerList(){
    const host=document.getElementById("pickerList"); host.innerHTML="";
    const q=normalizeText(document.getElementById("pickerSearch").value||"");
    let items = __picker.mode==="brand" ? activeItems(brands) : (__picker.mode==="stores" ? activeItems(stores) : activeItems(categories));
    items = items.slice().sort((a,b)=>a.name.localeCompare(b.name,"he"));
    if(q) items = items.filter(x=>normalizeText(x.name).includes(q));
    if(!items.length){ host.innerHTML='<div class="note">××™×Ÿ ×ª×•×¦××•×ª.</div>'; return; }

    items.forEach(it=>{
      const row=document.createElement("div");
      row.className="pickItem " + (__picker.selected.includes(it.id) ? "active" : "");
      row.innerHTML=`<div>${escapeHtml(it.name)}</div><div class="right"><div class="badge">${__picker.selected.includes(it.id)?"× ×‘×—×¨":"×‘×—×¨"}</div></div>`;
      row.onclick=()=>{
        if(__picker.multi){
          const idx=__picker.selected.indexOf(it.id);
          if(idx>=0) __picker.selected.splice(idx,1);
          else __picker.selected.push(it.id);
        } else {
          __picker.selected=[it.id];
        }
        renderPickerList();
      };
      host.appendChild(row);
    });
  }
  window.renderPickerList=renderPickerList;

  function pickerApply(){
    if(!__voucherDraft) return hidePicker();
    if(__picker.mode==="brand") __voucherDraft.brandId = __picker.selected[0] || "";
    if(__picker.mode==="stores") __voucherDraft.storeIds = __picker.selected.slice();
    if(__picker.mode==="cats") __voucherDraft.catIds = __picker.selected.slice();
    refreshChosenNotes();
    hidePicker();
  }
  window.pickerApply=pickerApply;

  function ensureVoucherHasBrandOrStore(v){ return !!(v.brandId || (v.storeIds && v.storeIds.length)); }

  function saveVoucher(){
    if(!__voucherDraft) return;
    __voucherDraft.type=document.getElementById("vType").value;
    __voucherDraft.scope=document.getElementById("vScope").value;
    __voucherDraft.physical=Number(document.getElementById("vPhysical").value)?1:0;
    __voucherDraft.expiryISO=document.getElementById("vExpiry").value||"";
    __voucherDraft.code=document.getElementById("vCode").value||"";
    __voucherDraft.notes=document.getElementById("vNotes").value||"";

    __voucherDraft.moneyValue=""; __voucherDraft.moneyUsed=""; __voucherDraft.moneyRemain="";
    __voucherDraft.percentText=""; __voucherDraft.dealText="";
    if(__voucherDraft.type==="×›×¡×¤×™"){
      __voucherDraft.moneyValue=(document.getElementById("moneyValue")||{}).value||"";
      __voucherDraft.moneyUsed=(document.getElementById("moneyUsed")||{}).value||"";
      __voucherDraft.moneyRemain=(document.getElementById("moneyRemain")||{}).value||"";
    } else if(__voucherDraft.type==="××—×•×–"){
      __voucherDraft.percentText=(document.getElementById("percentText")||{}).value||"";
    } else if(__voucherDraft.type==="1+1"){
      __voucherDraft.dealText=(document.getElementById("dealText")||{}).value||"";
    }

    if(!ensureVoucherHasBrandOrStore(__voucherDraft)){
      alert("×›×“×™ ×œ×©××•×¨: ×—×•×‘×” ×œ×‘×—×•×¨ ××•×ª×’ ××• ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×—× ×•×ª ××—×ª.");
      return;
    }

    __voucherDraft.updatedAt=Date.now();
    __voucherDraft.updatedBy=DEVICE_NAME;

    if(!__voucherDraft.archived && isExpired(__voucherDraft)){ __voucherDraft.archived=true; __voucherDraft.archivedReason="expired"; }
    if(!__voucherDraft.archived && __voucherDraft.type==="×›×¡×¤×™"){
      const rem=voucherAmountRemain(__voucherDraft);
      if(rem<=0 && String(__voucherDraft.moneyRemain).trim()!==""){ __voucherDraft.archived=true; __voucherDraft.archivedReason="zero"; }
    }

    if(editingVoucherId){
      const idx=vouchers.findIndex(x=>x.id===editingVoucherId);
      if(idx>=0) vouchers[idx]=__voucherDraft;
    } else {
      vouchers.push(__voucherDraft);
    }

    saveAll();
    hideVoucherModal();
    renderAll();
  }
  window.saveVoucher=saveVoucher;

  function deleteVoucherById(id){
    vouchers = vouchers.filter(v=>v.id!==id);
    saveAll(); renderAll();
  }

  function deleteVoucherFromModal(){
    if(!editingVoucherId) return;
    if(!confirm("×œ××—×•×§ ××ª ×”×©×•×‘×¨?")) return;
    deleteVoucherById(editingVoucherId);
    hideVoucherModal();
  }
  window.deleteVoucherFromModal=deleteVoucherFromModal;

  function openViewModal(id){
    const v=vouchers.find(x=>x.id===id);
    if(!v) return;
    viewingId=id;
    document.getElementById("viewTitle").textContent=voucherTitle(v);
    const body=document.getElementById("viewBody"); body.innerHTML="";
    const addRow=(k,val)=>{
      const row=document.createElement("div");
      row.className="vrow";
      row.innerHTML=`<b>${escapeHtml(k)}</b><span>${escapeHtml(val)}</span>`;
      body.appendChild(row);
    };
    addRow("×¡×•×’", v.type||"×›×œ×œ×™");
    addRow("××•×ª×’", v.brandId?nameById(brands,v.brandId):"â€”");
    const sNames=(v.storeIds||[]).map(sid=>nameById(stores,sid)).filter(Boolean);
    addRow("×—× ×•×™×•×ª", sNames.length?sNames.join(", "):"â€”");
    const cNames=(v.catIds||[]).map(cid=>nameById(categories,cid)).filter(Boolean);
    addRow("×§×˜×’×•×¨×™×•×ª", cNames.length?cNames.join(", "):"â€”");
    addRow("×›×¨×˜×™×¡ ×¤×™×–×™", v.physical?"×›×Ÿ":"×œ×");
    addRow("×ª×•×§×£", v.expiryISO||"â€”");
    if(v.type==="×›×¡×¤×™"){
      addRow("×¢×¨×š", String(v.moneyValue||"").trim()!==""?v.moneyValue:"â€”");
      addRow("× ×•×¦×œ", String(v.moneyUsed||"").trim()!==""?v.moneyUsed:"â€”");
      addRow("×™×ª×¨×”", String(v.moneyRemain||"").trim()!==""?v.moneyRemain:"â€”");
    } else if(v.type==="××—×•×–"){
      addRow("×¤×™×¨×•×˜", v.percentText||"â€”");
    } else if(v.type==="1+1"){
      addRow("×¤×™×¨×•×˜", v.dealText||"â€”");
    }
    addRow("×§×•×“", v.code?v.code:"â€”");
    addRow("×”×¢×¨×•×ª", v.notes?v.notes:"â€”");
    document.getElementById("viewBackdrop").style.display="flex";
  }
  window.openViewModal=openViewModal;

  function hideViewModal(){ document.getElementById("viewBackdrop").style.display="none"; viewingId=""; }
  window.hideViewModal=hideViewModal;

  function closeViewModal(e){ if(e.target===document.getElementById("viewBackdrop")) hideViewModal(); }
  window.closeViewModal=closeViewModal;

  function copyCode(){
    const v=vouchers.find(x=>x.id===viewingId);
    const code=String(v?.code||"").trim();
    if(!code) return alert("××™×Ÿ ×§×•×“ ×œ×”×¢×ª×§×”");
    navigator.clipboard?.writeText(code).then(()=>alert("×”×•×¢×ª×§ âœ…")).catch(()=>alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§ ××•×˜×•××˜×™×ª"));
  }
  window.copyCode=copyCode;

  function openEditFromView(){
    const id=viewingId;
    hideViewModal();
    openVoucherModal(id);
  }
  window.openEditFromView=openEditFromView;

  function toggleArchiveFromView(){
    const v=vouchers.find(x=>x.id===viewingId);
    if(!v) return;
    if(v.archived){ v.archived=false; v.archivedReason=""; }
    else { v.archived=true; v.archivedReason="manual"; }
    v.updatedAt=Date.now(); v.updatedBy=DEVICE_NAME;
    saveAll(); hideViewModal(); renderAll();
  }
  window.toggleArchiveFromView=toggleArchiveFromView;

  function deleteVoucherFromView(){
    if(!confirm("×œ××—×•×§ ××ª ×”×©×•×‘×¨?")) return;
    const id=viewingId;
    hideViewModal();
    deleteVoucherById(id);
  }
  window.deleteVoucherFromView=deleteVoucherFromView;

  function resetAll(){
    if(!confirm("××™×¤×•×¡ ××œ×?")) return;
    localStorage.clear();
    location.reload();
  }
  window.resetAll=resetAll;

  function renderAll(){
    renderActive();
    renderArchive();
    renderManage();
    renderSyncLastLine();
    showLocalNoteIfYanir();
    maybeShowDeviceCard();
  }

  loadAll();
  renderAll();
</script>
</body>
</html>
