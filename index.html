<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×©×•×‘×¨×™× ×•×§×•×¤×•× ×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;

      /* Pastel status colors */
      --st-green:#d1fae5;
      --st-yellow:#fef3c7;
      --st-gray:#e5e7eb;
      --st-red:#fee2e2;

      --accent-green:#22c55e;
      --accent-yellow:#f59e0b;
      --accent-gray:#64748b;
      --accent-red:#ef4444;

      --soft-green:#e8f7ee;
      --soft-blue:#eef2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
      overflow:hidden;
    }
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .view{display:none}
    .view.active{display:block}

    .field{margin-top:10px; min-width:0; overflow:hidden;}
    label{font-weight:900}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff;
      max-width:100%;
    }
    input[type="date"]{width:100%; max-width:100%; display:block; min-width:0;}
    textarea{min-height:120px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline > *{flex:1; min-width:180px}
    .inline .tight{flex:0 0 auto; min-width:auto}
    .inline .btn{flex:0 0 auto; min-width:auto}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}
    .softgreen{background:#16a34a14; color:#065f46; border:1px solid #86efac}
    .softgreen:hover{background:#16a34a22}

    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      font-weight:900; line-height:1;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      min-width:40px;
    }

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    .chips{
      display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; margin:8px 0 10px;
    }
    .chip{
      display:flex; align-items:center; gap:6px;
      font-weight:900; font-size:12px;
      background:#fff; border:1px solid var(--border);
      padding:6px 10px; border-radius:999px;
      white-space:nowrap; flex:0 0 auto;
      cursor:pointer;
    }
    .chip.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .chip.small{padding:6px 8px}
    .chip.muted{background:#f8fafc}

    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    li span{flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .btn-group{display:flex; gap:8px; align-items:center; flex:0 0 auto}

    /* Voucher list cards */
    .vcard{
      border:1px solid var(--border);
      background:#fff;
      border-radius:18px;
      padding:12px;
      margin-bottom:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.03);
    }
    .vtop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:8px;
    }
    .vtitle{
      font-weight:1000;
      font-size:16px;
      margin:0;
      display:flex; align-items:center; gap:8px;
      min-width:0;
    }
    .vsubtitle{
      font-weight:900;
      color:#374151;
      font-size:13px;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .vmeta{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--border);
      white-space:nowrap;
      background:var(--pill);
    }

    /* Status icon (left side) + Open button next to it */
    .leftActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .statusIcon{
      width:34px; height:34px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--border);
      font-weight:1000;
      user-select:none;
    }
    .st-green{background:var(--st-green); color:#065f46; border-color:#86efac}
    .st-yellow{background:var(--st-yellow); color:#92400e; border-color:#fde68a}
    .st-gray{background:var(--st-gray); color:#334155; border-color:#cbd5e1}
    .st-red{background:var(--st-red); color:#991b1b; border-color:#fecaca}

    .openBtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:1000;
      white-space:nowrap;
    }

    .sectionTitleRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }

    /* Split filter rows */
    .filterBlock{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      background:#fff;
    }
    .filterLabel{font-weight:1000; font-size:13px; color:#374151; margin:0 0 6px}
    .searchRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .searchRow input{flex:1; min-width:220px}
    .searchRow .tight{flex:0 0 auto}

    .twoCols{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media(min-width:720px){
      body{max-width:900px;margin:auto}
      .twoCols{grid-template-columns:1fr 1fr;}
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:760px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
      max-height:86vh;
      overflow:auto;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      position:sticky;
      top:0;
      background:#fff;
      padding-bottom:8px;
      z-index:2;
    }
    .modal-title{font-weight:1000;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tiny{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .tiny.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    .tiny.danger{background:var(--danger); color:#fff; border-color:var(--danger)}

    .divider{
      height:1px;
      background:var(--border);
      margin:12px 0;
    }

    .readonly{
      background:#f9fafb;
      color:#111827;
    }

    .warn{
      color:var(--danger);
      font-size:13px;
      margin-top:8px;
      display:none;
      font-weight:900;
    }

    .kvs{
      display:flex; flex-direction:column; gap:6px; margin-top:6px;
    }
    .kv{
      display:flex; justify-content:space-between; gap:10px;
      padding:8px 10px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:#fafafa;
      align-items:center;
    }
    .kv b{white-space:nowrap}
    .kv span{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; color:#374151; font-weight:900;}
  </style>
</head>

<body>
  <h1>ğŸŸï¸ ×©×•×‘×¨×™× ×•×§×•×¤×•× ×™×</h1>

  <div class="tabs">
    <button class="tabbtn active" type="button" onclick="showTab('active')">×¤×¢×™×œ×™×</button>
    <button class="tabbtn" type="button" onclick="showTab('archive')">××¨×›×™×•×Ÿ</button>
    <button class="tabbtn" type="button" onclick="showTab('manage')">× ×™×”×•×œ</button>
    <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
  </div>

  <!-- ×¤×¢×™×œ×™× -->
  <section id="view-active" class="view active">
    <section class="card" style="background:var(--soft-green); border-color:#bbf7d0;">
      <div class="sectionTitleRow">
        <div>
          <h2 style="margin:0;">×™×¦×™×¨×ª ×©×•×‘×¨ ×—×“×©</h2>
          <div class="note" style="margin:6px 0 0; font-weight:900; color:#065f46;">×œ×—×¥ ×›××Ÿ ×œ×”×•×¡×¤×ª ×©×•×‘×¨ ×—×“×©</div>
        </div>
        <button class="btn softgreen" type="button" onclick="openVoucherCreate()">+ ×”×•×¡×£ ×©×•×‘×¨</button>
      </div>
    </section>

    <section class="card">
      <h2>×—×™×¤×•×© ×•×¡×™× ×•×Ÿ</h2>

      <div class="searchRow">
        <input id="searchInputActive" placeholder="×—×™×¤×•×© ×œ×¤×™ ××•×ª×’ / ×—× ×•×ª / ×”×¢×¨×•×ª / ×§×•×“..." oninput="renderActive()">
        <button class="btn ghost tight" type="button" onclick="clearSearch('active')">× ×§×”</button>
      </div>

      <div class="note" style="font-weight:900; margin-top:8px;">
        ×˜×™×¤: ×× ××¡×¢×“×”/×—× ×•×ª ××•×¤×™×¢×” ×‘×›××” ×©×•×‘×¨×™× â€” ×ª×•×›×œ ×œ×¡× ×Ÿ ×œ×¤×™ ×”×—× ×•×ª ×•×œ××™×™×Ÿ ×œ×¤×™ ×ª×•×§×£/×™×ª×¨×” ×›×“×™ ×œ×‘×—×•×¨ ××” ×œ× ×¦×œ.
      </div>

      <div class="filterBlock">
        <div class="filterLabel">××¦×‘</div>
        <div class="chips" id="chipsStateActive"></div>

        <div class="filterLabel" style="margin-top:10px;">××•×ª×’×™×</div>
        <div class="chips" id="chipsBrandsActive"></div>

        <div class="filterLabel" style="margin-top:10px;">×—× ×•×™×•×ª</div>
        <div class="chips" id="chipsStoresActive"></div>

        <div class="filterLabel" style="margin-top:10px;">×§×˜×’×•×¨×™×•×ª</div>
        <div class="chips" id="chipsCatsActive"></div>

        <div class="filterLabel" style="margin-top:10px;">××™×•×Ÿ</div>
        <div class="chips" id="chipsSortActive"></div>
      </div>
    </section>

    <section class="card">
      <div class="sectionTitleRow">
        <h2 style="margin:0;">×¨×©×™××ª ×©×•×‘×¨×™× ×¤×¢×™×œ×™×</h2>
        <span class="pill" id="activeCount">0</span>
      </div>
      <div id="activeList"></div>
      <div class="note" id="activeEmpty" style="display:none;">××™×Ÿ ×©×•×‘×¨×™× ×œ×”×¦×’×”.</div>
    </section>
  </section>

  <!-- ××¨×›×™×•×Ÿ -->
  <section id="view-archive" class="view">
    <section class="card">
      <h2>×—×™×¤×•×© ×•×¡×™× ×•×Ÿ</h2>

      <div class="searchRow">
        <input id="searchInputArchive" placeholder="×—×™×¤×•×© ×‘××¨×›×™×•×Ÿ ×œ×¤×™ ××•×ª×’ / ×—× ×•×ª / ×”×¢×¨×•×ª / ×§×•×“..." oninput="renderArchive()">
        <button class="btn ghost tight" type="button" onclick="clearSearch('archive')">× ×§×”</button>
      </div>

      <div class="filterBlock">
        <div class="filterLabel">××¦×‘</div>
        <div class="chips" id="chipsStateArchive"></div>

        <div class="filterLabel" style="margin-top:10px;">××•×ª×’×™×</div>
        <div class="chips" id="chipsBrandsArchive"></div>

        <div class="filterLabel" style="margin-top:10px;">×—× ×•×™×•×ª</div>
        <div class="chips" id="chipsStoresArchive"></div>

        <div class="filterLabel" style="margin-top:10px;">×§×˜×’×•×¨×™×•×ª</div>
        <div class="chips" id="chipsCatsArchive"></div>

        <div class="filterLabel" style="margin-top:10px;">××™×•×Ÿ</div>
        <div class="chips" id="chipsSortArchive"></div>
      </div>
    </section>

    <section class="card">
      <div class="sectionTitleRow">
        <h2 style="margin:0;">××¨×›×™×•×Ÿ</h2>
        <span class="pill" id="archiveCount">0</span>
      </div>
      <div id="archiveList"></div>
      <div class="note" id="archiveEmpty" style="display:none;">××™×Ÿ ×©×•×‘×¨×™× ×‘××¨×›×™×•×Ÿ ×œ×”×¦×’×”.</div>
    </section>
  </section>

  <!-- × ×™×”×•×œ -->
  <section id="view-manage" class="view">
    <section class="card">
      <h2>× ×™×”×•×œ ××•×ª×’×™×</h2>
      <div class="inline">
        <input id="newBrandInput" placeholder="×©× ××•×ª×’ ×—×“×©">
        <button class="btn primary" type="button" onclick="addBrand()">×”×•×¡×£</button>
      </div>
      <div class="note">××—×™×§×ª ××•×ª×’ ×œ× ××•×—×§×ª ×©×•×‘×¨×™× ×”×™×¡×˜×•×¨×™×™× ×©×›×‘×¨ × ×•×¦×¨×• â€” ×”×©××•×ª × ×©××¨×™× ×‘×ª×•×š ×”×©×•×‘×¨ ×¢×¦××•.</div>
      <div id="brandsList"></div>
    </section>

    <section class="card">
      <h2>× ×™×”×•×œ ×—× ×•×™×•×ª</h2>
      <div class="inline">
        <input id="newStoreInput" placeholder="×©× ×—× ×•×ª ×—×“×©×”">
        <button class="btn primary" type="button" onclick="addStore()">×”×•×¡×£</button>
      </div>
      <div class="note">×—× ×•×ª ×™×›×•×œ×” ×œ×”×©×ª×™×™×š ×œ××¡×¤×¨ ××•×ª×’×™×. ××ª ×–×” ×× ×”×œ×™× ×‘××¡×š â€œ×¤×ª×—â€ ×©×œ ××•×ª×’/×—× ×•×ª.</div>
      <div id="storesList"></div>
    </section>

    <section class="card">
      <h2>× ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</h2>
      <div class="inline">
        <input id="newCatInput" placeholder="×©× ×§×˜×’×•×¨×™×” ×—×“×©×”">
        <button class="btn primary" type="button" onclick="addCategory()">×”×•×¡×£</button>
      </div>
      <div class="note">×§×˜×’×•×¨×™×•×ª ××©×•×™×›×•×ª ×œ×—× ×•×™×•×ª (×•×œ× ×œ××•×ª×’×™×), ×•××©××©×•×ª ×œ×¡×™× ×•×Ÿ ××”×™×¨ ×‘××¡×š ×”×¨××©×™ ×•×‘××¨×›×™×•×Ÿ.</div>
      <div id="catsList"></div>
    </section>
  </section>

  <!-- × ×ª×•× ×™× -->
  <section id="view-data" class="view">
    <section class="card">
      <h2>×¡× ×›×¨×•×Ÿ</h2>
      <div class="note" id="syncStatusLine"></div>
      <div class="note" id="syncLastLine"></div>

      <div class="inline" style="margin-top:10px;">
        <button class="btn primary" type="button" onclick="syncPullNow()">â¬‡ï¸ ××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ</button>
        <button class="btn primary" type="button" onclick="syncPushNow()">â¬†ï¸ ×©×œ×— × ×ª×•× ×™× ×œ×¢× ×Ÿ</button>
        <button class="btn ghost" type="button" onclick="backupNow()">×’×™×‘×•×™ ×œ×§×•×‘×¥</button>
        <button class="btn ghost" type="button" onclick="triggerRestore()">×˜×¢×™× ×ª ×’×™×‘×•×™</button>
      </div>

      <input id="restoreFile" type="file" accept=".json,application/json" style="display:none" onchange="restoreFromFile(event)">

      <div class="note" id="syncLocalNote" style="display:none; margin-top:10px;"></div>
    </section>

    <section class="card" id="deviceCard" style="display:none;">
      <h2>×”×’×“×¨×•×ª ××›×©×™×¨ (×¨×§ ××¦×œ Yanir)</h2>
      <div class="note">×–×” ×œ× ××¡×š ×œ××©×ª×š. ×–×” ×¨×§ ×›×“×™ ×œ×× ×•×¢ ×‘×œ×‘×•×œ ×•×œ×©××•×¨ ×¢×œ ×‘×¨×™×¨×ª ××—×“×œ ×©×‘×” Yanir ×× ×¦×— ×× ×™×© ×”×ª× ×’×©×•×ª.</div>

      <div class="field">
        <label>×©× ××›×©×™×¨ ×œ×¡× ×›×¨×•×Ÿ</label>
        <select id="deviceNameSelect" onchange="setDeviceNameFromUI()">
          <option value="Yanir">Yanir</option>
          <option value="Shirli">Shirli</option>
        </select>
        <div class="note">××¦×œ ××©×ª×š ×–×” ××•×¡×ª×¨. ××¦×œ×” ×‘×¨×™×¨×ª ×”××—×“×œ ×ª×”×™×” Shirli.</div>
      </div>
    </section>

    <section class="card">
      <h2>×›×œ×™ ×‘×“×™×§×”</h2>
      <div class="note">××™×¤×•×¡ ××•×—×§ × ×ª×•× ×™× ××§×•××™×™× ××”××›×©×™×¨ ×”×–×” ×‘×œ×‘×“.</div>
      <button class="btn danger" type="button" onclick="resetAll()">××™×¤×•×¡ ××œ×</button>
    </section>
  </section>

  <!-- MODAL: Create/Edit Voucher -->
  <div id="voucherBackdrop" class="modal-backdrop" onclick="closeVoucherModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="voucherModalTitle">×©×•×‘×¨</div>
        <div class="modal-actions">
          <button class="tiny primary" type="button" onclick="saveVoucher()">×©××™×¨×”</button>
          <button class="tiny" type="button" onclick="hideVoucherModal()">×¡×’×•×¨</button>
        </div>
      </div>

      <div class="twoCols">
        <div class="field">
          <label>×¡×•×’ ×©×•×‘×¨</label>
          <select id="vType" onchange="renderVoucherFields()">
            <option value="money">×©×•×‘×¨ ×›×¡×¤×™</option>
            <option value="cap">×”× ×—×” ×¢× ×ª×§×¨×” (×œ××©×œ 20% ×¢×“ 200â‚ª)</option>
            <option value="percent">×”× ×—×” ×‘××—×•×–×™× (×œ×œ× ×ª×§×¨×”)</option>
            <option value="bogo">1+1 / ××‘×¦×¢</option>
            <option value="general">×›×œ×œ×™</option>
          </select>
        </div>

        <div class="field">
          <label>×›×¨×˜×™×¡ ×¤×™×–×™</label>
          <select id="vPhysical" onchange="renderVoucherFields()">
            <option value="0" selected>×œ×</option>
            <option value="1">×›×Ÿ</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>×‘×—×¨ ××•×ª×’ (××• ×¦×•×¨ ×—×“×©)</label>
        <div class="inline">
          <select id="vBrand"></select>
          <button class="btn ghost tight" type="button" onclick="quickAddBrand()">+ ××•×ª×’ ×—×“×©</button>
        </div>
        <div class="note">××™×Ÿ ×©×“×” â€œ×©× ×©×•×‘×¨â€ â€” ×”×©× × ×’×–×¨ ××”××•×ª×’/×”×—× ×•×™×•×ª ×©×‘×—×¨×ª.</div>
      </div>

      <div class="field">
        <label>×ª×—×•×œ×ª ×”×©×•×‘×¨</label>
        <div class="inline">
          <select id="vScope" onchange="renderVoucherFields()">
            <option value="all" selected>×ª×§×£ ×œ×›×œ ×”×¨×©×ª</option>
            <option value="stores">×ª×§×£ ×¨×§ ×œ×—× ×•×™×•×ª ××¡×•×™××•×ª</option>
          </select>
        </div>
      </div>

      <div class="field" id="storesField">
        <label>×—× ×•×™×•×ª ×ª×§×¤×•×ª (×¨×‘Ö¾×‘×—×™×¨×”)</label>
        <div class="inline">
          <select id="vStores" multiple size="6" style="height:160px;"></select>
          <div class="tight" style="display:flex; flex-direction:column; gap:8px;">
            <button class="btn ghost" type="button" onclick="quickAddStore()">+ ×—× ×•×ª ×—×“×©×”</button>
            <button class="btn ghost" type="button" onclick="selectStoresOfBrand()">×‘×—×¨ ×—× ×•×™×•×ª ×©×œ ×”××•×ª×’</button>
            <button class="btn ghost" type="button" onclick="clearStoresSelection()">× ×§×” ×‘×—×™×¨×”</button>
          </div>
        </div>
        <div class="note">×× ×‘×—×¨×ª â€œ×ª×§×£ ×œ×›×œ ×”×¨×©×ªâ€ â€” ××¤×©×¨ ×œ×”×©××™×¨ ×—× ×•×™×•×ª ×¨×™×§ (×”××¢×¨×›×ª ×ª×¦×™×’ ×œ×š ×—× ×•×™×•×ª ×¢×™×§×¨×™×•×ª ×× ×§×™×™××•×ª ×‘××•×ª×’).</div>
      </div>

      <div class="divider"></div>

      <div id="moneyBlock" class="twoCols">
        <div class="field">
          <label>×¡×›×•× ×©×•×‘×¨ (â‚ª)</label>
          <input id="vTotal" type="number" inputmode="decimal" placeholder="×œ××©×œ 500">
        </div>
        <div class="field">
          <label>× ×•×¦×œ (â‚ª)</label>
          <input id="vUsed" type="number" inputmode="decimal" placeholder="×œ××©×œ 200" oninput="recalcBalance()">
        </div>
        <div class="field">
          <label>×™×ª×¨×” (â‚ª)</label>
          <input id="vBalance" class="readonly" type="number" inputmode="decimal" readonly>
          <div class="note">××—×•×©×‘ ××•×˜×•××˜×™×ª: ×¡×›×•× ×©×•×‘×¨ ×¤×—×•×ª × ×•×¦×œ.</div>
        </div>
      </div>

      <div id="capBlock" class="twoCols" style="display:none;">
        <div class="field">
          <label>×ª×™××•×¨ ×”×”× ×—×”</label>
          <input id="vCapDesc" placeholder='×œ××©×œ "20% ×”× ×—×” ×¢×“ 200â‚ª"'>
        </div>
        <div class="field">
          <label>×ª×§×¨×” (â‚ª)</label>
          <input id="vCapTotal" type="number" inputmode="decimal" placeholder="×œ××©×œ 200">
        </div>
        <div class="field">
          <label>× ×•×¦×œ ××ª×•×š ×”×ª×§×¨×” (â‚ª)</label>
          <input id="vCapUsed" type="number" inputmode="decimal" placeholder="×œ××©×œ 20" oninput="recalcBalance()">
        </div>
        <div class="field">
          <label>×™×ª×¨×” (â‚ª)</label>
          <input id="vCapBalance" class="readonly" type="number" inputmode="decimal" readonly>
        </div>
      </div>

      <div id="simpleDescBlock" style="display:none;">
        <div class="field">
          <label>×¤×™×¨×•×˜ / ×ª×™××•×¨ ×”×©×•×‘×¨</label>
          <input id="vDesc" placeholder='×œ××©×œ "10% ×”× ×—×”", "1+1 ×¢×œ ×—×•×œ×¦×•×ª", "××‘×¦×¢ ×›×œ×œ×™"...'>
        </div>
      </div>

      <div class="divider"></div>

      <div class="twoCols">
        <div class="field">
          <label>×ª×•×§×£ (××•×¤×¦×™×•× ×œ×™)</label>
          <input type="date" id="vExpiry" onchange="renderVoucherFields()">
          <div class="note" id="expiryHint"></div>
        </div>

        <div class="field" id="codeBlock">
          <label>×§×•×“ / ××¡×¤×¨ ×›×¨×˜×™×¡ (××•×¤×¦×™×•× ×œ×™)</label>
          <div class="inline">
            <input id="vCode" placeholder="×”×“×‘×§ ×›××Ÿ ×§×•×“...">
            <button class="btn ghost tight" type="button" onclick="pasteInto('vCode')">×”×“×‘×§</button>
          </div>
          <div class="note">×‘××¡×š ×”×©×•×‘×¨ ×™×”×™×” ×›×¤×ª×•×¨ â€œ×”×¢×ª×§ ×§×•×“â€.</div>
        </div>
      </div>

      <div class="field">
        <label>×”×¢×¨×•×ª / ×ª×•×›×Ÿ × ×•×¡×£</label>
        <div class="inline">
          <button class="btn ghost tight" type="button" onclick="pasteInto('vNotes')">×”×“×‘×§</button>
        </div>
        <textarea id="vNotes" placeholder="×”×“×‘×§ ×›××Ÿ ×¤×¨×˜×™× × ×•×¡×¤×™× / ×ª× ××™× / ××” ×©×¦×¨×™×š..."></textarea>
        <div id="pasteWarn" class="warn">×× ×”×”×“×‘×§×” ×”××•×˜×•××˜×™×ª ×œ× ×¢×•×‘×“×ª â€” ×”×“×‘×§ ×™×“× ×™×ª (×œ×—×™×¦×” ××¨×•×›×” â†’ Paste).</div>
      </div>

      <div class="divider"></div>

      <div class="inline">
        <button class="btn danger tight" type="button" id="deleteVoucherBtn" style="display:none;" onclick="deleteVoucher()">××—×§ ×©×•×‘×¨</button>
        <button class="btn ghost tight" type="button" id="archiveVoucherBtn" style="display:none;" onclick="moveVoucherToArchive()">×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ</button>
        <button class="btn ghost tight" type="button" id="restoreVoucherBtn" style="display:none;" onclick="restoreVoucherFromArchive()">×”×—×–×¨ ×œ×¤×¢×™×œ</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Brand details -->
  <div id="brandBackdrop" class="modal-backdrop" onclick="closeBrandModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="brandModalTitle">××•×ª×’</div>
        <div class="modal-actions">
          <button class="tiny primary" type="button" onclick="saveBrandLinks()">×©××™×¨×”</button>
          <button class="tiny" type="button" onclick="hideBrandModal()">×¡×’×•×¨</button>
        </div>
      </div>

      <div class="field">
        <label>×¢×¨×™×›×ª ×©× ××•×ª×’</label>
        <div class="inline">
          <input id="brandNameEdit">
          <button class="btn ghost tight" type="button" onclick="renameBrand()">×©× ×” ×©×</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>×—× ×•×™×•×ª ×©×©×™×™×›×•×ª ×œ××•×ª×’ (×¨×‘Ö¾×‘×—×™×¨×”)</label>
        <div class="inline">
          <select id="brandStoresMulti" multiple size="10" style="height:220px;"></select>
          <div class="tight" style="display:flex; flex-direction:column; gap:8px;">
            <button class="btn ghost" type="button" onclick="quickAddStoreFromBrand()">+ ×—× ×•×ª ×—×“×©×”</button>
            <button class="btn ghost" type="button" onclick="selectAllBrandStores()">×‘×—×¨ ×”×›×œ</button>
            <button class="btn ghost" type="button" onclick="clearAllBrandStores()">× ×§×”</button>
          </div>
        </div>
        <div class="note">×–×” × ×™×”×•×œ ×§×©×¨×™×. ×œ× ××•×—×§ ×”×™×¡×˜×•×¨×™×” ×©×œ ×©×•×‘×¨×™× ×©× ×•×¦×¨×• ×‘×¢×‘×¨.</div>
      </div>

      <div class="divider"></div>

      <button class="btn danger" type="button" onclick="deleteBrand()">××—×§ ××•×ª×’</button>
      <div class="note">××—×™×§×” ×œ× ××•×—×§×ª ×©×•×‘×¨×™× ×©×›×‘×¨ × ×•×¦×¨×•. ×¨×§ ××¡×™×¨×” ××”×¨×©×™××•×ª ×œ×‘×—×™×¨×” ×¢×ª×™×“×™×ª.</div>
    </div>
  </div>

  <!-- MODAL: Store details -->
  <div id="storeBackdrop" class="modal-backdrop" onclick="closeStoreModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="storeModalTitle">×—× ×•×ª</div>
        <div class="modal-actions">
          <button class="tiny primary" type="button" onclick="saveStoreLinks()">×©××™×¨×”</button>
          <button class="tiny" type="button" onclick="hideStoreModal()">×¡×’×•×¨</button>
        </div>
      </div>

      <div class="field">
        <label>×¢×¨×™×›×ª ×©× ×—× ×•×ª</label>
        <div class="inline">
          <input id="storeNameEdit">
          <button class="btn ghost tight" type="button" onclick="renameStore()">×©× ×” ×©×</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>×©×™×™×š ×œ××•×ª×’×™× (×¨×‘Ö¾×‘×—×™×¨×”)</label>
        <select id="storeBrandsMulti" multiple size="8" style="height:190px;"></select>
      </div>

      <div class="field">
        <label>×§×˜×’×•×¨×™×•×ª ×œ×—× ×•×ª (×¨×‘Ö¾×‘×—×™×¨×”)</label>
        <select id="storeCatsMulti" multiple size="8" style="height:190px;"></select>
      </div>

      <div class="divider"></div>

      <button class="btn danger" type="button" onclick="deleteStore()">××—×§ ×—× ×•×ª</button>
      <div class="note">××—×™×§×” ×œ× ××•×—×§×ª ×©×•×‘×¨×™× ×”×™×¡×˜×•×¨×™×™× ×©×›×‘×¨ × ×•×¦×¨×•.</div>
    </div>
  </div>

<script>
  /* ===== Service Worker registration ===== */
  (function(){
    if (!("serviceWorker" in navigator)) return;
    navigator.serviceWorker.register("./sw.js").catch(function(){});
  })();

  /* ===== Sync Config ===== */
  var __isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

  // ×›×ª×•×‘×ª ×”×¢× ×Ÿ ×©× ×ª×ª ×œ×™:
  var SYNC_URL = "https://script.google.com/macros/s/AKfycbzq9M_mKke4GTDeVPIHHfF-NFu5Yb7MADNVdeaYiuIn_S4LmkqhYejJw7DT9vR7HZG6/exec";

  // TOKEN ××•××¦× (××•×˜××¢ ×›××Ÿ). ×©×™× ××•×ª×• ×–×”×” ×’× ×‘-Apps Script ×©×œ×š.
  var SYNC_TOKEN = "COUPONS_TOKEN_9f3bA2_kP17";

  // Device name: ××¦×œ×š × ×—×©×•×£, ××¦×œ ×©×™×¨×œ×™ × ×¡×ª×™×¨.
  var DEVICE_NAME = (function(){
    var saved = localStorage.getItem("deviceNameCoupons");
    if(saved) return saved;
    var guess = __isIOS ? "Shirli" : "Yanir";
    localStorage.setItem("deviceNameCoupons", guess);
    return guess;
  })();

  var META_KEY = "cloudMetaCoupons";
  var LAST_SYNC_AT_KEY = "lastSyncAtCoupons";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtDateTime(ms){
    if(!ms) return "";
    var d = new Date(ms);
    return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate()) + " " + pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  }
  function setLastSyncNow(){
    var now = Date.now();
    localStorage.setItem(LAST_SYNC_AT_KEY, String(now));
    renderSyncLastLine();
  }
  function renderSyncLastLine(){
    var el = document.getElementById("syncLastLine");
    if(!el) return;
    var v = Number(localStorage.getItem(LAST_SYNC_AT_KEY) || "0");
    el.textContent = v ? ("×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: " + fmtDateTime(v)) : "×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”: â€”";
  }
  function setSyncMsg(msg){
    var el2 = document.getElementById("syncStatusLine");
    if(el2) el2.textContent = msg || "";
  }
  function safeJSONParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }
  function getLocalMeta(){
    return safeJSONParse(localStorage.getItem(META_KEY) || "null", { updatedAt:0, updatedBy:"" });
  }
  function setLocalMeta(meta){
    localStorage.setItem(META_KEY, JSON.stringify(meta || { updatedAt:0, updatedBy:"" }));
  }
  function localPayload(){
    return {
      brands: safeJSONParse(localStorage.getItem("brands") || "[]", []),
      stores: safeJSONParse(localStorage.getItem("stores") || "[]", []),
      categories: safeJSONParse(localStorage.getItem("categories") || "[]", []),
      vouchers: safeJSONParse(localStorage.getItem("vouchers") || "[]", [])
    };
  }
  function doFetchJSON(url){
    return fetch(url, { cache:"no-store" }).then(function(r){ return r.json(); });
  }

  function applyRemote(remote, meta){
    localStorage.setItem("brands", JSON.stringify(remote.brands || []));
    localStorage.setItem("stores", JSON.stringify(remote.stores || []));
    localStorage.setItem("categories", JSON.stringify(remote.categories || []));
    localStorage.setItem("vouchers", JSON.stringify(remote.vouchers || []));
    setLocalMeta(meta || { updatedAt:0, updatedBy:"" });

    brands = normalizeBrands(remote.brands || []);
    stores = normalizeStores(remote.stores || []);
    categories = normalizeCats(remote.categories || []);
    vouchers = normalizeVouchers(remote.vouchers || []);

    autoArchiveByRules(); // ×›×•×œ×œ ×ª×•×§×£/×™×ª×¨×” 0
    renderAll();
  }

  function syncPullNow(){
    setSyncMsg("×˜×•×¢×Ÿ ××”×¢× ×Ÿ...");
    doFetchJSON(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN))
      .then(function(j){
        if(!j || !j.ok) throw new Error("bad");
        if(!j.data){
          setSyncMsg("××™×Ÿ × ×ª×•× ×™× ×‘×¢× ×Ÿ");
          renderSyncLastLine();
          return;
        }
        var remote = safeJSONParse(j.data, null);
        if(!remote) throw new Error("bad json");
        applyRemote(remote, j.meta);
        setSyncMsg("× ×˜×¢×Ÿ ××”×¢× ×Ÿ âœ…");
        setLastSyncNow();
      })
      .catch(function(){
        setSyncMsg("×˜×¢×™× ×” ××”×¢× ×Ÿ × ×›×©×œ×” âŒ");
        renderSyncLastLine();
      });
  }
  window.syncPullNow = syncPullNow;

  function doSyncSend(){
    var payloadStr = JSON.stringify(localPayload());
    var url = SYNC_URL
      + "?token=" + encodeURIComponent(SYNC_TOKEN)
      + "&write=1"
      + "&by=" + encodeURIComponent(DEVICE_NAME)
      + "&data=" + encodeURIComponent(payloadStr);
    return doFetchJSON(url);
  }

  function syncPushNow(){
    setSyncMsg("×©×•×œ×— ×œ×¢× ×Ÿ...");
    doSyncSend()
      .then(function(w){
        if(w && w.ok){
          setLocalMeta(w.meta || getLocalMeta());
          setSyncMsg("× ×©×œ×— ×œ×¢× ×Ÿ âœ…");
          setLastSyncNow();
        } else {
          setSyncMsg("×©×œ×™×—×” × ×›×©×œ×” âŒ");
        }
      })
      .catch(function(){
        setSyncMsg("×©×œ×™×—×” × ×›×©×œ×” âŒ");
      });
  }
  window.syncPushNow = syncPushNow;

  function showLocalNoteIfYanir(){
    var el = document.getElementById("syncLocalNote");
    if(!el) return;
    if(DEVICE_NAME === "Yanir"){
      el.style.display = "block";
      el.textContent = "×”×¢×¨×” (×¨×§ ××¦×œ×š): ×× ×©×™×¨×œ×™ ×œ× ×¨×•××” ×¢×“×›×•× ×™× â€” ×ª×‘×§×© ××× ×” ×œ×œ×—×•×¥ '××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ'.";
    } else {
      el.style.display = "none";
    }
  }

  /* ===== Backup / Restore ===== */
  function backupNow(){
    try{
      var backup = {
        v: 1,
        exportedAt: Date.now(),
        deviceName: DEVICE_NAME,
        meta: getLocalMeta(),
        payload: localPayload()
      };
      var blob = new Blob([JSON.stringify(backup, null, 2)], { type:"application/json" });
      var url = URL.createObjectURL(blob);

      var a = document.createElement("a");
      a.href = url;
      a.download = "coupons-backup-" + (new Date().toISOString().slice(0,10)) + ".json";
      a.rel = "noopener";
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(function(){
        try{ URL.revokeObjectURL(url); }catch(e){}
      }, 1500);

      setSyncMsg("×’×™×‘×•×™ × ×•×¦×¨ âœ…");
    } catch(e){
      alert("×’×™×‘×•×™ × ×›×©×œ");
    }
  }
  window.backupNow = backupNow;

  function triggerRestore(){
    if(!confirm("×˜×¢×™× ×ª ×’×™×‘×•×™ ×ª×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×‘××›×©×™×¨ ×”×–×”. ×œ×”××©×™×š?")) return;
    var inp = document.getElementById("restoreFile");
    if(!inp) return;
    inp.value = "";
    inp.click();
  }
  window.triggerRestore = triggerRestore;

  function restoreFromFile(ev){
    try{
      var f = ev && ev.target && ev.target.files && ev.target.files[0];
      if(!f) return;

      var reader = new FileReader();
      reader.onload = function(){
        try{
          var obj = safeJSONParse(reader.result, null);
          if(!obj || !obj.payload) throw new Error("bad");

          var p = obj.payload || {};
          localStorage.setItem("brands", JSON.stringify(p.brands || []));
          localStorage.setItem("stores", JSON.stringify(p.stores || []));
          localStorage.setItem("categories", JSON.stringify(p.categories || []));
          localStorage.setItem("vouchers", JSON.stringify(p.vouchers || []));
          if(obj.meta) setLocalMeta(obj.meta);

          brands = normalizeBrands(p.brands || []);
          stores = normalizeStores(p.stores || []);
          categories = normalizeCats(p.categories || []);
          vouchers = normalizeVouchers(p.vouchers || []);

          autoArchiveByRules();
          renderAll();

          setSyncMsg("×’×™×‘×•×™ × ×˜×¢×Ÿ âœ…");
        } catch(e){
          alert("×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ");
        }
      };
      reader.readAsText(f);
      ev.target.value = "";
    } catch(e){
      alert("×˜×¢×™× ×ª ×’×™×‘×•×™ × ×›×©×œ×”");
    }
  }
  window.restoreFromFile = restoreFromFile;

  /* ===== App data ===== */
  var DAY = 24*60*60*1000;
  var SOON_MS = 90*DAY; // 3 ×—×•×“×©×™×

  function uid(){ return "v_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }

  function escapeHtml(s){
    s = String(s);
    return s.replace(/[&<>"']/g, function(m){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[m];
    });
  }

  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function isoToMs(d){
    if(!d) return 0;
    return new Date(d + "T00:00:00").getTime();
  }
  function fmtILDate(iso){
    if(!iso) return "â€”";
    var parts = String(iso).split("-");
    if(parts.length !== 3) return iso;
    return parts[2] + "/" + parts[1] + "/" + parts[0];
  }

  function normalizeBrands(raw){
    return (raw || []).map(function(b){
      b = b || {};
      return {
        id: String(b.id || uid()),
        name: String(b.name || "").trim(),
        storeIds: Array.isArray(b.storeIds) ? b.storeIds.map(String) : [],
        disabled: !!b.disabled
      };
    }).filter(function(b){ return b.name; });
  }
  function normalizeStores(raw){
    return (raw || []).map(function(s){
      s = s || {};
      return {
        id: String(s.id || uid()),
        name: String(s.name || "").trim(),
        brandIds: Array.isArray(s.brandIds) ? s.brandIds.map(String) : [],
        catIds: Array.isArray(s.catIds) ? s.catIds.map(String) : [],
        disabled: !!s.disabled
      };
    }).filter(function(s){ return s.name; });
  }
  function normalizeCats(raw){
    return (raw || []).map(function(c){
      c = c || {};
      return { id:String(c.id||uid()), name:String(c.name||"").trim(), disabled:!!c.disabled };
    }).filter(function(c){ return c.name; });
  }
  function normalizeVouchers(raw){
    return (raw || []).map(function(v){
      v = v || {};
      return {
        id: String(v.id || uid()),
        createdAt: Number(v.createdAt || Date.now()),
        updatedAt: Number(v.updatedAt || Date.now()),
        updatedBy: String(v.updatedBy || ""),
        archived: !!v.archived,

        type: String(v.type || "money"),
        physical: !!v.physical,

        brandId: String(v.brandId || ""),
        brandNameAtCreation: String(v.brandNameAtCreation || ""),
        scope: String(v.scope || "all"), // all | stores
        storeIds: Array.isArray(v.storeIds) ? v.storeIds.map(String) : [],
        storeNamesAtCreation: Array.isArray(v.storeNamesAtCreation) ? v.storeNamesAtCreation.map(String) : [],

        total: Number(v.total || 0),
        used: Number(v.used || 0),

        capDesc: String(v.capDesc || ""),
        capTotal: Number(v.capTotal || 0),
        capUsed: Number(v.capUsed || 0),

        desc: String(v.desc || ""),
        expiry: String(v.expiry || ""),
        code: String(v.code || ""),
        notes: String(v.notes || "")
      };
    });
  }

  function saveAll(){
    localStorage.setItem("brands", JSON.stringify(brands));
    localStorage.setItem("stores", JSON.stringify(stores));
    localStorage.setItem("categories", JSON.stringify(categories));
    localStorage.setItem("vouchers", JSON.stringify(vouchers));
  }

  // Defaults (empty first install)
  var brands = normalizeBrands(safeJSONParse(localStorage.getItem("brands") || "[]", []));
  var stores = normalizeStores(safeJSONParse(localStorage.getItem("stores") || "[]", []));
  var categories = normalizeCats(safeJSONParse(localStorage.getItem("categories") || "[]", []));
  var vouchers = normalizeVouchers(safeJSONParse(localStorage.getItem("vouchers") || "[]", []));

  /* ===== Tabs ===== */
  function showTab(key){
    var btns = document.querySelectorAll(".tabbtn");
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
    var views = document.querySelectorAll(".view");
    for(var j=0;j<views.length;j++) views[j].classList.remove("active");

    var idx = 0, viewId = "view-active";
    if(key==="archive"){ idx=1; viewId="view-archive"; }
    else if(key==="manage"){ idx=2; viewId="view-manage"; }
    else if(key==="data"){ idx=3; viewId="view-data"; }

    btns[idx].classList.add("active");
    document.getElementById(viewId).classList.add("active");

    // Refresh current view
    if(key==="active") renderActive();
    if(key==="archive") renderArchive();
    if(key==="manage") renderManage();
    if(key==="data") renderDataTab();
  }
  window.showTab = showTab;

  /* ===== Device name UI (Yanir only) ===== */
  function renderDataTab(){
    renderSyncLastLine();
    showLocalNoteIfYanir();

    var deviceCard = document.getElementById("deviceCard");
    if(deviceCard){
      if(DEVICE_NAME === "Yanir"){
        deviceCard.style.display = "block";
        document.getElementById("deviceNameSelect").value = DEVICE_NAME;
      } else {
        deviceCard.style.display = "none";
      }
    }
  }
  function setDeviceNameFromUI(){
    var sel = document.getElementById("deviceNameSelect");
    if(!sel) return;
    DEVICE_NAME = sel.value;
    localStorage.setItem("deviceNameCoupons", DEVICE_NAME);
    showLocalNoteIfYanir();
  }
  window.setDeviceNameFromUI = setDeviceNameFromUI;

  /* ===== Helpers: find entities ===== */
  function findBrandById(id){ return brands.find(function(b){return b.id===id;}) || null; }
  function findStoreById(id){ return stores.find(function(s){return s.id===id;}) || null; }
  function findCatById(id){ return categories.find(function(c){return c.id===id;}) || null; }

  function brandNameForVoucher(v){
    var b = findBrandById(v.brandId);
    return (b && b.name) ? b.name : (v.brandNameAtCreation || "");
  }
  function storeNamesForVoucher(v){
    var names = [];
    if(v.storeIds && v.storeIds.length){
      v.storeIds.forEach(function(id){
        var s = findStoreById(id);
        names.push((s && s.name) ? s.name : "");
      });
      names = names.filter(Boolean);
      if(names.length) return names;
    }
    return (v.storeNamesAtCreation || []).filter(Boolean);
  }

  function getBalance(v){
    if(v.type==="money"){
      var tot = Number(v.total||0);
      var used = Number(v.used||0);
      return Math.max(0, round2(tot - used));
    }
    if(v.type==="cap"){
      var ct = Number(v.capTotal||0);
      var cu = Number(v.capUsed||0);
      return Math.max(0, round2(ct - cu));
    }
    // others: no balance
    return null;
  }
  function round2(x){
    x = Number(x||0);
    return Math.round(x*100)/100;
  }
  function isExpired(v){
    if(!v.expiry) return false;
    var ms = isoToMs(v.expiry);
    if(!ms) return false;
    return ms < isoToMs(todayISO());
  }
  function isSoon(v){
    if(!v.expiry) return false;
    var ms = isoToMs(v.expiry);
    if(!ms) return false;
    var now = isoToMs(todayISO());
    return (ms - now) <= SOON_MS && (ms - now) >= 0;
  }

  function voucherStatusClass(v){
    // Priority: expired -> red? you asked: red for <3 months, but expired/mused should be gray.
    // Rule we set: red overrides everything except "archived by reason used/expired"? Actually you approved red overrides all and gray for archived/expired.
    // We'll implement:
    // - If expired OR archived -> gray
    // - Else if soon -> red
    // - Else if monetary/cap:
    //    - if balance==total => green (unused)
    //    - if balance<total && balance>0 => yellow
    //    - if balance==0 => gray (auto-archive will move)
    // - Else:
    //    - green (available)
    if(v.archived || isExpired(v)) return "st-gray";
    if(isSoon(v)) return "st-red";

    if(v.type==="money"){
      var tot = Number(v.total||0);
      var bal = getBalance(v);
      if(tot>0 && bal===tot) return "st-green";
      if(tot>0 && bal>0 && bal<tot) return "st-yellow";
      return "st-green";
    }
    if(v.type==="cap"){
      var ct = Number(v.capTotal||0);
      var cb = getBalance(v);
      if(ct>0 && cb===ct) return "st-green";
      if(ct>0 && cb>0 && cb<ct) return "st-yellow";
      return "st-green";
    }
    // percent/bogo/general
    return "st-green";
  }

  function voucherStatusIcon(v){
    // Simple ticket icon
    return "ğŸŸï¸";
  }

  function autoArchiveByRules(){
    var changed = false;
    vouchers.forEach(function(v){
      // auto archive if expiry passed OR balance 0 (money/cap)
      if(!v.archived){
        if(isExpired(v)){
          v.archived = true;
          changed = true;
        } else if(v.type==="money"){
          var bal = getBalance(v);
          if(bal !== null && bal <= 0 && Number(v.total||0)>0){
            v.archived = true;
            changed = true;
          }
        } else if(v.type==="cap"){
          var bal2 = getBalance(v);
          if(bal2 !== null && bal2 <= 0 && Number(v.capTotal||0)>0){
            v.archived = true;
            changed = true;
          }
        }
      }
    });
    if(changed){
      saveAll();
    }
  }

  /* ===== Filters / Sorting state ===== */
  var filters = {
    active: { state:"all", brandId:"", storeId:"", catId:"", sort:"smart" },
    archive:{ state:"all", brandId:"", storeId:"", catId:"", sort:"date" }
  };

  function clearSearch(which){
    if(which==="active") document.getElementById("searchInputActive").value = "";
    else document.getElementById("searchInputArchive").value = "";
    if(which==="active") renderActive();
    else renderArchive();
  }
  window.clearSearch = clearSearch;

  function buildChips(hostId, items, activeValue, onPick){
    var host = document.getElementById(hostId);
    if(!host) return;
    host.innerHTML = "";
    items.forEach(function(it){
      var d = document.createElement("div");
      d.className = "chip" + (String(it.value)===String(activeValue) ? " active" : "");
      d.textContent = it.label;
      d.onclick = function(){ onPick(it.value); };
      host.appendChild(d);
    });
  }

  function getAllBrandOptions(includeAll){
    var arr = brands.filter(function(b){return !b.disabled;})
      .slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); })
      .map(function(b){ return { value:b.id, label:b.name }; });
    if(includeAll) arr.unshift({value:"", label:"×”×›×œ"});
    return arr;
  }
  function getAllStoreOptions(includeAll){
    var arr = stores.filter(function(s){return !s.disabled;})
      .slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); })
      .map(function(s){ return { value:s.id, label:s.name }; });
    if(includeAll) arr.unshift({value:"", label:"×”×›×œ"});
    return arr;
  }
  function getAllCatOptions(includeAll){
    var arr = categories.filter(function(c){return !c.disabled;})
      .slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); })
      .map(function(c){ return { value:c.id, label:c.name }; });
    if(includeAll) arr.unshift({value:"", label:"×”×›×œ"});
    return arr;
  }

  function initFilterChips(){
    // State chips (separate row with "×”×›×œ" and "×§×¨×•×‘ ×œ×¤×§×™×¢×”")
    var stateItems = [
      {value:"all", label:"×”×›×œ"},
      {value:"soon", label:"×§×¨×•×‘ ×œ×¤×§×™×¢×” (3 ×—×•×“×©×™×)"}
    ];

    buildChips("chipsStateActive", stateItems, filters.active.state, function(v){ filters.active.state=v; renderActive(); });
    buildChips("chipsBrandsActive", getAllBrandOptions(true), filters.active.brandId, function(v){ filters.active.brandId=v; renderActive(); });
    buildChips("chipsStoresActive", getAllStoreOptions(true), filters.active.storeId, function(v){ filters.active.storeId=v; renderActive(); });
    buildChips("chipsCatsActive", getAllCatOptions(true), filters.active.catId, function(v){ filters.active.catId=v; renderActive(); });

    var sortItemsActive = [
      {value:"smart", label:"×—×›× (×‘×¨×™×¨×ª ××—×“×œ)"},
      {value:"expiry", label:"×ª×•×§×£"},
      {value:"amount", label:"×™×ª×¨×” (×’×‘×•×”â†’× ××•×š)"},
      {value:"az", label:"×-×‘"}
    ];
    buildChips("chipsSortActive", sortItemsActive, filters.active.sort, function(v){ filters.active.sort=v; renderActive(); });

    buildChips("chipsStateArchive", stateItems, filters.archive.state, function(v){ filters.archive.state=v; renderArchive(); });
    buildChips("chipsBrandsArchive", getAllBrandOptions(true), filters.archive.brandId, function(v){ filters.archive.brandId=v; renderArchive(); });
    buildChips("chipsStoresArchive", getAllStoreOptions(true), filters.archive.storeId, function(v){ filters.archive.storeId=v; renderArchive(); });
    buildChips("chipsCatsArchive", getAllCatOptions(true), filters.archive.catId, function(v){ filters.archive.catId=v; renderArchive(); });

    var sortItemsArchive = [
      {value:"date", label:"×ª××¨×™×š ×¢×“×›×•×Ÿ"},
      {value:"expiry", label:"×ª×•×§×£"},
      {value:"az", label:"×-×‘"}
    ];
    buildChips("chipsSortArchive", sortItemsArchive, filters.archive.sort, function(v){ filters.archive.sort=v; renderArchive(); });
  }

  /* ===== Render Active / Archive ===== */
  function matchesSearch(v, q){
    q = (q||"").trim().toLowerCase();
    if(!q) return true;
    var bn = brandNameForVoucher(v).toLowerCase();
    var storesN = storeNamesForVoucher(v).join(" ").toLowerCase();
    var notes = String(v.notes||"").toLowerCase();
    var code = String(v.code||"").toLowerCase();
    var desc = String(v.desc||"").toLowerCase();
    var capDesc = String(v.capDesc||"").toLowerCase();
    return (bn.indexOf(q)>=0) || (storesN.indexOf(q)>=0) || (notes.indexOf(q)>=0) || (code.indexOf(q)>=0) || (desc.indexOf(q)>=0) || (capDesc.indexOf(q)>=0);
  }

  function voucherHasStore(v, storeId){
    if(!storeId) return true;
    return (v.storeIds||[]).indexOf(storeId)>=0;
  }
  function voucherHasBrand(v, brandId){
    if(!brandId) return true;
    return String(v.brandId||"") === String(brandId);
  }

  function voucherHasCategory(v, catId){
    if(!catId) return true;
    var storeIds = v.storeIds || [];
    // If voucher scope is all and stores empty, we try brand's primary stores too
    var effectiveStores = storeIds.slice();
    if((v.scope==="all" || !effectiveStores.length) && v.brandId){
      var b = findBrandById(v.brandId);
      if(b && b.storeIds && b.storeIds.length){
        b.storeIds.forEach(function(id){ if(effectiveStores.indexOf(id)<0) effectiveStores.push(id); });
      }
    }
    for(var i=0;i<effectiveStores.length;i++){
      var s = findStoreById(effectiveStores[i]);
      if(s && (s.catIds||[]).indexOf(catId)>=0) return true;
    }
    return false;
  }

  function getBrandUsageCounts(activeOnly){
    var counts = {};
    vouchers.forEach(function(v){
      if(activeOnly && v.archived) return;
      var bid = String(v.brandId||"");
      if(!bid) return;
      counts[bid] = (counts[bid]||0) + 1;
    });
    return counts;
  }

  function smartSort(arr){
    // Priority: soon first (but not expired/archived), then brand frequency desc, then balance desc, then alphabet
    var brandCounts = getBrandUsageCounts(true);

    arr.sort(function(a,b){
      var aSoon = (!a.archived && isSoon(a) && !isExpired(a)) ? 1 : 0;
      var bSoon = (!b.archived && isSoon(b) && !isExpired(b)) ? 1 : 0;
      if(bSoon !== aSoon) return bSoon - aSoon;

      var ac = brandCounts[String(a.brandId||"")] || 0;
      var bc = brandCounts[String(b.brandId||"")] || 0;
      if(bc !== ac) return bc - ac;

      var ab = getBalance(a); var bb = getBalance(b);
      ab = (ab==null ? -1 : ab); bb = (bb==null ? -1 : bb);
      if(bb !== ab) return bb - ab;

      var an = brandNameForVoucher(a) || "";
      var bn = brandNameForVoucher(b) || "";
      return an.localeCompare(bn,"he");
    });
  }

  function sortByExpiry(arr){
    arr.sort(function(a,b){
      var ae = isoToMs(a.expiry||"") || 9999999999999;
      var be = isoToMs(b.expiry||"") || 9999999999999;
      if(ae!==be) return ae - be;
      return (brandNameForVoucher(a)||"").localeCompare(brandNameForVoucher(b)||"","he");
    });
  }

  function sortByAmount(arr){
    arr.sort(function(a,b){
      var ab = getBalance(a); var bb = getBalance(b);
      ab = (ab==null ? -1 : ab); bb = (bb==null ? -1 : bb);
      if(bb!==ab) return bb - ab;
      return (brandNameForVoucher(a)||"").localeCompare(brandNameForVoucher(b)||"","he");
    });
  }

  function sortAZ(arr){
    arr.sort(function(a,b){
      return (brandNameForVoucher(a)||"").localeCompare(brandNameForVoucher(b)||"","he");
    });
  }

  function sortArchive(arr){
    if(filters.archive.sort==="expiry") return sortByExpiry(arr);
    if(filters.archive.sort==="az") return sortAZ(arr);
    // date (updatedAt desc)
    arr.sort(function(a,b){ return (b.updatedAt||0)-(a.updatedAt||0); });
  }

  function buildVoucherSubtitle(v){
    var bn = brandNameForVoucher(v);
    var sNames = storeNamesForVoucher(v);

    if(v.scope==="all"){
      // show main stores if exist
      var b = findBrandById(v.brandId);
      var mains = [];
      if(b && b.storeIds && b.storeIds.length){
        b.storeIds.forEach(function(id){
          var s = findStoreById(id);
          if(s && s.name) mains.push(s.name);
        });
      }
      if(!mains.length && sNames.length) mains = sNames.slice();

      if(!mains.length){
        return "×›×œ ×”×¨×©×ª";
      }
      var shown = mains.slice(0,2);
      var rest = mains.length - shown.length;
      return "×›×œ ×”×¨×©×ª Â· " + shown.join(" Â· ") + (rest>0 ? ("  +" + rest) : "");
    } else {
      if(!sNames.length){
        return "×—× ×•×™×•×ª: â€”";
      }
      var shown2 = sNames.slice(0,2);
      var rest2 = sNames.length - shown2.length;
      return shown2.join(" Â· ") + (rest2>0 ? ("  +" + rest2) : "");
    }
  }

  function buildVoucherMetaPills(v){
    var pills = [];
    // type
    var typeLabel = {
      money:"×›×¡×¤×™",
      cap:"×ª×§×¨×”",
      percent:"××—×•×–×™×",
      bogo:"1+1",
      general:"×›×œ×œ×™"
    }[v.type] || "×›×œ×œ×™";
    pills.push(typeLabel);

    // expiry
    if(v.expiry){
      pills.push("×ª×•×§×£: " + fmtILDate(v.expiry));
    }

    // amounts
    var bal = getBalance(v);
    if(v.type==="money"){
      pills.push("×™×ª×¨×”: â‚ª" + (bal==null ? "â€”" : bal));
    }
    if(v.type==="cap"){
      pills.push("× ×•×ª×¨ ××”×ª×§×¨×”: â‚ª" + (bal==null ? "â€”" : bal));
    }

    // physical
    if(v.physical){
      pills.push("×›×¨×˜×™×¡ ×¤×™×–×™");
    }

    return pills;
  }

  function renderVoucherCard(v, host){
    var bn = brandNameForVoucher(v);
    var subtitle = buildVoucherSubtitle(v);

    var card = document.createElement("div");
    card.className = "vcard";

    var top = document.createElement("div");
    top.className = "vtop";

    var titleWrap = document.createElement("div");
    titleWrap.style.minWidth = "0";
    titleWrap.style.flex = "1";

    var title = document.createElement("div");
    title.className = "vtitle";
    title.innerHTML = '<span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">'+escapeHtml(bn || "(×œ×œ× ××•×ª×’)")+'</span>';

    var sub = document.createElement("div");
    sub.className = "vsubtitle";
    sub.textContent = subtitle;

    titleWrap.appendChild(title);
    titleWrap.appendChild(sub);

    var left = document.createElement("div");
    left.className = "leftActions";

    var st = document.createElement("div");
    st.className = "statusIcon " + voucherStatusClass(v);
    st.title = "×¡×˜×˜×•×¡";
    st.textContent = voucherStatusIcon(v);

    var open = document.createElement("button");
    open.className = "openBtn";
    open.type = "button";
    open.textContent = "×¤×ª×—";
    open.onclick = function(){ openVoucherView(v.id); };

    left.appendChild(st);
    left.appendChild(open);

    top.appendChild(titleWrap);
    top.appendChild(left);

    var meta = document.createElement("div");
    meta.className = "vmeta";
    buildVoucherMetaPills(v).forEach(function(p){
      var pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = p;
      meta.appendChild(pill);
    });

    card.appendChild(top);
    card.appendChild(meta);

    host.appendChild(card);
  }

  function filterVoucherList(mode){
    autoArchiveByRules();

    var f = filters[mode];
    var q = (mode==="active")
      ? (document.getElementById("searchInputActive").value || "")
      : (document.getElementById("searchInputArchive").value || "");

    var list = vouchers.slice().filter(function(v){
      if(mode==="active" && v.archived) return false;
      if(mode==="archive" && !v.archived) return false;

      if(f.state==="soon"){
        if(!(isSoon(v) && !isExpired(v) && !v.archived)) return false;
      }

      if(f.brandId && !voucherHasBrand(v, f.brandId)) return false;
      if(f.storeId && !voucherHasStore(v, f.storeId)) return false;
      if(f.catId && !voucherHasCategory(v, f.catId)) return false;

      if(!matchesSearch(v, q)) return false;
      return true;
    });

    // Sorting
    if(mode==="active"){
      if(f.sort==="smart") smartSort(list);
      else if(f.sort==="expiry") sortByExpiry(list);
      else if(f.sort==="amount") sortByAmount(list);
      else if(f.sort==="az") sortAZ(list);
      else smartSort(list);
    } else {
      sortArchive(list);
    }

    return list;
  }

  function renderActive(){
    initFilterChips();
    var host = document.getElementById("activeList");
    host.innerHTML = "";
    var list = filterVoucherList("active");
    document.getElementById("activeCount").textContent = String(list.length);
    document.getElementById("activeEmpty").style.display = list.length ? "none" : "block";
    list.forEach(function(v){ renderVoucherCard(v, host); });
  }
  window.renderActive = renderActive;

  function renderArchive(){
    initFilterChips();
    var host = document.getElementById("archiveList");
    host.innerHTML = "";
    var list = filterVoucherList("archive");
    document.getElementById("archiveCount").textContent = String(list.length);
    document.getElementById("archiveEmpty").style.display = list.length ? "none" : "block";
    list.forEach(function(v){ renderVoucherCard(v, host); });
  }
  window.renderArchive = renderArchive;

  /* ===== Voucher modal logic ===== */
  var voucherEditingId = null;

  function openVoucherCreate(){
    voucherEditingId = null;
    document.getElementById("voucherModalTitle").textContent = "×™×¦×™×¨×ª ×©×•×‘×¨ ×—×“×©";
    document.getElementById("deleteVoucherBtn").style.display = "none";
    document.getElementById("archiveVoucherBtn").style.display = "none";
    document.getElementById("restoreVoucherBtn").style.display = "none";

    fillBrandSelect();
    fillStoresSelect();

    // Defaults: type money, physical no, scope all
    document.getElementById("vType").value = "money";
    document.getElementById("vPhysical").value = "0";
    document.getElementById("vScope").value = "all";

    document.getElementById("vBrand").value = brands.filter(function(b){return !b.disabled;})[0]?.id || "";
    clearStoresSelection();

    document.getElementById("vTotal").value = "";
    document.getElementById("vUsed").value = "";
    document.getElementById("vBalance").value = "";

    document.getElementById("vCapDesc").value = "";
    document.getElementById("vCapTotal").value = "";
    document.getElementById("vCapUsed").value = "";
    document.getElementById("vCapBalance").value = "";

    document.getElementById("vDesc").value = "";

    document.getElementById("vExpiry").value = "";
    document.getElementById("vCode").value = "";
    document.getElementById("vNotes").value = "";
    document.getElementById("pasteWarn").style.display = "none";

    renderVoucherFields();

    document.getElementById("voucherBackdrop").style.display = "flex";
  }
  window.openVoucherCreate = openVoucherCreate;

  function openVoucherView(id){
    var v = vouchers.find(function(x){return x.id===id;});
    if(!v) return;
    voucherEditingId = id;

    document.getElementById("voucherModalTitle").textContent = v.archived ? "×©×•×‘×¨ (××¨×›×™×•×Ÿ)" : "×©×•×‘×¨";
    document.getElementById("deleteVoucherBtn").style.display = "inline-flex";
    document.getElementById("archiveVoucherBtn").style.display = v.archived ? "none" : "inline-flex";
    document.getElementById("restoreVoucherBtn").style.display = v.archived ? "inline-flex" : "none";

    fillBrandSelect();
    fillStoresSelect();

    document.getElementById("vType").value = v.type || "money";
    document.getElementById("vPhysical").value = v.physical ? "1" : "0";
    document.getElementById("vScope").value = v.scope || "all";

    document.getElementById("vBrand").value = v.brandId || "";

    // Select stores
    clearStoresSelection();
    var ms = document.getElementById("vStores");
    var set = {};
    (v.storeIds||[]).forEach(function(x){ set[x]=true; });
    for(var i=0;i<ms.options.length;i++){
      var opt = ms.options[i];
      opt.selected = !!set[opt.value];
    }

    document.getElementById("vTotal").value = (v.total||0) ? String(v.total) : "";
    document.getElementById("vUsed").value = (v.used||0) ? String(v.used) : "";
    document.getElementById("vBalance").value = String(getBalance(v) ?? "");

    document.getElementById("vCapDesc").value = v.capDesc || "";
    document.getElementById("vCapTotal").value = (v.capTotal||0) ? String(v.capTotal) : "";
    document.getElementById("vCapUsed").value = (v.capUsed||0) ? String(v.capUsed) : "";
    document.getElementById("vCapBalance").value = String(getBalance(v) ?? "");

    document.getElementById("vDesc").value = v.desc || "";

    document.getElementById("vExpiry").value = v.expiry || "";
    document.getElementById("vCode").value = v.code || "";
    document.getElementById("vNotes").value = v.notes || "";
    document.getElementById("pasteWarn").style.display = "none";

    renderVoucherFields();
    document.getElementById("voucherBackdrop").style.display = "flex";
  }
  window.openVoucherView = openVoucherView;

  function hideVoucherModal(){
    document.getElementById("voucherBackdrop").style.display = "none";
    voucherEditingId = null;
  }
  window.hideVoucherModal = hideVoucherModal;

  function closeVoucherModal(e){
    if(e.target === document.getElementById("voucherBackdrop")) hideVoucherModal();
  }
  window.closeVoucherModal = closeVoucherModal;

  function fillBrandSelect(){
    var sel = document.getElementById("vBrand");
    sel.innerHTML = "";
    var act = brands.filter(function(b){return !b.disabled;}).slice().sort(function(a,b){return a.name.localeCompare(b.name,"he");});
    act.forEach(function(b){
      var o = document.createElement("option");
      o.value = b.id;
      o.textContent = b.name;
      sel.appendChild(o);
    });
    if(!act.length){
      var o2 = document.createElement("option");
      o2.value = "";
      o2.textContent = "â€” ××™×Ÿ ××•×ª×’×™× â€”";
      sel.appendChild(o2);
    }
  }

  function fillStoresSelect(){
    var sel = document.getElementById("vStores");
    sel.innerHTML = "";
    var act = stores.filter(function(s){return !s.disabled;}).slice().sort(function(a,b){return a.name.localeCompare(b.name,"he");});
    act.forEach(function(s){
      var o = document.createElement("option");
      o.value = s.id;
      o.textContent = s.name;
      sel.appendChild(o);
    });
  }

  function getSelectedValues(selectEl){
    var out = [];
    for(var i=0;i<selectEl.options.length;i++){
      if(selectEl.options[i].selected) out.push(selectEl.options[i].value);
    }
    return out;
  }

  function clearStoresSelection(){
    var ms = document.getElementById("vStores");
    if(!ms) return;
    for(var i=0;i<ms.options.length;i++) ms.options[i].selected = false;
  }
  window.clearStoresSelection = clearStoresSelection;

  function selectStoresOfBrand(){
    var brandId = document.getElementById("vBrand").value;
    if(!brandId) return;
    var b = findBrandById(brandId);
    if(!b) return;
    var set = {};
    (b.storeIds||[]).forEach(function(x){ set[x]=true; });
    var ms = document.getElementById("vStores");
    for(var i=0;i<ms.options.length;i++){
      var opt = ms.options[i];
      opt.selected = !!set[opt.value];
    }
  }
  window.selectStoresOfBrand = selectStoresOfBrand;

  function recalcBalance(){
    var type = document.getElementById("vType").value;
    if(type==="money"){
      var total = Number(document.getElementById("vTotal").value || 0);
      var used = Number(document.getElementById("vUsed").value || 0);
      document.getElementById("vBalance").value = String(Math.max(0, round2(total - used)));
    }
    if(type==="cap"){
      var ct = Number(document.getElementById("vCapTotal").value || 0);
      var cu = Number(document.getElementById("vCapUsed").value || 0);
      document.getElementById("vCapBalance").value = String(Math.max(0, round2(ct - cu)));
    }
  }
  window.recalcBalance = recalcBalance;

  function renderVoucherFields(){
    var type = document.getElementById("vType").value;
    var scope = document.getElementById("vScope").value;
    var physical = document.getElementById("vPhysical").value === "1";

    // Blocks
    document.getElementById("moneyBlock").style.display = (type==="money") ? "grid" : "none";
    document.getElementById("capBlock").style.display = (type==="cap") ? "grid" : "none";
    document.getElementById("simpleDescBlock").style.display = (type==="percent" || type==="bogo" || type==="general") ? "block" : "none";

    // stores selection visible always, but guidance differs
    document.getElementById("storesField").style.display = "block";
    if(scope==="all"){
      // selection optional
    }

    // code block hidden for physical cards
    document.getElementById("codeBlock").style.display = physical ? "none" : "block";

    // expiry hint / soon
    var expiry = document.getElementById("vExpiry").value;
    var hint = document.getElementById("expiryHint");
    if(!expiry){
      hint.textContent = "×× ××™×Ÿ ×ª×•×§×£ â€” ××¤×©×¨ ×œ×”×©××™×¨ ×¨×™×§.";
    } else {
      var ms = isoToMs(expiry);
      var now = isoToMs(todayISO());
      if(ms < now){
        hint.textContent = "×©×™××• ×œ×‘: ×ª×•×§×£ ×›×‘×¨ ×¤×’ â€” ×”×©×•×‘×¨ ×™×¢×‘×•×¨ ××•×˜×•××˜×™×ª ×œ××¨×›×™×•×Ÿ.";
      } else if(ms - now <= SOON_MS){
        hint.textContent = "×§×¨×•×‘ ×œ×¤×§×™×¢×” (×¤×—×•×ª ×-3 ×—×•×“×©×™×) â€” ×™×§×¤×•×¥ ×œ××¢×œ×” ×•×™×¡×•××Ÿ ×‘××“×•×.";
      } else {
        hint.textContent = "";
      }
    }

    recalcBalance();
  }
  window.renderVoucherFields = renderVoucherFields;

  function quickAddBrand(){
    var name = (prompt("×©× ××•×ª×’ ×—×“×©:") || "").trim();
    if(!name) return;
    // existing active?
    var ex = brands.find(function(b){ return b.name.toLowerCase() === name.toLowerCase(); });
    if(ex){
      if(ex.disabled){
        if(confirm("×”××•×ª×’ ×§×™×™× ××š ××•×©×‘×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?")){
          ex.disabled = false;
          saveAll();
          fillBrandSelect();
          document.getElementById("vBrand").value = ex.id;
          renderManage();
          renderActive();
          renderArchive();
        }
      } else {
        alert("×”××•×ª×’ ×›×‘×¨ ×§×™×™×");
      }
      return;
    }
    var b = { id:uid(), name:name, storeIds:[], disabled:false };
    brands.push(b);
    saveAll();
    fillBrandSelect();
    document.getElementById("vBrand").value = b.id;
    renderManage();
    initFilterChips();
  }
  window.quickAddBrand = quickAddBrand;

  function quickAddStore(){
    var name = (prompt("×©× ×—× ×•×ª ×—×“×©×”:") || "").trim();
    if(!name) return;
    var ex = stores.find(function(s){ return s.name.toLowerCase() === name.toLowerCase(); });
    if(ex){
      if(ex.disabled){
        if(confirm("×”×—× ×•×ª ×§×™×™××ª ××š ××•×©×‘×ª×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ×”?")){
          ex.disabled = false;
          saveAll();
          fillStoresSelect();
          renderManage();
        }
      } else {
        alert("×”×—× ×•×ª ×›×‘×¨ ×§×™×™××ª");
      }
      return;
    }
    var s = { id:uid(), name:name, brandIds:[], catIds:[], disabled:false };
    stores.push(s);
    saveAll();
    fillStoresSelect();

    // select it in voucher
    var ms = document.getElementById("vStores");
    for(var i=0;i<ms.options.length;i++){
      if(ms.options[i].value === s.id) ms.options[i].selected = true;
    }

    renderManage();
    initFilterChips();
  }
  window.quickAddStore = quickAddStore;

  function pasteInto(id){
    document.getElementById("pasteWarn").style.display = "none";
    try{
      if(!navigator.clipboard || !navigator.clipboard.readText){
        document.getElementById("pasteWarn").style.display="block"; return;
      }
      navigator.clipboard.readText().then(function(txt){
        if(txt) document.getElementById(id).value = txt;
        recalcBalance();
      }).catch(function(){
        document.getElementById("pasteWarn").style.display="block";
      });
    } catch(e){
      document.getElementById("pasteWarn").style.display="block";
    }
  }
  window.pasteInto = pasteInto;

  function validateVoucherDraft(draft){
    // ×—×•×‘×”: ××•×ª×’ ××• ×—× ×•×ª ××—×ª ×œ×¤×—×•×ª
    var hasBrand = !!draft.brandId;
    var hasStore = (draft.storeIds && draft.storeIds.length>0);
    if(!hasBrand && !hasStore){
      return "×—×•×‘×” ×œ×‘×—×•×¨ ××•×ª×’ ××• ×œ×¤×—×•×ª ×—× ×•×ª ××—×ª.";
    }

    // type validations
    if(draft.type==="money"){
      if(!(draft.total>0)) return "×‘×©×•×‘×¨ ×›×¡×¤×™ ×—×•×‘×” ×œ××œ× ×¡×›×•× ×©×•×‘×¨ ×’×“×•×œ ×-0.";
      if(draft.used < 0) return "× ×•×¦×œ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×©×œ×™×œ×™.";
      if(draft.used > draft.total) return "× ×•×¦×œ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×’×“×•×œ ××¡×›×•× ×”×©×•×‘×¨.";
    }
    if(draft.type==="cap"){
      if(!(draft.capTotal>0)) return "×‘×©×•×‘×¨ ×ª×§×¨×” ×—×•×‘×” ×œ××œ× ×ª×§×¨×” ×’×“×•×œ×” ×-0.";
      if(draft.capUsed < 0) return "× ×•×¦×œ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×©×œ×™×œ×™.";
      if(draft.capUsed > draft.capTotal) return "× ×•×¦×œ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×’×“×•×œ ××”×ª×§×¨×”.";
      if(!draft.capDesc.trim()) return "×‘×©×•×‘×¨ ×ª×§×¨×” ××•××œ×¥ ×œ××œ× ×ª×™××•×¨ (×œ×“×•×’××”: 20% ×¢×“ 200â‚ª).";
    }

    return "";
  }

  function saveVoucher(){
    var draft = {
      type: document.getElementById("vType").value,
      physical: document.getElementById("vPhysical").value === "1",
      brandId: document.getElementById("vBrand").value,
      scope: document.getElementById("vScope").value,
      storeIds: getSelectedValues(document.getElementById("vStores")),
      total: Number(document.getElementById("vTotal").value || 0),
      used: Number(document.getElementById("vUsed").value || 0),

      capDesc: String(document.getElementById("vCapDesc").value || ""),
      capTotal: Number(document.getElementById("vCapTotal").value || 0),
      capUsed: Number(document.getElementById("vCapUsed").value || 0),

      desc: String(document.getElementById("vDesc").value || ""),
      expiry: String(document.getElementById("vExpiry").value || ""),
      code: String(document.getElementById("vCode").value || ""),
      notes: String(document.getElementById("vNotes").value || "")
    };

    // If scope is all and no stores selected, allow empty (and show brand main stores later)
    // If scope is stores, allow empty too (user may not have list yet) but it will show "×—× ×•×™×•×ª: â€”" if none.
    // still ok.

    var err = validateVoucherDraft(draft);
    if(err){
      alert(err);
      return;
    }

    var brand = findBrandById(draft.brandId);
    var brandNameAtCreation = brand ? brand.name : "";
    var storeNamesAtCreation = draft.storeIds.map(function(id){
      var s = findStoreById(id);
      return s ? s.name : "";
    }).filter(Boolean);

    var now = Date.now();

    if(voucherEditingId){
      vouchers = vouchers.map(function(v){
        if(v.id !== voucherEditingId) return v;

        v.type = draft.type;
        v.physical = draft.physical;

        v.brandId = draft.brandId;
        v.brandNameAtCreation = v.brandNameAtCreation || brandNameAtCreation; // preserve old name snapshot if existed
        if(brandNameAtCreation) v.brandNameAtCreation = brandNameAtCreation;

        v.scope = draft.scope;
        v.storeIds = draft.storeIds;
        v.storeNamesAtCreation = storeNamesAtCreation.length ? storeNamesAtCreation : v.storeNamesAtCreation;

        v.total = draft.total;
        v.used = draft.used;

        v.capDesc = draft.capDesc;
        v.capTotal = draft.capTotal;
        v.capUsed = draft.capUsed;

        v.desc = draft.desc;
        v.expiry = draft.expiry;
        v.code = draft.code;
        v.notes = draft.notes;

        v.updatedAt = now;
        v.updatedBy = DEVICE_NAME;

        // auto archive check
        return v;
      });
    } else {
      var vNew = {
        id: uid(),
        createdAt: now,
        updatedAt: now,
        updatedBy: DEVICE_NAME,
        archived: false,

        type: draft.type,
        physical: draft.physical,

        brandId: draft.brandId,
        brandNameAtCreation: brandNameAtCreation,

        scope: draft.scope,
        storeIds: draft.storeIds,
        storeNamesAtCreation: storeNamesAtCreation,

        total: draft.total,
        used: draft.used,

        capDesc: draft.capDesc,
        capTotal: draft.capTotal,
        capUsed: draft.capUsed,

        desc: draft.desc,
        expiry: draft.expiry,
        code: draft.code,
        notes: draft.notes
      };
      vouchers.push(vNew);
    }

    autoArchiveByRules();
    saveAll();
    renderAll();
    hideVoucherModal();
  }
  window.saveVoucher = saveVoucher;

  function deleteVoucher(){
    if(!voucherEditingId) return;
    if(!confirm("×œ××—×•×§ ××ª ×”×©×•×‘×¨ ×œ×¦××™×ª×•×ª?")) return;
    vouchers = vouchers.filter(function(v){ return v.id !== voucherEditingId; });
    saveAll();
    renderAll();
    hideVoucherModal();
  }
  window.deleteVoucher = deleteVoucher;

  function moveVoucherToArchive(){
    if(!voucherEditingId) return;
    vouchers.forEach(function(v){
      if(v.id===voucherEditingId){
        v.archived = true;
        v.updatedAt = Date.now();
        v.updatedBy = DEVICE_NAME;
      }
    });
    saveAll();
    renderAll();
    hideVoucherModal();
  }
  window.moveVoucherToArchive = moveVoucherToArchive;

  function restoreVoucherFromArchive(){
    if(!voucherEditingId) return;
    vouchers.forEach(function(v){
      if(v.id===voucherEditingId){
        if(isExpired(v)){
          alert("×ª×•×§×£ ×›×‘×¨ ×¤×’. ×œ× × ×™×ª×Ÿ ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ.");
          return;
        }
        v.archived = false;
        v.updatedAt = Date.now();
        v.updatedBy = DEVICE_NAME;
      }
    });
    saveAll();
    renderAll();
    hideVoucherModal();
  }
  window.restoreVoucherFromArchive = restoreVoucherFromArchive;

  /* ===== Manage: brands/stores/categories lists ===== */
  function renderManage(){
    // Brands list
    var hostB = document.getElementById("brandsList");
    hostB.innerHTML = "";
    brands.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(b){
      var row = document.createElement("div");
      row.className = "kv";
      var label = b.name + (b.disabled ? " (××•×©×‘×ª)" : "");
      row.innerHTML =
        "<b>"+escapeHtml(label)+"</b>" +
        '<span style="display:flex; gap:8px; align-items:center; justify-content:flex-start;">' +
          '<button class="iconbtn" type="button" title="×¤×ª×—">â®•</button>' +
          '<button class="iconbtn" type="button" title="×¢×¨×•×š ×©×">âœï¸</button>' +
          (b.disabled
            ? '<button class="iconbtn" type="button" title="×”×—×–×¨ ×œ×¤×¢×™×œ">âœ…</button>'
            : '<button class="iconbtn" type="button" title="×”×©×‘×ª">â›”</button>') +
        "</span>";

      var btns = row.querySelectorAll("button");
      btns[0].onclick = function(){ openBrandModal(b.id); };
      btns[1].onclick = function(){ quickRenameBrand(b.id); };
      btns[2].onclick = function(){
        if(b.disabled){
          if(confirm("×œ×”×—×–×™×¨ ××ª ×”××•×ª×’ ×œ×¤×¢×™×œ?")){
            b.disabled = false;
            saveAll();
            renderAll();
          }
        } else {
          if(confirm("×œ×”×©×‘×™×ª ××ª ×”××•×ª×’? (×œ× × ××—×§ ×”×™×¡×˜×•×¨×™×”)")){
            b.disabled = true;
            saveAll();
            renderAll();
          }
        }
      };

      hostB.appendChild(row);
    });

    // Stores list
    var hostS = document.getElementById("storesList");
    hostS.innerHTML = "";
    stores.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(s){
      var row2 = document.createElement("div");
      row2.className = "kv";
      var label2 = s.name + (s.disabled ? " (××•×©×‘×ª)" : "");
      row2.innerHTML =
        "<b>"+escapeHtml(label2)+"</b>" +
        '<span style="display:flex; gap:8px; align-items:center; justify-content:flex-start;">' +
          '<button class="iconbtn" type="button" title="×¤×ª×—">â®•</button>' +
          '<button class="iconbtn" type="button" title="×¢×¨×•×š ×©×">âœï¸</button>' +
          (s.disabled
            ? '<button class="iconbtn" type="button" title="×”×—×–×¨ ×œ×¤×¢×™×œ">âœ…</button>'
            : '<button class="iconbtn" type="button" title="×”×©×‘×ª">â›”</button>') +
        "</span>";

      var btns2 = row2.querySelectorAll("button");
      btns2[0].onclick = function(){ openStoreModal(s.id); };
      btns2[1].onclick = function(){ quickRenameStore(s.id); };
      btns2[2].onclick = function(){
        if(s.disabled){
          if(confirm("×œ×”×—×–×™×¨ ××ª ×”×—× ×•×ª ×œ×¤×¢×™×œ×”?")){
            s.disabled = false;
            saveAll();
            renderAll();
          }
        } else {
          if(confirm("×œ×”×©×‘×™×ª ××ª ×”×—× ×•×ª? (×œ× × ××—×§ ×”×™×¡×˜×•×¨×™×”)")){
            s.disabled = true;
            saveAll();
            renderAll();
          }
        }
      };

      hostS.appendChild(row2);
    });

    // Categories list
    var hostC = document.getElementById("catsList");
    hostC.innerHTML = "";
    categories.slice().sort(function(a,b){ return a.name.localeCompare(b.name,"he"); }).forEach(function(c){
      var row3 = document.createElement("div");
      row3.className = "kv";
      var label3 = c.name + (c.disabled ? " (××•×©×‘×ª)" : "");
      row3.innerHTML =
        "<b>"+escapeHtml(label3)+"</b>" +
        '<span style="display:flex; gap:8px; align-items:center; justify-content:flex-start;">' +
          '<button class="iconbtn" type="button" title="×¢×¨×•×š ×©×">âœï¸</button>' +
          (c.disabled
            ? '<button class="iconbtn" type="button" title="×”×—×–×¨ ×œ×¤×¢×™×œ">âœ…</button>'
            : '<button class="iconbtn" type="button" title="×”×©×‘×ª">â›”</button>') +
          '<button class="iconbtn" type="button" title="××—×§">ğŸ—‘ï¸</button>' +
        "</span>";

      var btns3 = row3.querySelectorAll("button");
      btns3[0].onclick = function(){
        var nn = (prompt("×©× ×—×“×© ×œ×§×˜×’×•×¨×™×”:", c.name) || "").trim();
        if(!nn) return;
        c.name = nn;
        saveAll();
        renderAll();
      };
      btns3[1].onclick = function(){
        if(c.disabled){
          if(confirm("×œ×”×—×–×™×¨ ×§×˜×’×•×¨×™×” ×œ×¤×¢×™×œ×”?")){
            c.disabled = false;
            saveAll();
            renderAll();
          }
        } else {
          if(confirm("×œ×”×©×‘×™×ª ×§×˜×’×•×¨×™×”?")){
            c.disabled = true;
            saveAll();
            renderAll();
          }
        }
      };
      btns3[2].onclick = function(){
        if(!confirm("×œ××—×•×§ ×§×˜×’×•×¨×™×”? (×œ× ××•×—×§ ×”×™×¡×˜×•×¨×™×”)")) return;
        // remove category from store links
        stores.forEach(function(s){
          s.catIds = (s.catIds||[]).filter(function(x){ return x!==c.id; });
        });
        categories = categories.filter(function(x){ return x.id !== c.id; });
        saveAll();
        renderAll();
      };

      hostC.appendChild(row3);
    });
  }

  function addBrand(){
    var name = (document.getElementById("newBrandInput").value || "").trim();
    if(!name) return;
    document.getElementById("newBrandInput").value = "";

    var ex = brands.find(function(b){ return b.name.toLowerCase() === name.toLowerCase(); });
    if(ex){
      if(ex.disabled){
        if(confirm("×”××•×ª×’ ×§×™×™× ××š ××•×©×‘×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ?")){
          ex.disabled = false;
          saveAll();
          renderAll();
        }
      } else {
        alert("×”××•×ª×’ ×›×‘×¨ ×§×™×™×");
      }
      return;
    }
    brands.push({id:uid(), name:name, storeIds:[], disabled:false});
    saveAll();
    renderAll();
  }
  window.addBrand = addBrand;

  function addStore(){
    var name = (document.getElementById("newStoreInput").value || "").trim();
    if(!name) return;
    document.getElementById("newStoreInput").value = "";

    var ex = stores.find(function(s){ return s.name.toLowerCase() === name.toLowerCase(); });
    if(ex){
      if(ex.disabled){
        if(confirm("×”×—× ×•×ª ×§×™×™××ª ××š ××•×©×‘×ª×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ×”?")){
          ex.disabled = false;
          saveAll();
          renderAll();
        }
      } else {
        alert("×”×—× ×•×ª ×›×‘×¨ ×§×™×™××ª");
      }
      return;
    }
    stores.push({id:uid(), name:name, brandIds:[], catIds:[], disabled:false});
    saveAll();
    renderAll();
  }
  window.addStore = addStore;

  function addCategory(){
    var name = (document.getElementById("newCatInput").value || "").trim();
    if(!name) return;
    document.getElementById("newCatInput").value = "";

    var ex = categories.find(function(c){ return c.name.toLowerCase() === name.toLowerCase(); });
    if(ex){
      if(ex.disabled){
        if(confirm("×”×§×˜×’×•×¨×™×” ×§×™×™××ª ××š ××•×©×‘×ª×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ×”?")){
          ex.disabled = false;
          saveAll();
          renderAll();
        }
      } else {
        alert("×”×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª");
      }
      return;
    }
    categories.push({id:uid(), name:name, disabled:false});
    saveAll();
    renderAll();
  }
  window.addCategory = addCategory;

  function quickRenameBrand(brandId){
    var b = findBrandById(brandId);
    if(!b) return;
    var nn = (prompt("×©× ×—×“×© ×œ××•×ª×’:", b.name) || "").trim();
    if(!nn) return;
    b.name = nn;
    saveAll();
    renderAll();
  }
  function quickRenameStore(storeId){
    var s = findStoreById(storeId);
    if(!s) return;
    var nn = (prompt("×©× ×—×“×© ×œ×—× ×•×ª:", s.name) || "").trim();
    if(!nn) return;
    s.name = nn;
    saveAll();
    renderAll();
  }

  /* ===== Brand modal (manage links) ===== */
  var brandEditingId = null;

  function openBrandModal(brandId){
    var b = findBrandById(brandId);
    if(!b) return;
    brandEditingId = brandId;

    document.getElementById("brandModalTitle").textContent = "××•×ª×’: " + b.name;
    document.getElementById("brandNameEdit").value = b.name;

    var multi = document.getElementById("brandStoresMulti");
    multi.innerHTML = "";
    stores.filter(function(s){return !s.disabled;}).slice().sort(function(a,b){return a.name.localeCompare(b.name,"he");})
      .forEach(function(s){
        var o = document.createElement("option");
        o.value = s.id;
        o.textContent = s.name;
        o.selected = (b.storeIds||[]).indexOf(s.id)>=0;
        multi.appendChild(o);
      });

    document.getElementById("brandBackdrop").style.display = "flex";
  }
  window.openBrandModal = openBrandModal;

  function hideBrandModal(){
    document.getElementById("brandBackdrop").style.display = "none";
    brandEditingId = null;
  }
  window.hideBrandModal = hideBrandModal;

  function closeBrandModal(e){
    if(e.target === document.getElementById("brandBackdrop")) hideBrandModal();
  }
  window.closeBrandModal = closeBrandModal;

  function renameBrand(){
    if(!brandEditingId) return;
    var b = findBrandById(brandEditingId);
    if(!b) return;
    var nn = (document.getElementById("brandNameEdit").value || "").trim();
    if(!nn) return;
    b.name = nn;
    saveAll();
    renderAll();
    document.getElementById("brandModalTitle").textContent = "××•×ª×’: " + b.name;
  }
  window.renameBrand = renameBrand;

  function quickAddStoreFromBrand(){
    var name = (prompt("×©× ×—× ×•×ª ×—×“×©×”:") || "").trim();
    if(!name) return;
    var ex = stores.find(function(s){ return s.name.toLowerCase() === name.toLowerCase(); });
    var id;
    if(ex){
      if(ex.disabled){
        if(confirm("×”×—× ×•×ª ×§×™×™××ª ××š ××•×©×‘×ª×ª. ×œ×”×—×–×™×¨ ×œ×¤×¢×™×œ×”?")){
          ex.disabled = false;
        }
      }
      id = ex.id;
    } else {
      var s = { id:uid(), name:name, brandIds:[], catIds:[], disabled:false };
      stores.push(s);
      id = s.id;
    }
    saveAll();
    // refresh modal list
    openBrandModal(brandEditingId);
    // select it
    var multi = document.getElementById("brandStoresMulti");
    for(var i=0;i<multi.options.length;i++){
      if(multi.options[i].value === id) multi.options[i].selected = true;
    }
  }
  window.quickAddStoreFromBrand = quickAddStoreFromBrand;

  function selectAllBrandStores(){
    var multi = document.getElementById("brandStoresMulti");
    for(var i=0;i<multi.options.length;i++) multi.options[i].selected = true;
  }
  window.selectAllBrandStores = selectAllBrandStores;

  function clearAllBrandStores(){
    var multi = document.getElementById("brandStoresMulti");
    for(var i=0;i<multi.options.length;i++) multi.options[i].selected = false;
  }
  window.clearAllBrandStores = clearAllBrandStores;

  function saveBrandLinks(){
    if(!brandEditingId) return;
    var b = findBrandById(brandEditingId);
    if(!b) return;
    var multi = document.getElementById("brandStoresMulti");
    var storeIds = getSelectedValues(multi);

    b.storeIds = storeIds;

    // update store -> brandIds (bidirectional)
    stores.forEach(function(s){
      var has = (s.brandIds||[]).indexOf(b.id)>=0;
      var should = storeIds.indexOf(s.id)>=0;
      if(should && !has) s.brandIds.push(b.id);
      if(!should && has) s.brandIds = s.brandIds.filter(function(x){return x!==b.id;});
    });

    saveAll();
    renderAll();
    alert("× ×©××¨ âœ…");
  }
  window.saveBrandLinks = saveBrandLinks;

  function deleteBrand(){
    if(!brandEditingId) return;
    var b = findBrandById(brandEditingId);
    if(!b) return;
    if(!confirm("×œ××—×•×§ ××•×ª×’?")) return;

    // remove references in stores
    stores.forEach(function(s){
      s.brandIds = (s.brandIds||[]).filter(function(x){ return x!==b.id; });
    });

    // remove brand from list (keep voucher history)
    brands = brands.filter(function(x){ return x.id !== b.id; });

    // vouchers keep brandNameAtCreation, but brandId may point nowhere
    vouchers.forEach(function(v){
      if(v.brandId === b.id){
        v.brandId = "";
        if(!v.brandNameAtCreation) v.brandNameAtCreation = b.name;
      }
    });

    saveAll();
    renderAll();
    hideBrandModal();
  }
  window.deleteBrand = deleteBrand;

  /* ===== Store modal ===== */
  var storeEditingId = null;

  function openStoreModal(storeId){
    var s = findStoreById(storeId);
    if(!s) return;
    storeEditingId = storeId;

    document.getElementById("storeModalTitle").textContent = "×—× ×•×ª: " + s.name;
    document.getElementById("storeNameEdit").value = s.name;

    var bMulti = document.getElementById("storeBrandsMulti");
    bMulti.innerHTML = "";
    brands.filter(function(b){return !b.disabled;}).slice().sort(function(a,b){return a.name.localeCompare(b.name,"he");})
      .forEach(function(b){
        var o = document.createElement("option");
        o.value = b.id;
        o.textContent = b.name;
        o.selected = (s.brandIds||[]).indexOf(b.id)>=0;
        bMulti.appendChild(o);
      });

    var cMulti = document.getElementById("storeCatsMulti");
    cMulti.innerHTML = "";
    categories.filter(function(c){return !c.disabled;}).slice().sort(function(a,b){return a.name.localeCompare(b.name,"he");})
      .forEach(function(c){
        var o2 = document.createElement("option");
        o2.value = c.id;
        o2.textContent = c.name;
        o2.selected = (s.catIds||[]).indexOf(c.id)>=0;
        cMulti.appendChild(o2);
      });

    document.getElementById("storeBackdrop").style.display = "flex";
  }
  window.openStoreModal = openStoreModal;

  function hideStoreModal(){
    document.getElementById("storeBackdrop").style.display = "none";
    storeEditingId = null;
  }
  window.hideStoreModal = hideStoreModal;

  function closeStoreModal(e){
    if(e.target === document.getElementById("storeBackdrop")) hideStoreModal();
  }
  window.closeStoreModal = closeStoreModal;

  function renameStore(){
    if(!storeEditingId) return;
    var s = findStoreById(storeEditingId);
    if(!s) return;
    var nn = (document.getElementById("storeNameEdit").value || "").trim();
    if(!nn) return;
    s.name = nn;
    saveAll();
    renderAll();
    document.getElementById("storeModalTitle").textContent = "×—× ×•×ª: " + s.name;
  }
  window.renameStore = renameStore;

  function saveStoreLinks(){
    if(!storeEditingId) return;
    var s = findStoreById(storeEditingId);
    if(!s) return;

    var bMulti = document.getElementById("storeBrandsMulti");
    var cMulti = document.getElementById("storeCatsMulti");

    s.brandIds = getSelectedValues(bMulti);
    s.catIds = getSelectedValues(cMulti);

    // update brands storeIds (bidirectional)
    brands.forEach(function(b){
      var has = (b.storeIds||[]).indexOf(s.id)>=0;
      var should = (s.brandIds||[]).indexOf(b.id)>=0;
      if(should && !has) b.storeIds.push(s.id);
      if(!should && has) b.storeIds = b.storeIds.filter(function(x){return x!==s.id;});
    });

    saveAll();
    renderAll();
    alert("× ×©××¨ âœ…");
  }
  window.saveStoreLinks = saveStoreLinks;

  function deleteStore(){
    if(!storeEditingId) return;
    var s = findStoreById(storeEditingId);
    if(!s) return;
    if(!confirm("×œ××—×•×§ ×—× ×•×ª?")) return;

    // remove from brands
    brands.forEach(function(b){
      b.storeIds = (b.storeIds||[]).filter(function(x){ return x!==s.id; });
    });

    // remove store entity
    stores = stores.filter(function(x){ return x.id !== s.id; });

    // vouchers keep storeNamesAtCreation, but storeIds may point nowhere
    vouchers.forEach(function(v){
      if((v.storeIds||[]).indexOf(s.id)>=0){
        v.storeIds = (v.storeIds||[]).filter(function(x){ return x!==s.id; });
        if(!v.storeNamesAtCreation || !v.storeNamesAtCreation.length){
          v.storeNamesAtCreation = [s.name];
        } else if(v.storeNamesAtCreation.indexOf(s.name)<0){
          v.storeNamesAtCreation.push(s.name);
        }
      }
    });

    saveAll();
    renderAll();
    hideStoreModal();
  }
  window.deleteStore = deleteStore;

  /* ===== Reset ===== */
  function resetAll(){
    if(!confirm("××™×¤×•×¡ ××œ× ×‘××›×©×™×¨ ×”×–×”?")) return;
    localStorage.clear();
    location.reload();
  }
  window.resetAll = resetAll;

  /* ===== Render all ===== */
  function renderAll(){
    initFilterChips();
    renderActive();
    renderArchive();
    renderManage();
    renderDataTab();
  }

  // Initial load
  autoArchiveByRules();
  renderAll();
  renderDataTab();
  setSyncMsg("××•×›×Ÿ âœ…");
  renderSyncLastLine();
</script>

</body>
</html>
