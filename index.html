<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×§×•×¤×•× ×™× ×•×©×•×‘×¨×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;
      --warn:#b45309;
      --ok:#16a34a;
      --near:#fee2e2;
      --expired:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
      overflow:hidden;
    }
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .view{display:none}
    .view.active{display:block}

    .field{margin-top:10px; min-width:0; overflow:hidden;}
    label{font-weight:900}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff;
      max-width:100%;
    }
    input[type="date"]{width:100%;display:block;min-width:0;}
    textarea{min-height:100px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline > *{flex:1; min-width:160px}
    .inline .tinybtn{flex:0 0 auto; min-width:auto}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}
    .ok{background:var(--ok); color:#fff}
    .warn{background:#fff7ed; border:1px solid #fed7aa; color:var(--warn)}
    .tinybtn{
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      background:#f3f4f6; font-weight:900; cursor:pointer;
    }

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .toolbar-left{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .toolbar-right{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}

    .search{
      flex:1;
      min-width:220px;
    }

    .chips{
      display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; margin:10px 0 6px;
    }
    .chip{
      display:flex; align-items:center; gap:6px;
      font-weight:900; font-size:12px;
      background:#fff; border:1px solid var(--border);
      padding:6px 8px; border-radius:999px;
      white-space:nowrap; flex:0 0 auto;
      cursor:pointer;
    }
    .chip.active{background:var(--primary); color:#fff; border-color:var(--primary);}

    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
    }
    .rowtop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .title{font-weight:900; font-size:16px}
    .meta{color:#374151; font-weight:900; font-size:13px; margin-top:4px}
    .badges{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
      border:1px solid var(--border);
      background:var(--pill);
      white-space:nowrap;
    }
    .badge.near{background:var(--near); border-color:#fecaca}
    .badge.expired{background:var(--expired)}
    .badge.physical{background:#ecfeff; border-color:#a5f3fc}
    .badge.type{background:#eef2ff; border-color:#c7d2fe}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .actionbtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }

    .kv{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed var(--border); font-weight:900;}
    .kv:last-child{border-bottom:none}
    .kv span{color:#374151; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left;}

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:780px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
      max-height:90vh;
      overflow:auto;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modal-title{font-weight:900;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}

    @media(min-width:700px){ body{max-width:900px;margin:auto} }
  </style>
</head>

<body>
<h1>ğŸŸï¸ ×§×•×¤×•× ×™× ×•×©×•×‘×¨×™×</h1>

<div class="tabs">
  <button class="tabbtn active" type="button" onclick="showTab('active')">×¤×¢×™×œ×™×</button>
  <button class="tabbtn" type="button" onclick="showTab('archive')">××¨×›×™×•×Ÿ</button>
  <button class="tabbtn" type="button" onclick="showTab('manage')">× ×™×”×•×œ</button>
  <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
</div>

<section id="view-active" class="view active">
  <section class="card">
    <div class="toolbar">
      <div class="toolbar-left" style="flex:1;">
        <input id="q" class="search" placeholder="×—×™×¤×•×©: ×©× ×©×•×‘×¨ / ×¨×©×ª / ×—× ×•×ª" oninput="renderActive()">
        <select id="sortMode" onchange="renderActive()" style="max-width:220px;">
          <option value="smart" selected>××™×•×Ÿ ×—×›× (×›×•×œ×œ ×ª×•×§×£)</option>
          <option value="expiry">×ª×•×§×£ ×§×¨×•×‘</option>
          <option value="value">×™×ª×¨×” ×’×‘×•×”×”</option>
          <option value="name">×©× (×-×‘)</option>
        </select>
      </div>
      <div class="toolbar-right">
        <button class="btn primary" type="button" onclick="openVoucherModal(null)">+ ×”×•×¡×£ ×©×•×‘×¨</button>
      </div>
    </div>

    <div class="chips" id="filterChips"></div>

    <div class="note" id="activeHint"></div>

    <ul id="activeList"></ul>
  </section>
</section>

<section id="view-archive" class="view">
  <section class="card">
    <div class="toolbar">
      <div class="toolbar-left" style="flex:1;">
        <input id="q2" class="search" placeholder="×—×™×¤×•×© ×‘××¨×›×™×•×Ÿ" oninput="renderArchive()">
        <select id="sortArchive" onchange="renderArchive()" style="max-width:220px;">
          <option value="recent" selected>×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”</option>
          <option value="expiry">×ª×•×§×£</option>
          <option value="name">×©× (×-×‘)</option>
        </select>
      </div>
    </div>
    <ul id="archiveList"></ul>
  </section>
</section>

<section id="view-manage" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ××•×ª×’×™× / ×—× ×•×™×•×ª / ×§×˜×’×•×¨×™×•×ª</h2>

    <div class="chips">
      <div class="chip active" id="mg-brands" onclick="showManage('brands')">××•×ª×’×™×</div>
      <div class="chip" id="mg-stores" onclick="showManage('stores')">×—× ×•×™×•×ª</div>
      <div class="chip" id="mg-cats" onclick="showManage('cats')">×§×˜×’×•×¨×™×•×ª</div>
    </div>

    <div id="manage-brands">
      <h3>××•×ª×’×™× (×¨×©×ª ×¨××©×™×ª)</h3>
      <div class="inline">
        <input id="newBrandName" placeholder="×©× ××•×ª×’ (×œ××©×œ DREAM / LOVE)">
        <button class="btn primary" type="button" onclick="addBrand()">×”×•×¡×£</button>
      </div>
      <div class="note">××¤×©×¨ ×œ×©×™×™×š ×—× ×•×™×•×ª ×œ××•×ª×’ ×’× ××ª×•×š ×¢×¨×™×›×ª ×©×•×‘×¨.</div>
      <ul id="brandsList"></ul>
    </div>

    <div id="manage-stores" style="display:none;">
      <h3>×—× ×•×™×•×ª</h3>
      <div class="inline">
        <input id="newStoreName" placeholder="×©× ×—× ×•×ª (×œ××©×œ ×§×¡×˜×¨×•)">
        <button class="btn primary" type="button" onclick="addStore()">×”×•×¡×£</button>
      </div>
      <div class="note">×—× ×•×ª ×™×›×•×œ×” ×œ×”×©×ª×™×™×š ×œ×›××” ××•×ª×’×™×, ×•××¤×©×¨ ×œ×¡×•×•×’ ×œ×§×˜×’×•×¨×™×•×ª.</div>
      <ul id="storesList"></ul>
    </div>

    <div id="manage-cats" style="display:none;">
      <h3>×§×˜×’×•×¨×™×•×ª</h3>
      <div class="inline">
        <input id="newCatName" placeholder="×©× ×§×˜×’×•×¨×™×” (×œ××©×œ ××•×¤× ×” / ××¡×¢×“×•×ª)">
        <button class="btn primary" type="button" onclick="addCategory()">×”×•×¡×£</button>
      </div>
      <ul id="catsList"></ul>
    </div>

  </section>
</section>

<section id="view-data" class="view">
  <section class="card">
    <h2>×¡× ×›×¨×•×Ÿ ×•×’×™×‘×•×™</h2>
    <div class="note" id="syncStatusLine"></div>
    <div class="note" id="syncLastLine"></div>

    <div class="inline" style="margin-top:10px;">
      <button class="btn ghost" type="button" onclick="cloudPull()">××©×•×š × ×ª×•× ×™× ××”×¢× ×Ÿ</button>
      <button class="btn ok" type="button" onclick="cloudPush()">×©×œ×— × ×ª×•× ×™× ×œ×¢× ×Ÿ</button>
      <button class="btn ghost" type="button" onclick="backupNow()">×’×™×‘×•×™ ×œ×§×•×‘×¥</button>
      <button class="btn ghost" type="button" onclick="triggerRestore()">×˜×¢×™× ×ª ×’×™×‘×•×™</button>
    </div>

    <input id="restoreFile" type="file" accept=".json,application/json" style="display:none" onchange="restoreFromFile(event)">

    <div class="note" style="margin-top:10px;">
      ×˜×™×¤: ×× ×™×© â€œ×”×ª× ×’×©×•×ªâ€ ×‘×™×Ÿ ××›×©×™×¨×™× â€” ×¤×©×•×˜ ××©×›×• ××”×¢× ×Ÿ ×•××– ×©×œ×—×• ××—×“×©.
      ×‘××§×¨×” ×©×œ ×”×ª× ×’×©×•×ª ×××™×ª×™×ª, <b>Yanir ×× ×¦×—</b>.
    </div>
  </section>

  <section class="card">
    <h2>×”×’×“×¨×•×ª ××›×©×™×¨</h2>
    <div class="note">×‘×¨×™×¨×ª ××—×“×œ: Yanir ×‘××›×©×™×¨ ××—×“, Wife ×‘××›×©×™×¨ ×”×©× ×™.</div>
    <div class="inline">
      <select id="deviceName" onchange="setDeviceName(this.value)">
        <option value="Yanir">Yanir</option>
        <option value="Wife">Wife</option>
      </select>
      <button class="btn danger" type="button" onclick="resetAll()">××™×¤×•×¡ ××§×•××™</button>
    </div>
  </section>
</section>

<!-- Voucher modal -->
<div id="voucherBackdrop" class="modal-backdrop" onclick="closeVoucherModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="voucherTitle">+ ×©×•×‘×¨ ×—×“×©</div>
      <div class="modal-actions">
        <button class="tinybtn" type="button" onclick="saveVoucher()">×©××™×¨×”</button>
        <button class="tinybtn" type="button" onclick="hideVoucherModal()">×¡×’×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>×©× ×”×©×•×‘×¨</label>
      <input id="v_title" placeholder="×œ××©×œ: ×©×•×‘×¨ DREAM / LOVE / ×§×¡×˜×¨×•">
    </div>

    <div class="field">
      <label>×¡×•×’</label>
      <select id="v_type" onchange="renderTypeFields()">
        <option value="money">×©×•×‘×¨ ×›×¡×¤×™</option>
        <option value="percent">××—×•×– ×”× ×—×”</option>
        <option value="bogo">1+1 / ××‘×¦×¢</option>
        <option value="generic" selected>×›×œ×œ×™</option>
      </select>
      <div class="note">×× ××©×”×• ×œ× ××ª××™× â€” ×‘×—×¨ â€œ×›×œ×œ×™â€ ×•×›×ª×•×‘ ×‘×¤×¨×˜×™×.</div>
    </div>

    <div class="field" style="margin-top:12px;">
      <label style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="v_physical" onchange="renderTypeFields()" style="width:18px;height:18px;margin:0">
        ×›×¨×˜×™×¡ ×¤×™×–×™ (××™×Ÿ ×§×•×“ ×œ×”×¢×ª×§×”)
      </label>
    </div>

    <div class="field" id="codeWrap">
      <label>×§×•×“ (××•×¤×¦×™×•× ×œ×™)</label>
      <input id="v_code" placeholder="×”×“×‘×§ ×§×•×“ ×›××Ÿ">
      <div class="note">××—×¨ ×›×š ×™×”×™×” ×›×¤×ª×•×¨ â€œ×”×¢×ª×§ ×§×•×“â€.</div>
    </div>

    <div class="field">
      <label>×ª×•×§×£ (××•×¤×¦×™×•× ×œ×™)</label>
      <input type="date" id="v_exp">
      <div class="note"><= 3 ×—×•×“×©×™× ×™×¡×•××Ÿ â€œ×§×¨×•×‘ ×œ×¤×§×™×¢×”â€ ×•×™×§×¤×•×¥ ×œ×¨××©.</div>
    </div>

    <div class="field" id="moneyWrap" style="display:none;">
      <h3>×¢×¨×š / × ×™×¦×•×œ</h3>
      <div class="inline">
        <input id="v_face" inputmode="decimal" placeholder="×¢×¨×š ××§×•×¨×™ (×œ××©×œ 500)">
        <input id="v_used" inputmode="decimal" placeholder="× ×•×¦×œ (×œ××©×œ 200)">
      </div>
      <div class="note">××™×Ÿ ×”×™×¡×˜×•×¨×™×” â€” ×¨×§ ×¡×›×•× × ×•×¦×œ/×™×ª×¨×” (×›××• ×©×‘×™×§×©×ª).</div>
    </div>

    <div class="field" id="percentWrap" style="display:none;">
      <h3>××—×•×–/×ª×§×¨×•×ª</h3>
      <input id="v_details_percent" placeholder='×œ××©×œ: "20% ×¢×“ 200â‚ª" ××• "20% ×¢×œ 200â‚ª"'>
      <div class="note">×× ×™×© â€œ×™×ª×¨×”â€ (×œ××©×œ × ×©××¨ 20â‚ª ××ª×•×š 200) â€” ××¤×©×¨ ×œ×”×©×ª××© ×‘×¢×¨×š/× ×•×¦×œ ×œ××¢×œ×”.</div>
    </div>

    <div class="field" id="bogoWrap" style="display:none;">
      <h3>×¤×™×¨×•×˜ ××‘×¦×¢</h3>
      <input id="v_details_bogo" placeholder='×œ××©×œ: "1+1 ×¢×œ ×§×¤×”", "2+1", "××ª× ×” ×‘×”×¦×˜×¨×¤×•×ª"'>
    </div>

    <div class="field">
      <label>×¤×¨×˜×™× / ×”×¢×¨×•×ª</label>
      <textarea id="v_notes" placeholder="×›×œ ××” ×©×—×©×•×‘ ×œ×–×›×•×¨â€¦"></textarea>
    </div>

    <div class="field">
      <h3>××•×ª×’×™× (×¨×©×ª ×¨××©×™×ª) â€” ×¨×‘ ×‘×—×™
